<!DOCTYPE html>
<html lang="zh">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>血袭燃烧</title>
    <link rel="icon" href="{{ url_for('static', filename='favicon.ico') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css', v='1.0') }}">
    <style>
        /* 导航栏优先加载样式 */
        .navbar {
            opacity: 1 !important;
            visibility: visible !important;
        }
        
        /* 下拉菜单样式 */
        #dropdown-menu {
            display: none;
            position: absolute;
            background-color: white;
            min-width: 120px;
            box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
            z-index: 1000;
            border-radius: 4px;
            overflow: hidden;
        }
        
        #dropdown-menu a {
            color: black;
            padding: 12px 16px;
            text-decoration: none;
            display: block;
            font-size: 14px;
        }
        
        #dropdown-menu a:hover {
            background-color: #f1f1f1;
        }
        
        [data-theme="dark"] #dropdown-menu {
            background-color: #333;
        }
        
        [data-theme="dark"] #dropdown-menu a {
            color: white;
        }
        
        [data-theme="dark"] #dropdown-menu a:hover {
            background-color: #444;
        }
        
        /* 内容区域初始隐藏，避免闪烁 */
        .content-loading {
            opacity: 0.3;
            pointer-events: none;
        }
        
        .content-loading .info-card,
        .content-loading .table-section {
            opacity: 0.5;
            transition: opacity 0.3s ease;
        }
        
        /* 骨架屏样式 */
        .skeleton {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
            position: relative;
            overflow: hidden;
        }
        
        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
        
        .skeleton-card {
            height: 120px;
            border-radius: 12px;
            margin-bottom: 20px;
        }
        
        .skeleton-table {
            height: 200px;
            border-radius: 8px;
        }
        
        /* 顶部加载指示器样式 */
        .top-loading {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: linear-gradient(135deg, #1976d2, #42a5f5);
            color: white;
            padding: 8px 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            z-index: 9999;
            font-size: 14px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .top-loading .spinner {
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255,255,255,0.3);
            border-top: 2px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        /* 夜间模式下的骨架屏样式 */
        [data-theme="dark"] .skeleton {
            background: linear-gradient(90deg, #2a2a2a 25%, #333 50%, #2a2a2a 75%);
        }
        
        [data-theme="dark"] .top-loading {
            background: linear-gradient(135deg, #1565c0, #1976d2);
        }
    </style>
    <script>
    // 下拉菜单功能
    document.addEventListener('DOMContentLoaded', function() {
        const userBtn = document.getElementById('user-btn');
        const dropdownMenu = document.getElementById('dropdown-menu');
        
        if (userBtn && dropdownMenu) {
            // 点击用户名按钮时显示/隐藏下拉菜单
            userBtn.addEventListener('click', function(e) {
                e.stopPropagation();
                
                // 获取按钮位置
                const rect = userBtn.getBoundingClientRect();
                
                // 设置下拉菜单位置
                dropdownMenu.style.top = (rect.bottom + window.scrollY) + 'px';
                dropdownMenu.style.left = (rect.left + window.scrollX) + 'px';
                dropdownMenu.style.display = dropdownMenu.style.display === 'block' ? 'none' : 'block';
            });
            
            // 点击页面其他地方关闭下拉菜单
            document.addEventListener('click', function() {
                dropdownMenu.style.display = 'none';
            });
        }
    });
    </script>
</head>

<body>
   <nav class="navbar">
        <div class="navbar-container">
            <div class="navbar-menu">
                <a href="/" class="navbar-brand">EVE 工具集</a>
                <a href="/price_history" class="navbar-item">价格查询</a>
                <a href="/xuexi_ranshao" class="navbar-item">血袭燃烧</a>
            </div>
            <div class="navbar-menu">
                <!-- EVE SSO 认证按钮 -->
                {% if session.get('eve_character_name') %}
                    <span class="navbar-item user-btn" id="user-btn">{{ session.get('eve_character_name') }}</span>
                {% else %}
                    <a href="/auth/login" class="navbar-item">EVE SSO 登录</a>
                {% endif %}
                <!-- 主题切换按钮 -->
                <button class="navbar-item theme-btn" onclick="toggleTheme()" title="切换夜间模式">
                    <span id="theme-icon">🌙</span>
                </button>
            </div>
        </div>
    </nav>
    
    <!-- 将下拉菜单移到body的直接子元素，完全脱离导航栏 -->
    {% if session.get('eve_character_name') %}
    <div id="dropdown-menu">
        <a href="/auth/logout">退出</a>
    </div>
    {% endif %}

    <!-- 用户操作区域 -->
    <div id="userArea" class="user-area">
        <!-- 未登录状态 -->
        <div id="guestArea" class="guest-area">
            <button id="loginBtn" class="auth-btn login-btn">登录</button>
            <button id="registerBtn" class="auth-btn register-btn">注册</button>
        </div>

        <!-- 已登录状态 -->
        <div id="userProfile" class="user-profile" style="display: none;">

            <div class="user-avatar" id="userAvatar">
                <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23fff'%3E%3Cpath d='M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z'/%3E%3C/svg%3E"
                    alt="用户头像">
                <span class="username" id="displayUsername"></span>
                <span class="dropdown-arrow">▼</span>
            </div>
            <div class="user-dropdown" id="userDropdown">
                <div class="dropdown-item user-info">
                    <div class="user-details">
                        <div class="user-name" id="dropdownUsername"></div>
                        <div class="user-level" id="userLevel"></div>
                    </div>
                </div>
                <div class="dropdown-divider"></div>
                <!-- 设置比率按钮 -->
                <button class="dropdown-item settings-item" id="settingsBtnLoggedIn">
                    <span class="settings-icon">⚙️</span>
                    设置比率
                </button>
                <!-- 更新数据按钮 -->
                <button class="dropdown-item update-data-item" id="updateDataBtn">
                    <span class="update-icon">🔄</span>
                    更新数据
                </button>
                <!-- 删除强制刷新按钮 -->
                <!-- <button class="dropdown-item force-refresh-item" id="forceRefreshBtn">
                    <span class="refresh-icon">🔄</span>
                    强制刷新
                </button> -->
                <div class="dropdown-divider"></div>
                <button class="dropdown-item logout-btn" id="logoutBtn">
                    <span class="logout-icon">🚪</span>
                    退出登录
                </button>
            </div>
        </div>
    </div>

    <main>
        <!-- 登录弹窗 -->
        <div id="loginModal" class="modal">
            <div class="modal-content">
                <span class="close" id="closeModal">&times;</span>
                <h2>用户登录</h2>
                <div class="modal-body">
                    <form id="loginForm" action="/xuexi_ranshao/login" method="POST">
                        <div class="mb-3">
                            <label for="username" class="form-label">用户名</label>
                            <input type="text" class="form-control" id="username" name="username" required>
                        </div>
                        <div class="mb-3">
                            <label for="password" class="form-label">密码</label>
                            <input type="password" class="form-control" id="password" name="password" required>
                        </div>
                        <div class="mb-3 form-check">
                            <input type="checkbox" class="form-check-input" id="rememberMe" name="rememberMe">
                            <label class="form-check-label" for="rememberMe">记住我（保持登录状态30天）</label>
                        </div>
                        <button type="submit" class="btn btn-primary">登录</button>
                    </form>
                    <div class="switch-form">
                        <p>还没有账号？<a href="#" id="showRegister">立即注册</a></p>
                    </div>
                </div>
            </div>
        </div>

        <!-- 注册弹窗 -->
        <div id="registerModal" class="modal">
            <div class="modal-content">
                <span class="close" id="closeRegisterModal">&times;</span>
                <h2>用户注册</h2>
                <div class="modal-body">
                    <form id="registerForm" action="/xuexi_ranshao/register" method="POST">
                        <div class="mb-3">
                            <label for="regUsername" class="form-label">用户名</label>
                            <input type="text" class="form-control" id="regUsername" name="username" required>
                        </div>
                        <div class="mb-3">
                            <label for="regPassword" class="form-label">密码</label>
                            <input type="password" class="form-control" id="regPassword" name="password" required>
                        </div>
                        <div class="mb-3">
                            <label for="confirmPassword" class="form-label">确认密码</label>
                            <input type="password" class="form-control" id="confirmPassword" name="confirmPassword"
                                required>
                        </div>
                        <div class="mb-3">
                            <label for="regEmail" class="form-label">邮箱（可选）</label>
                            <input type="email" class="form-control" id="regEmail" name="email">
                        </div>
                        <button type="submit" class="btn btn-success">注册</button>
                    </form>
                    <div class="switch-form">
                        <p>已有账号？<a href="#" id="showLogin">立即登录</a></p>
                    </div>
                </div>
            </div>
        </div>

        <!-- 设置比率弹窗 -->
        <div id="settingsModal" class="modal">
            <div class="modal-content">
                <span class="close" id="closeSettingsModal">&times;</span>
                <h2>设置合作社回收比率</h2>
                <p>当前比率: <span id="currentRateSpan">2200</span></p>
                <div class="modal-body">
                    <form id="settingsForm">
                        <div class="mb-3">
                            <label for="cooperativeRate" class="form-label">新比率</label>
                            <input type="number" step="0.01" class="form-control" id="cooperativeRate" required>
                        </div>
                        <button type="submit" class="btn btn-primary">保存</button>
                        <button type="button" id="cancelSettings" class="btn btn-secondary cancel-btn">取消</button>
                    </form>
                </div>
            </div>
        </div>

        <!-- 自定义消息弹窗 -->
        <div id="messageModal" class="message-modal">
            <div class="message-content">
                <div class="message-icon" id="messageIcon"></div>
                <div class="message-text" id="messageText"></div>
                <button class="message-btn" id="messageBtn">确定</button>
            </div>
        </div>

        <!-- 更新数据弹窗 -->
        <div id="updateDataModal" class="modal">
            <div class="modal-content">
                <span class="close" id="closeUpdateDataModal">&times;</span>
                <h2>更新血袭合作社数据</h2>
                <div class="modal-body">
                    <!-- 移除表单部分，直接显示进度 -->
                    <div id="updateLoadingIndicator" class="loading-indicator" style="display: none;">
                        <div class="spinner"></div>
                        <div>正在获取数据，请稍候...</div>
                    </div>
                    <!-- 更新状态显示区域 -->
                    <div id="updateStatusDisplay" class="update-status-display" style="display: none;">
                        <div class="update-progress">
                            <div class="progress-bar">
                                <div class="progress-fill" id="progressFill"></div>
                            </div>
                            <div class="progress-text" id="progressText">0%</div>
                        </div>
                        <div class="update-steps">
                            <div class="update-step" id="step1">
                                <div class="step-icon">1</div>
                                <div class="step-text">验证账户</div>
                            </div>
                            <div class="update-step" id="step2">
                                <div class="step-icon">2</div>
                                <div class="step-text">获取数据</div>
                            </div>
                            <div class="update-step" id="step3">
                                <div class="step-icon">3</div>
                                <div class="step-text">保存到数据库</div>
                            </div>
                            <div class="update-step" id="step4">
                                <div class="step-icon">4</div>
                                <div class="step-text">计算统计信息</div>
                            </div>
                        </div>
                        <!-- 添加关闭按钮 -->
                        <div style="margin-top: 20px; text-align: center;">
                            <button type="button" id="cancelUpdateData" class="btn btn-secondary cancel-btn">关闭</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 页面内容区域 -->
        <div class="content-area">
            <div class="isk-lp-info">
                <a href="https://www.fuzzwork.co.uk/lpstore/buy/10000002/1000134" class="info-card-link" target="_blank" rel="noopener noreferrer">
                    <div class="info-card clickable">
                        <div class="info-label">实时jita ISK/LP 比率</div>
                        <div class="info-value">{{ max_isk_lp if max_isk_lp is defined else '0' }}</div>
                    </div>
                </a>
                <div class="info-card clickable" onclick="openSettingsModal()">
                    <div class="info-label">实时合作社回收 ISK/LP 比率</div>
                    <div class="info-value">2200</div>
                </div>
                <!-- 新增血袭者LP点数显示卡片 -->
                <div class="info-card">
                    <div class="info-label">血袭者LP点数</div>
                    <div class="info-value">{{ '{:,}'.format(blood_raider_lp) if blood_raider_lp is defined and blood_raider_lp else '0' }}</div>
                </div>
                <div class="info-card">
                    <div class="info-label">意林奸商价</div>
                    <div class="info-value">{{ '{:,.0f}'.format(2200 * blood_raider_lp) if blood_raider_lp is defined and blood_raider_lp else '0' }}</div>
                </div>
            </div>
            
            <!-- 任务状态信息 -->
            <div class="mission-status-info">
                <h3>任务状态统计</h3>
                <div class="isk-lp-info">  <!-- 复用现有的卡片布局样式 -->
                    {% if mission_status is defined and mission_status.completed %}
                    <div class="info-card">
                        <div class="info-label">已完成任务</div>
                        <div class="info-value">{{ mission_status.completed.count }}</div>
                        <div class="info-bounty">{{ '{:,.0f}'.format(mission_status.completed.total_bounty) }} ISK</div>
                    </div>
                    {% endif %}
                    
                    {% if mission_status is defined and mission_status.paid %}
                    <div class="info-card clickable" onclick="window.open('https://blood.cs-eve.com/running', '_blank')" style="cursor: pointer;">
                        <div class="info-label">已支付任务</div>
                        <div class="info-value">{{ mission_status.paid.count }}</div>
                        <div class="info-bounty">{{ '{:,.0f}'.format(mission_status.paid.total_bounty) }} ISK</div>
                    </div>
                    {% endif %}
                    
                    {% if mission_status is defined and mission_status.done %}
                    <div class="info-card">
                        <div class="info-label">已完结任务</div>
                        <div class="info-value">{{ mission_status.done.count }}</div>
                        <div class="info-bounty">{{ '{:,.0f}'.format(mission_status.done.total_bounty) }} ISK</div>
                    </div>
                    {% endif %}
                </div>
            </div>
            
            <!-- 在任务状态统计下方添加 -->
            <div class="tables-container">
                <div class="table-section">
                    <h4>已支付任务汇总</h4>
                    <div class="table-wrapper">
                        <table id="paidMissionsTable" class="data-table">
                            <thead>
                                <tr>
                                    <th>老板账号</th>
                                    <th>任务数量</th>
                                    <th>总金额</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- 数据将通过JavaScript动态加载 -->
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="table-section">
                    <h4>最近钱包捐赠</h4>
                    <div class="table-wrapper">
                        <table id="walletDonationsTable" class="data-table">
                            <thead>
                                <tr>
                                    <th>捐赠人</th>
                                    <th>类型</th>
                                    <th>金额</th>
                                    <th>日期</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- 数据将通过JavaScript动态加载 -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            

        </div>
    </main>

    <!-- 角落通知弹窗 -->
    <div id="cornerNotification" class="corner-notification">
        <div class="corner-notification-icon" id="cornerNotificationIcon"></div>
        <div class="corner-notification-text" id="cornerNotificationText"></div>
    </div>

    <style>
        .db-save-status {
            margin: 15px 0;
            padding: 12px;
            border-radius: 6px;
            font-weight: 500;
        }

        .db-save-status.success {
            background: #e8f5e9;
            color: #388e3c;
            border-left: 4px solid #4caf50;
        }

        .db-save-status.error {
            background: #ffebee;
            color: #d32f2f;
            border-left: 4px solid #f44336;
        }

        .btn-success:hover {
            background: linear-gradient(90deg, #2e7d32 0%, #81c784 100%) !important;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin: 0 4px;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background-color: #007bff;
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            background-color: #0056b3;
        }

        .btn-primary:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }

        .btn-secondary {
            background-color: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background-color: #545b62;
        }

        /* 添加取消按钮样式，与设置比率按钮保持一致 */
        .btn-secondary.cancel-btn {
            background: linear-gradient(135deg, #4caf50, #66bb6a);
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            padding: 12px;
            margin-top: 8px;
            box-sizing: border-box;
            width: 100%;
        }

        .btn-secondary.cancel-btn:hover {
            background: linear-gradient(135deg, #388e3c, #81c784);
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(76, 175, 80, 0.3);
        }
        
        /* 更新状态显示样式 */
        .update-status-display {
            margin-top: 20px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
        }

        .update-progress {
            margin-bottom: 20px;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e0e0e0;
            border-radius: 4px;
            overflow: hidden;
            position: relative;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #1976d2, #42a5f5);
            border-radius: 4px;
            transition: width 0.3s ease;
            width: 0%;
        }

        .progress-text {
            text-align: center;
            margin-top: 8px;
            font-weight: 600;
            color: #1976d2;
        }

        .update-steps {
            display: flex;
            justify-content: space-between;
            gap: 10px;
        }

        .update-step {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
        }

        .step-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #e0e0e0;
            color: #666;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-bottom: 8px;
            transition: all 0.3s ease;
        }

        .step-text {
            font-size: 0.9em;
            color: #666;
            transition: color 0.3s ease;
        }

        .update-step.active .step-icon {
            background: #1976d2;
            color: white;
            animation: pulse 1.5s infinite;
        }

        .update-step.active .step-text {
            color: #1976d2;
            font-weight: 600;
        }

        .update-step.completed .step-icon {
            background: #4caf50;
            color: white;
        }

        .update-step.completed .step-text {
            color: #4caf50;
            font-weight: 600;
        }

        .update-step.error .step-icon {
            background: #f44336;
            color: white;
        }

        .update-step.error .step-text {
            color: #f44336;
            font-weight: 600;
        }

        @keyframes pulse {
            0% {
                transform: scale(1);
                box-shadow: 0 0 0 0 rgba(25, 118, 210, 0.7);
            }
            70% {
                transform: scale(1.05);
                box-shadow: 0 0 0 10px rgba(25, 118, 210, 0);
            }
            100% {
                transform: scale(1);
                box-shadow: 0 0 0 0 rgba(25, 118, 210, 0);
            }
        }

        /* 夜间模式适配 */
        [data-theme="dark"] .update-status-display {
            background: #2a2a2a;
            border-color: #444;
        }

        [data-theme="dark"] .progress-bar {
            background: #444;
        }

        [data-theme="dark"] .progress-text {
            color: #64b5f6;
        }

        [data-theme="dark"] .step-icon {
            background: #444;
            color: #b0b0b0;
        }

        [data-theme="dark"] .step-text {
            color: #b0b0b0;
        }

        [data-theme="dark"] .update-step.active .step-text {
            color: #64b5f6;
        }

        [data-theme="dark"] .update-step.completed .step-text {
            color: #4caf50;
        }

        [data-theme="dark"] .update-step.error .step-text {
            color: #f44336;
        }

        .switch-form {
            margin-top: 20px;
            padding-top: 16px;
            border-top: 1px solid #eee;
        }

        .settings-item {
            color: #4caf50;
            font-weight: 500;
        }

        .settings-item:hover {
            background: #e8f5e9;
            color: #388e3c;
        }

        /* 统一所有图标样式，覆盖之前的定义 */
        .settings-icon,
        .update-icon,
        .logout-icon {
            font-size: 14px !important; /* 使用!important确保优先级 */
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 16px;
            height: 16px;
            flex-shrink: 0;
            line-height: 1;
            vertical-align: baseline;
        }

        .update-data-item {
            color: #1976d2;
            font-weight: 500;
        }

        .update-data-item:hover {
            background: #e3f2fd;
            color: #1565c0;
        }



        /* ISK/LP 信息卡片样式 */
        .isk-lp-info {
            display: flex;
            gap: 20px;
            margin: 30px 0;
            flex-wrap: wrap;
        }

        .info-card-link {
            text-decoration: none;
            color: inherit;
            display: block;
            flex: 1;
        }

        .info-card {
            background: linear-gradient(135deg, #ffffff, #f8f9fa);
            border: 2px solid #e3f2fd;
            border-radius: 12px;
            padding: 20px;
            min-width: 200px;
            flex: 1;
            text-align: center;
            box-shadow: 0 4px 12px rgba(25, 118, 210, 0.1);
            transition: all 0.3s ease;
        }

        .info-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(25, 118, 210, 0.15);
            border-color: #1976d2;
        }

        .info-card.clickable {
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .info-card.clickable:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 25px rgba(25, 118, 210, 0.2);
            border-color: #1976d2;
            background: linear-gradient(135deg, #f8f9fa, #e3f2fd);
        }

        .info-card.clickable:active {
            transform: translateY(-2px);
        }

        .info-label {
            font-size: 0.9em;
            color: #666;
            margin-bottom: 8px;
            font-weight: 500;
        }

        .info-value {
            font-size: 1.8em;
            font-weight: bold;
            color: #1976d2;
            text-shadow: 0 1px 2px rgba(25, 118, 210, 0.1);
        }
        
        .info-bounty {
            font-size: 1em;
            color: #388e3c;
            margin-top: 5px;
            font-weight: 500;
        }
        
        /* 任务状态信息样式 */
        .mission-status-info {
            margin: 30px 0;
        }
        
        .mission-status-info h3 {
            color: #1976d2;
            margin-bottom: 15px;
            font-size: 1.3em;
        }
        
        .info-bounty {
            font-size: 1em;
            color: #388e3c;
            margin-top: 5px;
            font-weight: 500;
        }

        /* 响应式设计 */
        @media (max-width: 768px) {
            .isk-lp-info {
                flex-direction: column;
            }

            .info-card {
                min-width: auto;
            }
        }

        .tables-container {
            display: flex;
            gap: 20px;
            margin-top: 30px;
            width: 100%;
        }

        .table-section {
            flex: 1;
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .table-section h4 {
            margin: 0 0 15px 0;
            color: #333;
            font-size: 1.2em;
            text-align: center;
        }

        .table-wrapper {
            overflow-x: auto;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 8px;
            overflow: hidden;
        }

        .data-table th {
            background: linear-gradient(135deg, #1976d2, #42a5f5);
            color: white;
            padding: 12px 15px;
            text-align: left;
            font-weight: 600;
            font-size: 0.9em;
        }

        .data-table td {
            padding: 10px 15px;
            border-bottom: 1px solid #e0e0e0;
            color: #333;
        }

        .data-table tbody tr:hover {
            background-color: #f5f5f5;
        }

        .data-table tbody tr:last-child td {
            border-bottom: none;
        }

        .data-table .amount {
            color: #388e3c;
            font-weight: 500;
        }

        .data-table .count {
            color: #1976d2;
            font-weight: 500;
        }

        /* 操作按钮样式 */
        .action-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
        }
        
        .view-btn {
            background: linear-gradient(135deg, #2196f3, #64b5f6);
            color: white;
        }
        
        .view-btn:hover {
            background: linear-gradient(135deg, #1976d2, #42a5f5);
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(33, 150, 243, 0.3);
        }
        
        .action-btn .icon-view {
            font-size: 14px;
        }
        
        /* 支付者匹配弹窗样式 */
        .payer-match-modal {
            max-width: 900px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e0e0e0;
        }
        
        .modal-header h3 {
            margin: 0;
            color: #1976d2;
            font-size: 1.4em;
        }
        
        .match-info {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #2196f3;
        }
        
        .match-info h4 {
            margin: 0 0 10px 0;
            color: #1976d2;
        }
        
        .match-info p {
            margin: 0;
            color: #666;
        }
        
        .match-records-list {
            margin-top: 15px;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .match-record-item {
            background: #f8f9fa;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            margin-bottom: 15px;
            padding: 15px;
            transition: all 0.3s ease;
        }
        
        .match-record-item:hover {
            background: #e3f2fd;
            border-color: #2196f3;
        }
        
        .record-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding-bottom: 8px;
            border-bottom: 1px solid #ddd;
        }
        
        .record-number {
            background: #2196f3;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8em;
            font-weight: bold;
        }
        
        .record-donor {
            font-weight: 600;
            color: #1976d2;
            flex: 1;
            margin-left: 15px;
        }
        
        .record-amount {
            color: #388e3c;
            font-weight: 600;
            font-size: 1.1em;
        }
        
        .record-details {
            display: grid;
            gap: 8px;
        }
        
        .detail-item {
            color: #666;
            font-size: 0.9em;
        }
        
        .detail-item strong {
            color: #333;
            margin-right: 8px;
        }
        
        .no-match {
            text-align: center;
            color: #666;
            font-style: italic;
            padding: 40px 20px;
        }
        
        .modal-footer {
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid #e0e0e0;
            text-align: right;
        }
        
        /* 优化的匹配失败弹窗样式 */
        .no-match-modal {
            max-width: 600px;
            width: 90%;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15);
            border: none;
            overflow: hidden;
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
        }
        
        .modal-header-enhanced {
            display: flex;
            align-items: center;
            padding: 24px 32px 20px;
            background: linear-gradient(135deg, #ff6b6b 0%, #ff8e8e 100%);
            color: white;
            border-bottom: none;
            position: relative;
        }
        
        .header-icon {
            font-size: 32px;
            margin-right: 16px;
            animation: pulse 2s infinite;
        }
        
        .header-content {
            flex: 1;
        }
        
        .header-content h3 {
            margin: 0 0 4px 0;
            font-size: 1.5em;
            font-weight: 600;
            color: white;
        }
        
        .header-subtitle {
            margin: 0;
            font-size: 0.9em;
            opacity: 0.9;
            color: white;
        }
        
        .close-btn {
            position: absolute;
            top: 16px;
            right: 20px;
            font-size: 28px;
            color: white;
            cursor: pointer;
            opacity: 0.8;
            transition: opacity 0.2s;
            line-height: 1;
        }
        
        .close-btn:hover {
            opacity: 1;
        }
        
        .modal-body-enhanced {
            padding: 32px;
        }
        
        .payer-info-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 24px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            border: 1px solid #e9ecef;
        }
        
        .info-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #f1f3f4;
        }
        
        .info-row:last-child {
            border-bottom: none;
        }
        
        .info-label {
            font-weight: 500;
            color: #495057;
            font-size: 0.95em;
        }
        
        .info-value {
            font-weight: 600;
            color: #212529;
            font-size: 1em;
        }
        
        .info-value.amount {
            color: #28a745;
            font-family: 'Courier New', monospace;
        }
        
        .reasons-section, .suggestions-section {
            margin-bottom: 24px;
        }
        
        .reasons-section h4, .suggestions-section h4 {
            display: flex;
            align-items: center;
            margin: 0 0 16px 0;
            font-size: 1.1em;
            color: #495057;
            font-weight: 600;
        }
        
        .reasons-section h4 i, .suggestions-section h4 i {
            margin-right: 8px;
            font-size: 1.2em;
        }
        
        .reasons-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .reason-item {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #ffc107;
            transition: transform 0.2s;
        }
        
        .reason-item:hover {
            transform: translateX(4px);
        }
        
        .reason-icon {
            margin-right: 12px;
            font-size: 1.1em;
        }
        
        .suggestion-text {
            color: #6c757d;
            line-height: 1.5;
            margin: 0;
            font-size: 0.95em;
        }
        
        .modal-footer-enhanced {
            padding: 20px 32px 32px;
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }
        
        .btn-enhanced {
            display: flex;
            align-items: center;
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            font-weight: 500;
            font-size: 0.95em;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            min-width: 140px;
            justify-content: center;
        }
        
        .btn-icon {
            margin-right: 8px;
            font-size: 1em;
        }
        
        .btn-primary-enhanced {
            background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(0, 123, 255, 0.3);
        }
        
        .btn-primary-enhanced:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(0, 123, 255, 0.4);
        }
        
        .btn-success-enhanced {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
        }
        
        .btn-success-enhanced:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(40, 167, 69, 0.4);
        }
        
        .btn-secondary-enhanced {
            background: linear-gradient(135deg, #6c757d 0%, #5a6268 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(108, 117, 125, 0.3);
        }
        
        .btn-secondary-enhanced:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(108, 117, 125, 0.4);
        }
        
        .btn-enhanced:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
            box-shadow: none !important;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        
        /* 响应式设计 */
        @media (max-width: 768px) {
            .tables-container {
                flex-direction: column;
            }
            
            .data-table {
                font-size: 0.8em;
            }
            
            .data-table th,
            .data-table td {
                padding: 8px 10px;
            }
            
            .action-btn {
                padding: 6px 12px;
                font-size: 0.8em;
            }
            
            .payer-match-modal {
                width: 95%;
                max-height: 90vh;
            }
            
            .record-details {
                grid-template-columns: 1fr;
            }
            
            .record-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
            }
            
            .record-donor {
                margin-left: 0;
            }
            
            .no-match-modal {
                width: 95%;
                margin: 20px auto;
            }
            
            .modal-header-enhanced {
                padding: 20px 24px 16px;
            }
            
            .modal-body-enhanced {
                padding: 24px 20px;
            }
            
            .modal-footer-enhanced {
                padding: 16px 20px 24px;
                flex-direction: column;
            }
            
            .btn-enhanced {
                width: 100%;
                margin-bottom: 8px;
            }
        }

        /* 血袭数据区域样式 */
        .blood-data-section {
            margin-top: 40px;
            padding: 30px;
            background: #f8f9fa;
            border-radius: 12px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
        }

        .blood-data-section h2 {
            color: #1976d2;
            margin-bottom: 25px;
            font-size: 1.5em;
            display: inline-block;
            margin-right: 20px;
        }

        .data-controls {
            margin-bottom: 25px;
            display: inline-block;
            vertical-align: top;
        }

        .section-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 25px;
        }

        .credentials-input {
            display: grid;
            grid-template-columns: auto 1fr auto 1fr auto;
            gap: 15px;
            align-items: center;
            max-width: 700px;
        }

        .credentials-input label {
            font-weight: 600;
            color: #333;
        }

        .credentials-input input {
            padding: 10px 12px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 1em;
            transition: border-color 0.3s;
        }

        .credentials-input input:focus {
            border-color: #1976d2;
            outline: none;
        }

        .fetch-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            background: linear-gradient(135deg, #1976d2, #42a5f5);
            color: white;
        }

        .fetch-btn:hover {
            background: linear-gradient(135deg, #1565c0, #64b5f6);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(25, 118, 210, 0.3);
        }

        .summary-btn {
            background: linear-gradient(135deg, #388e3c, #66bb6a);
        }

        .summary-btn:hover {
            background: linear-gradient(135deg, #2e7d32, #81c784);
        }

        .loading-indicator {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 20px;
            background: #e3f2fd;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .spinner {
            width: 24px;
            height: 24px;
            border: 3px solid #e0e0e0;
            border-top: 3px solid #1976d2;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .data-display {
            background: white;
            border-radius: 8px;
            padding: 20px;
            min-height: 200px;
            border: 1px solid #e0e0e0;
        }

        .data-placeholder {
            text-align: center;
            color: #666;
            font-style: italic;
            padding: 40px 20px;
        }

        .data-content {
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            line-height: 1.6;
            white-space: pre-wrap;
            word-wrap: break-word;
            max-height: 600px;
            overflow-y: auto;
        }

        .error-message {
            color: #d32f2f;
            background: #ffebee;
            padding: 15px;
            border-radius: 6px;
            border-left: 4px solid #d32f2f;
        }

        /* 用户操作区域样式 */
        .user-area {
            position: absolute;
            top: 70px;
            right: 40px;
            z-index: 100;
        }

        /* 未登录状态样式 */
        .guest-area {
            display: flex;
            gap: 12px;
        }

        .auth-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 20px;
            font-size: 0.95em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .login-btn {
            background: linear-gradient(135deg, #1976d2, #42a5f5);
            color: white;
        }

        .login-btn:hover {
            background: linear-gradient(135deg, #1565c0, #64b5f6);
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(25, 118, 210, 0.3);
        }

        .register-btn {
            background: white;
            color: #1976d2;
            border: 2px solid #1976d2;
        }

        .register-btn:hover {
            background: #1976d2;
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(25, 118, 210, 0.3);
        }

        /* 已登录状态样式 */
        .user-profile {
            position: relative;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        /* 设置按钮样式 */
        .settings-btn {
            background: linear-gradient(135deg, #4caf50, #66bb6a);
            color: white;
        }

        .settings-btn:hover {
            background: linear-gradient(135deg, #388e3c, #81c784);
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(76, 175, 80, 0.3);
        }

        .user-avatar {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: linear-gradient(135deg, #1976d2, #42a5f5);
            color: white;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 12px rgba(25, 118, 210, 0.2);
        }

        .user-avatar:hover {
            background: linear-gradient(135deg, #1565c0, #64b5f6);
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(25, 118, 210, 0.3);
        }

        .user-avatar img {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            padding: 4px;
        }

        .username {
            font-weight: 600;
            font-size: 0.95em;
            max-width: 120px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .dropdown-arrow {
            font-size: 0.8em;
            transition: transform 0.3s ease;
        }

        .user-profile.active .dropdown-arrow {
            transform: rotate(180deg);
        }

        /* 下拉菜单样式 */
        .user-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            margin-top: 8px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
            min-width: 220px;
            max-width: 220px; /* 添加最大宽度限制 */
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: all 0.3s ease;
            z-index: 1000;
        }

        .user-profile.active .user-dropdown {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .dropdown-item {
            padding: 12px 16px;
            border: none;
            background: none;
            width: 100%;
            text-align: left;
            cursor: pointer;
            transition: background 0.2s ease;
            display: flex;
            align-items: center;
            gap: 10px;
            line-height: 1.4;
            font-size: 14px;
            box-sizing: border-box; /* 确保padding计算正确 */
        }

        .dropdown-item:hover {
            background: #f5f5f5;
        }

        .dropdown-item:first-child {
            border-radius: 12px 12px 0 0;
        }

        .dropdown-item:last-child {
            border-radius: 0 0 12px 12px;
        }

        .user-info {
            cursor: default;
            background: #f8f9fa;
            padding: 12px 16px; /* 确保与其他项一致的内边距 */
        }

        .user-info:hover {
            background: #f8f9fa;
        }

        .user-details {
            flex: 1;
            min-width: 0; /* 防止flex项目溢出 */
        }

        .user-name {
            font-weight: 600;
            color: #333;
            font-size: 1em;
        }

        .user-level {
            font-size: 0.85em;
            color: #666;
            margin-top: 2px;
        }

        .dropdown-divider {
            height: 1px;
            background: #e0e0e0;
            margin: 0;
        }

        .logout-btn {
            color: #d32f2f;
            font-weight: 500;
        }

        .logout-btn:hover {
            background: #ffebee;
            color: #c62828;
        }

        /* 删除重复的logout-icon定义，已在上面统一定义 */

        /* 原有样式保持不变 */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.15);
            justify-content: center;
            align-items: center;
        }

        .modal.show {
            display: flex;
            animation: simpleModalFadeIn 0.15s ease-out forwards;
        }

        @keyframes simpleModalFadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        .modal-content {
            background: #fff;
            margin: auto;
            padding: 36px 32px 28px 32px;
            border-radius: 18px;
            width: 340px;
            box-shadow: 0 8px 24px rgba(25, 118, 210, 0.12);
            position: relative;
            text-align: center;
            /* 移除内容的单独动画，避免重复动画 */
            /* animation: modalFadeIn 0.3s; */
        }

        .close {
            position: absolute;
            right: 18px;
            top: 12px;
            font-size: 28px;
            color: #aaa;
            cursor: pointer;
            transition: color 0.2s;
        }

        .close:hover {
            color: #1976d2;
        }

        .modal-content h2 {
            margin-bottom: 24px;
            color: #1976d2;
            font-weight: bold;
            font-size: 1.5em;
        }

        .modal-content label {
            display: block;
            text-align: left;
            margin-bottom: 6px;
            color: #333;
            font-size: 1em;
        }

        .modal-content input {
            width: 100%;
            margin-bottom: 18px;
            padding: 10px 12px;
            border: 1.5px solid #bdbdbd;
            border-radius: 6px;
            font-size: 1.1em;
            transition: border 0.2s;
            box-sizing: border-box;
        }

        .modal-content input:focus {
            border: 1.5px solid #1976d2;
            outline: none;
        }

        .modal-content button[type="submit"] {
            width: 100%;
            padding: 12px;
            background: linear-gradient(90deg, #1976d2 0%, #42a5f5 100%);
            color: #fff;
            border: none;
            border-radius: 6px;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            transition: background 0.3s;
            margin-top: 8px;
            box-sizing: border-box;
        }

        .modal-content button[type="submit"]:hover {
            background: linear-gradient(90deg, #1565c0 0%, #64b5f6 100%);
        }

        .btn-success {
            background: linear-gradient(90deg, #388e3c 0%, #66bb6a 100%) !important;
        }

        .btn-success:hover {
            background: linear-gradient(90deg, #2e7d32 0%, #81c784 100%) !important;
        }

        .switch-form {
            margin-top: 20px;
            padding-top: 16px;
            border-top: 1px solid #eee;
        }

        .switch-form p {
            margin: 0;
            color: #666;
            font-size: 0.9em;
        }

        .switch-form a {
            color: #1976d2;
            text-decoration: none;
            font-weight: bold;
            transition: color 0.2s;
        }

        .switch-form a:hover {
            color: #1565c0;
            text-decoration: underline;
        }

        /* 自定义消息弹窗样式 */
        .message-modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.2);
            justify-content: center;
            align-items: center;
        }

        .message-modal.show {
            display: flex;
            animation: simpleModalFadeIn 0.15s ease-out forwards;
        }

        .message-content {
            background: #fff;
            padding: 32px 28px 24px 28px;
            border-radius: 16px;
            width: 320px;
            max-width: 90vw;
            box-shadow: 0 12px 30px rgba(0, 0, 0, 0.1);
            text-align: center;
            /* 移除内容的单独动画，避免重复动画 */
            /* animation: messageModalFadeIn 0.25s; */
        }

        .message-icon {
            width: 48px;
            height: 48px;
            margin: 0 auto 16px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            font-weight: bold;
        }

        .message-icon.success {
            background: linear-gradient(135deg, #4caf50, #66bb6a);
            color: #fff;
        }

        .message-icon.success::before {
            content: '✓';
        }

        .message-icon.error {
            background: linear-gradient(135deg, #f44336, #ef5350);
            color: #fff;
        }

        .message-icon.error::before {
            content: '✕';
        }

        .message-icon.info {
            background: linear-gradient(135deg, #2196f3, #42a5f5);
            color: #fff;
        }

        .message-icon.info::before {
            content: 'i';
        }

        .message-icon.warning {
            background: linear-gradient(135deg, #ff9800, #ffb74d);
            color: #fff;
        }

        .message-icon.warning::before {
            content: '⚠';
        }

        .message-text {
            font-size: 1.1em;
            color: #333;
            margin-bottom: 24px;
            line-height: 1.5;
        }

        .message-btn {
            background: linear-gradient(90deg, #1976d2 0%, #42a5f5 100%);
            color: #fff;
            border: none;
            padding: 10px 32px;
            border-radius: 8px;
            font-size: 1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
            min-width: 80px;
        }

        .message-btn:hover {
            background: linear-gradient(90deg, #1565c0 0%, #64b5f6 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(25, 118, 210, 0.3);
        }

        /* 内容区域样式 */
        .content-area {
            padding: 120px 40px 40px;
            max-width: 1200px;
            margin: 0 auto;
        }

        .content-area h1 {
            color: #1976d2;
            margin-bottom: 20px;
        }

        /* EVE令牌通知样式 */
        .eve-token-notification {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        .eve-token-notification .notification-content {
            display: flex;
            align-items: flex-start;
            gap: 12px;
        }

        .eve-token-notification .notification-icon {
            font-size: 24px;
            flex-shrink: 0;
            margin-top: 2px;
        }

        .eve-token-notification .notification-text {
            flex: 1;
        }

        .eve-token-notification .notification-text strong {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-size: 16px;
        }

        .eve-token-notification .notification-text p {
            margin: 0;
            color: #666;
            font-size: 14px;
            line-height: 1.4;
        }

        .eve-token-notification .notification-actions {
            display: flex;
            gap: 8px;
            margin-top: 12px;
            flex-wrap: wrap;
        }

        .eve-token-notification .btn-primary {
            background: linear-gradient(135deg, #1976d2, #42a5f5);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .eve-token-notification .btn-primary:hover {
            background: linear-gradient(135deg, #1565c0, #64b5f6);
            transform: translateY(-1px);
        }

        .eve-token-notification .btn-secondary {
            background: #f5f5f5;
            color: #666;
            border: 1px solid #ddd;
            padding: 8px 16px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .eve-token-notification .btn-secondary:hover {
            background: #e0e0e0;
            color: #333;
        }

        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideOutRight {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }
    </style>

    <script>
        // 初始化表格（保留原有函数以兼容性）
        function initTables() {
            // 加载数据
            loadPaidMissionsData();
            loadWalletDonationsData();
        }

        // 加载已支付任务数据
        function loadPaidMissionsData() {
            // 🆕 添加token检查和重试机制
            async function fetchPaidMissionsData(retryCount = 0) {
                try {
                    // 检查token是否有效
                    if (!isCurrentTokenValid()) {
                        console.log('🔄 Token即将过期，先刷新token');
                        const tokenRefreshSuccess = await attemptTokenRefreshSilent();
                        if (!tokenRefreshSuccess) {
                            console.error('❌ Token刷新失败，无法获取已支付任务数据');
                            return;
                        }
                    }
                    
                    const response = await fetch('/api/paid_missions_summary', {
                        credentials: 'same-origin',
                        headers: {
                            'Content-Type': 'application/json',
                            'Cache-Control': 'no-cache'
                        }
                    });
                    
                    if (response.status === 401 && retryCount < 2) {
                        console.log('🔄 收到401错误，尝试刷新token并重试');
                        const tokenRefreshSuccess = await attemptTokenRefreshSilent();
                        if (tokenRefreshSuccess) {
                            return fetchPaidMissionsData(retryCount + 1);
                        }
                    }
                    
                    const result = await response.json();
                    if (result.success) {
                        const data = result.data;
                        const tbody = document.querySelector('#paidMissionsTable tbody');
                        
                        // 清空现有数据
                        tbody.innerHTML = '';
                        
                        if (data.length === 0) {
                            tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; color: #666;">暂无数据</td></tr>';
                            return;
                        }
                        
                        data.forEach(item => {
                            const row = document.createElement('tr');
                            row.innerHTML = `
                                <td>${item.payer}</td>
                                <td class="count">${item.mission_count}</td>
                                <td class="amount">${(item.total_amount || 0).toLocaleString()} ISK</td>
                                <td>
                                    <button class="action-btn view-btn" onclick="viewPayerDetails('${item.payer}')" title="查看详情">
                                        <i class="icon-view">👁</i> 详情
                                    </button>
                                </td>
                            `;
                            tbody.appendChild(row);
                        });
                    }
                } catch (error) {
                    console.error('加载已支付任务数据失败:', error);
                }
            }
            
            fetchPaidMissionsData();
        }

        // 查看支付者详情 - 在钱包捐赠中查找匹配项
        async function viewPayerDetails(payer) {
            console.log('查找支付者在钱包捐赠中的记录:', payer);
            
            try {
                // 检查token是否有效
                if (!isCurrentTokenValid()) {
                    console.log('🔄 Token即将过期，先刷新token');
                    const tokenRefreshSuccess = await attemptTokenRefreshSilent();
                    if (!tokenRefreshSuccess) {
                        showMessage('Token刷新失败，请重新登录EVE SSO', 'error');
                        return;
                    }
                }
                
                // 首先获取已支付任务数据，找到对应支付者的金额
                const response = await fetch('/api/paid_missions_summary', {
                    credentials: 'same-origin',
                    headers: {
                        'Content-Type': 'application/json',
                        'Cache-Control': 'no-cache'
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`获取已支付任务数据失败: ${response.status}`);
                }
                
                const result = await response.json();
                if (result.success) {
                    const paidMissionsData = result.data;
                    const payerData = paidMissionsData.find(item => item.payer === payer);
                    
                    if (!payerData) {
                        showMessage('未找到支付者信息', 'error');
                        return;
                    }
                    
                    const payerAmount = payerData.total_amount;
                    const missionIds = payerData.mission_ids || []; // 获取任务ID列表
                    console.log('支付者金额:', payerAmount);
                    console.log('任务IDs:', missionIds);
                    
                    // 获取钱包捐赠数据
                    const walletResponse = await fetch('/api/recent_wallet_donations', {
                        credentials: 'same-origin',
                        headers: {
                            'Content-Type': 'application/json',
                            'Cache-Control': 'no-cache'
                        }
                    });
                    
                    if (!walletResponse.ok) {
                        throw new Error(`获取钱包捐赠数据失败: ${walletResponse.status}`);
                    }
                    
                    const walletResult = await walletResponse.json();
                    if (walletResult.success) {
                        const walletData = walletResult.data;
                        
                        // 查找匹配项 - 采用模糊匹配方式
                        const matchedRecords = walletData.filter(item => {
                            // 模糊名称匹配 - 使用多种匹配策略
                            const nameMatch = fuzzyNameMatch(item.donor, payer);
                            
                            // 宽松金额匹配（允许±5%的误差范围）
                            const amountMatch = item.amount && Math.abs(item.amount - payerAmount) <= (payerAmount * 0.05);
                            
                            return nameMatch && amountMatch;
                        });
                        
                        // 显示匹配结果，传递mission_ids
                        showPayerMatchResults(payer, matchedRecords, payerAmount, missionIds);
                    } else {
                        showMessage('获取钱包捐赠数据失败', 'error');
                    }
                } else {
                    showMessage('获取已支付任务数据失败', 'error');
                }
            } catch (error) {
                console.error('查找支付者详情失败:', error);
                showMessage('查找支付者详情失败: ' + error.message, 'error');
            }
        }
        
        // 显示支付者匹配结果弹窗（更新函数签名以包含金额和任务IDs）
        function showPayerMatchResults(payer, matchedRecords, payerAmount, missionIds) {
            // 如果没有匹配记录，显示带有重新更新选项的弹窗
            if (matchedRecords.length === 0) {
                const noMatchModalHtml = `
                    <div id="payerNoMatchModal" class="modal show">
                        <div class="modal-content no-match-modal">
                            <div class="modal-header-enhanced">
                                <div class="header-icon">
                                    <i class="icon-warning">⚠️</i>
                                </div>
                                <div class="header-content">
                                    <h3>支付者匹配失败</h3>
                                    <p class="header-subtitle">未在钱包记录中找到匹配项</p>
                                </div>
                                <span class="close-btn" onclick="closePayerNoMatchModal()">&times;</span>
                            </div>
                            
                            <div class="modal-body-enhanced">
                                <div class="payer-info-card">
                                    <div class="info-row">
                                        <span class="info-label">支付者</span>
                                        <span class="info-value">${payer}</span>
                                    </div>
                                    <div class="info-row">
                                        <span class="info-label">任务金额</span>
                                        <span class="info-value amount">${payerAmount.toLocaleString()} ISK</span>
                                    </div>
                                    <div class="info-row">
                                        <span class="info-label">任务数量</span>
                                        <span class="info-value">${missionIds ? missionIds.length : 0} 个</span>
                                    </div>
                                </div>
                                

                            </div>
                            
                            <div class="modal-footer-enhanced">
                                <button class="btn-enhanced btn-primary-enhanced" onclick="refreshWalletDataAndRetry('${payer}', ${payerAmount}, ${JSON.stringify(missionIds).replace(/"/g, '&quot;')})">
                                    <i class="btn-icon">🔄</i>
                                    <span>重新更新钱包记录</span>
                                </button>
                                <button class="btn-enhanced btn-success-enhanced" onclick="markMissionsAsDone('${payer}', ${JSON.stringify(missionIds).replace(/"/g, '&quot;')})" ${!missionIds || missionIds.length === 0 ? 'disabled' : ''}>
                                    <i class="btn-icon">✅</i>
                                    <span>强制标记完成</span>
                                </button>
                                <button class="btn-enhanced btn-secondary-enhanced" onclick="closePayerNoMatchModal()">
                                    <i class="btn-icon">✖️</i>
                                    <span>关闭</span>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                
                // 添加到页面
                document.body.insertAdjacentHTML('beforeend', noMatchModalHtml);
                return;
            }
            
            // 只有匹配成功时才创建弹窗
            const modalHtml = `
                <div id="payerMatchModal" class="modal show">
                    <div class="modal-content payer-match-modal">
                        <div class="modal-header">
                            <h3>支付者匹配结果</h3>
                            <span class="close" onclick="closePayerMatchModal()">&times;</span>
                        </div>
                        <div class="modal-body">
                            <div class="match-info">
                                <h4>支付者: ${payer}</h4>
                                <p>任务金额: <strong>${payerAmount.toLocaleString()} ISK</strong></p>
                                <p>在钱包捐赠记录中找到 <strong>${matchedRecords.length}</strong> 条匹配记录（名称+金额匹配）</p>
                                <p>任务数量: <strong>${missionIds ? missionIds.length : 0}</strong> 个</p>
                            </div>
                            <div class="match-results">
                                ${generateMatchResultsList(matchedRecords)}
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-primary" onclick="markMissionsAsDone('${payer}', ${JSON.stringify(missionIds).replace(/"/g, '&quot;')})" ${!missionIds || missionIds.length === 0 ? 'disabled' : ''}>标记任务完成</button>
                            <button class="btn btn-secondary" onclick="closePayerMatchModal()">关闭</button>
                        </div>
                    </div>
                </div>
            `;
            
            // 添加到页面
            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }
        
        // 生成匹配结果列表（替换原来的表格函数）
        function generateMatchResultsList(records) {
            let listHtml = '<div class="match-records-list">';
            
            records.forEach((record, index) => {
                listHtml += `
                    <div class="match-record-item">
                        <div class="record-header">
                            <span class="record-number">#${index + 1}</span>
                            <span class="record-donor">${record.donor || '未知'}</span>
                            <span class="record-amount">${(record.amount || 0).toLocaleString()} ISK</span>
                        </div>
                        <div class="record-details">
                            <div class="detail-item">
                                <strong>类型:</strong> ${record.type || '未知'}
                            </div>
                            <div class="detail-item">
                                <strong>日期:</strong> ${record.date ? record.date.split('T')[0] : '未知'}
                            </div>
                            <div class="detail-item">
                                <strong>描述:</strong> ${record.description || '无描述'}
                            </div>
                        </div>
                    </div>
                `;
            });
            
            listHtml += '</div>';
            return listHtml;
        }
        
        // 关闭支付者匹配弹窗
        function closePayerMatchModal() {
            const modal = document.getElementById('payerMatchModal');
            if (modal) {
                modal.remove();
            }
        }
        
        // 关闭支付者无匹配弹窗
        function closePayerNoMatchModal() {
            const modal = document.getElementById('payerNoMatchModal');
            if (modal) {
                modal.remove();
            }
        }
        
        // 重新更新钱包数据并重试匹配
        async function refreshWalletDataAndRetry(payer, payerAmount, missionIds) {
            const refreshBtn = document.querySelector('#payerNoMatchModal .btn-primary-enhanced');
            
            if (refreshBtn) {
                const originalText = refreshBtn.innerHTML;
                refreshBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 更新中...';
                refreshBtn.disabled = true;
                
                try {
                    console.log('🔄 开始直接更新EVE钱包数据');
                    
                    // 检查EVE token状态
                    if (!isCurrentTokenValid()) {
                        console.log('🔄 Token即将过期，先刷新token');
                        const tokenRefreshSuccess = await attemptTokenRefreshSilent();
                        if (!tokenRefreshSuccess) {
                            showMessage('Token刷新失败，请重新登录EVE SSO', 'error');
                            return;
                        }
                    }
                    
                    // 🆕 直接调用增量更新API获取最新EVE数据
                    const updateResponse = await fetch('/api/wallet_incremental_update', {
                        method: 'POST',
                        credentials: 'same-origin',
                        headers: {
                            'Content-Type': 'application/json',
                            'Cache-Control': 'no-cache'
                        },
                        body: JSON.stringify({
                            force_refresh: true,  // 强制刷新获取最新数据
                            last_update: null
                        })
                    });
                    
                    if (updateResponse.ok) {
                        const updateResult = await updateResponse.json();
                        if (updateResult.success) {
                            console.log(`✅ 增量更新成功，获取到 ${updateResult.new_entries || 0} 条新记录`);
                            
                            // 等待数据库写入完成
                            await new Promise(resolve => setTimeout(resolve, 2000));
                            
                            // 强制刷新钱包数据显示
                            await loadWalletDonationsData();
                            
                            // 再次等待界面渲染
                            await new Promise(resolve => setTimeout(resolve, 1000));
                            
                            // 验证是否有数据更新
                            const verifyResponse = await fetch('/api/recent_wallet_donations?' + Date.now(), {
                                method: 'GET',
                                credentials: 'same-origin',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'Cache-Control': 'no-cache, no-store, must-revalidate'
                                }
                            });
                            
                            if (verifyResponse.ok) {
                                const verifyResult = await verifyResponse.json();
                                if (verifyResult.success && verifyResult.data && verifyResult.data.length > 0) {
                                    const latestEntry = verifyResult.data[0];
                                    const entryTime = new Date(latestEntry.date || latestEntry.timestamp);
                                    const now = new Date();
                                    const timeDiff = (now - entryTime) / 1000 / 60;
                                    
                                    console.log(`📊 验证结果: 最新记录时间=${entryTime.toLocaleString()}, 时间差=${timeDiff.toFixed(1)}分钟`);
                                }
                            }
                            
                            // 关闭当前弹窗
                            closePayerNoMatchModal();
                            
                            // 重新尝试匹配支付者
                            setTimeout(() => {
                                viewPayerDetails(payer, payerAmount, missionIds);
                            }, 500);
                            
                            showMessage('钱包数据更新完成，正在重新匹配...', 'success');
                            
                        } else {
                            showMessage(`增量更新失败: ${updateResult.message}`, 'error');
                        }
                    } else {
                        const errorResult = await updateResponse.json();
                        showMessage(`增量更新失败: ${errorResult.message}`, 'error');
                    }
                    
                } catch (error) {
                    console.error('❌ 更新钱包数据时出错:', error);
                    showMessage('更新钱包数据失败: ' + error.message, 'error');
                } finally {
                    if (refreshBtn) {
                        refreshBtn.innerHTML = originalText;
                        refreshBtn.disabled = false;
                    }
                }
            }
        }

        // 加载钱包捐赠数据
        function loadWalletDonationsData() {
            // 🆕 添加token检查和重试机制
            async function fetchWalletData(retryCount = 0) {
                try {
                    // 检查token是否有效
                    if (!isCurrentTokenValid()) {
                        console.log('🔄 Token即将过期，先刷新token');
                        const tokenRefreshSuccess = await attemptTokenRefreshSilent();
                        if (!tokenRefreshSuccess) {
                            console.error('❌ Token刷新失败，无法获取钱包数据');
                            return;
                        }
                    }
                    
                    const response = await fetch('/api/recent_wallet_donations', {
                        credentials: 'same-origin',
                        headers: {
                            'Content-Type': 'application/json',
                            'Cache-Control': 'no-cache'
                        }
                    });
                    
                    if (response.status === 401 && retryCount < 2) {
                        console.log('🔄 收到401错误，尝试刷新token并重试');
                        const tokenRefreshSuccess = await attemptTokenRefreshSilent();
                        if (tokenRefreshSuccess) {
                            return fetchWalletData(retryCount + 1);
                        }
                    }
                    
                    const result = await response.json();
                    if (result.success) {
                        const data = result.data;
                        const tbody = document.querySelector('#walletDonationsTable tbody');
                        
                        // 清空现有数据
                        tbody.innerHTML = '';
                        
                        if (data.length === 0) {
                            tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; color: #666;">暂无数据</td></tr>';
                            return;
                        }
                        
                        data.forEach(item => {
                            const row = document.createElement('tr');
                            row.innerHTML = `
                                <td>${item.donor}</td>
                                <td>${item.type}</td>
                                <td class="amount">${(item.amount || 0).toLocaleString()} ISK</td>
                                <td>${item.date ? item.date.split('T')[0] : ''}</td>
                            `;
                            tbody.appendChild(row);
                        });
                    }
                } catch (error) {
                    console.error('加载钱包捐赠数据失败:', error);
                }
            }
            
            fetchWalletData();
        }

        // DOM 元素
        const userArea = document.getElementById('userArea');
        const guestArea = document.getElementById('guestArea');
        const userProfile = document.getElementById('userProfile');
        const userAvatar = document.getElementById('userAvatar');
        const userDropdown = document.getElementById('userDropdown');
        const displayUsername = document.getElementById('displayUsername');
        const dropdownUsername = document.getElementById('dropdownUsername');
        const userLevel = document.getElementById('userLevel');

        const loginBtn = document.getElementById('loginBtn');
        const registerBtn = document.getElementById('registerBtn');
        const logoutBtn = document.getElementById('logoutBtn');
        
        // 设置比率相关元素
        const settingsBtnLoggedIn = document.getElementById('settingsBtnLoggedIn');
        const settingsModal = document.getElementById('settingsModal');
        const closeSettingsModal = document.getElementById('closeSettingsModal');
        const settingsForm = document.getElementById('settingsForm');
        const cancelSettings = document.getElementById('cancelSettings');
        const cooperativeRateInput = document.getElementById('cooperativeRate');
        const currentRateSpan = document.getElementById('currentRateSpan');

        const loginModal = document.getElementById('loginModal');
        const registerModal = document.getElementById('registerModal');
        const closeModal = document.getElementById('closeModal');
        const closeRegisterModal = document.getElementById('closeRegisterModal');
        const loginForm = document.getElementById('loginForm');
        const registerForm = document.getElementById('registerForm');
        const showRegister = document.getElementById('showRegister');
        const showLogin = document.getElementById('showLogin');

        // 自定义消息弹窗元素
        const messageModal = document.getElementById('messageModal');
        const messageIcon = document.getElementById('messageIcon');
        const messageText = document.getElementById('messageText');
        const messageBtn = document.getElementById('messageBtn');
        
        // 更新数据元素
        const updateDataBtn = document.getElementById('updateDataBtn');
        const updateDataModal = document.getElementById('updateDataModal');
        const closeUpdateDataModal = document.getElementById('closeUpdateDataModal');
        const cancelUpdateData = document.getElementById('cancelUpdateData');
        const updateLoadingIndicator = document.getElementById('updateLoadingIndicator');

        // 当前用户信息
        let currentUser = null;
        // 添加血袭合作社凭据存储
        let bloodCredentials = {
            username: '',
            password: ''
        };
        
        // 将bloodCredentials暴露到全局作用域
        window.bloodCredentials = bloodCredentials;
        // 添加定时更新的计时器变量
        let autoUpdateTimer = null;

        // 保存凭据函数（含备份）
        function saveCredentials(username, password) {
            const credentials = { username, password, timestamp: Date.now() };
            
            try {
                // 主存储
                localStorage.setItem('bloodCredentials', JSON.stringify(credentials));
                // 备份存储
                localStorage.setItem('bloodCredentials_backup', JSON.stringify(credentials));
                console.log('✅ 凭据保存成功（含备份）');
            } catch (e) {
                console.error('❌ 凭据保存失败:', e);
            }
        }

        // 恢复凭据函数（尝试备份）
        function restoreCredentials() {
            let savedCredentials = localStorage.getItem('bloodCredentials');
            
            if (!savedCredentials) {
                console.log('🔄 主凭据不存在，尝试从备份恢复');
                savedCredentials = localStorage.getItem('bloodCredentials_backup');
                
                if (savedCredentials) {
                    // 从备份恢复到主存储
                    localStorage.setItem('bloodCredentials', savedCredentials);
                    console.log('✅ 从备份成功恢复凭据');
                }
            }
            
            return savedCredentials;
        }

        // 角落通知弹窗元素
        const cornerNotification = document.getElementById('cornerNotification');
        const cornerNotificationIcon = document.getElementById('cornerNotificationIcon');
        const cornerNotificationText = document.getElementById('cornerNotificationText');
        
        // 自定义消息弹窗函数 - 改为角落弹窗
        function showMessage(text, type = 'info') {
            // 设置文本和图标
            cornerNotificationText.textContent = text;
            cornerNotificationIcon.className = `corner-notification-icon ${type}`;
            cornerNotification.className = `corner-notification ${type}`;
            
            // 显示弹窗
            cornerNotification.classList.add('show');
            
            // 4秒后开始淡出动画
            setTimeout(() => {
                cornerNotification.classList.add('fade-out');
                cornerNotification.classList.remove('show');
                
                // 动画完成后重置状态
                setTimeout(() => {
                    cornerNotification.classList.remove('fade-out', type);
                }, 400);
            }, 4000);
        }

        // 关闭消息弹窗
        messageBtn.onclick = () => messageModal.classList.remove('show');

        // 点击消息弹窗外部关闭
        messageModal.onclick = (event) => {
            if (event.target === messageModal) {
                messageModal.classList.remove('show');
            }
        };

        // 获取当前有效的token过期时间
        function getCurrentTokenExpires() {
            // 优先使用更新后的token信息
            return window.eveTokenInfo?.token_expires || '{{ session.get("eve_token_expires") if session else "" }}';
        }

        // 添加会话保活功能
        let sessionKeepAliveTimer = null;

        function startSessionKeepAlive() {
            // 清除现有定时器
            if (sessionKeepAliveTimer) {
                clearInterval(sessionKeepAliveTimer);
            }
            
            // 每3分钟发送一次保活请求
            sessionKeepAliveTimer = setInterval(async () => {
                try {
                    console.log('🔄 执行会话保活检查');
                    
                    // 同时检查EVE token状态
                    const eveTokenExpires = getCurrentTokenExpires();
                    if (eveTokenExpires) {
                        const expiresTime = new Date(eveTokenExpires);
                        const now = new Date();
                        const timeLeft = Math.floor((expiresTime - now) / 1000 / 60);
                        
                        if (timeLeft <= 0) {
                            console.warn('⚠️ EVE token已过期，尝试刷新');
                            await attemptTokenRefreshSilent();
                        } else if (timeLeft <= 10) {
                            console.warn(`⚠️ EVE token即将过期，剩余${timeLeft}分钟`);
                        }
                    }
                    
                    const response = await fetch('/xuexi_ranshao/check_auth', {
                        method: 'GET',
                        credentials: 'same-origin',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    });
                    
                    if (response.ok) {
                        const result = await response.json();
                        if (result.authenticated) {
                            console.log('✅ 会话保活成功');
                        } else {
                            console.warn('⚠️ 会话已失效，停止保活');
                            stopSessionKeepAlive();
                            updateUserInterface(); // 切换到未登录状态
                        }
                    } else {
                        console.warn('⚠️ 会话保活请求失败');
                    }
                } catch (error) {
                    console.error('❌ 会话保活异常:', error);
                }
            }, 3 * 60 * 1000); // 3分钟
            
            console.log('🔄 会话保活已启动（包含EVE token检查）');
        }

        function stopSessionKeepAlive() {
            if (sessionKeepAliveTimer) {
                clearInterval(sessionKeepAliveTimer);
                sessionKeepAliveTimer = null;
                console.log('🛑 会话保活已停止');
            }
        }

        // 更新用户界面
        function updateUserInterface(user = null) {
            console.log(`🔄 [updateUserInterface] 更新用户界面:`, user);
            
            // 🆕 添加EVE SSO状态输出
            console.log(`🚀 [updateUserInterface] EVE SSO会话信息:`, {
                character_id: '{{ session.get("eve_character_id") if session else "" }}',
                character_name: '{{ session.get("eve_character_name") if session else "" }}',
                has_access_token: '{{ session.get("eve_access_token") if session else "" }}' ? true : false,
                has_refresh_token: '{{ session.get("eve_refresh_token") if session else "" }}' ? true : false,
                token_expires: '{{ session.get("eve_token_expires") if session else "" }}'
            });
            
            if (user) {
                currentUser = user;
                console.log(`✅ [updateUserInterface] 用户登录状态:`, {
                    username: user.username,
                    access_level: user.access_level || 'standard',
                    eve_sso_linked: '{{ session.get("eve_character_name") if session else "" }}' ? true : false
                });
                
                guestArea.style.display = 'none';
                userProfile.style.display = 'block';
                displayUsername.textContent = user.username;
                dropdownUsername.textContent = user.username;
                userLevel.textContent = `权限等级: ${user.access_level || 'standard'}`;
                
                // 重新绑定按钮事件
                updateDataBtn.onclick = function(e) {
                    e.stopPropagation();
                    openUpdateDataModal();
                };
                
                settingsBtnLoggedIn.onclick = function(e) {
                    e.stopPropagation();
                    openSettingsModal();
                };
                
                // 启动会话保活
                startSessionKeepAlive();
            } else {
                console.log(`❌ [updateUserInterface] 用户未登录，清除界面状态`);
                currentUser = null;
                guestArea.style.display = 'flex';
                userProfile.style.display = 'none';
                userProfile.classList.remove('active');
                // 停止会话保活
                stopSessionKeepAlive();
            }
        }

        // 检查登录状态（带重试机制和详细调试信息）
async function checkAuthStatus(retryCount = 0) {
    console.log(`🔍 [checkAuthStatus] 开始检查登录状态，重试次数: ${retryCount}`);
    
    try {
        // 🔑 强制刷新页面cookies
        if (retryCount === 0) {
            console.log('🔄 [checkAuthStatus] 首次检查，等待cookies加载');
            await new Promise(resolve => setTimeout(resolve, 500));
        }
        
        console.log(`📡 [checkAuthStatus] 发送请求到: /xuexi_ranshao/check_auth`);
        const response = await fetch('/xuexi_ranshao/check_auth', {
            method: 'GET',
            credentials: 'same-origin',  // 🔑 确保包含cookies
            headers: {
                'Content-Type': 'application/json',
                'Cache-Control': 'no-cache',
                'Pragma': 'no-cache'  // 强制不使用缓存
            }
        });
        
        console.log(`📥 [checkAuthStatus] 收到响应:`, {
            status: response.status,
            statusText: response.statusText,
            ok: response.ok,
            headers: Object.fromEntries(response.headers.entries())
        });
        
        if (response.ok) {
            const result = await response.json();
            console.log(`✅ [checkAuthStatus] 解析JSON成功:`, result);
            
            // 🆕 添加EVE SSO信息输出
            console.log(`🚀 [checkAuthStatus] EVE SSO状态检查:`, {
                eve_character_id: '{{ session.get("eve_character_id") if session else "" }}',
                eve_character_name: '{{ session.get("eve_character_name") if session else "" }}',
                eve_access_token: '{{ session.get("eve_access_token") if session else "" }}' ? '存在' : '不存在',
                eve_token_expires: '{{ session.get("eve_token_expires") if session else "" }}',
                eve_refresh_token: '{{ session.get("eve_refresh_token") if session else "" }}' ? '存在' : '不存在'
            });
            
            if (result.authenticated) {
                console.log(`🎉 [checkAuthStatus] 用户已认证:`, result.user);
                
                // 🆕 检查EVE SSO令牌状态
                const eveTokenExpires = '{{ session.get("eve_token_expires") if session else "" }}';
                if (eveTokenExpires) {
                    const expiresTime = new Date(eveTokenExpires);
                    const now = new Date();
                    const timeLeft = Math.floor((expiresTime - now) / 1000 / 60); // 分钟
                    
                    console.log(`⏰ [checkAuthStatus] EVE SSO令牌状态:`, {
                        expires_at: eveTokenExpires,
                        time_left_minutes: timeLeft,
                        is_expired: timeLeft <= 0,
                        needs_refresh: timeLeft <= 5
                    });
                    
                    if (timeLeft <= 0) {
                        console.warn(`⚠️ [checkAuthStatus] EVE SSO令牌已过期！`);
                    } else if (timeLeft <= 5) {
                        console.warn(`⚠️ [checkAuthStatus] EVE SSO令牌即将过期，剩余${timeLeft}分钟`);
                    } else {
                        console.log(`✅ [checkAuthStatus] EVE SSO令牌有效，剩余${timeLeft}分钟`);
                    }
                } else {
                    console.warn(`❌ [checkAuthStatus] 未找到EVE SSO令牌过期时间`);
                }
                
                updateUserInterface(result.user);
                    
                    // 尝试从本地存储恢复血袭合作社凭据
                    try {
                        const savedCredentials = restoreCredentials();
                        console.log(`💾 [checkAuthStatus] 本地存储的凭据:`, savedCredentials ? '存在' : '不存在');
                        
                        if (savedCredentials) {
                            const parsed = JSON.parse(savedCredentials);
                            console.log(`🔑 [checkAuthStatus] 解析凭据成功:`, {
                                hasUsername: !!parsed.username,
                                hasPassword: !!parsed.password
                            });
                            
                            bloodCredentials.username = parsed.username;
                            bloodCredentials.password = parsed.password;
                            
                            // 启动自动更新定时器
                            startAutoUpdate();
                        }
                    } catch (e) {
                        console.error('❌ [checkAuthStatus] 恢复凭据失败:', e);
                    }
                } else {
                console.log(`❌ [checkAuthStatus] 用户未认证，重试次数: ${retryCount}`);
                
                // 如果认证失败且重试次数少于3次，则重试
                if (retryCount < 3) {
                    console.log(`🔄 [checkAuthStatus] ${retryCount + 1}秒后重试...`);
                    setTimeout(() => checkAuthStatus(retryCount + 1), 1000);
                    return;
                }
                console.log(`🚫 [checkAuthStatus] 达到最大重试次数，停止重试`);
                updateUserInterface();
                stopAutoUpdate();
            }
        } else {
            console.error(`❌ [checkAuthStatus] HTTP错误:`, {
                status: response.status,
                statusText: response.statusText
            });
            
            // 网络错误也进行重试
            if (retryCount < 3) {
                console.log(`🔄 [checkAuthStatus] 网络错误，${retryCount + 1}秒后重试...`);
                setTimeout(() => checkAuthStatus(retryCount + 1), 1000);
                return;
            }
            console.log(`🚫 [checkAuthStatus] 网络错误达到最大重试次数`);
            updateUserInterface();
            stopAutoUpdate();
        }
    } catch (error) {
        console.error('💥 [checkAuthStatus] 请求异常:', {
            name: error.name,
            message: error.message,
            stack: error.stack
        });
        
        if (retryCount < 3) {
            console.log(`🔄 [checkAuthStatus] 异常后重试，${retryCount + 1}秒后重试...`);
            setTimeout(() => checkAuthStatus(retryCount + 1), 1000);
            return;
        }
        console.log(`🚫 [checkAuthStatus] 异常达到最大重试次数`);
        updateUserInterface();
        stopAutoUpdate();
    }
}

        // 🆕 EVE SSO状态调试函数
        function debugEveSSO() {
            console.log(`🔍 [debugEveSSO] 完整EVE SSO状态:`, {
                session_data: {
                    character_id: '{{ session.get("eve_character_id") if session else "" }}',
                    character_name: '{{ session.get("eve_character_name") if session else "" }}',
                    access_token: '{{ session.get("eve_access_token") if session else "" }}' ? '存在(长度:' + '{{ session.get("eve_access_token")|length if session and session.get("eve_access_token") else 0 }}' + ')' : '不存在',
                    refresh_token: '{{ session.get("eve_refresh_token") if session else "" }}' ? '存在' : '不存在',
                    token_expires: '{{ session.get("eve_token_expires") if session else "" }}'
                },
                local_storage: {
                    blood_credentials: localStorage.getItem('bloodCredentials') ? '存在' : '不存在',
                    last_update_time: localStorage.getItem('lastUpdateTime')
                },
                current_time: new Date().toISOString()
            });
            
            // 检查令牌有效性
            const eveTokenExpires = '{{ session.get("eve_token_expires") if session else "" }}';
            if (eveTokenExpires) {
                const expiresTime = new Date(eveTokenExpires);
                const now = new Date();
                const timeLeft = Math.floor((expiresTime - now) / 1000 / 60);
                
                console.log(`⏰ [debugEveSSO] 令牌时间分析:`, {
                    expires_at: eveTokenExpires,
                    current_time: now.toISOString(),
                    time_left_minutes: timeLeft,
                    status: timeLeft > 5 ? '正常' : timeLeft > 0 ? '即将过期' : '已过期'
                });
            }
        }

        // 页面加载时检查登录状态
        document.addEventListener('DOMContentLoaded', function() {
            // 1. 立即显示导航栏和基础UI
            initializeBasicUI();
            
            // 2. 异步初始化token信息（不阻塞UI）
            setTimeout(() => {
                window.eveTokenInfo = {
                    character_id: '{{ session.get("eve_character_id") if session else "" }}',
                    character_name: '{{ session.get("eve_character_name") if session else "" }}',
                    token_expires: '{{ session.get("eve_token_expires") if session else "" }}',
                    has_access_token: "{{ 'true' if session.get('eve_access_token') else 'false' }}"
                };
                
                debugEveSSO();
                checkAuthStatus();
                checkEveTokenOnPageLoad();
            }, 0);
            
            // 3. 延迟加载数据密集型操作
            setTimeout(() => {
                initTablesAsync();
            }, 100);
            
            // 4. 最后启动自动更新
            setTimeout(() => {
                startOptimizedAutoUpdate();
            }, 500);
        }); // 结束前一个函数的闭包

        // 新增：基础UI初始化函数
        function initializeBasicUI() {
            // 移除内容加载状态
            document.body.classList.remove('content-loading');
            
            // 显示骨架屏
            showSkeletonScreens();
        }

        // 新增：显示骨架屏
        function showSkeletonScreens() {
            const infoCards = document.querySelectorAll('.info-card');
            const tables = document.querySelectorAll('.table-section');
            
            infoCards.forEach(card => {
                const valueElement = card.querySelector('.info-value');
                if (valueElement && !valueElement.textContent.trim()) {
                    card.classList.add('skeleton', 'skeleton-card');
                }
            });
            
            tables.forEach(table => {
                const tbody = table.querySelector('tbody');
                if (!tbody || tbody.children.length === 0) {
                    table.classList.add('skeleton', 'skeleton-table');
                }
            });
        }

        // 新增：异步表格初始化
        async function initTablesAsync() {
            try {
                // 显示加载指示器
                showLoadingIndicator();
                
                // 并行加载数据，但不阻塞UI
                const loadPromises = [
                    loadPaidMissionsDataAsync(),
                    loadWalletDonationsDataAsync()
                ];
                
                // 等待所有数据加载完成
                await Promise.allSettled(loadPromises);
                
                // 移除骨架屏
                removeSkeletonScreens();
                
            } catch (error) {
                console.error('数据加载失败:', error);
            } finally {
                hideLoadingIndicator();
            }
        }

        // 新增：异步加载已支付任务数据
        async function loadPaidMissionsDataAsync() {
            try {
                return new Promise((resolve, reject) => {
                    loadPaidMissionsData();
                    resolve();
                });
            } catch (error) {
                console.error('加载已支付任务数据失败:', error);
            }
        }

        // 新增：异步加载钱包捐赠数据
        async function loadWalletDonationsDataAsync() {
            try {
                return new Promise((resolve, reject) => {
                    loadWalletDonationsData();
                    resolve();
                });
            } catch (error) {
                console.error('加载钱包捐赠数据失败:', error);
            }
        }

        // 新增：移除骨架屏
        function removeSkeletonScreens() {
            document.querySelectorAll('.skeleton').forEach(element => {
                element.classList.remove('skeleton', 'skeleton-card', 'skeleton-table');
            });
        }

        // 新增：显示/隐藏加载指示器
        function showLoadingIndicator() {
            const indicator = document.createElement('div');
            indicator.id = 'page-loading-indicator';
            indicator.className = 'top-loading';
            indicator.innerHTML = '<div class="spinner"></div><span>正在加载数据...</span>';
            document.body.appendChild(indicator);
        }

        function hideLoadingIndicator() {
            const indicator = document.getElementById('page-loading-indicator');
            if (indicator) {
                indicator.remove();
            }
        }

        // 🆕 页面加载时检查EVE SSO令牌状态
        function checkEveTokenOnPageLoad() {
            const eveCharacterId = '{{ session.get("eve_character_id") if session else "" }}';
            const eveTokenExpires = getCurrentTokenExpires();
            
            // 如果用户已经绑定了EVE SSO但令牌过期
            if (eveCharacterId && eveTokenExpires) {
                const expiresTime = new Date(eveTokenExpires);
                const now = new Date();
                const timeLeft = Math.floor((expiresTime - now) / 1000 / 60); // 分钟
                
                console.log(`🔍 [checkEveTokenOnPageLoad] EVE SSO令牌检查:`, {
                    character_id: eveCharacterId,
                    expires_at: eveTokenExpires,
                    time_left_minutes: timeLeft,
                    is_expired: timeLeft <= 0
                });
                
                if (timeLeft <= 0) {
                    // 令牌已过期，尝试自动刷新
                    console.warn(`⚠️ [checkEveTokenOnPageLoad] EVE SSO令牌已过期，尝试自动刷新`);
                    attemptTokenRefresh();
                } else if (timeLeft <= 10) {
                    // 令牌即将过期（10分钟内），提前刷新
                    console.warn(`⚠️ [checkEveTokenOnPageLoad] EVE SSO令牌即将过期，剩余${timeLeft}分钟`);
                    attemptTokenRefresh();
                }
            }
        }

        // 🆕 添加token刷新函数
        async function attemptTokenRefresh() {
            try {
                console.log('🔄 [attemptTokenRefresh] 尝试刷新EVE SSO令牌');
                const response = await fetch('/auth/refresh', {
                    method: 'POST',
                    credentials: 'same-origin',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        console.log('✅ [attemptTokenRefresh] EVE SSO令牌刷新成功');
                        
                        // 如果返回了token信息，更新全局token信息变量
                        if (result.token_info) {
                            window.eveTokenInfo = {
                                character_id: result.token_info.character_id,
                                character_name: result.token_info.character_name,
                                token_expires: result.token_info.token_expires,
                                has_access_token: result.token_info.has_access_token
                            };
                            console.log('🔄 [attemptTokenRefresh] 已更新页面token信息:', window.eveTokenInfo);
                        }
                        
                        // 刷新页面以获取新的token信息
                        location.reload();
                    } else {
                        console.error('❌ [attemptTokenRefresh] EVE SSO令牌刷新失败:', result.message);
                        showEveTokenExpiredNotification();
                    }
                } else {
                    console.error('❌ [attemptTokenRefresh] 令牌刷新请求失败:', response.status);
                    showEveTokenExpiredNotification();
                }
            } catch (error) {
                console.error('❌ [attemptTokenRefresh] 令牌刷新请求异常:', error);
                showEveTokenExpiredNotification();
            }
        }

        // 添加静默token刷新函数
        async function attemptTokenRefreshSilent() {
            try {
                console.log('🔄 [attemptTokenRefreshSilent] 静默刷新EVE SSO令牌');
                const response = await fetch('/auth/refresh', {
                    method: 'POST',
                    credentials: 'same-origin',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const result = await response.json();
                    if (result.success && result.token_info) {
                        console.log('✅ [attemptTokenRefreshSilent] EVE SSO令牌静默刷新成功');
                        
                        // 更新全局token信息变量
                        window.eveTokenInfo = {
                            character_id: result.token_info.character_id,
                            character_name: result.token_info.character_name,
                            token_expires: result.token_info.token_expires,
                            has_access_token: result.token_info.has_access_token
                        };
                        
                        console.log('🔄 [attemptTokenRefreshSilent] 已更新页面token信息:', window.eveTokenInfo);
                        
                        // 🆕 刷新成功后重新加载数据
                        console.log('🔄 Token刷新成功，重新加载页面数据');
                        setTimeout(() => {
                            loadWalletDonationsData();
                            loadPaidMissionsData();
                        }, 500);
                        
                        return true;
                    } else {
                        console.error('❌ [attemptTokenRefreshSilent] EVE SSO令牌刷新失败:', result.message);
                        return false;
                    }
                } else {
                    console.error('❌ [attemptTokenRefreshSilent] 令牌刷新请求失败:', response.status);
                    return false;
                }
            } catch (error) {
                console.error('❌ [attemptTokenRefreshSilent] 令牌刷新请求异常:', error);
                return false;
            }
        }

        // 🆕 显示EVE SSO令牌过期通知
        function showEveTokenExpiredNotification() {
            // 创建通知元素
            const notification = document.createElement('div');
            notification.className = 'eve-token-notification expired';
            notification.innerHTML = `
                <div class="notification-content">
                    <div class="notification-icon">⚠️</div>
                    <div class="notification-text">
                        <strong>EVE SSO会话已过期</strong>
                        <p>您的EVE在线认证已过期，无法获取最新的忠诚点数据。请重新登录EVE SSO以继续使用完整功能。</p>
                    </div>
                    <div class="notification-actions">
                        <button onclick="window.location.href='/auth/login'" class="btn-primary">重新登录EVE SSO</button>
                        <button onclick="closeEveTokenNotification()" class="btn-secondary">稍后提醒</button>
                    </div>
                </div>
            `;
            
            // 添加样式
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: #fff;
                border: 2px solid #ff6b6b;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                padding: 16px;
                max-width: 400px;
                z-index: 10000;
                animation: slideInRight 0.3s ease-out;
            `;
            
            document.body.appendChild(notification);
            
            // 5分钟后自动隐藏
            setTimeout(() => {
                if (notification.parentNode) {
                    closeEveTokenNotification();
                }
            }, 5 * 60 * 1000);
        }

        // 🆕 显示EVE SSO令牌即将过期通知
        function showEveTokenExpiringNotification(minutesLeft) {
            const notification = document.createElement('div');
            notification.className = 'eve-token-notification expiring';
            notification.innerHTML = `
                <div class="notification-content">
                    <div class="notification-icon">⏰</div>
                    <div class="notification-text">
                        <strong>EVE SSO会话即将过期</strong>
                        <p>您的EVE在线认证将在${minutesLeft}分钟后过期。建议提前重新登录以避免数据获取中断。</p>
                    </div>
                    <div class="notification-actions">
                        <button onclick="window.location.href='/auth/login'" class="btn-primary">立即重新登录</button>
                        <button onclick="closeEveTokenNotification()" class="btn-secondary">知道了</button>
                    </div>
                </div>
            `;
            
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: #fff;
                border: 2px solid #ffa726;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                padding: 16px;
                max-width: 400px;
                z-index: 10000;
                animation: slideInRight 0.3s ease-out;
            `;
            
            document.body.appendChild(notification);
            
            // 2分钟后自动隐藏
            setTimeout(() => {
                if (notification.parentNode) {
                    closeEveTokenNotification();
                }
            }, 2 * 60 * 1000);
        }

        // 🆕 关闭EVE令牌通知
        function closeEveTokenNotification() {
            const notifications = document.querySelectorAll('.eve-token-notification');
            notifications.forEach(notification => {
                notification.style.animation = 'slideOutRight 0.3s ease-in';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            });
        }

        // 添加到全局，方便手动调用
        window.debugEveSSO = debugEveSSO;
        
        // 检查当前token是否有效
        function isCurrentTokenValid() {
            const eveTokenExpires = getCurrentTokenExpires();
            if (!eveTokenExpires) return false;
            
            const expiresTime = new Date(eveTokenExpires);
            const now = new Date();
            const timeLeft = Math.floor((expiresTime - now) / 1000 / 60); // 分钟
            
            return timeLeft > 5; // 如果剩余时间大于5分钟，认为有效
        }

        // 用户头像点击事件
        userAvatar.onclick = (e) => {
            e.stopPropagation();
            userProfile.classList.toggle('active');
        };



        // 阻止下拉菜单点击事件冒泡，但允许按钮点击
        userDropdown.onclick = (e) => {
            e.stopPropagation();
            // 不阻止默认行为，允许按钮点击事件触发
        };

        // 退出登录（添加调试信息）
        logoutBtn.onclick = async () => {
            console.log(`🚪 [logout] 开始退出登录流程`);
            
            try {
                console.log(`📡 [logout] 发送退出请求到: /xuexi_ranshao/logout`);
                const response = await fetch('/xuexi_ranshao/logout', {
                    method: 'POST'
                });

                console.log(`📥 [logout] 收到退出响应:`, {
                    status: response.status,
                    statusText: response.statusText,
                    ok: response.ok,
                    headers: Object.fromEntries(response.headers.entries())
                });

                if (response.ok) {
                    const result = await response.json();
                    console.log(`✅ [logout] 退出响应JSON:`, result);
                    
                    if (result.success) {
                        console.log(`🎉 [logout] 退出成功`);
                        showMessage('已成功退出登录', 'success');
                        updateUserInterface();
                        
                        // 清除保存的凭据
                        console.log(`🗑️ [logout] 清除本地凭据`);
                        bloodCredentials.username = '';
                        bloodCredentials.password = '';
                        try {
                            localStorage.removeItem('bloodCredentials');
                            localStorage.removeItem('bloodCredentials_backup');
                            console.log(`✅ [logout] 本地凭据清除成功（含备份）`);
                        } catch (e) {
                            console.error('❌ [logout] 清除凭据失败:', e);
                        }
                        
                        // 停止自动更新
                        stopAutoUpdate();
                    } else {
                        console.error(`❌ [logout] 退出失败:`, result.message);
                        showMessage('退出登录失败: ' + result.message, 'error');
                    }
                } else {
                    console.error(`❌ [logout] 退出请求HTTP错误:`, {
                        status: response.status,
                        statusText: response.statusText
                    });
                    showMessage('退出登录请求失败', 'error');
                }
            } catch (error) {
                console.error('💥 [logout] 退出请求异常:', {
                    name: error.name,
                    message: error.message,
                    stack: error.stack
                });
                showMessage('退出登录出错', 'error');
            }
        };

        // 显示登录弹窗
        loginBtn.onclick = () => {
            loginModal.classList.add('show');
            registerModal.classList.remove('show');
        };

        // 显示注册弹窗
        registerBtn.onclick = () => {
            registerModal.classList.add('show');
            loginModal.classList.remove('show');
        };

        // 切换到注册弹窗
        showRegister.onclick = (e) => {
            e.preventDefault();
            loginModal.classList.remove('show');
            registerModal.classList.add('show');
        };

        // 切换到登录弹窗
        showLogin.onclick = (e) => {
            e.preventDefault();
            registerModal.classList.remove('show');
            loginModal.classList.add('show');
        };

        // 关闭登录弹窗
        closeModal.onclick = () => loginModal.classList.remove('show');

        // 关闭注册弹窗
        closeRegisterModal.onclick = () => registerModal.classList.remove('show');

        // 点击页面其他地方关闭下拉菜单和弹窗
        window.onclick = (event) => {
            // 关闭用户下拉菜单
            userProfile.classList.remove('active');
            
            // 关闭登录和注册弹窗
            if (event.target === loginModal) {
                loginModal.classList.remove('show');
            }
            if (event.target === registerModal) {
                registerModal.classList.remove('show');
            }
            
            // 关闭设置比率弹窗
            if (event.target === settingsModal) {
                closeSettingsModalFunc();
            }
            
            // 关闭更新数据弹窗
            if (event.target === updateDataModal) {
                closeUpdateDataModalFunc();
            }
        };

        // 登录表单AJAX提交（添加调试信息）
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            console.log(`🔐 [login] 开始登录流程`);

            const formData = new FormData(loginForm);
            const rememberMe = formData.get('rememberMe') === 'on';
            
            console.log(`📝 [login] 表单数据:`, {
                username: formData.get('username'),
                hasPassword: !!formData.get('password'),
                rememberMe: rememberMe
            });
            
            try {
                console.log('📡 [login] 发送登录请求');
                const response = await fetch('/xuexi_ranshao/login', {
                    method: 'POST',
                    body: formData,
                    credentials: 'same-origin',  // 确保包含cookies
                    // 不要设置Content-Type，让浏览器自动处理FormData
                });
                
                console.log('📥 [login] 收到登录响应:', {
                    status: response.status,
                    statusText: response.statusText,
                    ok: response.ok,
                    headers: Object.fromEntries(response.headers.entries())
                });

                if (response.ok) {
                    const result = await response.json();
                    console.log('✅ [login] 登录响应JSON:', result);
                    
                    if (result.success) {
                        console.log('🎉 [login] 登录成功:', result.user);
                        showMessage('登录成功！', 'success');
                        loginModal.classList.remove('show');
                        loginForm.reset();
                        
                        // 保存血袭合作社凭据（与登录凭据相同）
                        bloodCredentials.username = formData.get('username');
                        bloodCredentials.password = formData.get('password');
                        
                        console.log(`💾 [login] 保存凭据到本地存储`);
                        // 保存到本地存储（含备份）
                        saveCredentials(bloodCredentials.username, bloodCredentials.password);
                        
                        // 更新用户界面
                        updateUserInterface({
                            username: result.user,
                            access_level: result.xuexi_specific_data?.access_level || 'standard'
                        });
                        
                        // 🔑 关键：等待会话完全建立后再进行后续操作
                        console.log('⏳ [login] 等待会话建立...');
                        setTimeout(async () => {
                            console.log('🔄 [login] 验证会话是否建立成功');
                            try {
                                const authCheck = await fetch('/xuexi_ranshao/check_auth', {
                                    method: 'GET',
                                    credentials: 'same-origin',
                                    headers: {
                                        'Content-Type': 'application/json',
                                        'Cache-Control': 'no-cache'
                                    }
                                });
                                
                                if (authCheck.ok) {
                                    const authResult = await authCheck.json();
                                    if (authResult.authenticated) {
                                        console.log('✅ [login] 会话验证成功，启动自动更新');
                                        startAutoUpdate();
                                    } else {
                                        console.error('❌ [login] 会话验证失败');
                                        showMessage('会话建立失败，请重新登录', 'error');
                                    }
                                } else {
                                    console.error('❌ [login] 会话验证请求失败');
                                }
                            } catch (error) {
                                console.error('💥 [login] 会话验证异常:', error);
                            }
                        }, 2000); // 等待2秒确保会话完全建立
                    } else {
                        console.error('❌ [login] 登录失败:', result.message);
                        showMessage('登录失败: ' + result.message, 'error');
                    }
                } else {
                    console.error('❌ [login] 登录请求HTTP错误:', {
                        status: response.status,
                        statusText: response.statusText
                    });
                    showMessage('登录请求失败，请稍后再试。', 'error');
                }
            } catch (error) {
                console.error('💥 [login] 登录请求异常:', error);
                showMessage('登录请求出错，请稍后再试。', 'error');
            }
        });

        // 注册表单AJAX提交
        registerForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            // 验证密码确认
            const password = document.getElementById('regPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;

            if (password !== confirmPassword) {
                showMessage('两次输入的密码不一致，请重新输入。', 'error');
                return;
            }

            const formData = new FormData(registerForm);
            try {
                const response = await fetch('/xuexi_ranshao/register', {
                    method: 'POST',
                    body: formData
                });

                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        showMessage('注册成功！请登录。', 'success');
                        // 切换到登录弹窗并预填用户名
                        document.getElementById('username').value = document.getElementById('regUsername').value;
                        registerModal.classList.remove('show');
                        loginModal.classList.add('show');
                        // 清空注册表单
                        registerForm.reset();
                    } else {
                        showMessage('注册失败: ' + result.message, 'error');
                    }
                } else {
                    showMessage('注册请求失败，请稍后再试。', 'error');
                }
            } catch (error) {
                console.error('注册请求出错:', error);
                showMessage('注册请求出错，请稍后再试。', 'error');
            }
        });



        // 更新数据功能（合并强制刷新功能）
        // 打开更新数据弹窗
        function openUpdateDataModal() {
            // 清除更新时间缓存，确保获取最新数据
            localStorage.removeItem('lastUpdateTime');
            
            // 如果有保存的凭据，直接开始更新流程
            if (bloodCredentials.username && bloodCredentials.password) {
                startDataUpdate(bloodCredentials.username, bloodCredentials.password, true);
                showMessage('正在更新数据...', 'info');
            } else {
                // 如果没有保存的凭据，显示提示消息
                showMessage('无法获取血袭合作社凭据，请重新登录', 'error');
            }
        }

        // 关闭更新数据弹窗
        function closeUpdateDataModalFunc() {
            updateDataModal.classList.remove('show');
            // 重置进度显示
            resetStepStatus();
            updateProgress(0);
            updateLoadingIndicator.style.display = 'none';
        }

        // 绑定事件
        updateDataBtn.addEventListener('click', function(e) {
            e.stopPropagation(); // 阻止冒泡，防止关闭下拉菜单
            
            // 检查用户是否已登录
            if (!currentUser) {
                showMessage('请先登录后再更新数据', 'error');
                return;
            }
            
            // 直接显示弹窗并开始更新
            updateDataModal.classList.add('show');
            const updateStatusDisplay = document.getElementById('updateStatusDisplay');
            updateStatusDisplay.style.display = 'block';
            
            // 使用保存的凭据直接开始更新
            const savedCreds = restoreCredentials();
            if (savedCreds) {
                try {
                    const creds = JSON.parse(savedCreds);
                    if (creds.username && creds.password) {
                        // 直接开始数据更新
                        startDataUpdate(creds.username, creds.password);
                    } else {
                        showMessage('未找到保存的血袭合作社凭据，请先登录', 'error');
                        updateDataModal.classList.remove('show');
                    }
                } catch (e) {
                    console.error('恢复凭据失败:', e);
                    showMessage('凭据格式错误，请重新登录', 'error');
                    updateDataModal.classList.remove('show');
                }
            } else {
                showMessage('未找到保存的血袭合作社凭据，请先登录', 'error');
                updateDataModal.classList.remove('show');
            }
        });
        
        // 关闭按钮事件绑定
        closeUpdateDataModal.addEventListener('click', function() {
            updateDataModal.classList.remove('show');
        });
        
        // 取消按钮事件绑定
        cancelUpdateData.addEventListener('click', function() {
            updateDataModal.classList.remove('show');
        });



        // 添加新函数处理数据更新（修复静默模式问题）
        async function startDataUpdate(username, password, silent = false) {
            console.log(`🚀 [startDataUpdate] 开始数据更新:`, {
                username: username,
                silent: silent,
                eve_character_id: '{{ session.get("eve_character_id") if session else "" }}',
                eve_character_name: '{{ session.get("eve_character_name") if session else "" }}'
            });
            
            // 🆕 检查EVE SSO状态 - 优先使用更新后的token信息
            const eveCharacterId = window.eveTokenInfo?.character_id || '{{ session.get("eve_character_id") if session else "" }}';
            const eveAccessToken = window.eveTokenInfo?.has_access_token || ('{{ session.get("eve_access_token") if session else "" }}' ? true : false);
            const eveTokenExpires = getCurrentTokenExpires();
            
            console.log(`🔍 [startDataUpdate] EVE SSO数据更新前检查:`, {
                has_character_id: !!eveCharacterId,
                has_access_token: !!eveAccessToken,
                token_expires: eveTokenExpires,
                can_fetch_eve_data: !!(eveCharacterId && eveAccessToken)
            });
            
            if (eveTokenExpires) {
                const expiresTime = new Date(eveTokenExpires);
                const now = new Date();
                const isExpired = now >= expiresTime;
                
                console.log(`⏰ [startDataUpdate] EVE令牌检查:`, {
                    expires_at: eveTokenExpires,
                    current_time: now.toISOString(),
                    is_expired: isExpired,
                    time_diff_minutes: Math.floor((expiresTime - now) / 1000 / 60)
                });
                
                if (isExpired) {
                    console.error(`❌ [startDataUpdate] EVE SSO令牌已过期，尝试刷新`);
                    
                    // 尝试刷新令牌
                    const refreshSuccess = await attemptTokenRefreshSilent();
                    if (!refreshSuccess) {
                        console.error(`❌ [startDataUpdate] 令牌刷新失败，无法获取EVE数据`);
                        if (!silent) {
                            showMessage('EVE SSO令牌已过期且刷新失败，请重新登录EVE SSO', 'error');
                            showEveTokenExpiredNotification();
                        }
                        return; // 停止执行
                    } else {
                        console.log(`✅ [startDataUpdate] 令牌刷新成功，继续数据更新`);
                        // 不需要刷新页面，继续执行
                    }
                }
            }
            
            // 检查登录状态
            if (!currentUser) {
                console.error(`❌ [startDataUpdate] 用户未登录`);
                if (!silent) showMessage('请先登录后再更新数据', 'error');
                return;
            }

            // 🔑 强制重新验证会话状态
            console.log(`🔍 [startDataUpdate] 验证会话状态`);
            try {
                const authResponse = await fetch('/xuexi_ranshao/check_auth', {
                    method: 'GET',
                    credentials: 'same-origin',
                    headers: {
                        'Content-Type': 'application/json',
                        'Cache-Control': 'no-cache'
                    }
                });
                
                if (!authResponse.ok) {
                    console.error(`❌ [startDataUpdate] 会话验证请求失败: ${authResponse.status}`);
                    if (!silent) {
                        showMessage('会话验证失败，请重新登录', 'error');
                        updateUserInterface(); // 切换到未登录状态
                    }
                    return;
                }
                
                const authResult = await authResponse.json();
                if (!authResult.authenticated) {
                    console.error(`❌ [startDataUpdate] 会话验证失败，用户未认证`);
                    if (!silent) {
                        showMessage('会话已过期，请重新登录', 'error');
                        updateUserInterface(); // 切换到未登录状态
                    }
                    return;
                }
                
                console.log(`✅ [startDataUpdate] 会话验证成功，用户: ${authResult.user}`);
            } catch (error) {
                console.error(`💥 [startDataUpdate] 会话验证异常:`, error);
                if (!silent) showMessage('会话验证出错，请重新登录', 'error');
                return;
            }

            // 🆕 只在非静默模式下显示UI
            if (!silent) {
                // 显示加载状态和更新状态区域
                updateDataModal.classList.add('show');
                updateLoadingIndicator.style.display = 'flex';
                const updateStatusDisplay = document.getElementById('updateStatusDisplay');
                updateStatusDisplay.style.display = 'block';
                
                // 重置所有步骤状态
                resetStepStatus();
                
                // 更新进度条为0%
                updateProgress(0);
            }
            
            try {
                // 第一步：验证账户
                console.log(`1️⃣ [startDataUpdate] 步骤1: 验证账户`);
                if (!silent) {
                    updateStepStatus('step1', 'active');
                    await simulateDelay(500);
                    updateProgress(25);
                    updateStepStatus('step1', 'completed');
                }
                
                // 第二步：获取数据
                console.log(`2️⃣ [startDataUpdate] 步骤2: 获取数据`);
                if (!silent) {
                    updateStepStatus('step2', 'active');
                    await simulateDelay(500);
                }
                
                const params = new URLSearchParams({
                    blood_username: username,
                    blood_password: password
                });
                const apiUrl = `/api/blood_cooperatives_data?${params.toString()}`;
                console.log(`📡 [startDataUpdate] 发送数据请求到:`, apiUrl);
                
                // 🔑 关键修复：确保包含会话凭据
                const response = await fetch(apiUrl, {
                    method: 'GET',
                    credentials: 'same-origin',  // 确保包含cookies
                    headers: {
                        'Content-Type': 'application/json',
                        'Cache-Control': 'no-cache'
                    }
                });
                
                console.log(`📥 [startDataUpdate] 收到数据响应:`, {
                    status: response.status,
                    statusText: response.statusText,
                    ok: response.ok,
                    headers: Object.fromEntries(response.headers.entries())
                });
                
                // 🔧 修复：处理401认证错误
                if (response.status === 401) {
                    console.error('❌ EVE SSO认证失败');
                    if (!silent) {
                        updateStepStatus('step2', 'error');
                        updateProgress(50);
                        showMessage('EVE SSO认证已过期，请重新登录EVE SSO', 'error');
                        showEveTokenExpiredNotification();
                    }
                    return false;
                }
                
                if (!silent) {
                    updateProgress(50);
                    updateStepStatus('step2', 'completed');
                }
                
                if (response.ok) {
                    const result = await response.json();
                    console.log(`✅ [startDataUpdate] 数据响应JSON:`, result);

                    if (result.success) {
                        // 第三步：保存到数据库
                        console.log(`3️⃣ [startDataUpdate] 步骤3: 保存到数据库`);
                        if (!silent) {
                            updateStepStatus('step3', 'active');
                            await simulateDelay(500);
                            updateProgress(75);
                            updateStepStatus('step3', 'completed');
                        }
                        
                        // 第四步：计算统计信息
                        console.log(`4️⃣ [startDataUpdate] 步骤4: 计算统计信息`);
                        if (!silent) {
                            updateStepStatus('step4', 'active');
                            await simulateDelay(500);
                            updateProgress(100);
                            updateStepStatus('step4', 'completed');
                        }
                        
                        console.log(`🎉 [startDataUpdate] 数据更新成功`);
                        
                        // 🆕 验证实际数据更新结果
                        const hasValidData = result.data && (
                            (result.data.summary && Object.keys(result.data.summary).length > 0) ||
                            (result.data.missions && result.data.missions.length > 0) ||
                            (result.data.wallet_donations && result.data.wallet_donations.length > 0)
                        );
                        
                        if (hasValidData) {
                            if (!silent) {
                                showMessage('数据更新成功！', 'success');
                                // 关闭更新弹窗
                                setTimeout(() => {
                                    closeUpdateDataModalFunc();
                                }, 2000);
                            }
                            
                            // 可选：动态更新页面上的统计数据
                            if (result.data && result.data.summary) {
                                updatePageStatistics(result.data.summary);
                            }
                            
                            return true; // 返回成功状态
                        } else {
                            console.warn(`⚠️ [startDataUpdate] 数据更新成功但无有效数据`);
                            if (!silent) {
                                showMessage('数据更新完成，但未获取到新数据', 'warning');
                            }
                            return true; // 🆕 即使无新数据也返回成功，因为更新流程本身是成功的
                        }
                    } else {
                        console.error(`❌ [startDataUpdate] 数据更新失败:`, result.message);
                        if (!silent) {
                            updateStepStatus('step2', 'error');
                            updateProgress(50);
                            showMessage(`数据更新失败: ${result.message}`, 'error');
                        }
                        return false;
                    }
                } else {
                    const errorMessage = `HTTP ${response.status}: ${response.statusText}`;
                    console.error(`❌ [startDataUpdate] 数据请求HTTP错误:`, {
                        status: response.status,
                        statusText: response.statusText
                    });
                    if (!silent) {
                        updateStepStatus('step2', 'error');
                        updateProgress(50);
                        showMessage(`数据请求失败: ${errorMessage}`, 'error');
                    }
                    return false;
                }
            } catch (error) {
                console.error('💥 [startDataUpdate] 数据更新异常:', {
                    name: error.name,
                    message: error.message,
                    stack: error.stack
                });
                if (!silent) {
                    updateStepStatus('step2', 'error');
                    updateProgress(50);
                    showMessage(`数据更新异常: ${error.message}`, 'error');
                }
                return false;
            } finally {
                if (!silent) {
                    updateLoadingIndicator.style.display = 'none';
                }
                console.log(`🏁 [startDataUpdate] 数据更新流程结束`);
            }
        }

        // 处理更新数据表单提交（已移除，现在直接使用保存的凭据）

        // 更新进度条
        function updateProgress(percentage) {
            const progressFill = document.getElementById('progressFill');
            const progressText = document.getElementById('progressText');
            
            progressFill.style.width = `${percentage}%`;
            progressText.textContent = `${percentage}%`;
        }

        // 更新步骤状态
        function updateStepStatus(stepId, status) {
            const step = document.getElementById(stepId);
            // 移除所有状态类
            step.classList.remove('active', 'completed', 'error');
            // 添加新状态
            step.classList.add(status);
        }

        // 重置所有步骤状态
        function resetStepStatus() {
            const steps = ['step1', 'step2', 'step3', 'step4'];
            steps.forEach(stepId => {
                const step = document.getElementById(stepId);
                step.classList.remove('active', 'completed', 'error');
            });
        }

        // 模拟延迟
        function simulateDelay(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }
        
        // 更新页面统计信息
        async function updatePageStatistics(summary) {
            console.log('📊 [updatePageStatistics] 更新页面统计信息:', summary);
            
            try {
                // 检查token是否有效
                if (!isCurrentTokenValid()) {
                    console.log('🔄 Token即将过期，先刷新token');
                    const tokenRefreshSuccess = await attemptTokenRefreshSilent();
                    if (!tokenRefreshSuccess) {
                        console.error('❌ Token刷新失败，无法更新统计信息');
                        return;
                    }
                }
                
                // 获取最新的任务状态统计信息
                const response = await fetch('/api/mission_status_summary', {
                    method: 'GET',
                    credentials: 'same-origin',
                    headers: {
                        'Content-Type': 'application/json',
                        'Cache-Control': 'no-cache'
                    }
                });
                
                if (response.ok) {
                    const result = await response.json();
                    if (result.success && result.data) {
                        const missionStatus = result.data;
                        
                        // 更新任务状态统计信息
                        const missionStatusCards = document.querySelectorAll('.mission-status-info .info-card');
                        
                        // 更新已完成任务
                        if (missionStatus.completed && missionStatusCards[0]) {
                            const countElement = missionStatusCards[0].querySelector('.info-value');
                            const bountyElement = missionStatusCards[0].querySelector('.info-bounty');
                            if (countElement) countElement.textContent = missionStatus.completed.count;
                            if (bountyElement) {
                                bountyElement.textContent = new Intl.NumberFormat('zh-CN').format(missionStatus.completed.total_bounty) + ' ISK';
                            }
                        }
                        
                        // 更新已支付任务
                        if (missionStatus.paid && missionStatusCards[1]) {
                            const countElement = missionStatusCards[1].querySelector('.info-value');
                            const bountyElement = missionStatusCards[1].querySelector('.info-bounty');
                            if (countElement) countElement.textContent = missionStatus.paid.count;
                            if (bountyElement) {
                                bountyElement.textContent = new Intl.NumberFormat('zh-CN').format(missionStatus.paid.total_bounty) + ' ISK';
                            }
                        }
                        
                        // 更新已完结任务
                        if (missionStatus.done && missionStatusCards[2]) {
                            const countElement = missionStatusCards[2].querySelector('.info-value');
                            const bountyElement = missionStatusCards[2].querySelector('.info-bounty');
                            if (countElement) countElement.textContent = missionStatus.done.count;
                            if (bountyElement) {
                                bountyElement.textContent = new Intl.NumberFormat('zh-CN').format(missionStatus.done.total_bounty) + ' ISK';
                            }
                        }
                        
                        console.log('✅ [updatePageStatistics] 任务状态统计信息更新完成');
                    } else {
                        console.log('⚠️ [updatePageStatistics] 获取任务状态统计信息失败:', result.message);
                    }
                } else {
                    console.log('⚠️ [updatePageStatistics] 任务状态统计信息请求失败:', response.status);
                }
                
                // 更新血袭者LP点数
                console.log('🔄 [updatePageStatistics] 更新血袭者LP点数');
                try {
                    const lpResponse = await fetch('/api/blood_raider_lp', {
                        credentials: 'same-origin',
                        headers: {
                            'Content-Type': 'application/json',
                            'Cache-Control': 'no-cache'
                        }
                    });
                    if (lpResponse.ok) {
                        const lpResult = await lpResponse.json();
                        if (lpResult.success) {
                            // 更新血袭者LP点数显示
                            const infoCards = document.querySelectorAll('.info-card');
                            if (infoCards.length > 2) {
                                const lpCard = infoCards[2].querySelector('.info-value');
                                if (lpCard) {
                                    lpCard.textContent = new Intl.NumberFormat('zh-CN').format(lpResult.blood_raider_lp);
                                }
                            }
                            
                            // 更新意林奸商价计算
                            updateBloodRaiderLPCalculation();
                            
                            console.log('✅ [updatePageStatistics] 血袭者LP点数更新完成:', lpResult.blood_raider_lp);
                        } else {
                            console.log('⚠️ [updatePageStatistics] 获取血袭者LP点数失败:', lpResult.message);
                        }
                    } else {
                        console.log('⚠️ [updatePageStatistics] 血袭者LP点数请求失败:', lpResponse.status);
                    }
                } catch (error) {
                    console.error('❌ [updatePageStatistics] 更新血袭者LP点数时出错:', error);
                }
                
                // 刷新已支付任务表格
                console.log('🔄 [updatePageStatistics] 刷新已支付任务表格');
                loadPaidMissionsData();
                
                // 刷新钱包捐赠表格
                console.log('🔄 [updatePageStatistics] 刷新钱包捐赠表格');
                loadWalletDonationsData();
                
                // 刷新表格数据
                initTables();
                
            } catch (error) {
                console.error('❌ [updatePageStatistics] 更新统计信息时出错:', error);
            }
        }
       
        
        // 自动更新功能
        function startAutoUpdate() {
            // 清除现有的定时器（如果有）
            stopAutoUpdate();
            
            // 设置新的定时器，每3分钟自动更新一次（与session保活同步）
            autoUpdateTimer = setInterval(async () => {
                // 首先检查EVE token状态
                const eveTokenExpires = getCurrentTokenExpires();
                if (eveTokenExpires) {
                    const expiresTime = new Date(eveTokenExpires);
                    const now = new Date();
                    const timeLeft = Math.floor((expiresTime - now) / 1000 / 60);
                    
                    // 如果token在5分钟内过期，先尝试刷新
                    if (timeLeft <= 5) {
                        console.log(`⚠️ [autoUpdate] EVE token即将过期，剩余${timeLeft}分钟，尝试刷新`);
                        const refreshSuccess = await attemptTokenRefreshSilent();
                        if (!refreshSuccess) {
                            console.error('❌ [autoUpdate] Token刷新失败，跳过本次更新');
                            return;
                        }
                    }
                }
                
                // 检查是否有保存的凭据
                if (bloodCredentials.username && bloodCredentials.password) {
                    // 静默更新数据
                    startDataUpdate(bloodCredentials.username, bloodCredentials.password, true);
                }
            }, 3 * 60 * 1000); // 改为3分钟，与session保活同步
            
            console.log('自动更新已启动（每3分钟，与session保活同步）');
        }
        
        // 停止自动更新
        function stopAutoUpdate() {
            if (autoUpdateTimer) {
                clearInterval(autoUpdateTimer);
                autoUpdateTimer = null;
                console.log('自动更新已停止');
            }
        }

        // 打开设置弹窗
        function openSettingsModal() {
            settingsModal.classList.add('show');
            cooperativeRateInput.value = '';
            cooperativeRateInput.focus();
        }

        // 关闭设置弹窗
        function closeSettingsModalFunc() {
            settingsModal.classList.remove('show');
        }

        // 绑定事件
        settingsBtnLoggedIn.onclick = function(e) {
            e.stopPropagation(); // 阻止冒泡，防止关闭下拉菜单
            openSettingsModal();
        };
        closeSettingsModal.onclick = closeSettingsModalFunc;
        cancelSettings.onclick = closeSettingsModalFunc;



        // 更新血袭者LP点数计算
        function updateBloodRaiderLPCalculation() {
            const infoCards = document.querySelectorAll('.info-card');
            let currentRate = 2200; // 默认比率
            
            // 获取当前设置的比率
            if (infoCards.length > 1) {
                const cooperativeCard = infoCards[1].querySelector('.info-value');
                if (cooperativeCard) {
                    currentRate = parseFloat(cooperativeCard.textContent) || 2200;
                }
            }
            
            // 获取血袭者LP点数
            let bloodRaiderLP = 0;
            if (infoCards.length > 2) {
                const lpCard = infoCards[2].querySelector('.info-value');
                if (lpCard) {
                    // 移除千分位分隔符并转换为数字
                    bloodRaiderLP = parseFloat(lpCard.textContent.replace(/,/g, '')) || 0;
                }
            }
            
            // 更新计算结果
            if (infoCards.length > 3) {
                const calculationCard = infoCards[3].querySelector('.info-value');
                if (calculationCard) {
                    const calculatedValue = currentRate * bloodRaiderLP;
                    calculationCard.textContent = new Intl.NumberFormat('zh-CN').format(Math.round(calculatedValue));
                }
            }
        }

        // 处理表单提交
        settingsForm.addEventListener('submit', (e) => {
            e.preventDefault();

            const newRate = parseFloat(cooperativeRateInput.value);

            if (isNaN(newRate) || newRate <= 0) {
                showMessage('请输入有效的比率数值', 'error');
                return;
            }

            // 更新显示的比率
            const infoCards = document.querySelectorAll('.info-card');
            if (infoCards.length > 1) {
                const cooperativeCard = infoCards[1].querySelector('.info-value');
                if (cooperativeCard) {
                    cooperativeCard.textContent = newRate;
                }
            }

            // 更新当前比率显示
            currentRateSpan.textContent = newRate;

            // 更新血袭者LP点数计算
            updateBloodRaiderLPCalculation();

            // 保存到本地存储
            localStorage.setItem('cooperativeRate', newRate);

            showMessage('合作社比率设置成功', 'success');
            closeSettingsModalFunc();
        });



        // 页面加载时恢复保存的比率
        window.addEventListener('DOMContentLoaded', () => {
            const savedRate = localStorage.getItem('cooperativeRate');
            if (savedRate) {
                const infoCards = document.querySelectorAll('.info-card');
                if (infoCards.length > 1) {
                    const cooperativeCard = infoCards[1].querySelector('.info-value');
                    if (cooperativeCard) {
                        cooperativeCard.textContent = savedRate;
                    }
                }
                currentRateSpan.textContent = savedRate;
                
                // 页面加载时也更新血袭者LP点数计算
                setTimeout(() => {
                    updateBloodRaiderLPCalculation();
                }, 100);
            }
        });

        // 定期检查凭据状态
        setInterval(() => {
            const credentials = localStorage.getItem('bloodCredentials');
            if (!credentials && bloodCredentials.username) {
                console.warn('⚠️ 检测到凭据丢失，尝试恢复');
                // 尝试从内存恢复到存储
                if (bloodCredentials.username && bloodCredentials.password) {
                    saveCredentials(bloodCredentials.username, bloodCredentials.password);
                }
            }
        }, 30000); // 每30秒检查一次

        // 从已支付任务表格中移除指定支付者的行
        function removePayerFromTable(payer) {
            const tbody = document.querySelector('#paidMissionsTable tbody');
            const rows = tbody.querySelectorAll('tr');
            
            rows.forEach(row => {
                const payerCell = row.querySelector('td:first-child');
                if (payerCell && payerCell.textContent.trim() === payer) {
                    row.remove();
                }
            });
            
            // 如果表格为空，显示暂无数据
            if (tbody.children.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; color: #666;">暂无数据</td></tr>';
            }
        }

        // 标记任务为完成状态
async function markMissionsAsDone(payer, missionIds) {
    try {
        // 通过后端API代理请求，避免CORS问题
        const response = await fetch('/api/mark_missions_done', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            credentials: 'same-origin',
            body: JSON.stringify({
                mission_ids: missionIds
            })
        });
        
        if (!response.ok) {
            throw new Error(`请求失败: ${response.status}`);
        }
        
        const result = await response.json();
        
        if (result.success) {
            // 后端处理成功后再从前端移除对应的支付者行
            removePayerFromTable(payer);
            
            const successCount = result.results.filter(r => r.status === 'success').length;
            const failCount = result.results.length - successCount;
            showMessage(`任务标记完成！成功: ${successCount}个，失败: ${failCount}个`, 'success');
            
            // 关闭弹窗
            closePayerMatchModal();
            closePayerNoMatchModal();
            
            // 只更新统计信息，不重新加载整个表格
            updatePageStatistics();
        } else {
            // 如果后端处理失败，显示错误消息
            showMessage('标记任务失败: ' + result.message, 'error');
        }
        
    } catch (error) {
        console.error('标记任务完成时出错:', error);
        showMessage('标记任务完成失败: ' + error.message, 'error');
    }
}
        
        // 添加模糊名称匹配函数
        function fuzzyNameMatch(donor, payer) {
            if (!donor || !payer) return false;
            
            const donorLower = donor.toLowerCase().trim();
            const payerLower = payer.toLowerCase().trim();
            
            // 1. 完全匹配
            if (donorLower === payerLower) return true;
            
            // 2. 包含匹配（双向）
            if (donorLower.includes(payerLower) || payerLower.includes(donorLower)) return true;
            
            // 3. 去除空格后匹配
            const donorNoSpace = donorLower.replace(/\s+/g, '');
            const payerNoSpace = payerLower.replace(/\s+/g, '');
            if (donorNoSpace.includes(payerNoSpace) || payerNoSpace.includes(donorNoSpace)) return true;
            
            // 4. 计算编辑距离相似度
            const similarity = calculateSimilarity(donorLower, payerLower);
            return similarity > 0.7; // 相似度阈值70%
        }

        // 计算字符串相似度（基于编辑距离）
        function calculateSimilarity(str1, str2) {
            const maxLength = Math.max(str1.length, str2.length);
            if (maxLength === 0) return 1;
            
            const distance = levenshteinDistance(str1, str2);
            return (maxLength - distance) / maxLength;
        }

        // 计算编辑距离
        function levenshteinDistance(str1, str2) {
            const matrix = [];
            
            for (let i = 0; i <= str2.length; i++) {
                matrix[i] = [i];
            }
            
            for (let j = 0; j <= str1.length; j++) {
                matrix[0][j] = j;
            }
            
            for (let i = 1; i <= str2.length; i++) {
                for (let j = 1; j <= str1.length; j++) {
                    if (str2.charAt(i - 1) === str1.charAt(j - 1)) {
                        matrix[i][j] = matrix[i - 1][j - 1];
                    } else {
                        matrix[i][j] = Math.min(
                            matrix[i - 1][j - 1] + 1, // 替换
                            matrix[i][j - 1] + 1,     // 插入
                            matrix[i - 1][j] + 1      // 删除
                        );
                    }
                }
            }
            
            return matrix[str2.length][str1.length];
        }

        // 🆕 智能数据更新策略
        async function smartDataUpdate() {
            try {
                // 检查ESI缓存头动态调整更新频率
                const lastExpires = localStorage.getItem('lastEsiExpires');
                if (lastExpires) {
                    const expiresTime = new Date(lastExpires);
                    const now = new Date();
                    if (now < expiresTime) {
                        console.log(`⏰ ESI缓存未过期，${Math.ceil((expiresTime - now) / 60000)}分钟后重试`);
                        return;
                    }
                }
                
                // 检查数据新鲜度 - 修改为基于UTC+8时区的比较
                const lastUpdate = localStorage.getItem('lastWalletUpdate');
                const now = Date.now();
                const updateInterval = 30 * 60 * 1000; // 修改为30分钟间隔
                
                if (lastUpdate) {
                    // 获取最新的钱包数据进行时间比较
                    const walletResponse = await fetch('/api/recent_wallet_donations', {
                        method: 'GET',
                        credentials: 'same-origin',
                        headers: {
                            'Content-Type': 'application/json',
                            'Cache-Control': 'no-cache'
                        }
                    });
                    
                    if (walletResponse.ok) {
                        const walletData = await walletResponse.json();
                        if (walletData.success && walletData.data && walletData.data.length > 0) {
                            const latestEntry = walletData.data[0];
                            
                            // 🔧 修复：直接使用UTC时间，不要手动添加8小时
                            const entryTime = new Date(latestEntry.date || latestEntry.timestamp);
                            const currentTime = new Date();
                            const timeDiff = (currentTime - entryTime) / 1000 / 60; // 分钟差
                            
                            if (timeDiff < 30) {
                                console.log(`📊 数据仍然新鲜(${timeDiff.toFixed(1)}分钟前)，跳过更新`);
                                return;
                            } else {
                                console.log(`⏰ 数据已过期(${timeDiff.toFixed(1)}分钟前)，需要更新`);
                            }
                        }
                    }
                }
                
                // 检查ESI错误限制
                const errorCount = parseInt(localStorage.getItem('esiErrorCount') || '0');
                if (errorCount >= 5) {
                    const lastError = parseInt(localStorage.getItem('lastEsiError') || '0');
                    const errorCooldown = 30 * 60 * 1000; // 30分钟冷却
                    if ((now - lastError) < errorCooldown) {
                        console.log('⚠️ ESI错误过多，等待冷却期结束');
                        return;
                    } else {
                        localStorage.removeItem('esiErrorCount');
                        localStorage.removeItem('lastEsiError');
                    }
                }
                
                // 执行增量更新并保存新的Expires时间
                const response = await fetch('/api/wallet_incremental_update', {
                    method: 'POST',
                    credentials: 'same-origin',
                    headers: {
                        'Content-Type': 'application/json',
                        'Cache-Control': 'no-cache'
                    },
                    body: JSON.stringify({
                        force_refresh: false,
                        last_update: lastUpdate
                    })
                });
                
                // 保存ESI缓存过期时间
                const expires = response.headers.get('Expires');
                if (expires) {
                    localStorage.setItem('lastEsiExpires', expires);
                    console.log(`📅 ESI缓存过期时间: ${expires}`);
                }
                
                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        localStorage.setItem('lastWalletUpdate', now.toString());
                        console.log('✅ 增量数据更新成功');
                        
                        // 🔧 修复：无论是否有新数据都刷新界面，确保显示最新状态
                        console.log(`📊 本次更新获取到 ${result.new_entries || 0} 条新记录，刷新界面`);
                        loadWalletDonationsData();
                        loadPaidMissionsData();
                        
                        // 🔧 增加延迟确保数据库写入完成
                        setTimeout(() => {
                            loadWalletDonationsData();
                            loadPaidMissionsData();
                            console.log('🔄 延迟刷新界面完成');
                        }, 2000);
                    }
                }
                
            } catch (error) {
                console.error('❌ 智能数据更新失败:', error);
                // 记录错误
                const errorCount = parseInt(localStorage.getItem('esiErrorCount') || '0') + 1;
                localStorage.setItem('esiErrorCount', errorCount.toString());
                localStorage.setItem('lastEsiError', Date.now().toString());
            }
        }

        // 🆕 优化的自动更新
        function startOptimizedAutoUpdate() {
            // 使用更智能的更新间隔
            const updateInterval = 3 * 60 * 1000; // 3分钟基础间隔
            
            setInterval(async () => {
                if (currentUser && isCurrentTokenValid()) {
                    await smartDataUpdate();
                }
            }, updateInterval);
            
            // 🆕 页面可见性变化时的处理
            document.addEventListener('visibilitychange', () => {
                if (!document.hidden && currentUser) {
                    // 页面重新可见时检查是否需要更新
                    setTimeout(smartDataUpdate, 1000);
                }
            });
        }

        // 将函数暴露到全局作用域，以便HTML中的onclick可以访问
        window.viewPayerDetails = viewPayerDetails;
        window.closePayerMatchModal = closePayerMatchModal;
        window.closePayerNoMatchModal = closePayerNoMatchModal;
        window.refreshWalletDataAndRetry = refreshWalletDataAndRetry;
        window.generateMatchResultsList = generateMatchResultsList;
        window.showPayerMatchResults = showPayerMatchResults;
        window.markMissionsAsDone = markMissionsAsDone;
        window.fuzzyNameMatch = fuzzyNameMatch;
        window.calculateSimilarity = calculateSimilarity;
        window.levenshteinDistance = levenshteinDistance;
        // 将函数暴露到全局作用域，以便HTML中的onclick可以访问
        window.viewPayerDetails = viewPayerDetails;
        window.closePayerMatchModal = closePayerMatchModal;
        window.closePayerNoMatchModal = closePayerNoMatchModal;
        window.refreshWalletDataAndRetry = refreshWalletDataAndRetry;
        window.generateMatchResultsList = generateMatchResultsList;
        window.showPayerMatchResults = showPayerMatchResults;
        window.markMissionsAsDone = markMissionsAsDone;
        window.fuzzyNameMatch = fuzzyNameMatch;
        window.calculateSimilarity = calculateSimilarity;
        window.levenshteinDistance = levenshteinDistance;
        window.attemptTokenRefresh = attemptTokenRefresh;
        window.attemptTokenRefreshSilent = attemptTokenRefreshSilent;
        window.checkEveTokenOnPageLoad = checkEveTokenOnPageLoad;
        window.smartDataUpdate = smartDataUpdate;
        window.startOptimizedAutoUpdate = startOptimizedAutoUpdate;
        window.initializeBasicUI = initializeBasicUI;
        window.showSkeletonScreens = showSkeletonScreens;
        window.initTablesAsync = initTablesAsync;
        window.removeSkeletonScreens = removeSkeletonScreens;
        window.showLoadingIndicator = showLoadingIndicator;
        window.hideLoadingIndicator = hideLoadingIndicator;

        // 夜间模式切换功能
        function toggleTheme() {
            const body = document.body;
            const themeIcon = document.getElementById('theme-icon');
            const currentTheme = body.getAttribute('data-theme');
            
            if (currentTheme === 'dark') {
                body.removeAttribute('data-theme');
                themeIcon.textContent = '🌙';
                localStorage.setItem('theme', 'light');
            } else {
                body.setAttribute('data-theme', 'dark');
                themeIcon.textContent = '☀️';
                localStorage.setItem('theme', 'dark');
            }
        }

        // 页面加载时应用保存的主题
        document.addEventListener('DOMContentLoaded', function() {
            const savedTheme = localStorage.getItem('theme');
            const themeIcon = document.getElementById('theme-icon');
            
            if (savedTheme === 'dark') {
                document.body.setAttribute('data-theme', 'dark');
                themeIcon.textContent = '☀️';
            } else {
                themeIcon.textContent = '🌙';
            }
        });

        // 将夜间模式切换函数暴露到全局作用域
        window.toggleTheme = toggleTheme;

    </script>

    <style>
        /* 夜间模式切换按钮样式 - 已注释掉 */
        /* .theme-toggle {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 50px;
            height: 50px;
            border: none;
            border-radius: 50%;
            background: linear-gradient(135deg, #1976d2, #42a5f5);
            color: white;
            font-size: 20px;
            cursor: pointer;
            box-shadow: 0 4px 16px rgba(25, 118, 210, 0.3);
            transition: all 0.3s ease;
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .theme-toggle:hover {
            background: linear-gradient(135deg, #1565c0, #64b5f6);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(25, 118, 210, 0.4);
        }

        .theme-toggle:active {
            transform: translateY(0);
        } */

        [data-theme="dark"] .navbar-brand,
        [data-theme="dark"] .navbar-item {
            color: #e0e0e0;
        }

        [data-theme="dark"] .navbar-item:hover {
            color: #64b5f6;
        }

        [data-theme="dark"] .content-area {
            background-color: #121212;
        }

        [data-theme="dark"] .info-card {
            background: linear-gradient(135deg, #1e1e1e, #2a2a2a);
            border-color: #333;
            color: #e0e0e0;
        }

        [data-theme="dark"] .info-card:hover {
            background: linear-gradient(135deg, #2a2a2a, #333);
            border-color: #64b5f6;
        }

        [data-theme="dark"] .info-label {
            color: #b0b0b0;
        }

        [data-theme="dark"] .info-value {
            color: #64b5f6;
        }

        [data-theme="dark"] .table-section {
            background: #1e1e1e;
        }

        [data-theme="dark"] .data-table {
            background: #1a1a1a;
        }

        [data-theme="dark"] .data-table th {
            background: linear-gradient(135deg, #1565c0, #1976d2);
        }

        [data-theme="dark"] .data-table td {
            border-bottom-color: #333;
            color: #e0e0e0;
        }

        [data-theme="dark"] .data-table tbody tr:hover {
            background-color: #2a2a2a;
        }

        [data-theme="dark"] .modal-content {
            background: #1e1e1e;
            color: #e0e0e0;
        }

        [data-theme="dark"] .modal-content h2 {
            color: #64b5f6;
        }

        [data-theme="dark"] .modal-content input {
            background: #2a2a2a;
            border-color: #444;
            color: #e0e0e0;
        }

        [data-theme="dark"] .modal-content input:focus {
            border-color: #64b5f6;
        }

        [data-theme="dark"] .user-dropdown {
            background: #1e1e1e;
            border: 1px solid #333;
        }

        [data-theme="dark"] .dropdown-item {
            color: #e0e0e0;
        }

        [data-theme="dark"] .dropdown-item:hover {
            background: #2a2a2a;
        }

        [data-theme="dark"] .user-info {
            background: #2a2a2a;
        }

        [data-theme="dark"] .user-info:hover {
            background: #2a2a2a;
        }

        /* 弹窗夜间模式样式 */
        [data-theme="dark"] .message-modal {
            background: rgba(0, 0, 0, 0.6);
        }

        [data-theme="dark"] .message-content {
            background: #1e1e1e;
            color: #e0e0e0;
            box-shadow: 0 12px 30px rgba(0, 0, 0, 0.3);
        }

        [data-theme="dark"] .message-text {
            color: #e0e0e0;
        }

        /* 支付者匹配弹窗夜间模式 */
        [data-theme="dark"] .payer-match-modal {
            background: #1e1e1e;
            color: #e0e0e0;
        }

        [data-theme="dark"] .modal-header {
            border-bottom-color: #333;
        }

        [data-theme="dark"] .modal-header h3 {
            color: #64b5f6;
        }

        [data-theme="dark"] .match-info {
            background: #2a2a2a;
            border-left-color: #64b5f6;
        }

        [data-theme="dark"] .match-info h4 {
            color: #64b5f6;
        }

        [data-theme="dark"] .match-info p {
            color: #b0b0b0;
        }

        [data-theme="dark"] .detail-item strong {
            color: #e0e0e0;
        }

        [data-theme="dark"] .modal-footer {
            border-top-color: #333;
        }

        /* 匹配失败弹窗夜间模式 */
        [data-theme="dark"] .no-match-modal {
            background: linear-gradient(135deg, #1e1e1e 0%, #2a2a2a 100%);
        }

        [data-theme="dark"] .modal-body-enhanced {
            background: #1e1e1e;
        }

        [data-theme="dark"] .payer-info-card {
            background: #2a2a2a;
            border-color: #444;
        }

        [data-theme="dark"] .info-row {
            border-bottom-color: #333;
        }

        [data-theme="dark"] .info-label {
            color: #b0b0b0;
        }

        [data-theme="dark"] .info-value {
            color: #e0e0e0;
        }

        [data-theme="dark"] .info-value.amount {
            color: #4caf50;
        }

        [data-theme="dark"] .reasons-section h4,
        [data-theme="dark"] .suggestions-section h4 {
            color: #e0e0e0;
        }

        [data-theme="dark"] .reason-item {
            background: #333;
            border-left-color: #ffb74d;
        }

        [data-theme="dark"] .suggestion-text {
            color: #b0b0b0;
        }

        /* 增强按钮夜间模式 */
        [data-theme="dark"] .btn-enhanced {
            color: #e0e0e0;
        }

        [data-theme="dark"] .btn-secondary-enhanced {
            background: linear-gradient(135deg, #444 0%, #555 100%);
            color: #e0e0e0;
        }

        [data-theme="dark"] .btn-secondary-enhanced:hover {
            background: linear-gradient(135deg, #555 0%, #666 100%);
        }

        /* 通用弹窗背景夜间模式 */
        [data-theme="dark"] .modal {
            background-color: rgba(0, 0, 0, 0.6);
        }

        /* 表单元素夜间模式 */
        [data-theme="dark"] .form-control {
            background: #2a2a2a;
            border-color: #444;
            color: #e0e0e0;
        }

        [data-theme="dark"] .form-control:focus {
            border-color: #64b5f6;
            box-shadow: 0 0 0 0.2rem rgba(100, 181, 246, 0.25);
        }

        [data-theme="dark"] .form-label {
            color: #e0e0e0;
        }

        /* 关闭按钮夜间模式 */
        [data-theme="dark"] .close {
            color: #e0e0e0;
            opacity: 0.8;
        }

        [data-theme="dark"] .close:hover {
            color: #64b5f6;
            opacity: 1;
        }

        [data-theme="dark"] .close-btn {
            color: rgba(255, 255, 255, 0.9);
        }

        [data-theme="dark"] .close-btn:hover {
            color: white;
        }

        [data-theme="dark"] .theme-toggle {
            background: linear-gradient(135deg, #ff9800, #ffb74d);
            box-shadow: 0 4px 16px rgba(255, 152, 0, 0.3);
        }

        [data-theme="dark"] .theme-toggle:hover {
            background: linear-gradient(135deg, #f57c00, #ffa726);
            box-shadow: 0 6px 20px rgba(255, 152, 0, 0.4);
        }

        /* 夜间模式下的加载指示器样式 */
        [data-theme="dark"] .loading-indicator {
            background: #2a2a2a;
            border: 1px solid #444;
            color: #e0e0e0;
        }

        [data-theme="dark"] .spinner {
            border: 3px solid #444;
            border-top: 3px solid #64b5f6;
        }

        /* 如果没有data-theme属性，也可以使用媒体查询 */
        @media (prefers-color-scheme: dark) {
            .loading-indicator {
                background: #2a2a2a !important;
                border: 1px solid #444 !important;
                color: #e0e0e0 !important;
            }
            
            .spinner {
                border: 3px solid #444 !important;
                border-top: 3px solid #64b5f6 !important;
            }
        }

        /* 表格夜间模式补充样式 */
        [data-theme="dark"] .table-section h4 {
            color: #64b5f6;
        }

        [data-theme="dark"] .data-table .amount {
            color: #4caf50;
            font-weight: 600;
        }

        [data-theme="dark"] .data-table .count {
            color: #64b5f6;
            font-weight: 600;
        }

        [data-theme="dark"] .table-wrapper {
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }

        [data-theme="dark"] .action-btn.view-btn {
            background: linear-gradient(135deg, #1976d2, #42a5f5);
        }

        [data-theme="dark"] .action-btn.view-btn:hover {
            background: linear-gradient(135deg, #1565c0, #64b5f6);
        }

        /* 确保表格在夜间模式下的边框可见性 */
        [data-theme="dark"] .data-table {
            border: 1px solid #333;
        }

        [data-theme="dark"] .table-wrapper {
            border: 1px solid #333;
            border-radius: 8px;
        }

        /* 角落弹窗样式 */
        .corner-notification {
            position: fixed;
            bottom: 20px;
            left: 20px;
            z-index: 2000;
            background: #fff;
            padding: 16px 20px;
            border-radius: 12px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
            max-width: 350px;
            min-width: 280px;
            display: flex;
            align-items: center;
            gap: 12px;
            transform: translateX(-100%);
            opacity: 0;
            transition: all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            border-left: 4px solid #2196f3;
        }

        /* 匹配记录列表夜间模式样式 */
        [data-theme="dark"] .match-records-list {
            background: #1e1e1e;
        }

        [data-theme="dark"] .match-record-item {
            background: #2a2a2a;
            border-color: #444;
            color: #e0e0e0;
        }

        [data-theme="dark"] .match-record-item:hover {
            background: #333;
            border-color: #64b5f6;
        }

        [data-theme="dark"] .record-header {
            border-bottom-color: #444;
        }

        [data-theme="dark"] .record-number {
            background: #64b5f6;
            color: #1e1e1e;
        }

        [data-theme="dark"] .record-donor {
            color: #64b5f6;
        }

        [data-theme="dark"] .record-amount {
            color: #4caf50;
        }

        [data-theme="dark"] .record-details {
            color: #b0b0b0;
        }

        [data-theme="dark"] .detail-item {
            color: #b0b0b0;
        }

        [data-theme="dark"] .no-match {
            color: #b0b0b0;
        }

        .corner-notification.show {
            transform: translateX(0);
            opacity: 1;
        }

        .corner-notification.fade-out {
            transform: translateX(-100%);
            opacity: 0;
        }

        .corner-notification-icon {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: bold;
            flex-shrink: 0;
        }

        .corner-notification-icon.success {
            background: #4caf50;
            color: #fff;
        }

        .corner-notification-icon.success::before {
            content: '✓';
        }

        .corner-notification-icon.error {
            background: #f44336;
            color: #fff;
        }

        .corner-notification-icon.error::before {
            content: '✕';
        }

        .corner-notification-icon.info {
            background: #2196f3;
            color: #fff;
        }

        .corner-notification-icon.info::before {
            content: 'i';
        }

        .corner-notification-icon.warning {
            background: #ff9800;
            color: #fff;
        }

        .corner-notification-icon.warning::before {
            content: '⚠';
        }

        .corner-notification-text {
            font-size: 14px;
            color: #333;
            line-height: 1.4;
            flex: 1;
        }

        .corner-notification.success {
            border-left-color: #4caf50;
        }

        .corner-notification.error {
            border-left-color: #f44336;
        }

        .corner-notification.warning {
            border-left-color: #ff9800;
        }

        /* 夜间模式样式 */
        [data-theme="dark"] .corner-notification {
            background: #2a2a2a;
            color: #e0e0e0;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.4);
        }

        [data-theme="dark"] .corner-notification-text {
            color: #e0e0e0;
        }

        /* 响应式设计 */
        @media (max-width: 768px) {
            .theme-toggle {
                bottom: 20px;
                right: 20px;
                width: 45px;
                height: 45px;
                font-size: 18px;
            }
        }
    </style>
</body>

</html>