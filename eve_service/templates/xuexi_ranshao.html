<!DOCTYPE html>
<html lang="zh">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>血袭燃烧</title>
    <link rel="icon" href="{{ url_for('static', filename='favicon.ico') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css', v='1.0') }}">
</head>

<body>
    <nav class="navbar">
        <div class="navbar-container">
            <a href="/" class="navbar-brand">EVE 工具集</a>
            <div class="navbar-menu">
                <a href="/price_history" class="navbar-item">价格查询</a>
                <a href="/xuexi_ranshao" class="navbar-item">血袭燃烧</a>
                <!-- EVE SSO 认证按钮 -->
                {% if session and session.get('eve_character_name') %}
                    <span class="navbar-item">{{ session.get('eve_character_name') }}</span>
                    <a href="/auth/logout" class="navbar-item">退出</a>
                {% else %}
                    <a href="/auth/login" class="navbar-item">EVE SSO 登录</a>
                {% endif %}
            </div>
        </div>
    </nav>

    <!-- 用户操作区域 -->
    <div id="userArea" class="user-area">
        <!-- 未登录状态 -->
        <div id="guestArea" class="guest-area">
            <button id="loginBtn" class="auth-btn login-btn">登录</button>
            <button id="registerBtn" class="auth-btn register-btn">注册</button>
        </div>

        <!-- 已登录状态 -->
        <div id="userProfile" class="user-profile" style="display: none;">

            <div class="user-avatar" id="userAvatar">
                <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23fff'%3E%3Cpath d='M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z'/%3E%3C/svg%3E"
                    alt="用户头像">
                <span class="username" id="displayUsername"></span>
                <span class="dropdown-arrow">▼</span>
            </div>
            <div class="user-dropdown" id="userDropdown">
                <div class="dropdown-item user-info">
                    <div class="user-details">
                        <div class="user-name" id="dropdownUsername"></div>
                        <div class="user-level" id="userLevel"></div>
                    </div>
                </div>
                <div class="dropdown-divider"></div>
                <!-- 设置比率按钮 -->
                <button class="dropdown-item settings-item" id="settingsBtnLoggedIn">
                    <span class="settings-icon">⚙️</span>
                    设置比率
                </button>
                <!-- 更新数据按钮 -->
                <button class="dropdown-item update-data-item" id="updateDataBtn">
                    <span class="update-icon">🔄</span>
                    更新数据
                </button>
                <!-- 强制刷新按钮 -->
                <button class="dropdown-item force-refresh-item" id="forceRefreshBtn">
                    <span class="refresh-icon">🔄</span>
                    强制刷新
                </button>
                <div class="dropdown-divider"></div>
                <button class="dropdown-item logout-btn" id="logoutBtn">
                    <span class="logout-icon">🚪</span>
                    退出登录
                </button>
            </div>
        </div>
    </div>

    <main>
        <!-- 登录弹窗 -->
        <div id="loginModal" class="modal">
            <div class="modal-content">
                <span class="close" id="closeModal">&times;</span>
                <h2>用户登录</h2>
                <div class="modal-body">
                    <form id="loginForm" action="/xuexi_ranshao/login" method="POST">
                        <div class="mb-3">
                            <label for="username" class="form-label">用户名</label>
                            <input type="text" class="form-control" id="username" name="username" required>
                        </div>
                        <div class="mb-3">
                            <label for="password" class="form-label">密码</label>
                            <input type="password" class="form-control" id="password" name="password" required>
                        </div>
                        <div class="mb-3 form-check">
                            <input type="checkbox" class="form-check-input" id="rememberMe" name="rememberMe">
                            <label class="form-check-label" for="rememberMe">记住我（保持登录状态30天）</label>
                        </div>
                        <button type="submit" class="btn btn-primary">登录</button>
                    </form>
                    <div class="switch-form">
                        <p>还没有账号？<a href="#" id="showRegister">立即注册</a></p>
                    </div>
                </div>
            </div>
        </div>

        <!-- 注册弹窗 -->
        <div id="registerModal" class="modal">
            <div class="modal-content">
                <span class="close" id="closeRegisterModal">&times;</span>
                <h2>用户注册</h2>
                <div class="modal-body">
                    <form id="registerForm" action="/xuexi_ranshao/register" method="POST">
                        <div class="mb-3">
                            <label for="regUsername" class="form-label">用户名</label>
                            <input type="text" class="form-control" id="regUsername" name="username" required>
                        </div>
                        <div class="mb-3">
                            <label for="regPassword" class="form-label">密码</label>
                            <input type="password" class="form-control" id="regPassword" name="password" required>
                        </div>
                        <div class="mb-3">
                            <label for="confirmPassword" class="form-label">确认密码</label>
                            <input type="password" class="form-control" id="confirmPassword" name="confirmPassword"
                                required>
                        </div>
                        <div class="mb-3">
                            <label for="regEmail" class="form-label">邮箱（可选）</label>
                            <input type="email" class="form-control" id="regEmail" name="email">
                        </div>
                        <button type="submit" class="btn btn-success">注册</button>
                    </form>
                    <div class="switch-form">
                        <p>已有账号？<a href="#" id="showLogin">立即登录</a></p>
                    </div>
                </div>
            </div>
        </div>

        <!-- 设置比率弹窗 -->
        <div id="settingsModal" class="modal">
            <div class="modal-content">
                <span class="close" id="closeSettingsModal">&times;</span>
                <h2>设置合作社回收比率</h2>
                <p>当前比率: <span id="currentRateSpan">2200</span></p>
                <div class="modal-body">
                    <form id="settingsForm">
                        <div class="mb-3">
                            <label for="cooperativeRate" class="form-label">新比率</label>
                            <input type="number" step="0.01" class="form-control" id="cooperativeRate" required>
                        </div>
                        <button type="submit" class="btn btn-primary">保存</button>
                        <button type="button" id="cancelSettings" class="btn btn-secondary">取消</button>
                    </form>
                </div>
            </div>
        </div>

        <!-- 自定义消息弹窗 -->
        <div id="messageModal" class="message-modal">
            <div class="message-content">
                <div class="message-icon" id="messageIcon"></div>
                <div class="message-text" id="messageText"></div>
                <button class="message-btn" id="messageBtn">确定</button>
            </div>
        </div>

        <!-- 更新数据弹窗 -->
        <div id="updateDataModal" class="modal">
            <div class="modal-content">
                <span class="close" id="closeUpdateDataModal">&times;</span>
                <h2>更新血袭合作社数据</h2>
                <div class="modal-body">
                    <form id="updateDataForm">
                        <div class="mb-3">
                            <label for="updateBloodUsername" class="form-label">血袭合作社用户名</label>
                            <input type="text" class="form-control" id="updateBloodUsername" required>
                        </div>
                        <div class="mb-3">
                            <label for="updateBloodPassword" class="form-label">血袭合作社密码</label>
                            <input type="password" class="form-control" id="updateBloodPassword" required>
                        </div>
                        <button type="submit" class="btn btn-primary">获取并更新数据</button>
                        <button type="button" id="cancelUpdateData" class="btn btn-secondary">取消</button>
                    </form>
                    <div id="updateLoadingIndicator" class="loading-indicator" style="display: none;">
                        <div class="spinner"></div>
                        <div>正在获取数据，请稍候...</div>
                    </div>
                    <!-- 添加更新状态显示区域 -->
                    <div id="updateStatusDisplay" class="update-status-display" style="display: none;">
                        <div class="update-progress">
                            <div class="progress-bar">
                                <div class="progress-fill" id="progressFill"></div>
                            </div>
                            <div class="progress-text" id="progressText">0%</div>
                        </div>
                        <div class="update-steps">
                            <div class="update-step" id="step1">
                                <div class="step-icon">1</div>
                                <div class="step-text">验证账户</div>
                            </div>
                            <div class="update-step" id="step2">
                                <div class="step-icon">2</div>
                                <div class="step-text">获取数据</div>
                            </div>
                            <div class="update-step" id="step3">
                                <div class="step-icon">3</div>
                                <div class="step-text">保存到数据库</div>
                            </div>
                            <div class="update-step" id="step4">
                                <div class="step-icon">4</div>
                                <div class="step-text">计算统计信息</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 页面内容区域 -->
        <div class="content-area">
            <div class="isk-lp-info">
                <a href="https://www.fuzzwork.co.uk/lpstore/buy/10000002/1000134" class="info-card-link" target="_blank" rel="noopener noreferrer">
                    <div class="info-card clickable">
                        <div class="info-label">实时jita ISK/LP 比率</div>
                        <div class="info-value">{{ max_isk_lp if max_isk_lp is defined else '0' }}</div>
                    </div>
                </a>
                <div class="info-card clickable" onclick="openSettingsModal()">
                    <div class="info-label">实时合作社回收 ISK/LP 比率</div>
                    <div class="info-value">2200</div>
                </div>
                <!-- 新增血袭者LP点数显示卡片 -->
                <div class="info-card">
                    <div class="info-label">血袭者LP点数</div>
                    <div class="info-value">{{ '{:,}'.format(blood_raider_lp) if blood_raider_lp is defined and blood_raider_lp else '0' }}</div>
                </div>
                <div class="info-card">
                    <div class="info-label">意林奸商价</div>
                    <div class="info-value">{{ '{:,.0f}'.format(2200 * blood_raider_lp) if blood_raider_lp is defined and blood_raider_lp else '0' }}</div>
                </div>
            </div>
            
            <!-- 任务状态信息 -->
            <div class="mission-status-info">
                <h3>任务状态统计</h3>
                <div class="isk-lp-info">  <!-- 复用现有的卡片布局样式 -->
                    {% if mission_status is defined and mission_status.completed %}
                    <div class="info-card">
                        <div class="info-label">已完成任务</div>
                        <div class="info-value">{{ mission_status.completed.count }}</div>
                        <div class="info-bounty">{{ '{:,.0f}'.format(mission_status.completed.total_bounty) }} ISK</div>
                    </div>
                    {% endif %}
                    
                    {% if mission_status is defined and mission_status.paid %}
                    <div class="info-card">
                        <div class="info-label">已支付任务</div>
                        <div class="info-value">{{ mission_status.paid.count }}</div>
                        <div class="info-bounty">{{ '{:,.0f}'.format(mission_status.paid.total_bounty) }} ISK</div>
                    </div>
                    {% endif %}
                    
                    {% if mission_status is defined and mission_status.done %}
                    <div class="info-card">
                        <div class="info-label">已完结任务</div>
                        <div class="info-value">{{ mission_status.done.count }}</div>
                        <div class="info-bounty">{{ '{:,.0f}'.format(mission_status.done.total_bounty) }} ISK</div>
                    </div>
                    {% endif %}
                </div>
            </div>
            
            <!-- 在任务状态统计下方添加 -->
            <div class="tables-container">
                <div class="table-section">
                    <h4>已支付任务汇总</h4>
                    <div class="table-wrapper">
                        <table id="paidMissionsTable" class="data-table">
                            <thead>
                                <tr>
                                    <th>老板账号</th>
                                    <th>任务数量</th>
                                    <th>总金额</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- 数据将通过JavaScript动态加载 -->
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="table-section">
                    <h4>最近钱包捐赠</h4>
                    <div class="table-wrapper">
                        <table id="walletDonationsTable" class="data-table">
                            <thead>
                                <tr>
                                    <th>捐赠人</th>
                                    <th>类型</th>
                                    <th>金额</th>
                                    <th>日期</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- 数据将通过JavaScript动态加载 -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            

        </div>
    </main>

    <style>
        .db-save-status {
            margin: 15px 0;
            padding: 12px;
            border-radius: 6px;
            font-weight: 500;
        }

        .db-save-status.success {
            background: #e8f5e9;
            color: #388e3c;
            border-left: 4px solid #4caf50;
        }

        .db-save-status.error {
            background: #ffebee;
            color: #d32f2f;
            border-left: 4px solid #f44336;
        }

        .btn-success:hover {
            background: linear-gradient(90deg, #2e7d32 0%, #81c784 100%) !important;
        }

        /* 添加取消按钮样式，与设置比率按钮保持一致 */
        .btn-secondary {
            background: linear-gradient(135deg, #4caf50, #66bb6a);
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            padding: 12px;
            margin-top: 8px;
            box-sizing: border-box;
            width: 100%;
        }

        .btn-secondary:hover {
            background: linear-gradient(135deg, #388e3c, #81c784);
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(76, 175, 80, 0.3);
        }
        
        /* 更新状态显示样式 */
        .update-status-display {
            margin-top: 20px;
            padding: 15px;
            background: #f5f5f5;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
        }

        .update-progress {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }

        .progress-bar {
            flex: 1;
            height: 10px;
            background: #e0e0e0;
            border-radius: 5px;
            overflow: hidden;
            margin-right: 10px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #1976d2, #42a5f5);
            width: 0%;
            transition: width 0.3s ease;
        }

        .progress-text {
            font-weight: bold;
            color: #1976d2;
            width: 40px;
            text-align: right;
        }

        .update-steps {
            display: flex;
            justify-content: space-between;
        }

        .update-step {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 22%;
        }

        .step-icon {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: #e0e0e0;
            color: #757575;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-bottom: 8px;
            transition: all 0.3s ease;
        }

        .step-text {
            font-size: 0.8em;
            color: #757575;
            text-align: center;
            transition: all 0.3s ease;
        }

        .update-step.active .step-icon {
            background: #1976d2;
            color: white;
        }

        .update-step.active .step-text {
            color: #1976d2;
            font-weight: bold;
        }

        .update-step.completed .step-icon {
            background: #4caf50;
            color: white;
        }

        .update-step.completed .step-text {
            color: #4caf50;
            font-weight: bold;
        }

        .update-step.error .step-icon {
            background: #f44336;
            color: white;
        }

        .update-step.error .step-text {
            color: #f44336;
            font-weight: bold;
        }

        .switch-form {
            margin-top: 20px;
            padding-top: 16px;
            border-top: 1px solid #eee;
        }

        .settings-item {
            color: #4caf50;
            font-weight: 500;
        }

        .settings-item:hover {
            background: #e8f5e9;
            color: #388e3c;
        }

        .settings-icon {
            font-size: 1.1em;
        }

        .update-data-item {
            color: #1976d2;
            font-weight: 500;
        }

        .update-data-item:hover {
            background: #e3f2fd;
            color: #1565c0;
        }

        .update-icon {
            font-size: 1.1em;
        }

        .force-refresh-item {
            color: #ff9800;
            font-weight: 500;
        }

        .force-refresh-item:hover {
            background: #fff3e0;
            color: #f57c00;
        }

        .refresh-icon {
            font-size: 1.1em;
        }

        /* ISK/LP 信息卡片样式 */
        .isk-lp-info {
            display: flex;
            gap: 20px;
            margin: 30px 0;
            flex-wrap: wrap;
        }

        .info-card-link {
            text-decoration: none;
            color: inherit;
            display: block;
            flex: 1;
        }

        .info-card {
            background: linear-gradient(135deg, #ffffff, #f8f9fa);
            border: 2px solid #e3f2fd;
            border-radius: 12px;
            padding: 20px;
            min-width: 200px;
            flex: 1;
            text-align: center;
            box-shadow: 0 4px 12px rgba(25, 118, 210, 0.1);
            transition: all 0.3s ease;
        }

        .info-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(25, 118, 210, 0.15);
            border-color: #1976d2;
        }

        .info-card.clickable {
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .info-card.clickable:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 25px rgba(25, 118, 210, 0.2);
            border-color: #1976d2;
            background: linear-gradient(135deg, #f8f9fa, #e3f2fd);
        }

        .info-card.clickable:active {
            transform: translateY(-2px);
        }

        .info-label {
            font-size: 0.9em;
            color: #666;
            margin-bottom: 8px;
            font-weight: 500;
        }

        .info-value {
            font-size: 1.8em;
            font-weight: bold;
            color: #1976d2;
            text-shadow: 0 1px 2px rgba(25, 118, 210, 0.1);
        }
        
        .info-bounty {
            font-size: 1em;
            color: #388e3c;
            margin-top: 5px;
            font-weight: 500;
        }
        
        /* 任务状态信息样式 */
        .mission-status-info {
            margin: 30px 0;
        }
        
        .mission-status-info h3 {
            color: #1976d2;
            margin-bottom: 15px;
            font-size: 1.3em;
        }
        
        .info-bounty {
            font-size: 1em;
            color: #388e3c;
            margin-top: 5px;
            font-weight: 500;
        }

        /* 响应式设计 */
        @media (max-width: 768px) {
            .isk-lp-info {
                flex-direction: column;
            }

            .info-card {
                min-width: auto;
            }
        }

        .tables-container {
            display: flex;
            gap: 20px;
            margin-top: 30px;
            width: 100%;
        }

        .table-section {
            flex: 1;
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .table-section h4 {
            margin: 0 0 15px 0;
            color: #333;
            font-size: 1.2em;
            text-align: center;
        }

        .table-wrapper {
            overflow-x: auto;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 8px;
            overflow: hidden;
        }

        .data-table th {
            background: linear-gradient(135deg, #1976d2, #42a5f5);
            color: white;
            padding: 12px 15px;
            text-align: left;
            font-weight: 600;
            font-size: 0.9em;
        }

        .data-table td {
            padding: 10px 15px;
            border-bottom: 1px solid #e0e0e0;
            color: #333;
        }

        .data-table tbody tr:hover {
            background-color: #f5f5f5;
        }

        .data-table tbody tr:last-child td {
            border-bottom: none;
        }

        .data-table .amount {
            color: #388e3c;
            font-weight: 500;
        }

        .data-table .count {
            color: #1976d2;
            font-weight: 500;
        }

        @media (max-width: 768px) {
            .tables-container {
                flex-direction: column;
            }
            
            .data-table {
                font-size: 0.8em;
            }
            
            .data-table th,
            .data-table td {
                padding: 8px 10px;
            }
        }

        /* 血袭数据区域样式 */
        .blood-data-section {
            margin-top: 40px;
            padding: 30px;
            background: #f8f9fa;
            border-radius: 12px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
        }

        .blood-data-section h2 {
            color: #1976d2;
            margin-bottom: 25px;
            font-size: 1.5em;
            display: inline-block;
            margin-right: 20px;
        }

        .data-controls {
            margin-bottom: 25px;
            display: inline-block;
            vertical-align: top;
        }

        .section-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 25px;
        }

        .credentials-input {
            display: grid;
            grid-template-columns: auto 1fr auto 1fr auto;
            gap: 15px;
            align-items: center;
            max-width: 700px;
        }

        .credentials-input label {
            font-weight: 600;
            color: #333;
        }

        .credentials-input input {
            padding: 10px 12px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 1em;
            transition: border-color 0.3s;
        }

        .credentials-input input:focus {
            border-color: #1976d2;
            outline: none;
        }

        .fetch-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            background: linear-gradient(135deg, #1976d2, #42a5f5);
            color: white;
        }

        .fetch-btn:hover {
            background: linear-gradient(135deg, #1565c0, #64b5f6);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(25, 118, 210, 0.3);
        }

        .summary-btn {
            background: linear-gradient(135deg, #388e3c, #66bb6a);
        }

        .summary-btn:hover {
            background: linear-gradient(135deg, #2e7d32, #81c784);
        }

        .loading-indicator {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 20px;
            background: #e3f2fd;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .spinner {
            width: 24px;
            height: 24px;
            border: 3px solid #e0e0e0;
            border-top: 3px solid #1976d2;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .data-display {
            background: white;
            border-radius: 8px;
            padding: 20px;
            min-height: 200px;
            border: 1px solid #e0e0e0;
        }

        .data-placeholder {
            text-align: center;
            color: #666;
            font-style: italic;
            padding: 40px 20px;
        }

        .data-content {
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            line-height: 1.6;
            white-space: pre-wrap;
            word-wrap: break-word;
            max-height: 600px;
            overflow-y: auto;
        }

        .error-message {
            color: #d32f2f;
            background: #ffebee;
            padding: 15px;
            border-radius: 6px;
            border-left: 4px solid #d32f2f;
        }

        /* 用户操作区域样式 */
        .user-area {
            position: absolute;
            top: 70px;
            right: 40px;
            z-index: 100;
        }

        /* 未登录状态样式 */
        .guest-area {
            display: flex;
            gap: 12px;
        }

        .auth-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 20px;
            font-size: 0.95em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .login-btn {
            background: linear-gradient(135deg, #1976d2, #42a5f5);
            color: white;
        }

        .login-btn:hover {
            background: linear-gradient(135deg, #1565c0, #64b5f6);
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(25, 118, 210, 0.3);
        }

        .register-btn {
            background: white;
            color: #1976d2;
            border: 2px solid #1976d2;
        }

        .register-btn:hover {
            background: #1976d2;
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(25, 118, 210, 0.3);
        }

        /* 已登录状态样式 */
        .user-profile {
            position: relative;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        /* 设置按钮样式 */
        .settings-btn {
            background: linear-gradient(135deg, #4caf50, #66bb6a);
            color: white;
        }

        .settings-btn:hover {
            background: linear-gradient(135deg, #388e3c, #81c784);
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(76, 175, 80, 0.3);
        }

        .user-avatar {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: linear-gradient(135deg, #1976d2, #42a5f5);
            color: white;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 12px rgba(25, 118, 210, 0.2);
        }

        .user-avatar:hover {
            background: linear-gradient(135deg, #1565c0, #64b5f6);
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(25, 118, 210, 0.3);
        }

        .user-avatar img {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            padding: 4px;
        }

        .username {
            font-weight: 600;
            font-size: 0.95em;
            max-width: 120px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .dropdown-arrow {
            font-size: 0.8em;
            transition: transform 0.3s ease;
        }

        .user-profile.active .dropdown-arrow {
            transform: rotate(180deg);
        }

        /* 下拉菜单样式 */
        .user-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            margin-top: 8px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
            min-width: 220px;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: all 0.3s ease;
            z-index: 1000;
        }

        .user-profile.active .user-dropdown {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .dropdown-item {
            padding: 12px 16px;
            border: none;
            background: none;
            width: 100%;
            text-align: left;
            cursor: pointer;
            transition: background 0.2s ease;
            display: flex;
            align-items: center;
            gap: 12px;
            line-height: 1; /* 添加这一行，统一行高 */
        }

        .dropdown-item:hover {
            background: #f5f5f5;
        }

        .dropdown-item:first-child {
            border-radius: 12px 12px 0 0;
        }

        .dropdown-item:last-child {
            border-radius: 0 0 12px 12px;
        }

        .user-info {
            cursor: default;
            background: #f8f9fa;
        }

        .user-info:hover {
            background: #f8f9fa;
        }

        .user-details {
            flex: 1;
        }

        .user-name {
            font-weight: 600;
            color: #333;
            font-size: 1em;
        }

        .user-level {
            font-size: 0.85em;
            color: #666;
            margin-top: 2px;
        }

        .dropdown-divider {
            height: 1px;
            background: #e0e0e0;
            margin: 0;
        }

        .logout-btn {
            color: #d32f2f;
            font-weight: 500;
        }

        .logout-btn:hover {
            background: #ffebee;
            color: #c62828;
        }

        .logout-icon {
            font-size: 1.1em;
        }

        /* 原有样式保持不变 */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.15);
            justify-content: center;
            align-items: center;
        }

        .modal.show {
            display: flex;
            animation: simpleModalFadeIn 0.15s ease-out forwards;
        }

        @keyframes simpleModalFadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        .modal-content {
            background: #fff;
            margin: auto;
            padding: 36px 32px 28px 32px;
            border-radius: 18px;
            width: 340px;
            box-shadow: 0 8px 24px rgba(25, 118, 210, 0.12);
            position: relative;
            text-align: center;
            /* 移除内容的单独动画，避免重复动画 */
            /* animation: modalFadeIn 0.3s; */
        }

        .close {
            position: absolute;
            right: 18px;
            top: 12px;
            font-size: 28px;
            color: #aaa;
            cursor: pointer;
            transition: color 0.2s;
        }

        .close:hover {
            color: #1976d2;
        }

        .modal-content h2 {
            margin-bottom: 24px;
            color: #1976d2;
            font-weight: bold;
            font-size: 1.5em;
        }

        .modal-content label {
            display: block;
            text-align: left;
            margin-bottom: 6px;
            color: #333;
            font-size: 1em;
        }

        .modal-content input {
            width: 100%;
            margin-bottom: 18px;
            padding: 10px 12px;
            border: 1.5px solid #bdbdbd;
            border-radius: 6px;
            font-size: 1.1em;
            transition: border 0.2s;
            box-sizing: border-box;
        }

        .modal-content input:focus {
            border: 1.5px solid #1976d2;
            outline: none;
        }

        .modal-content button[type="submit"] {
            width: 100%;
            padding: 12px;
            background: linear-gradient(90deg, #1976d2 0%, #42a5f5 100%);
            color: #fff;
            border: none;
            border-radius: 6px;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            transition: background 0.3s;
            margin-top: 8px;
            box-sizing: border-box;
        }

        .modal-content button[type="submit"]:hover {
            background: linear-gradient(90deg, #1565c0 0%, #64b5f6 100%);
        }

        .btn-success {
            background: linear-gradient(90deg, #388e3c 0%, #66bb6a 100%) !important;
        }

        .btn-success:hover {
            background: linear-gradient(90deg, #2e7d32 0%, #81c784 100%) !important;
        }

        .switch-form {
            margin-top: 20px;
            padding-top: 16px;
            border-top: 1px solid #eee;
        }

        .switch-form p {
            margin: 0;
            color: #666;
            font-size: 0.9em;
        }

        .switch-form a {
            color: #1976d2;
            text-decoration: none;
            font-weight: bold;
            transition: color 0.2s;
        }

        .switch-form a:hover {
            color: #1565c0;
            text-decoration: underline;
        }

        /* 自定义消息弹窗样式 */
        .message-modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.2);
            justify-content: center;
            align-items: center;
        }

        .message-modal.show {
            display: flex;
            animation: simpleModalFadeIn 0.15s ease-out forwards;
        }

        .message-content {
            background: #fff;
            padding: 32px 28px 24px 28px;
            border-radius: 16px;
            width: 320px;
            max-width: 90vw;
            box-shadow: 0 12px 30px rgba(0, 0, 0, 0.1);
            text-align: center;
            /* 移除内容的单独动画，避免重复动画 */
            /* animation: messageModalFadeIn 0.25s; */
        }

        .message-icon {
            width: 48px;
            height: 48px;
            margin: 0 auto 16px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            font-weight: bold;
        }

        .message-icon.success {
            background: linear-gradient(135deg, #4caf50, #66bb6a);
            color: #fff;
        }

        .message-icon.success::before {
            content: '✓';
        }

        .message-icon.error {
            background: linear-gradient(135deg, #f44336, #ef5350);
            color: #fff;
        }

        .message-icon.error::before {
            content: '✕';
        }

        .message-icon.info {
            background: linear-gradient(135deg, #2196f3, #42a5f5);
            color: #fff;
        }

        .message-icon.info::before {
            content: 'i';
        }

        .message-icon.warning {
            background: linear-gradient(135deg, #ff9800, #ffb74d);
            color: #fff;
        }

        .message-icon.warning::before {
            content: '⚠';
        }

        .message-text {
            font-size: 1.1em;
            color: #333;
            margin-bottom: 24px;
            line-height: 1.5;
        }

        .message-btn {
            background: linear-gradient(90deg, #1976d2 0%, #42a5f5 100%);
            color: #fff;
            border: none;
            padding: 10px 32px;
            border-radius: 8px;
            font-size: 1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
            min-width: 80px;
        }

        .message-btn:hover {
            background: linear-gradient(90deg, #1565c0 0%, #64b5f6 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(25, 118, 210, 0.3);
        }

        /* 内容区域样式 */
        .content-area {
            padding: 120px 40px 40px;
            max-width: 1200px;
            margin: 0 auto;
        }

        .content-area h1 {
            color: #1976d2;
            margin-bottom: 20px;
        }

        /* EVE令牌通知样式 */
        .eve-token-notification {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        .eve-token-notification .notification-content {
            display: flex;
            align-items: flex-start;
            gap: 12px;
        }

        .eve-token-notification .notification-icon {
            font-size: 24px;
            flex-shrink: 0;
            margin-top: 2px;
        }

        .eve-token-notification .notification-text {
            flex: 1;
        }

        .eve-token-notification .notification-text strong {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-size: 16px;
        }

        .eve-token-notification .notification-text p {
            margin: 0;
            color: #666;
            font-size: 14px;
            line-height: 1.4;
        }

        .eve-token-notification .notification-actions {
            display: flex;
            gap: 8px;
            margin-top: 12px;
            flex-wrap: wrap;
        }

        .eve-token-notification .btn-primary {
            background: linear-gradient(135deg, #1976d2, #42a5f5);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .eve-token-notification .btn-primary:hover {
            background: linear-gradient(135deg, #1565c0, #64b5f6);
            transform: translateY(-1px);
        }

        .eve-token-notification .btn-secondary {
            background: #f5f5f5;
            color: #666;
            border: 1px solid #ddd;
            padding: 8px 16px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .eve-token-notification .btn-secondary:hover {
            background: #e0e0e0;
            color: #333;
        }

        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideOutRight {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }
    </style>

    <script>
        // 初始化表格
        function initTables() {
            // 加载数据
            loadPaidMissionsData();
            loadWalletDonationsData();
        }

        // 加载已支付任务数据
        function loadPaidMissionsData() {
            fetch('/api/paid_missions_summary')
                .then(response => response.json())
                .then(result => {
                    if (result.success) {
                        const data = result.data;
                        const tbody = document.querySelector('#paidMissionsTable tbody');
                        
                        // 清空现有数据
                        tbody.innerHTML = '';
                        
                        if (data.length === 0) {
                            tbody.innerHTML = '<tr><td colspan="3" style="text-align: center; color: #666;">暂无数据</td></tr>';
                            return;
                        }
                        
                        data.forEach(item => {
                            const row = document.createElement('tr');
                            row.innerHTML = `
                                <td>${item.payer}</td>
                                <td class="count">${item.mission_count}</td>
                                <td class="amount">${(item.total_amount || 0).toLocaleString()} ISK</td>
                            `;
                            tbody.appendChild(row);
                        });
                    }
                })
                .catch(error => console.error('加载已支付任务数据失败:', error));
        }

        // 加载钱包捐赠数据
        function loadWalletDonationsData() {
            fetch('/api/recent_wallet_donations')
                .then(response => response.json())
                .then(result => {
                    if (result.success) {
                        const data = result.data;
                        const tbody = document.querySelector('#walletDonationsTable tbody');
                        
                        // 清空现有数据
                        tbody.innerHTML = '';
                        
                        if (data.length === 0) {
                            tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; color: #666;">暂无数据</td></tr>';
                            return;
                        }
                        
                        data.forEach(item => {
                            const row = document.createElement('tr');
                            row.innerHTML = `
                                <td>${item.donor}</td>
                                <td>${item.type}</td>
                                <td class="amount">${(item.amount || 0).toLocaleString()} ISK</td>
                                <td>${item.date ? item.date.split('T')[0] : ''}</td>
                            `;
                            tbody.appendChild(row);
                        });
                    }
                })
                .catch(error => console.error('加载钱包捐赠数据失败:', error));
        }

        // DOM 元素
        const userArea = document.getElementById('userArea');
        const guestArea = document.getElementById('guestArea');
        const userProfile = document.getElementById('userProfile');
        const userAvatar = document.getElementById('userAvatar');
        const userDropdown = document.getElementById('userDropdown');
        const displayUsername = document.getElementById('displayUsername');
        const dropdownUsername = document.getElementById('dropdownUsername');
        const userLevel = document.getElementById('userLevel');

        const loginBtn = document.getElementById('loginBtn');
        const registerBtn = document.getElementById('registerBtn');
        const logoutBtn = document.getElementById('logoutBtn');
        
        // 设置比率相关元素
        const settingsBtnLoggedIn = document.getElementById('settingsBtnLoggedIn');
        const settingsModal = document.getElementById('settingsModal');
        const closeSettingsModal = document.getElementById('closeSettingsModal');
        const settingsForm = document.getElementById('settingsForm');
        const cancelSettings = document.getElementById('cancelSettings');
        const cooperativeRateInput = document.getElementById('cooperativeRate');
        const currentRateSpan = document.getElementById('currentRateSpan');

        const loginModal = document.getElementById('loginModal');
        const registerModal = document.getElementById('registerModal');
        const closeModal = document.getElementById('closeModal');
        const closeRegisterModal = document.getElementById('closeRegisterModal');
        const loginForm = document.getElementById('loginForm');
        const registerForm = document.getElementById('registerForm');
        const showRegister = document.getElementById('showRegister');
        const showLogin = document.getElementById('showLogin');

        // 自定义消息弹窗元素
        const messageModal = document.getElementById('messageModal');
        const messageIcon = document.getElementById('messageIcon');
        const messageText = document.getElementById('messageText');
        const messageBtn = document.getElementById('messageBtn');
        
        // 更新数据元素
        const updateDataBtn = document.getElementById('updateDataBtn');
        const updateDataModal = document.getElementById('updateDataModal');
        const closeUpdateDataModal = document.getElementById('closeUpdateDataModal');
        const updateDataForm = document.getElementById('updateDataForm');
        const cancelUpdateData = document.getElementById('cancelUpdateData');
        const updateBloodUsername = document.getElementById('updateBloodUsername');
        const updateBloodPassword = document.getElementById('updateBloodPassword');
        const updateLoadingIndicator = document.getElementById('updateLoadingIndicator');

        // 当前用户信息
        let currentUser = null;
        // 添加血袭合作社凭据存储
        let bloodCredentials = {
            username: '',
            password: ''
        };
        // 添加定时更新的计时器变量
        let autoUpdateTimer = null;

        // 保存凭据函数（含备份）
        function saveCredentials(username, password) {
            const credentials = { username, password, timestamp: Date.now() };
            
            try {
                // 主存储
                localStorage.setItem('bloodCredentials', JSON.stringify(credentials));
                // 备份存储
                localStorage.setItem('bloodCredentials_backup', JSON.stringify(credentials));
                console.log('✅ 凭据保存成功（含备份）');
            } catch (e) {
                console.error('❌ 凭据保存失败:', e);
            }
        }

        // 恢复凭据函数（尝试备份）
        function restoreCredentials() {
            let savedCredentials = localStorage.getItem('bloodCredentials');
            
            if (!savedCredentials) {
                console.log('🔄 主凭据不存在，尝试从备份恢复');
                savedCredentials = localStorage.getItem('bloodCredentials_backup');
                
                if (savedCredentials) {
                    // 从备份恢复到主存储
                    localStorage.setItem('bloodCredentials', savedCredentials);
                    console.log('✅ 从备份成功恢复凭据');
                }
            }
            
            return savedCredentials;
        }

        // 自定义消息弹窗函数
        function showMessage(text, type = 'info') {
            messageText.textContent = text;
            messageIcon.className = `message-icon ${type}`;
            messageModal.classList.add('show');
        }

        // 关闭消息弹窗
        messageBtn.onclick = () => messageModal.classList.remove('show');

        // 点击消息弹窗外部关闭
        messageModal.onclick = (event) => {
            if (event.target === messageModal) {
                messageModal.classList.remove('show');
            }
        };

        // 添加会话保活功能
        let sessionKeepAliveTimer = null;

        function startSessionKeepAlive() {
            // 清除现有定时器
            if (sessionKeepAliveTimer) {
                clearInterval(sessionKeepAliveTimer);
            }
            
            // 每3分钟发送一次保活请求
            sessionKeepAliveTimer = setInterval(async () => {
                try {
                    console.log('🔄 执行会话保活检查');
                    const response = await fetch('/xuexi_ranshao/check_auth', {
                        method: 'GET',
                        credentials: 'same-origin',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    });
                    
                    if (response.ok) {
                        const result = await response.json();
                        if (result.authenticated) {
                            console.log('✅ 会话保活成功');
                        } else {
                            console.warn('⚠️ 会话已失效，停止保活');
                            stopSessionKeepAlive();
                            updateUserInterface(); // 切换到未登录状态
                        }
                    } else {
                        console.warn('⚠️ 会话保活请求失败');
                    }
                } catch (error) {
                    console.error('❌ 会话保活异常:', error);
                }
            }, 3 * 60 * 1000); // 3分钟
            
            console.log('🔄 会话保活已启动');
        }

        function stopSessionKeepAlive() {
            if (sessionKeepAliveTimer) {
                clearInterval(sessionKeepAliveTimer);
                sessionKeepAliveTimer = null;
                console.log('🛑 会话保活已停止');
            }
        }

        // 更新用户界面
        function updateUserInterface(user = null) {
            console.log(`🔄 [updateUserInterface] 更新用户界面:`, user);
            
            // 🆕 添加EVE SSO状态输出
            console.log(`🚀 [updateUserInterface] EVE SSO会话信息:`, {
                character_id: '{{ session.get("eve_character_id") if session else "" }}',
                character_name: '{{ session.get("eve_character_name") if session else "" }}',
                has_access_token: '{{ session.get("eve_access_token") if session else "" }}' ? true : false,
                has_refresh_token: '{{ session.get("eve_refresh_token") if session else "" }}' ? true : false,
                token_expires: '{{ session.get("eve_token_expires") if session else "" }}'
            });
            
            if (user) {
                currentUser = user;
                console.log(`✅ [updateUserInterface] 用户登录状态:`, {
                    username: user.username,
                    access_level: user.access_level || 'standard',
                    eve_sso_linked: '{{ session.get("eve_character_name") if session else "" }}' ? true : false
                });
                
                guestArea.style.display = 'none';
                userProfile.style.display = 'block';
                displayUsername.textContent = user.username;
                dropdownUsername.textContent = user.username;
                userLevel.textContent = `权限等级: ${user.access_level || 'standard'}`;
                
                // 重新绑定按钮事件
                updateDataBtn.onclick = function(e) {
                    e.stopPropagation();
                    openUpdateDataModal();
                };
                
                settingsBtnLoggedIn.onclick = function(e) {
                    e.stopPropagation();
                    openSettingsModal();
                };
                
                // 启动会话保活
                startSessionKeepAlive();
            } else {
                console.log(`❌ [updateUserInterface] 用户未登录，清除界面状态`);
                currentUser = null;
                guestArea.style.display = 'flex';
                userProfile.style.display = 'none';
                userProfile.classList.remove('active');
                // 停止会话保活
                stopSessionKeepAlive();
            }
        }

        // 检查登录状态（带重试机制和详细调试信息）
async function checkAuthStatus(retryCount = 0) {
    console.log(`🔍 [checkAuthStatus] 开始检查登录状态，重试次数: ${retryCount}`);
    
    try {
        // 🔑 强制刷新页面cookies
        if (retryCount === 0) {
            console.log('🔄 [checkAuthStatus] 首次检查，等待cookies加载');
            await new Promise(resolve => setTimeout(resolve, 500));
        }
        
        console.log(`📡 [checkAuthStatus] 发送请求到: /xuexi_ranshao/check_auth`);
        const response = await fetch('/xuexi_ranshao/check_auth', {
            method: 'GET',
            credentials: 'same-origin',  // 🔑 确保包含cookies
            headers: {
                'Content-Type': 'application/json',
                'Cache-Control': 'no-cache',
                'Pragma': 'no-cache'  // 强制不使用缓存
            }
        });
        
        console.log(`📥 [checkAuthStatus] 收到响应:`, {
            status: response.status,
            statusText: response.statusText,
            ok: response.ok,
            headers: Object.fromEntries(response.headers.entries())
        });
        
        if (response.ok) {
            const result = await response.json();
            console.log(`✅ [checkAuthStatus] 解析JSON成功:`, result);
            
            // 🆕 添加EVE SSO信息输出
            console.log(`🚀 [checkAuthStatus] EVE SSO状态检查:`, {
                eve_character_id: '{{ session.get("eve_character_id") if session else "" }}',
                eve_character_name: '{{ session.get("eve_character_name") if session else "" }}',
                eve_access_token: '{{ session.get("eve_access_token") if session else "" }}' ? '存在' : '不存在',
                eve_token_expires: '{{ session.get("eve_token_expires") if session else "" }}',
                eve_refresh_token: '{{ session.get("eve_refresh_token") if session else "" }}' ? '存在' : '不存在'
            });
            
            if (result.authenticated) {
                console.log(`🎉 [checkAuthStatus] 用户已认证:`, result.user);
                
                // 🆕 检查EVE SSO令牌状态
                const eveTokenExpires = '{{ session.get("eve_token_expires") if session else "" }}';
                if (eveTokenExpires) {
                    const expiresTime = new Date(eveTokenExpires);
                    const now = new Date();
                    const timeLeft = Math.floor((expiresTime - now) / 1000 / 60); // 分钟
                    
                    console.log(`⏰ [checkAuthStatus] EVE SSO令牌状态:`, {
                        expires_at: eveTokenExpires,
                        time_left_minutes: timeLeft,
                        is_expired: timeLeft <= 0,
                        needs_refresh: timeLeft <= 5
                    });
                    
                    if (timeLeft <= 0) {
                        console.warn(`⚠️ [checkAuthStatus] EVE SSO令牌已过期！`);
                    } else if (timeLeft <= 5) {
                        console.warn(`⚠️ [checkAuthStatus] EVE SSO令牌即将过期，剩余${timeLeft}分钟`);
                    } else {
                        console.log(`✅ [checkAuthStatus] EVE SSO令牌有效，剩余${timeLeft}分钟`);
                    }
                } else {
                    console.warn(`❌ [checkAuthStatus] 未找到EVE SSO令牌过期时间`);
                }
                
                updateUserInterface(result.user);
                    
                    // 尝试从本地存储恢复血袭合作社凭据
                    try {
                        const savedCredentials = restoreCredentials();
                        console.log(`💾 [checkAuthStatus] 本地存储的凭据:`, savedCredentials ? '存在' : '不存在');
                        
                        if (savedCredentials) {
                            const parsed = JSON.parse(savedCredentials);
                            console.log(`🔑 [checkAuthStatus] 解析凭据成功:`, {
                                hasUsername: !!parsed.username,
                                hasPassword: !!parsed.password
                            });
                            
                            bloodCredentials.username = parsed.username;
                            bloodCredentials.password = parsed.password;
                            
                            // 启动自动更新定时器
                            startAutoUpdate();
                        }
                    } catch (e) {
                        console.error('❌ [checkAuthStatus] 恢复凭据失败:', e);
                    }
                } else {
                console.log(`❌ [checkAuthStatus] 用户未认证，重试次数: ${retryCount}`);
                
                // 如果认证失败且重试次数少于3次，则重试
                if (retryCount < 3) {
                    console.log(`🔄 [checkAuthStatus] ${retryCount + 1}秒后重试...`);
                    setTimeout(() => checkAuthStatus(retryCount + 1), 1000);
                    return;
                }
                console.log(`🚫 [checkAuthStatus] 达到最大重试次数，停止重试`);
                updateUserInterface();
                stopAutoUpdate();
            }
        } else {
            console.error(`❌ [checkAuthStatus] HTTP错误:`, {
                status: response.status,
                statusText: response.statusText
            });
            
            // 网络错误也进行重试
            if (retryCount < 3) {
                console.log(`🔄 [checkAuthStatus] 网络错误，${retryCount + 1}秒后重试...`);
                setTimeout(() => checkAuthStatus(retryCount + 1), 1000);
                return;
            }
            console.log(`🚫 [checkAuthStatus] 网络错误达到最大重试次数`);
            updateUserInterface();
            stopAutoUpdate();
        }
    } catch (error) {
        console.error('💥 [checkAuthStatus] 请求异常:', {
            name: error.name,
            message: error.message,
            stack: error.stack
        });
        
        if (retryCount < 3) {
            console.log(`🔄 [checkAuthStatus] 异常后重试，${retryCount + 1}秒后重试...`);
            setTimeout(() => checkAuthStatus(retryCount + 1), 1000);
            return;
        }
        console.log(`🚫 [checkAuthStatus] 异常达到最大重试次数`);
        updateUserInterface();
        stopAutoUpdate();
    }
}

        // 🆕 EVE SSO状态调试函数
        function debugEveSSO() {
            console.log(`🔍 [debugEveSSO] 完整EVE SSO状态:`, {
                session_data: {
                    character_id: '{{ session.get("eve_character_id") if session else "" }}',
                    character_name: '{{ session.get("eve_character_name") if session else "" }}',
                    access_token: '{{ session.get("eve_access_token") if session else "" }}' ? '存在(长度:' + '{{ session.get("eve_access_token")|length if session and session.get("eve_access_token") else 0 }}' + ')' : '不存在',
                    refresh_token: '{{ session.get("eve_refresh_token") if session else "" }}' ? '存在' : '不存在',
                    token_expires: '{{ session.get("eve_token_expires") if session else "" }}'
                },
                local_storage: {
                    blood_credentials: localStorage.getItem('bloodCredentials') ? '存在' : '不存在',
                    last_update_time: localStorage.getItem('lastUpdateTime')
                },
                current_time: new Date().toISOString()
            });
            
            // 检查令牌有效性
            const eveTokenExpires = '{{ session.get("eve_token_expires") if session else "" }}';
            if (eveTokenExpires) {
                const expiresTime = new Date(eveTokenExpires);
                const now = new Date();
                const timeLeft = Math.floor((expiresTime - now) / 1000 / 60);
                
                console.log(`⏰ [debugEveSSO] 令牌时间分析:`, {
                    expires_at: eveTokenExpires,
                    current_time: now.toISOString(),
                    time_left_minutes: timeLeft,
                    status: timeLeft > 5 ? '正常' : timeLeft > 0 ? '即将过期' : '已过期'
                });
            }
        }

        // 页面加载时检查登录状态
        document.addEventListener('DOMContentLoaded', function() {
            debugEveSSO();
            checkAuthStatus();
            // 🆕 添加EVE SSO过期检查
            checkEveTokenOnPageLoad();
            // 初始化表格
            initTables();
        });

        // 🆕 页面加载时检查EVE SSO令牌状态
        function checkEveTokenOnPageLoad() {
            const eveCharacterId = '{{ session.get("eve_character_id") if session else "" }}';
            const eveTokenExpires = '{{ session.get("eve_token_expires") if session else "" }}';
            
            // 如果用户已经绑定了EVE SSO但令牌过期
            if (eveCharacterId && eveTokenExpires) {
                const expiresTime = new Date(eveTokenExpires);
                const now = new Date();
                const timeLeft = Math.floor((expiresTime - now) / 1000 / 60); // 分钟
                
                console.log(`🔍 [checkEveTokenOnPageLoad] EVE SSO令牌检查:`, {
                    character_id: eveCharacterId,
                    expires_at: eveTokenExpires,
                    time_left_minutes: timeLeft,
                    is_expired: timeLeft <= 0
                });
                
                if (timeLeft <= 0) {
                    // 令牌已过期，显示提醒
                    console.warn(`⚠️ [checkEveTokenOnPageLoad] EVE SSO令牌已过期，提醒用户重新登录`);
                    showEveTokenExpiredNotification();
                } else if (timeLeft <= 10) {
                    // 令牌即将过期（10分钟内），显示警告
                    console.warn(`⚠️ [checkEveTokenOnPageLoad] EVE SSO令牌即将过期，剩余${timeLeft}分钟`);
                    showEveTokenExpiringNotification(timeLeft);
                }
            }
        }

        // 🆕 显示EVE SSO令牌过期通知
        function showEveTokenExpiredNotification() {
            // 创建通知元素
            const notification = document.createElement('div');
            notification.className = 'eve-token-notification expired';
            notification.innerHTML = `
                <div class="notification-content">
                    <div class="notification-icon">⚠️</div>
                    <div class="notification-text">
                        <strong>EVE SSO会话已过期</strong>
                        <p>您的EVE在线认证已过期，无法获取最新的忠诚点数据。请重新登录EVE SSO以继续使用完整功能。</p>
                    </div>
                    <div class="notification-actions">
                        <button onclick="window.location.href='/auth/login'" class="btn-primary">重新登录EVE SSO</button>
                        <button onclick="closeEveTokenNotification()" class="btn-secondary">稍后提醒</button>
                    </div>
                </div>
            `;
            
            // 添加样式
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: #fff;
                border: 2px solid #ff6b6b;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                padding: 16px;
                max-width: 400px;
                z-index: 10000;
                animation: slideInRight 0.3s ease-out;
            `;
            
            document.body.appendChild(notification);
            
            // 5分钟后自动隐藏
            setTimeout(() => {
                if (notification.parentNode) {
                    closeEveTokenNotification();
                }
            }, 5 * 60 * 1000);
        }

        // 🆕 显示EVE SSO令牌即将过期通知
        function showEveTokenExpiringNotification(minutesLeft) {
            const notification = document.createElement('div');
            notification.className = 'eve-token-notification expiring';
            notification.innerHTML = `
                <div class="notification-content">
                    <div class="notification-icon">⏰</div>
                    <div class="notification-text">
                        <strong>EVE SSO会话即将过期</strong>
                        <p>您的EVE在线认证将在${minutesLeft}分钟后过期。建议提前重新登录以避免数据获取中断。</p>
                    </div>
                    <div class="notification-actions">
                        <button onclick="window.location.href='/auth/login'" class="btn-primary">立即重新登录</button>
                        <button onclick="closeEveTokenNotification()" class="btn-secondary">知道了</button>
                    </div>
                </div>
            `;
            
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: #fff;
                border: 2px solid #ffa726;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                padding: 16px;
                max-width: 400px;
                z-index: 10000;
                animation: slideInRight 0.3s ease-out;
            `;
            
            document.body.appendChild(notification);
            
            // 2分钟后自动隐藏
            setTimeout(() => {
                if (notification.parentNode) {
                    closeEveTokenNotification();
                }
            }, 2 * 60 * 1000);
        }

        // 🆕 关闭EVE令牌通知
        function closeEveTokenNotification() {
            const notifications = document.querySelectorAll('.eve-token-notification');
            notifications.forEach(notification => {
                notification.style.animation = 'slideOutRight 0.3s ease-in';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            });
        }

        // 添加到全局，方便手动调用
        window.debugEveSSO = debugEveSSO;

        // 用户头像点击事件
        userAvatar.onclick = (e) => {
            e.stopPropagation();
            userProfile.classList.toggle('active');
        };



        // 阻止下拉菜单点击事件冒泡，但允许按钮点击
        userDropdown.onclick = (e) => {
            e.stopPropagation();
            // 不阻止默认行为，允许按钮点击事件触发
        };

        // 退出登录（添加调试信息）
        logoutBtn.onclick = async () => {
            console.log(`🚪 [logout] 开始退出登录流程`);
            
            try {
                console.log(`📡 [logout] 发送退出请求到: /xuexi_ranshao/logout`);
                const response = await fetch('/xuexi_ranshao/logout', {
                    method: 'POST'
                });

                console.log(`📥 [logout] 收到退出响应:`, {
                    status: response.status,
                    statusText: response.statusText,
                    ok: response.ok,
                    headers: Object.fromEntries(response.headers.entries())
                });

                if (response.ok) {
                    const result = await response.json();
                    console.log(`✅ [logout] 退出响应JSON:`, result);
                    
                    if (result.success) {
                        console.log(`🎉 [logout] 退出成功`);
                        showMessage('已成功退出登录', 'success');
                        updateUserInterface();
                        
                        // 清除保存的凭据
                        console.log(`🗑️ [logout] 清除本地凭据`);
                        bloodCredentials.username = '';
                        bloodCredentials.password = '';
                        try {
                            localStorage.removeItem('bloodCredentials');
                            localStorage.removeItem('bloodCredentials_backup');
                            console.log(`✅ [logout] 本地凭据清除成功（含备份）`);
                        } catch (e) {
                            console.error('❌ [logout] 清除凭据失败:', e);
                        }
                        
                        // 停止自动更新
                        stopAutoUpdate();
                    } else {
                        console.error(`❌ [logout] 退出失败:`, result.message);
                        showMessage('退出登录失败: ' + result.message, 'error');
                    }
                } else {
                    console.error(`❌ [logout] 退出请求HTTP错误:`, {
                        status: response.status,
                        statusText: response.statusText
                    });
                    showMessage('退出登录请求失败', 'error');
                }
            } catch (error) {
                console.error('💥 [logout] 退出请求异常:', {
                    name: error.name,
                    message: error.message,
                    stack: error.stack
                });
                showMessage('退出登录出错', 'error');
            }
        };

        // 显示登录弹窗
        loginBtn.onclick = () => {
            loginModal.classList.add('show');
            registerModal.classList.remove('show');
        };

        // 显示注册弹窗
        registerBtn.onclick = () => {
            registerModal.classList.add('show');
            loginModal.classList.remove('show');
        };

        // 切换到注册弹窗
        showRegister.onclick = (e) => {
            e.preventDefault();
            loginModal.classList.remove('show');
            registerModal.classList.add('show');
        };

        // 切换到登录弹窗
        showLogin.onclick = (e) => {
            e.preventDefault();
            registerModal.classList.remove('show');
            loginModal.classList.add('show');
        };

        // 关闭登录弹窗
        closeModal.onclick = () => loginModal.classList.remove('show');

        // 关闭注册弹窗
        closeRegisterModal.onclick = () => registerModal.classList.remove('show');

        // 点击页面其他地方关闭下拉菜单和弹窗
        window.onclick = (event) => {
            // 关闭用户下拉菜单
            userProfile.classList.remove('active');
            
            // 关闭登录和注册弹窗
            if (event.target === loginModal) {
                loginModal.classList.remove('show');
            }
            if (event.target === registerModal) {
                registerModal.classList.remove('show');
            }
            
            // 关闭设置比率弹窗
            if (event.target === settingsModal) {
                closeSettingsModalFunc();
            }
            
            // 关闭更新数据弹窗
            if (event.target === updateDataModal) {
                closeUpdateDataModalFunc();
            }
        };

        // 登录表单AJAX提交（添加调试信息）
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            console.log(`🔐 [login] 开始登录流程`);

            const formData = new FormData(loginForm);
            const rememberMe = formData.get('rememberMe') === 'on';
            
            console.log(`📝 [login] 表单数据:`, {
                username: formData.get('username'),
                hasPassword: !!formData.get('password'),
                rememberMe: rememberMe
            });
            
            try {
                console.log('📡 [login] 发送登录请求');
                const response = await fetch('/xuexi_ranshao/login', {
                    method: 'POST',
                    body: formData,
                    credentials: 'same-origin',  // 确保包含cookies
                    // 不要设置Content-Type，让浏览器自动处理FormData
                });
                
                console.log('📥 [login] 收到登录响应:', {
                    status: response.status,
                    statusText: response.statusText,
                    ok: response.ok,
                    headers: Object.fromEntries(response.headers.entries())
                });

                if (response.ok) {
                    const result = await response.json();
                    console.log('✅ [login] 登录响应JSON:', result);
                    
                    if (result.success) {
                        console.log('🎉 [login] 登录成功:', result.user);
                        showMessage('登录成功！', 'success');
                        loginModal.classList.remove('show');
                        loginForm.reset();
                        
                        // 保存血袭合作社凭据（与登录凭据相同）
                        bloodCredentials.username = formData.get('username');
                        bloodCredentials.password = formData.get('password');
                        
                        console.log(`💾 [login] 保存凭据到本地存储`);
                        // 保存到本地存储（含备份）
                        saveCredentials(bloodCredentials.username, bloodCredentials.password);
                        
                        // 更新用户界面
                        updateUserInterface({
                            username: result.user,
                            access_level: result.xuexi_specific_data?.access_level || 'standard'
                        });
                        
                        // 🔑 关键：等待会话完全建立后再进行后续操作
                        console.log('⏳ [login] 等待会话建立...');
                        setTimeout(async () => {
                            console.log('🔄 [login] 验证会话是否建立成功');
                            try {
                                const authCheck = await fetch('/xuexi_ranshao/check_auth', {
                                    method: 'GET',
                                    credentials: 'same-origin',
                                    headers: {
                                        'Content-Type': 'application/json',
                                        'Cache-Control': 'no-cache'
                                    }
                                });
                                
                                if (authCheck.ok) {
                                    const authResult = await authCheck.json();
                                    if (authResult.authenticated) {
                                        console.log('✅ [login] 会话验证成功，启动自动更新');
                                        startAutoUpdate();
                                    } else {
                                        console.error('❌ [login] 会话验证失败');
                                        showMessage('会话建立失败，请重新登录', 'error');
                                    }
                                } else {
                                    console.error('❌ [login] 会话验证请求失败');
                                }
                            } catch (error) {
                                console.error('💥 [login] 会话验证异常:', error);
                            }
                        }, 2000); // 等待2秒确保会话完全建立
                    } else {
                        console.error('❌ [login] 登录失败:', result.message);
                        showMessage('登录失败: ' + result.message, 'error');
                    }
                } else {
                    console.error('❌ [login] 登录请求HTTP错误:', {
                        status: response.status,
                        statusText: response.statusText
                    });
                    showMessage('登录请求失败，请稍后再试。', 'error');
                }
            } catch (error) {
                console.error('💥 [login] 登录请求异常:', error);
                showMessage('登录请求出错，请稍后再试。', 'error');
            }
        });

        // 注册表单AJAX提交
        registerForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            // 验证密码确认
            const password = document.getElementById('regPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;

            if (password !== confirmPassword) {
                showMessage('两次输入的密码不一致，请重新输入。', 'error');
                return;
            }

            const formData = new FormData(registerForm);
            try {
                const response = await fetch('/xuexi_ranshao/register', {
                    method: 'POST',
                    body: formData
                });

                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        showMessage('注册成功！请登录。', 'success');
                        // 切换到登录弹窗并预填用户名
                        document.getElementById('username').value = document.getElementById('regUsername').value;
                        registerModal.classList.remove('show');
                        loginModal.classList.add('show');
                        // 清空注册表单
                        registerForm.reset();
                    } else {
                        showMessage('注册失败: ' + result.message, 'error');
                    }
                } else {
                    showMessage('注册请求失败，请稍后再试。', 'error');
                }
            } catch (error) {
                console.error('注册请求出错:', error);
                showMessage('注册请求出错，请稍后再试。', 'error');
            }
        });



        // 更新数据功能
        // 打开更新数据弹窗
        function openUpdateDataModal() {
            // 如果有保存的凭据，直接开始更新流程
            if (bloodCredentials.username && bloodCredentials.password) {
                startDataUpdate(bloodCredentials.username, bloodCredentials.password);
            } else {
                // 如果没有保存的凭据，显示提示消息
                showMessage('无法获取血袭合作社凭据，请重新登录', 'error');
            }
        }

        // 关闭更新数据弹窗
        function closeUpdateDataModalFunc() {
            updateDataModal.classList.remove('show');
        }

        // 绑定事件
        updateDataBtn.onclick = function(e) {
            e.stopPropagation(); // 阻止冒泡，防止关闭下拉菜单
            openUpdateDataModal();
        };
        closeUpdateDataModal.onclick = closeUpdateDataModalFunc;
        cancelUpdateData.onclick = closeUpdateDataModalFunc;



        // 添加新函数处理数据更新（修复会话传递问题）
        async function startDataUpdate(username, password, silent = false) {
            console.log(`🚀 [startDataUpdate] 开始数据更新:`, {
                username: username,
                silent: silent,
                eve_character_id: '{{ session.get("eve_character_id") if session else "" }}',
                eve_character_name: '{{ session.get("eve_character_name") if session else "" }}'
            });
            
            // 🆕 检查EVE SSO状态
            const eveCharacterId = '{{ session.get("eve_character_id") if session else "" }}';
            const eveAccessToken = '{{ session.get("eve_access_token") if session else "" }}';
            const eveTokenExpires = '{{ session.get("eve_token_expires") if session else "" }}';
            
            console.log(`🔍 [startDataUpdate] EVE SSO数据更新前检查:`, {
                has_character_id: !!eveCharacterId,
                has_access_token: !!eveAccessToken,
                token_expires: eveTokenExpires,
                can_fetch_eve_data: !!(eveCharacterId && eveAccessToken)
            });
            
            if (eveTokenExpires) {
                const expiresTime = new Date(eveTokenExpires);
                const now = new Date();
                const isExpired = now >= expiresTime;
                
                console.log(`⏰ [startDataUpdate] EVE令牌检查:`, {
                    expires_at: eveTokenExpires,
                    current_time: now.toISOString(),
                    is_expired: isExpired,
                    time_diff_minutes: Math.floor((expiresTime - now) / 1000 / 60)
                });
                
                if (isExpired) {
                    console.error(`❌ [startDataUpdate] EVE SSO令牌已过期，无法获取EVE数据`);
                }
            }
            
            // 检查登录状态
            if (!currentUser) {
                console.error(`❌ [startDataUpdate] 用户未登录`);
                showMessage('请先登录后再更新数据', 'error');
                return;
            }

            // 🔑 强制重新验证会话状态
            console.log(`🔍 [startDataUpdate] 验证会话状态`);
            try {
                const authResponse = await fetch('/xuexi_ranshao/check_auth', {
                    method: 'GET',
                    credentials: 'same-origin',
                    headers: {
                        'Content-Type': 'application/json',
                        'Cache-Control': 'no-cache'
                    }
                });
                
                if (!authResponse.ok) {
                    console.error(`❌ [startDataUpdate] 会话验证请求失败: ${authResponse.status}`);
                    showMessage('会话验证失败，请重新登录', 'error');
                    updateUserInterface(); // 切换到未登录状态
                    return;
                }
                
                const authResult = await authResponse.json();
                if (!authResult.authenticated) {
                    console.error(`❌ [startDataUpdate] 会话验证失败，用户未认证`);
                    showMessage('会话已过期，请重新登录', 'error');
                    updateUserInterface(); // 切换到未登录状态
                    return;
                }
                
                console.log(`✅ [startDataUpdate] 会话验证成功，用户: ${authResult.user}`);
            } catch (error) {
                console.error(`💥 [startDataUpdate] 会话验证异常:`, error);
                showMessage('会话验证出错，请重新登录', 'error');
                return;
            }

            // 显示加载状态和更新状态区域
            updateDataModal.classList.add('show');
            updateDataForm.style.display = 'none';
            updateLoadingIndicator.style.display = 'flex';
            const updateStatusDisplay = document.getElementById('updateStatusDisplay');
            updateStatusDisplay.style.display = 'block';
            
            // 重置所有步骤状态
            resetStepStatus();
            
            // 更新进度条为0%
            updateProgress(0);
            
            try {
                // 第一步：验证账户
                console.log(`1️⃣ [startDataUpdate] 步骤1: 验证账户`);
                updateStepStatus('step1', 'active');
                await simulateDelay(500);
                updateProgress(25);
                updateStepStatus('step1', 'completed');
                
                // 第二步：获取数据
                console.log(`2️⃣ [startDataUpdate] 步骤2: 获取数据`);
                updateStepStatus('step2', 'active');
                await simulateDelay(500);
                
                const apiUrl = `/api/blood_cooperatives_data?blood_username=${encodeURIComponent(username)}&blood_password=${encodeURIComponent(password)}`;
                console.log(`📡 [startDataUpdate] 发送数据请求到:`, apiUrl);
                
                // 🔑 关键修复：确保包含会话凭据
                const response = await fetch(apiUrl, {
                    method: 'GET',
                    credentials: 'same-origin',  // 确保包含cookies
                    headers: {
                        'Content-Type': 'application/json',
                        'Cache-Control': 'no-cache'
                    }
                });
                
                console.log(`📥 [startDataUpdate] 收到数据响应:`, {
                    status: response.status,
                    statusText: response.statusText,
                    ok: response.ok,
                    headers: Object.fromEntries(response.headers.entries())
                });
                
                updateProgress(50);
                updateStepStatus('step2', 'completed');
                
                if (response.ok) {
                    const result = await response.json();
                    console.log(`✅ [startDataUpdate] 数据响应JSON:`, result);

                    if (result.success) {
                        // 第三步：保存到数据库
                        console.log(`3️⃣ [startDataUpdate] 步骤3: 保存到数据库`);
                        updateStepStatus('step3', 'active');
                        await simulateDelay(500);
                        updateProgress(75);
                        updateStepStatus('step3', 'completed');
                        
                        // 第四步：计算统计信息
                        console.log(`4️⃣ [startDataUpdate] 步骤4: 计算统计信息`);
                        updateStepStatus('step4', 'active');
                        await simulateDelay(500);
                        updateProgress(100);
                        updateStepStatus('step4', 'completed');
                        
                        console.log(`🎉 [startDataUpdate] 数据更新成功`);
                        showMessage('数据更新成功！', 'success');
                        
                        // 关闭更新弹窗
                        setTimeout(() => {
                            closeUpdateDataModalFunc();
                        }, 2000);
                        
                        // 可选：动态更新页面上的统计数据
                        if (result.data && result.data.summary) {
                            updatePageStatistics(result.data.summary);
                        }
                    } else {
                        console.error(`❌ [startDataUpdate] 数据更新失败:`, result.message);
                        updateStepStatus('step2', 'error');
                        updateProgress(50);
                        showMessage(`更新数据失败: ${result.message}`, 'error');
                    }
                } else {
                    console.error(`❌ [startDataUpdate] 数据请求HTTP错误:`, {
                        status: response.status,
                        statusText: response.statusText
                    });
                    updateStepStatus('step2', 'error');
                    updateProgress(50);
                    
                    // 🔍 针对401错误的特殊处理
                    if (response.status === 401) {
                        console.log(`🔄 [startDataUpdate] 检测到401错误，尝试重新验证登录状态`);
                        // 重新检查登录状态
                        await checkAuthStatus();
                        showMessage('会话已过期，请重新登录', 'error');
                    } else {
                        showMessage(`请求失败: ${response.status}`, 'error');
                    }
                }
            } catch (error) {
                console.error('💥 [startDataUpdate] 数据更新异常:', {
                    name: error.name,
                    message: error.message,
                    stack: error.stack
                });
                updateStepStatus('step2', 'error');
                updateProgress(50);
                showMessage('网络错误，请稍后再试', 'error');
            } finally {
                updateLoadingIndicator.style.display = 'none';
                console.log(`🏁 [startDataUpdate] 数据更新流程结束`);
            }
        }

        // 处理更新数据表单提交
        updateDataForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            // 检查登录状态
            if (!currentUser) {
                showMessage('请先登录后再更新数据', 'error');
                return;
            }

            // 检查凭证
            const username = updateBloodUsername.value.trim();
            const password = updateBloodPassword.value.trim();

            if (!username || !password) {
                showMessage('请输入血袭合作社用户名和密码', 'error');
                return;
            }

            // 保存凭据以便下次使用
            bloodCredentials.username = username;
            bloodCredentials.password = password;
            
            // 开始更新流程
            updateDataForm.style.display = 'none';
            startDataUpdate(username, password);
        });

        // 更新进度条
        function updateProgress(percentage) {
            const progressFill = document.getElementById('progressFill');
            const progressText = document.getElementById('progressText');
            
            progressFill.style.width = `${percentage}%`;
            progressText.textContent = `${percentage}%`;
        }

        // 更新步骤状态
        function updateStepStatus(stepId, status) {
            const step = document.getElementById(stepId);
            // 移除所有状态类
            step.classList.remove('active', 'completed', 'error');
            // 添加新状态
            step.classList.add(status);
        }

        // 重置所有步骤状态
        function resetStepStatus() {
            const steps = ['step1', 'step2', 'step3', 'step4'];
            steps.forEach(stepId => {
                const step = document.getElementById(stepId);
                step.classList.remove('active', 'completed', 'error');
            });
        }

        // 模拟延迟
        function simulateDelay(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }
        
        // 更新页面统计信息
        async function updatePageStatistics(summary) {
            console.log('📊 [updatePageStatistics] 更新页面统计信息:', summary);
            
            try {
                // 获取最新的任务状态统计信息
                const response = await fetch('/api/mission_status_summary', {
                    method: 'GET',
                    credentials: 'same-origin',
                    headers: {
                        'Content-Type': 'application/json',
                        'Cache-Control': 'no-cache'
                    }
                });
                
                if (response.ok) {
                    const result = await response.json();
                    if (result.success && result.data) {
                        const missionStatus = result.data;
                        
                        // 更新任务状态统计信息
                        const missionStatusCards = document.querySelectorAll('.mission-status-info .info-card');
                        
                        // 更新已完成任务
                        if (missionStatus.completed && missionStatusCards[0]) {
                            const countElement = missionStatusCards[0].querySelector('.info-value');
                            const bountyElement = missionStatusCards[0].querySelector('.info-bounty');
                            if (countElement) countElement.textContent = missionStatus.completed.count;
                            if (bountyElement) {
                                bountyElement.textContent = new Intl.NumberFormat('zh-CN').format(missionStatus.completed.total_bounty) + ' ISK';
                            }
                        }
                        
                        // 更新已支付任务
                        if (missionStatus.paid && missionStatusCards[1]) {
                            const countElement = missionStatusCards[1].querySelector('.info-value');
                            const bountyElement = missionStatusCards[1].querySelector('.info-bounty');
                            if (countElement) countElement.textContent = missionStatus.paid.count;
                            if (bountyElement) {
                                bountyElement.textContent = new Intl.NumberFormat('zh-CN').format(missionStatus.paid.total_bounty) + ' ISK';
                            }
                        }
                        
                        // 更新已完结任务
                        if (missionStatus.done && missionStatusCards[2]) {
                            const countElement = missionStatusCards[2].querySelector('.info-value');
                            const bountyElement = missionStatusCards[2].querySelector('.info-bounty');
                            if (countElement) countElement.textContent = missionStatus.done.count;
                            if (bountyElement) {
                                bountyElement.textContent = new Intl.NumberFormat('zh-CN').format(missionStatus.done.total_bounty) + ' ISK';
                            }
                        }
                        
                        console.log('✅ [updatePageStatistics] 任务状态统计信息更新完成');
                    } else {
                        console.log('⚠️ [updatePageStatistics] 获取任务状态统计信息失败:', result.message);
                    }
                } else {
                    console.log('⚠️ [updatePageStatistics] 任务状态统计信息请求失败:', response.status);
                }
                
                // 更新血袭者LP点数
                console.log('🔄 [updatePageStatistics] 更新血袭者LP点数');
                try {
                    const lpResponse = await fetch('/api/blood_raider_lp');
                    if (lpResponse.ok) {
                        const lpResult = await lpResponse.json();
                        if (lpResult.success) {
                            // 更新血袭者LP点数显示
                            const infoCards = document.querySelectorAll('.info-card');
                            if (infoCards.length > 2) {
                                const lpCard = infoCards[2].querySelector('.info-value');
                                if (lpCard) {
                                    lpCard.textContent = new Intl.NumberFormat('zh-CN').format(lpResult.blood_raider_lp);
                                }
                            }
                            
                            // 更新意林奸商价计算
                            updateBloodRaiderLPCalculation();
                            
                            console.log('✅ [updatePageStatistics] 血袭者LP点数更新完成:', lpResult.blood_raider_lp);
                        } else {
                            console.log('⚠️ [updatePageStatistics] 获取血袭者LP点数失败:', lpResult.message);
                        }
                    } else {
                        console.log('⚠️ [updatePageStatistics] 血袭者LP点数请求失败:', lpResponse.status);
                    }
                } catch (error) {
                    console.error('❌ [updatePageStatistics] 更新血袭者LP点数时出错:', error);
                }
                
                // 刷新已支付任务表格
                console.log('🔄 [updatePageStatistics] 刷新已支付任务表格');
                loadPaidMissionsData();
                
                // 刷新钱包捐赠表格
                console.log('🔄 [updatePageStatistics] 刷新钱包捐赠表格');
                loadWalletDonationsData();
                
                // 刷新表格数据
                initTables();
                
            } catch (error) {
                console.error('❌ [updatePageStatistics] 更新统计信息时出错:', error);
            }
        }
       
        
        // 自动更新功能
        function startAutoUpdate() {
            // 清除现有的定时器（如果有）
            stopAutoUpdate();
            
            // 设置新的定时器，每5分钟自动更新一次
            autoUpdateTimer = setInterval(() => {
                // 检查是否有保存的凭据
                if (bloodCredentials.username && bloodCredentials.password) {
                    // 静默更新数据
                    startDataUpdate(bloodCredentials.username, bloodCredentials.password, true);
                }
            }, 5 * 60 * 1000); // 5分钟 * 60秒 * 1000毫秒
            
            console.log('自动更新已启动（每5分钟）');
        }
        
        // 停止自动更新
        function stopAutoUpdate() {
            if (autoUpdateTimer) {
                clearInterval(autoUpdateTimer);
                autoUpdateTimer = null;
                console.log('自动更新已停止');
            }
        }

        // 打开设置弹窗
        function openSettingsModal() {
            settingsModal.classList.add('show');
            cooperativeRateInput.value = '';
            cooperativeRateInput.focus();
        }

        // 关闭设置弹窗
        function closeSettingsModalFunc() {
            settingsModal.classList.remove('show');
        }

        // 绑定事件
        settingsBtnLoggedIn.onclick = function(e) {
            e.stopPropagation(); // 阻止冒泡，防止关闭下拉菜单
            openSettingsModal();
        };
        closeSettingsModal.onclick = closeSettingsModalFunc;
        cancelSettings.onclick = closeSettingsModalFunc;



        // 更新血袭者LP点数计算
        function updateBloodRaiderLPCalculation() {
            const infoCards = document.querySelectorAll('.info-card');
            let currentRate = 2200; // 默认比率
            
            // 获取当前设置的比率
            if (infoCards.length > 1) {
                const cooperativeCard = infoCards[1].querySelector('.info-value');
                if (cooperativeCard) {
                    currentRate = parseFloat(cooperativeCard.textContent) || 2200;
                }
            }
            
            // 获取血袭者LP点数
            let bloodRaiderLP = 0;
            if (infoCards.length > 2) {
                const lpCard = infoCards[2].querySelector('.info-value');
                if (lpCard) {
                    // 移除千分位分隔符并转换为数字
                    bloodRaiderLP = parseFloat(lpCard.textContent.replace(/,/g, '')) || 0;
                }
            }
            
            // 更新计算结果
            if (infoCards.length > 3) {
                const calculationCard = infoCards[3].querySelector('.info-value');
                if (calculationCard) {
                    const calculatedValue = currentRate * bloodRaiderLP;
                    calculationCard.textContent = new Intl.NumberFormat('zh-CN').format(Math.round(calculatedValue));
                }
            }
        }

        // 处理表单提交
        settingsForm.addEventListener('submit', (e) => {
            e.preventDefault();

            const newRate = parseFloat(cooperativeRateInput.value);

            if (isNaN(newRate) || newRate <= 0) {
                showMessage('请输入有效的比率数值', 'error');
                return;
            }

            // 更新显示的比率
            const infoCards = document.querySelectorAll('.info-card');
            if (infoCards.length > 1) {
                const cooperativeCard = infoCards[1].querySelector('.info-value');
                if (cooperativeCard) {
                    cooperativeCard.textContent = newRate;
                }
            }

            // 更新当前比率显示
            currentRateSpan.textContent = newRate;

            // 更新血袭者LP点数计算
            updateBloodRaiderLPCalculation();

            // 保存到本地存储
            localStorage.setItem('cooperativeRate', newRate);

            showMessage('合作社比率设置成功', 'success');
            closeSettingsModalFunc();
        });

        // 强制刷新功能
        document.getElementById('forceRefreshBtn').addEventListener('click', function() {
            // 只清除更新时间，保留凭据
            localStorage.removeItem('lastUpdateTime');
            // localStorage.removeItem('bloodCredentials'); // ❌ 注释掉这行
            
            // 直接强制更新数据，不需要重新登录EVE
            if (bloodCredentials.username && bloodCredentials.password) {
                startDataUpdate(bloodCredentials.username, bloodCredentials.password, true);
                showMessage('正在强制刷新数据...', 'info');
            } else {
                showMessage('请先登录血袭合作社账号', 'warning');
            }
        });

        // 页面加载时恢复保存的比率
        window.addEventListener('DOMContentLoaded', () => {
            const savedRate = localStorage.getItem('cooperativeRate');
            if (savedRate) {
                const infoCards = document.querySelectorAll('.info-card');
                if (infoCards.length > 1) {
                    const cooperativeCard = infoCards[1].querySelector('.info-value');
                    if (cooperativeCard) {
                        cooperativeCard.textContent = savedRate;
                    }
                }
                currentRateSpan.textContent = savedRate;
                
                // 页面加载时也更新血袭者LP点数计算
                setTimeout(() => {
                    updateBloodRaiderLPCalculation();
                }, 100);
            }
        });

        // 定期检查凭据状态
        setInterval(() => {
            const credentials = localStorage.getItem('bloodCredentials');
            if (!credentials && bloodCredentials.username) {
                console.warn('⚠️ 检测到凭据丢失，尝试恢复');
                // 尝试从内存恢复到存储
                if (bloodCredentials.username && bloodCredentials.password) {
                    saveCredentials(bloodCredentials.username, bloodCredentials.password);
                }
            }
        }, 30000); // 每30秒检查一次

    </script>
</body>

</html>