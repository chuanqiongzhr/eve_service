<!DOCTYPE html>
<html lang="zh">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¡€è¢­ç‡ƒçƒ§</title>
    <link rel="icon" href="{{ url_for('static', filename='favicon.ico') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css', v='1.0') }}">
</head>

<body>
    <nav class="navbar">
        <div class="navbar-container">
            <a href="/" class="navbar-brand">EVE å·¥å…·é›†</a>
            <div class="navbar-menu">
                <a href="/price_history" class="navbar-item">ä»·æ ¼æŸ¥è¯¢</a>
                <a href="/xuexi_ranshao" class="navbar-item">è¡€è¢­ç‡ƒçƒ§</a>
                <!-- EVE SSO è®¤è¯æŒ‰é’® -->
                {% if session and session.get('eve_character_name') %}
                    <span class="navbar-item">{{ session.get('eve_character_name') }}</span>
                    <a href="/auth/logout" class="navbar-item">é€€å‡º</a>
                {% else %}
                    <a href="/auth/login" class="navbar-item">EVE SSO ç™»å½•</a>
                {% endif %}
            </div>
        </div>
    </nav>

    <!-- ç”¨æˆ·æ“ä½œåŒºåŸŸ -->
    <div id="userArea" class="user-area">
        <!-- æœªç™»å½•çŠ¶æ€ -->
        <div id="guestArea" class="guest-area">
            <button id="loginBtn" class="auth-btn login-btn">ç™»å½•</button>
            <button id="registerBtn" class="auth-btn register-btn">æ³¨å†Œ</button>
        </div>

        <!-- å·²ç™»å½•çŠ¶æ€ -->
        <div id="userProfile" class="user-profile" style="display: none;">

            <div class="user-avatar" id="userAvatar">
                <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23fff'%3E%3Cpath d='M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z'/%3E%3C/svg%3E"
                    alt="ç”¨æˆ·å¤´åƒ">
                <span class="username" id="displayUsername"></span>
                <span class="dropdown-arrow">â–¼</span>
            </div>
            <div class="user-dropdown" id="userDropdown">
                <div class="dropdown-item user-info">
                    <div class="user-details">
                        <div class="user-name" id="dropdownUsername"></div>
                        <div class="user-level" id="userLevel"></div>
                    </div>
                </div>
                <div class="dropdown-divider"></div>
                <!-- è®¾ç½®æ¯”ç‡æŒ‰é’® -->
                <button class="dropdown-item settings-item" id="settingsBtnLoggedIn">
                    <span class="settings-icon">âš™ï¸</span>
                    è®¾ç½®æ¯”ç‡
                </button>
                <!-- æ›´æ–°æ•°æ®æŒ‰é’® -->
                <button class="dropdown-item update-data-item" id="updateDataBtn">
                    <span class="update-icon">ğŸ”„</span>
                    æ›´æ–°æ•°æ®
                </button>
                <!-- å¼ºåˆ¶åˆ·æ–°æŒ‰é’® -->
                <button class="dropdown-item force-refresh-item" id="forceRefreshBtn">
                    <span class="refresh-icon">ğŸ”„</span>
                    å¼ºåˆ¶åˆ·æ–°
                </button>
                <div class="dropdown-divider"></div>
                <button class="dropdown-item logout-btn" id="logoutBtn">
                    <span class="logout-icon">ğŸšª</span>
                    é€€å‡ºç™»å½•
                </button>
            </div>
        </div>
    </div>

    <main>
        <!-- ç™»å½•å¼¹çª— -->
        <div id="loginModal" class="modal">
            <div class="modal-content">
                <span class="close" id="closeModal">&times;</span>
                <h2>ç”¨æˆ·ç™»å½•</h2>
                <div class="modal-body">
                    <form id="loginForm" action="/xuexi_ranshao/login" method="POST">
                        <div class="mb-3">
                            <label for="username" class="form-label">ç”¨æˆ·å</label>
                            <input type="text" class="form-control" id="username" name="username" required>
                        </div>
                        <div class="mb-3">
                            <label for="password" class="form-label">å¯†ç </label>
                            <input type="password" class="form-control" id="password" name="password" required>
                        </div>
                        <div class="mb-3 form-check">
                            <input type="checkbox" class="form-check-input" id="rememberMe" name="rememberMe">
                            <label class="form-check-label" for="rememberMe">è®°ä½æˆ‘ï¼ˆä¿æŒç™»å½•çŠ¶æ€30å¤©ï¼‰</label>
                        </div>
                        <button type="submit" class="btn btn-primary">ç™»å½•</button>
                    </form>
                    <div class="switch-form">
                        <p>è¿˜æ²¡æœ‰è´¦å·ï¼Ÿ<a href="#" id="showRegister">ç«‹å³æ³¨å†Œ</a></p>
                    </div>
                </div>
            </div>
        </div>

        <!-- æ³¨å†Œå¼¹çª— -->
        <div id="registerModal" class="modal">
            <div class="modal-content">
                <span class="close" id="closeRegisterModal">&times;</span>
                <h2>ç”¨æˆ·æ³¨å†Œ</h2>
                <div class="modal-body">
                    <form id="registerForm" action="/xuexi_ranshao/register" method="POST">
                        <div class="mb-3">
                            <label for="regUsername" class="form-label">ç”¨æˆ·å</label>
                            <input type="text" class="form-control" id="regUsername" name="username" required>
                        </div>
                        <div class="mb-3">
                            <label for="regPassword" class="form-label">å¯†ç </label>
                            <input type="password" class="form-control" id="regPassword" name="password" required>
                        </div>
                        <div class="mb-3">
                            <label for="confirmPassword" class="form-label">ç¡®è®¤å¯†ç </label>
                            <input type="password" class="form-control" id="confirmPassword" name="confirmPassword"
                                required>
                        </div>
                        <div class="mb-3">
                            <label for="regEmail" class="form-label">é‚®ç®±ï¼ˆå¯é€‰ï¼‰</label>
                            <input type="email" class="form-control" id="regEmail" name="email">
                        </div>
                        <button type="submit" class="btn btn-success">æ³¨å†Œ</button>
                    </form>
                    <div class="switch-form">
                        <p>å·²æœ‰è´¦å·ï¼Ÿ<a href="#" id="showLogin">ç«‹å³ç™»å½•</a></p>
                    </div>
                </div>
            </div>
        </div>

        <!-- è®¾ç½®æ¯”ç‡å¼¹çª— -->
        <div id="settingsModal" class="modal">
            <div class="modal-content">
                <span class="close" id="closeSettingsModal">&times;</span>
                <h2>è®¾ç½®åˆä½œç¤¾å›æ”¶æ¯”ç‡</h2>
                <p>å½“å‰æ¯”ç‡: <span id="currentRateSpan">2200</span></p>
                <div class="modal-body">
                    <form id="settingsForm">
                        <div class="mb-3">
                            <label for="cooperativeRate" class="form-label">æ–°æ¯”ç‡</label>
                            <input type="number" step="0.01" class="form-control" id="cooperativeRate" required>
                        </div>
                        <button type="submit" class="btn btn-primary">ä¿å­˜</button>
                        <button type="button" id="cancelSettings" class="btn btn-secondary">å–æ¶ˆ</button>
                    </form>
                </div>
            </div>
        </div>

        <!-- è‡ªå®šä¹‰æ¶ˆæ¯å¼¹çª— -->
        <div id="messageModal" class="message-modal">
            <div class="message-content">
                <div class="message-icon" id="messageIcon"></div>
                <div class="message-text" id="messageText"></div>
                <button class="message-btn" id="messageBtn">ç¡®å®š</button>
            </div>
        </div>

        <!-- æ›´æ–°æ•°æ®å¼¹çª— -->
        <div id="updateDataModal" class="modal">
            <div class="modal-content">
                <span class="close" id="closeUpdateDataModal">&times;</span>
                <h2>æ›´æ–°è¡€è¢­åˆä½œç¤¾æ•°æ®</h2>
                <div class="modal-body">
                    <form id="updateDataForm">
                        <div class="mb-3">
                            <label for="updateBloodUsername" class="form-label">è¡€è¢­åˆä½œç¤¾ç”¨æˆ·å</label>
                            <input type="text" class="form-control" id="updateBloodUsername" required>
                        </div>
                        <div class="mb-3">
                            <label for="updateBloodPassword" class="form-label">è¡€è¢­åˆä½œç¤¾å¯†ç </label>
                            <input type="password" class="form-control" id="updateBloodPassword" required>
                        </div>
                        <button type="submit" class="btn btn-primary">è·å–å¹¶æ›´æ–°æ•°æ®</button>
                        <button type="button" id="cancelUpdateData" class="btn btn-secondary">å–æ¶ˆ</button>
                    </form>
                    <div id="updateLoadingIndicator" class="loading-indicator" style="display: none;">
                        <div class="spinner"></div>
                        <div>æ­£åœ¨è·å–æ•°æ®ï¼Œè¯·ç¨å€™...</div>
                    </div>
                    <!-- æ·»åŠ æ›´æ–°çŠ¶æ€æ˜¾ç¤ºåŒºåŸŸ -->
                    <div id="updateStatusDisplay" class="update-status-display" style="display: none;">
                        <div class="update-progress">
                            <div class="progress-bar">
                                <div class="progress-fill" id="progressFill"></div>
                            </div>
                            <div class="progress-text" id="progressText">0%</div>
                        </div>
                        <div class="update-steps">
                            <div class="update-step" id="step1">
                                <div class="step-icon">1</div>
                                <div class="step-text">éªŒè¯è´¦æˆ·</div>
                            </div>
                            <div class="update-step" id="step2">
                                <div class="step-icon">2</div>
                                <div class="step-text">è·å–æ•°æ®</div>
                            </div>
                            <div class="update-step" id="step3">
                                <div class="step-icon">3</div>
                                <div class="step-text">ä¿å­˜åˆ°æ•°æ®åº“</div>
                            </div>
                            <div class="update-step" id="step4">
                                <div class="step-icon">4</div>
                                <div class="step-text">è®¡ç®—ç»Ÿè®¡ä¿¡æ¯</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- é¡µé¢å†…å®¹åŒºåŸŸ -->
        <div class="content-area">
            <div class="isk-lp-info">
                <a href="https://www.fuzzwork.co.uk/lpstore/buy/10000002/1000134" class="info-card-link" target="_blank" rel="noopener noreferrer">
                    <div class="info-card clickable">
                        <div class="info-label">å®æ—¶jita ISK/LP æ¯”ç‡</div>
                        <div class="info-value">{{ max_isk_lp if max_isk_lp is defined else '0' }}</div>
                    </div>
                </a>
                <div class="info-card clickable" onclick="openSettingsModal()">
                    <div class="info-label">å®æ—¶åˆä½œç¤¾å›æ”¶ ISK/LP æ¯”ç‡</div>
                    <div class="info-value">2200</div>
                </div>
                <!-- æ–°å¢è¡€è¢­è€…LPç‚¹æ•°æ˜¾ç¤ºå¡ç‰‡ -->
                <div class="info-card">
                    <div class="info-label">è¡€è¢­è€…LPç‚¹æ•°</div>
                    <div class="info-value">{{ '{:,}'.format(blood_raider_lp) if blood_raider_lp is defined and blood_raider_lp else '0' }}</div>
                </div>
                <div class="info-card">
                    <div class="info-label">æ„æ—å¥¸å•†ä»·</div>
                    <div class="info-value">{{ '{:,.0f}'.format(2200 * blood_raider_lp) if blood_raider_lp is defined and blood_raider_lp else '0' }}</div>
                </div>
            </div>
            
            <!-- ä»»åŠ¡çŠ¶æ€ä¿¡æ¯ -->
            <div class="mission-status-info">
                <h3>ä»»åŠ¡çŠ¶æ€ç»Ÿè®¡</h3>
                <div class="isk-lp-info">  <!-- å¤ç”¨ç°æœ‰çš„å¡ç‰‡å¸ƒå±€æ ·å¼ -->
                    {% if mission_status is defined and mission_status.completed %}
                    <div class="info-card">
                        <div class="info-label">å·²å®Œæˆä»»åŠ¡</div>
                        <div class="info-value">{{ mission_status.completed.count }}</div>
                        <div class="info-bounty">{{ '{:,.0f}'.format(mission_status.completed.total_bounty) }} ISK</div>
                    </div>
                    {% endif %}
                    
                    {% if mission_status is defined and mission_status.paid %}
                    <div class="info-card">
                        <div class="info-label">å·²æ”¯ä»˜ä»»åŠ¡</div>
                        <div class="info-value">{{ mission_status.paid.count }}</div>
                        <div class="info-bounty">{{ '{:,.0f}'.format(mission_status.paid.total_bounty) }} ISK</div>
                    </div>
                    {% endif %}
                    
                    {% if mission_status is defined and mission_status.done %}
                    <div class="info-card">
                        <div class="info-label">å·²å®Œç»“ä»»åŠ¡</div>
                        <div class="info-value">{{ mission_status.done.count }}</div>
                        <div class="info-bounty">{{ '{:,.0f}'.format(mission_status.done.total_bounty) }} ISK</div>
                    </div>
                    {% endif %}
                </div>
            </div>
            
            <!-- åœ¨ä»»åŠ¡çŠ¶æ€ç»Ÿè®¡ä¸‹æ–¹æ·»åŠ  -->
            <div class="tables-container">
                <div class="table-section">
                    <h4>å·²æ”¯ä»˜ä»»åŠ¡æ±‡æ€»</h4>
                    <div class="table-wrapper">
                        <table id="paidMissionsTable" class="data-table">
                            <thead>
                                <tr>
                                    <th>è€æ¿è´¦å·</th>
                                    <th>ä»»åŠ¡æ•°é‡</th>
                                    <th>æ€»é‡‘é¢</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- æ•°æ®å°†é€šè¿‡JavaScriptåŠ¨æ€åŠ è½½ -->
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="table-section">
                    <h4>æœ€è¿‘é’±åŒ…æèµ </h4>
                    <div class="table-wrapper">
                        <table id="walletDonationsTable" class="data-table">
                            <thead>
                                <tr>
                                    <th>æèµ äºº</th>
                                    <th>ç±»å‹</th>
                                    <th>é‡‘é¢</th>
                                    <th>æ—¥æœŸ</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- æ•°æ®å°†é€šè¿‡JavaScriptåŠ¨æ€åŠ è½½ -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            

        </div>
    </main>

    <style>
        .db-save-status {
            margin: 15px 0;
            padding: 12px;
            border-radius: 6px;
            font-weight: 500;
        }

        .db-save-status.success {
            background: #e8f5e9;
            color: #388e3c;
            border-left: 4px solid #4caf50;
        }

        .db-save-status.error {
            background: #ffebee;
            color: #d32f2f;
            border-left: 4px solid #f44336;
        }

        .btn-success:hover {
            background: linear-gradient(90deg, #2e7d32 0%, #81c784 100%) !important;
        }

        /* æ·»åŠ å–æ¶ˆæŒ‰é’®æ ·å¼ï¼Œä¸è®¾ç½®æ¯”ç‡æŒ‰é’®ä¿æŒä¸€è‡´ */
        .btn-secondary {
            background: linear-gradient(135deg, #4caf50, #66bb6a);
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            padding: 12px;
            margin-top: 8px;
            box-sizing: border-box;
            width: 100%;
        }

        .btn-secondary:hover {
            background: linear-gradient(135deg, #388e3c, #81c784);
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(76, 175, 80, 0.3);
        }
        
        /* æ›´æ–°çŠ¶æ€æ˜¾ç¤ºæ ·å¼ */
        .update-status-display {
            margin-top: 20px;
            padding: 15px;
            background: #f5f5f5;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
        }

        .update-progress {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }

        .progress-bar {
            flex: 1;
            height: 10px;
            background: #e0e0e0;
            border-radius: 5px;
            overflow: hidden;
            margin-right: 10px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #1976d2, #42a5f5);
            width: 0%;
            transition: width 0.3s ease;
        }

        .progress-text {
            font-weight: bold;
            color: #1976d2;
            width: 40px;
            text-align: right;
        }

        .update-steps {
            display: flex;
            justify-content: space-between;
        }

        .update-step {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 22%;
        }

        .step-icon {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: #e0e0e0;
            color: #757575;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-bottom: 8px;
            transition: all 0.3s ease;
        }

        .step-text {
            font-size: 0.8em;
            color: #757575;
            text-align: center;
            transition: all 0.3s ease;
        }

        .update-step.active .step-icon {
            background: #1976d2;
            color: white;
        }

        .update-step.active .step-text {
            color: #1976d2;
            font-weight: bold;
        }

        .update-step.completed .step-icon {
            background: #4caf50;
            color: white;
        }

        .update-step.completed .step-text {
            color: #4caf50;
            font-weight: bold;
        }

        .update-step.error .step-icon {
            background: #f44336;
            color: white;
        }

        .update-step.error .step-text {
            color: #f44336;
            font-weight: bold;
        }

        .switch-form {
            margin-top: 20px;
            padding-top: 16px;
            border-top: 1px solid #eee;
        }

        .settings-item {
            color: #4caf50;
            font-weight: 500;
        }

        .settings-item:hover {
            background: #e8f5e9;
            color: #388e3c;
        }

        .settings-icon {
            font-size: 1.1em;
        }

        .update-data-item {
            color: #1976d2;
            font-weight: 500;
        }

        .update-data-item:hover {
            background: #e3f2fd;
            color: #1565c0;
        }

        .update-icon {
            font-size: 1.1em;
        }

        .force-refresh-item {
            color: #ff9800;
            font-weight: 500;
        }

        .force-refresh-item:hover {
            background: #fff3e0;
            color: #f57c00;
        }

        .refresh-icon {
            font-size: 1.1em;
        }

        /* ISK/LP ä¿¡æ¯å¡ç‰‡æ ·å¼ */
        .isk-lp-info {
            display: flex;
            gap: 20px;
            margin: 30px 0;
            flex-wrap: wrap;
        }

        .info-card-link {
            text-decoration: none;
            color: inherit;
            display: block;
            flex: 1;
        }

        .info-card {
            background: linear-gradient(135deg, #ffffff, #f8f9fa);
            border: 2px solid #e3f2fd;
            border-radius: 12px;
            padding: 20px;
            min-width: 200px;
            flex: 1;
            text-align: center;
            box-shadow: 0 4px 12px rgba(25, 118, 210, 0.1);
            transition: all 0.3s ease;
        }

        .info-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(25, 118, 210, 0.15);
            border-color: #1976d2;
        }

        .info-card.clickable {
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .info-card.clickable:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 25px rgba(25, 118, 210, 0.2);
            border-color: #1976d2;
            background: linear-gradient(135deg, #f8f9fa, #e3f2fd);
        }

        .info-card.clickable:active {
            transform: translateY(-2px);
        }

        .info-label {
            font-size: 0.9em;
            color: #666;
            margin-bottom: 8px;
            font-weight: 500;
        }

        .info-value {
            font-size: 1.8em;
            font-weight: bold;
            color: #1976d2;
            text-shadow: 0 1px 2px rgba(25, 118, 210, 0.1);
        }
        
        .info-bounty {
            font-size: 1em;
            color: #388e3c;
            margin-top: 5px;
            font-weight: 500;
        }
        
        /* ä»»åŠ¡çŠ¶æ€ä¿¡æ¯æ ·å¼ */
        .mission-status-info {
            margin: 30px 0;
        }
        
        .mission-status-info h3 {
            color: #1976d2;
            margin-bottom: 15px;
            font-size: 1.3em;
        }
        
        .info-bounty {
            font-size: 1em;
            color: #388e3c;
            margin-top: 5px;
            font-weight: 500;
        }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            .isk-lp-info {
                flex-direction: column;
            }

            .info-card {
                min-width: auto;
            }
        }

        .tables-container {
            display: flex;
            gap: 20px;
            margin-top: 30px;
            width: 100%;
        }

        .table-section {
            flex: 1;
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .table-section h4 {
            margin: 0 0 15px 0;
            color: #333;
            font-size: 1.2em;
            text-align: center;
        }

        .table-wrapper {
            overflow-x: auto;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 8px;
            overflow: hidden;
        }

        .data-table th {
            background: linear-gradient(135deg, #1976d2, #42a5f5);
            color: white;
            padding: 12px 15px;
            text-align: left;
            font-weight: 600;
            font-size: 0.9em;
        }

        .data-table td {
            padding: 10px 15px;
            border-bottom: 1px solid #e0e0e0;
            color: #333;
        }

        .data-table tbody tr:hover {
            background-color: #f5f5f5;
        }

        .data-table tbody tr:last-child td {
            border-bottom: none;
        }

        .data-table .amount {
            color: #388e3c;
            font-weight: 500;
        }

        .data-table .count {
            color: #1976d2;
            font-weight: 500;
        }

        @media (max-width: 768px) {
            .tables-container {
                flex-direction: column;
            }
            
            .data-table {
                font-size: 0.8em;
            }
            
            .data-table th,
            .data-table td {
                padding: 8px 10px;
            }
        }

        /* è¡€è¢­æ•°æ®åŒºåŸŸæ ·å¼ */
        .blood-data-section {
            margin-top: 40px;
            padding: 30px;
            background: #f8f9fa;
            border-radius: 12px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
        }

        .blood-data-section h2 {
            color: #1976d2;
            margin-bottom: 25px;
            font-size: 1.5em;
            display: inline-block;
            margin-right: 20px;
        }

        .data-controls {
            margin-bottom: 25px;
            display: inline-block;
            vertical-align: top;
        }

        .section-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 25px;
        }

        .credentials-input {
            display: grid;
            grid-template-columns: auto 1fr auto 1fr auto;
            gap: 15px;
            align-items: center;
            max-width: 700px;
        }

        .credentials-input label {
            font-weight: 600;
            color: #333;
        }

        .credentials-input input {
            padding: 10px 12px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 1em;
            transition: border-color 0.3s;
        }

        .credentials-input input:focus {
            border-color: #1976d2;
            outline: none;
        }

        .fetch-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            background: linear-gradient(135deg, #1976d2, #42a5f5);
            color: white;
        }

        .fetch-btn:hover {
            background: linear-gradient(135deg, #1565c0, #64b5f6);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(25, 118, 210, 0.3);
        }

        .summary-btn {
            background: linear-gradient(135deg, #388e3c, #66bb6a);
        }

        .summary-btn:hover {
            background: linear-gradient(135deg, #2e7d32, #81c784);
        }

        .loading-indicator {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 20px;
            background: #e3f2fd;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .spinner {
            width: 24px;
            height: 24px;
            border: 3px solid #e0e0e0;
            border-top: 3px solid #1976d2;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .data-display {
            background: white;
            border-radius: 8px;
            padding: 20px;
            min-height: 200px;
            border: 1px solid #e0e0e0;
        }

        .data-placeholder {
            text-align: center;
            color: #666;
            font-style: italic;
            padding: 40px 20px;
        }

        .data-content {
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            line-height: 1.6;
            white-space: pre-wrap;
            word-wrap: break-word;
            max-height: 600px;
            overflow-y: auto;
        }

        .error-message {
            color: #d32f2f;
            background: #ffebee;
            padding: 15px;
            border-radius: 6px;
            border-left: 4px solid #d32f2f;
        }

        /* ç”¨æˆ·æ“ä½œåŒºåŸŸæ ·å¼ */
        .user-area {
            position: absolute;
            top: 70px;
            right: 40px;
            z-index: 100;
        }

        /* æœªç™»å½•çŠ¶æ€æ ·å¼ */
        .guest-area {
            display: flex;
            gap: 12px;
        }

        .auth-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 20px;
            font-size: 0.95em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .login-btn {
            background: linear-gradient(135deg, #1976d2, #42a5f5);
            color: white;
        }

        .login-btn:hover {
            background: linear-gradient(135deg, #1565c0, #64b5f6);
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(25, 118, 210, 0.3);
        }

        .register-btn {
            background: white;
            color: #1976d2;
            border: 2px solid #1976d2;
        }

        .register-btn:hover {
            background: #1976d2;
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(25, 118, 210, 0.3);
        }

        /* å·²ç™»å½•çŠ¶æ€æ ·å¼ */
        .user-profile {
            position: relative;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        /* è®¾ç½®æŒ‰é’®æ ·å¼ */
        .settings-btn {
            background: linear-gradient(135deg, #4caf50, #66bb6a);
            color: white;
        }

        .settings-btn:hover {
            background: linear-gradient(135deg, #388e3c, #81c784);
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(76, 175, 80, 0.3);
        }

        .user-avatar {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: linear-gradient(135deg, #1976d2, #42a5f5);
            color: white;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 12px rgba(25, 118, 210, 0.2);
        }

        .user-avatar:hover {
            background: linear-gradient(135deg, #1565c0, #64b5f6);
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(25, 118, 210, 0.3);
        }

        .user-avatar img {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            padding: 4px;
        }

        .username {
            font-weight: 600;
            font-size: 0.95em;
            max-width: 120px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .dropdown-arrow {
            font-size: 0.8em;
            transition: transform 0.3s ease;
        }

        .user-profile.active .dropdown-arrow {
            transform: rotate(180deg);
        }

        /* ä¸‹æ‹‰èœå•æ ·å¼ */
        .user-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            margin-top: 8px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
            min-width: 220px;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: all 0.3s ease;
            z-index: 1000;
        }

        .user-profile.active .user-dropdown {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .dropdown-item {
            padding: 12px 16px;
            border: none;
            background: none;
            width: 100%;
            text-align: left;
            cursor: pointer;
            transition: background 0.2s ease;
            display: flex;
            align-items: center;
            gap: 12px;
            line-height: 1; /* æ·»åŠ è¿™ä¸€è¡Œï¼Œç»Ÿä¸€è¡Œé«˜ */
        }

        .dropdown-item:hover {
            background: #f5f5f5;
        }

        .dropdown-item:first-child {
            border-radius: 12px 12px 0 0;
        }

        .dropdown-item:last-child {
            border-radius: 0 0 12px 12px;
        }

        .user-info {
            cursor: default;
            background: #f8f9fa;
        }

        .user-info:hover {
            background: #f8f9fa;
        }

        .user-details {
            flex: 1;
        }

        .user-name {
            font-weight: 600;
            color: #333;
            font-size: 1em;
        }

        .user-level {
            font-size: 0.85em;
            color: #666;
            margin-top: 2px;
        }

        .dropdown-divider {
            height: 1px;
            background: #e0e0e0;
            margin: 0;
        }

        .logout-btn {
            color: #d32f2f;
            font-weight: 500;
        }

        .logout-btn:hover {
            background: #ffebee;
            color: #c62828;
        }

        .logout-icon {
            font-size: 1.1em;
        }

        /* åŸæœ‰æ ·å¼ä¿æŒä¸å˜ */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.15);
            justify-content: center;
            align-items: center;
        }

        .modal.show {
            display: flex;
            animation: simpleModalFadeIn 0.15s ease-out forwards;
        }

        @keyframes simpleModalFadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        .modal-content {
            background: #fff;
            margin: auto;
            padding: 36px 32px 28px 32px;
            border-radius: 18px;
            width: 340px;
            box-shadow: 0 8px 24px rgba(25, 118, 210, 0.12);
            position: relative;
            text-align: center;
            /* ç§»é™¤å†…å®¹çš„å•ç‹¬åŠ¨ç”»ï¼Œé¿å…é‡å¤åŠ¨ç”» */
            /* animation: modalFadeIn 0.3s; */
        }

        .close {
            position: absolute;
            right: 18px;
            top: 12px;
            font-size: 28px;
            color: #aaa;
            cursor: pointer;
            transition: color 0.2s;
        }

        .close:hover {
            color: #1976d2;
        }

        .modal-content h2 {
            margin-bottom: 24px;
            color: #1976d2;
            font-weight: bold;
            font-size: 1.5em;
        }

        .modal-content label {
            display: block;
            text-align: left;
            margin-bottom: 6px;
            color: #333;
            font-size: 1em;
        }

        .modal-content input {
            width: 100%;
            margin-bottom: 18px;
            padding: 10px 12px;
            border: 1.5px solid #bdbdbd;
            border-radius: 6px;
            font-size: 1.1em;
            transition: border 0.2s;
            box-sizing: border-box;
        }

        .modal-content input:focus {
            border: 1.5px solid #1976d2;
            outline: none;
        }

        .modal-content button[type="submit"] {
            width: 100%;
            padding: 12px;
            background: linear-gradient(90deg, #1976d2 0%, #42a5f5 100%);
            color: #fff;
            border: none;
            border-radius: 6px;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            transition: background 0.3s;
            margin-top: 8px;
            box-sizing: border-box;
        }

        .modal-content button[type="submit"]:hover {
            background: linear-gradient(90deg, #1565c0 0%, #64b5f6 100%);
        }

        .btn-success {
            background: linear-gradient(90deg, #388e3c 0%, #66bb6a 100%) !important;
        }

        .btn-success:hover {
            background: linear-gradient(90deg, #2e7d32 0%, #81c784 100%) !important;
        }

        .switch-form {
            margin-top: 20px;
            padding-top: 16px;
            border-top: 1px solid #eee;
        }

        .switch-form p {
            margin: 0;
            color: #666;
            font-size: 0.9em;
        }

        .switch-form a {
            color: #1976d2;
            text-decoration: none;
            font-weight: bold;
            transition: color 0.2s;
        }

        .switch-form a:hover {
            color: #1565c0;
            text-decoration: underline;
        }

        /* è‡ªå®šä¹‰æ¶ˆæ¯å¼¹çª—æ ·å¼ */
        .message-modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.2);
            justify-content: center;
            align-items: center;
        }

        .message-modal.show {
            display: flex;
            animation: simpleModalFadeIn 0.15s ease-out forwards;
        }

        .message-content {
            background: #fff;
            padding: 32px 28px 24px 28px;
            border-radius: 16px;
            width: 320px;
            max-width: 90vw;
            box-shadow: 0 12px 30px rgba(0, 0, 0, 0.1);
            text-align: center;
            /* ç§»é™¤å†…å®¹çš„å•ç‹¬åŠ¨ç”»ï¼Œé¿å…é‡å¤åŠ¨ç”» */
            /* animation: messageModalFadeIn 0.25s; */
        }

        .message-icon {
            width: 48px;
            height: 48px;
            margin: 0 auto 16px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            font-weight: bold;
        }

        .message-icon.success {
            background: linear-gradient(135deg, #4caf50, #66bb6a);
            color: #fff;
        }

        .message-icon.success::before {
            content: 'âœ“';
        }

        .message-icon.error {
            background: linear-gradient(135deg, #f44336, #ef5350);
            color: #fff;
        }

        .message-icon.error::before {
            content: 'âœ•';
        }

        .message-icon.info {
            background: linear-gradient(135deg, #2196f3, #42a5f5);
            color: #fff;
        }

        .message-icon.info::before {
            content: 'i';
        }

        .message-icon.warning {
            background: linear-gradient(135deg, #ff9800, #ffb74d);
            color: #fff;
        }

        .message-icon.warning::before {
            content: 'âš ';
        }

        .message-text {
            font-size: 1.1em;
            color: #333;
            margin-bottom: 24px;
            line-height: 1.5;
        }

        .message-btn {
            background: linear-gradient(90deg, #1976d2 0%, #42a5f5 100%);
            color: #fff;
            border: none;
            padding: 10px 32px;
            border-radius: 8px;
            font-size: 1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
            min-width: 80px;
        }

        .message-btn:hover {
            background: linear-gradient(90deg, #1565c0 0%, #64b5f6 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(25, 118, 210, 0.3);
        }

        /* å†…å®¹åŒºåŸŸæ ·å¼ */
        .content-area {
            padding: 120px 40px 40px;
            max-width: 1200px;
            margin: 0 auto;
        }

        .content-area h1 {
            color: #1976d2;
            margin-bottom: 20px;
        }

        /* EVEä»¤ç‰Œé€šçŸ¥æ ·å¼ */
        .eve-token-notification {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        .eve-token-notification .notification-content {
            display: flex;
            align-items: flex-start;
            gap: 12px;
        }

        .eve-token-notification .notification-icon {
            font-size: 24px;
            flex-shrink: 0;
            margin-top: 2px;
        }

        .eve-token-notification .notification-text {
            flex: 1;
        }

        .eve-token-notification .notification-text strong {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-size: 16px;
        }

        .eve-token-notification .notification-text p {
            margin: 0;
            color: #666;
            font-size: 14px;
            line-height: 1.4;
        }

        .eve-token-notification .notification-actions {
            display: flex;
            gap: 8px;
            margin-top: 12px;
            flex-wrap: wrap;
        }

        .eve-token-notification .btn-primary {
            background: linear-gradient(135deg, #1976d2, #42a5f5);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .eve-token-notification .btn-primary:hover {
            background: linear-gradient(135deg, #1565c0, #64b5f6);
            transform: translateY(-1px);
        }

        .eve-token-notification .btn-secondary {
            background: #f5f5f5;
            color: #666;
            border: 1px solid #ddd;
            padding: 8px 16px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .eve-token-notification .btn-secondary:hover {
            background: #e0e0e0;
            color: #333;
        }

        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideOutRight {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }
    </style>

    <script>
        // åˆå§‹åŒ–è¡¨æ ¼
        function initTables() {
            // åŠ è½½æ•°æ®
            loadPaidMissionsData();
            loadWalletDonationsData();
        }

        // åŠ è½½å·²æ”¯ä»˜ä»»åŠ¡æ•°æ®
        function loadPaidMissionsData() {
            fetch('/api/paid_missions_summary')
                .then(response => response.json())
                .then(result => {
                    if (result.success) {
                        const data = result.data;
                        const tbody = document.querySelector('#paidMissionsTable tbody');
                        
                        // æ¸…ç©ºç°æœ‰æ•°æ®
                        tbody.innerHTML = '';
                        
                        if (data.length === 0) {
                            tbody.innerHTML = '<tr><td colspan="3" style="text-align: center; color: #666;">æš‚æ— æ•°æ®</td></tr>';
                            return;
                        }
                        
                        data.forEach(item => {
                            const row = document.createElement('tr');
                            row.innerHTML = `
                                <td>${item.payer}</td>
                                <td class="count">${item.mission_count}</td>
                                <td class="amount">${(item.total_amount || 0).toLocaleString()} ISK</td>
                            `;
                            tbody.appendChild(row);
                        });
                    }
                })
                .catch(error => console.error('åŠ è½½å·²æ”¯ä»˜ä»»åŠ¡æ•°æ®å¤±è´¥:', error));
        }

        // åŠ è½½é’±åŒ…æèµ æ•°æ®
        function loadWalletDonationsData() {
            fetch('/api/recent_wallet_donations')
                .then(response => response.json())
                .then(result => {
                    if (result.success) {
                        const data = result.data;
                        const tbody = document.querySelector('#walletDonationsTable tbody');
                        
                        // æ¸…ç©ºç°æœ‰æ•°æ®
                        tbody.innerHTML = '';
                        
                        if (data.length === 0) {
                            tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; color: #666;">æš‚æ— æ•°æ®</td></tr>';
                            return;
                        }
                        
                        data.forEach(item => {
                            const row = document.createElement('tr');
                            row.innerHTML = `
                                <td>${item.donor}</td>
                                <td>${item.type}</td>
                                <td class="amount">${(item.amount || 0).toLocaleString()} ISK</td>
                                <td>${item.date ? item.date.split('T')[0] : ''}</td>
                            `;
                            tbody.appendChild(row);
                        });
                    }
                })
                .catch(error => console.error('åŠ è½½é’±åŒ…æèµ æ•°æ®å¤±è´¥:', error));
        }

        // DOM å…ƒç´ 
        const userArea = document.getElementById('userArea');
        const guestArea = document.getElementById('guestArea');
        const userProfile = document.getElementById('userProfile');
        const userAvatar = document.getElementById('userAvatar');
        const userDropdown = document.getElementById('userDropdown');
        const displayUsername = document.getElementById('displayUsername');
        const dropdownUsername = document.getElementById('dropdownUsername');
        const userLevel = document.getElementById('userLevel');

        const loginBtn = document.getElementById('loginBtn');
        const registerBtn = document.getElementById('registerBtn');
        const logoutBtn = document.getElementById('logoutBtn');
        
        // è®¾ç½®æ¯”ç‡ç›¸å…³å…ƒç´ 
        const settingsBtnLoggedIn = document.getElementById('settingsBtnLoggedIn');
        const settingsModal = document.getElementById('settingsModal');
        const closeSettingsModal = document.getElementById('closeSettingsModal');
        const settingsForm = document.getElementById('settingsForm');
        const cancelSettings = document.getElementById('cancelSettings');
        const cooperativeRateInput = document.getElementById('cooperativeRate');
        const currentRateSpan = document.getElementById('currentRateSpan');

        const loginModal = document.getElementById('loginModal');
        const registerModal = document.getElementById('registerModal');
        const closeModal = document.getElementById('closeModal');
        const closeRegisterModal = document.getElementById('closeRegisterModal');
        const loginForm = document.getElementById('loginForm');
        const registerForm = document.getElementById('registerForm');
        const showRegister = document.getElementById('showRegister');
        const showLogin = document.getElementById('showLogin');

        // è‡ªå®šä¹‰æ¶ˆæ¯å¼¹çª—å…ƒç´ 
        const messageModal = document.getElementById('messageModal');
        const messageIcon = document.getElementById('messageIcon');
        const messageText = document.getElementById('messageText');
        const messageBtn = document.getElementById('messageBtn');
        
        // æ›´æ–°æ•°æ®å…ƒç´ 
        const updateDataBtn = document.getElementById('updateDataBtn');
        const updateDataModal = document.getElementById('updateDataModal');
        const closeUpdateDataModal = document.getElementById('closeUpdateDataModal');
        const updateDataForm = document.getElementById('updateDataForm');
        const cancelUpdateData = document.getElementById('cancelUpdateData');
        const updateBloodUsername = document.getElementById('updateBloodUsername');
        const updateBloodPassword = document.getElementById('updateBloodPassword');
        const updateLoadingIndicator = document.getElementById('updateLoadingIndicator');

        // å½“å‰ç”¨æˆ·ä¿¡æ¯
        let currentUser = null;
        // æ·»åŠ è¡€è¢­åˆä½œç¤¾å‡­æ®å­˜å‚¨
        let bloodCredentials = {
            username: '',
            password: ''
        };
        // æ·»åŠ å®šæ—¶æ›´æ–°çš„è®¡æ—¶å™¨å˜é‡
        let autoUpdateTimer = null;

        // ä¿å­˜å‡­æ®å‡½æ•°ï¼ˆå«å¤‡ä»½ï¼‰
        function saveCredentials(username, password) {
            const credentials = { username, password, timestamp: Date.now() };
            
            try {
                // ä¸»å­˜å‚¨
                localStorage.setItem('bloodCredentials', JSON.stringify(credentials));
                // å¤‡ä»½å­˜å‚¨
                localStorage.setItem('bloodCredentials_backup', JSON.stringify(credentials));
                console.log('âœ… å‡­æ®ä¿å­˜æˆåŠŸï¼ˆå«å¤‡ä»½ï¼‰');
            } catch (e) {
                console.error('âŒ å‡­æ®ä¿å­˜å¤±è´¥:', e);
            }
        }

        // æ¢å¤å‡­æ®å‡½æ•°ï¼ˆå°è¯•å¤‡ä»½ï¼‰
        function restoreCredentials() {
            let savedCredentials = localStorage.getItem('bloodCredentials');
            
            if (!savedCredentials) {
                console.log('ğŸ”„ ä¸»å‡­æ®ä¸å­˜åœ¨ï¼Œå°è¯•ä»å¤‡ä»½æ¢å¤');
                savedCredentials = localStorage.getItem('bloodCredentials_backup');
                
                if (savedCredentials) {
                    // ä»å¤‡ä»½æ¢å¤åˆ°ä¸»å­˜å‚¨
                    localStorage.setItem('bloodCredentials', savedCredentials);
                    console.log('âœ… ä»å¤‡ä»½æˆåŠŸæ¢å¤å‡­æ®');
                }
            }
            
            return savedCredentials;
        }

        // è‡ªå®šä¹‰æ¶ˆæ¯å¼¹çª—å‡½æ•°
        function showMessage(text, type = 'info') {
            messageText.textContent = text;
            messageIcon.className = `message-icon ${type}`;
            messageModal.classList.add('show');
        }

        // å…³é—­æ¶ˆæ¯å¼¹çª—
        messageBtn.onclick = () => messageModal.classList.remove('show');

        // ç‚¹å‡»æ¶ˆæ¯å¼¹çª—å¤–éƒ¨å…³é—­
        messageModal.onclick = (event) => {
            if (event.target === messageModal) {
                messageModal.classList.remove('show');
            }
        };

        // æ·»åŠ ä¼šè¯ä¿æ´»åŠŸèƒ½
        let sessionKeepAliveTimer = null;

        function startSessionKeepAlive() {
            // æ¸…é™¤ç°æœ‰å®šæ—¶å™¨
            if (sessionKeepAliveTimer) {
                clearInterval(sessionKeepAliveTimer);
            }
            
            // æ¯3åˆ†é’Ÿå‘é€ä¸€æ¬¡ä¿æ´»è¯·æ±‚
            sessionKeepAliveTimer = setInterval(async () => {
                try {
                    console.log('ğŸ”„ æ‰§è¡Œä¼šè¯ä¿æ´»æ£€æŸ¥');
                    const response = await fetch('/xuexi_ranshao/check_auth', {
                        method: 'GET',
                        credentials: 'same-origin',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    });
                    
                    if (response.ok) {
                        const result = await response.json();
                        if (result.authenticated) {
                            console.log('âœ… ä¼šè¯ä¿æ´»æˆåŠŸ');
                        } else {
                            console.warn('âš ï¸ ä¼šè¯å·²å¤±æ•ˆï¼Œåœæ­¢ä¿æ´»');
                            stopSessionKeepAlive();
                            updateUserInterface(); // åˆ‡æ¢åˆ°æœªç™»å½•çŠ¶æ€
                        }
                    } else {
                        console.warn('âš ï¸ ä¼šè¯ä¿æ´»è¯·æ±‚å¤±è´¥');
                    }
                } catch (error) {
                    console.error('âŒ ä¼šè¯ä¿æ´»å¼‚å¸¸:', error);
                }
            }, 3 * 60 * 1000); // 3åˆ†é’Ÿ
            
            console.log('ğŸ”„ ä¼šè¯ä¿æ´»å·²å¯åŠ¨');
        }

        function stopSessionKeepAlive() {
            if (sessionKeepAliveTimer) {
                clearInterval(sessionKeepAliveTimer);
                sessionKeepAliveTimer = null;
                console.log('ğŸ›‘ ä¼šè¯ä¿æ´»å·²åœæ­¢');
            }
        }

        // æ›´æ–°ç”¨æˆ·ç•Œé¢
        function updateUserInterface(user = null) {
            console.log(`ğŸ”„ [updateUserInterface] æ›´æ–°ç”¨æˆ·ç•Œé¢:`, user);
            
            // ğŸ†• æ·»åŠ EVE SSOçŠ¶æ€è¾“å‡º
            console.log(`ğŸš€ [updateUserInterface] EVE SSOä¼šè¯ä¿¡æ¯:`, {
                character_id: '{{ session.get("eve_character_id") if session else "" }}',
                character_name: '{{ session.get("eve_character_name") if session else "" }}',
                has_access_token: '{{ session.get("eve_access_token") if session else "" }}' ? true : false,
                has_refresh_token: '{{ session.get("eve_refresh_token") if session else "" }}' ? true : false,
                token_expires: '{{ session.get("eve_token_expires") if session else "" }}'
            });
            
            if (user) {
                currentUser = user;
                console.log(`âœ… [updateUserInterface] ç”¨æˆ·ç™»å½•çŠ¶æ€:`, {
                    username: user.username,
                    access_level: user.access_level || 'standard',
                    eve_sso_linked: '{{ session.get("eve_character_name") if session else "" }}' ? true : false
                });
                
                guestArea.style.display = 'none';
                userProfile.style.display = 'block';
                displayUsername.textContent = user.username;
                dropdownUsername.textContent = user.username;
                userLevel.textContent = `æƒé™ç­‰çº§: ${user.access_level || 'standard'}`;
                
                // é‡æ–°ç»‘å®šæŒ‰é’®äº‹ä»¶
                updateDataBtn.onclick = function(e) {
                    e.stopPropagation();
                    openUpdateDataModal();
                };
                
                settingsBtnLoggedIn.onclick = function(e) {
                    e.stopPropagation();
                    openSettingsModal();
                };
                
                // å¯åŠ¨ä¼šè¯ä¿æ´»
                startSessionKeepAlive();
            } else {
                console.log(`âŒ [updateUserInterface] ç”¨æˆ·æœªç™»å½•ï¼Œæ¸…é™¤ç•Œé¢çŠ¶æ€`);
                currentUser = null;
                guestArea.style.display = 'flex';
                userProfile.style.display = 'none';
                userProfile.classList.remove('active');
                // åœæ­¢ä¼šè¯ä¿æ´»
                stopSessionKeepAlive();
            }
        }

        // æ£€æŸ¥ç™»å½•çŠ¶æ€ï¼ˆå¸¦é‡è¯•æœºåˆ¶å’Œè¯¦ç»†è°ƒè¯•ä¿¡æ¯ï¼‰
async function checkAuthStatus(retryCount = 0) {
    console.log(`ğŸ” [checkAuthStatus] å¼€å§‹æ£€æŸ¥ç™»å½•çŠ¶æ€ï¼Œé‡è¯•æ¬¡æ•°: ${retryCount}`);
    
    try {
        // ğŸ”‘ å¼ºåˆ¶åˆ·æ–°é¡µé¢cookies
        if (retryCount === 0) {
            console.log('ğŸ”„ [checkAuthStatus] é¦–æ¬¡æ£€æŸ¥ï¼Œç­‰å¾…cookiesåŠ è½½');
            await new Promise(resolve => setTimeout(resolve, 500));
        }
        
        console.log(`ğŸ“¡ [checkAuthStatus] å‘é€è¯·æ±‚åˆ°: /xuexi_ranshao/check_auth`);
        const response = await fetch('/xuexi_ranshao/check_auth', {
            method: 'GET',
            credentials: 'same-origin',  // ğŸ”‘ ç¡®ä¿åŒ…å«cookies
            headers: {
                'Content-Type': 'application/json',
                'Cache-Control': 'no-cache',
                'Pragma': 'no-cache'  // å¼ºåˆ¶ä¸ä½¿ç”¨ç¼“å­˜
            }
        });
        
        console.log(`ğŸ“¥ [checkAuthStatus] æ”¶åˆ°å“åº”:`, {
            status: response.status,
            statusText: response.statusText,
            ok: response.ok,
            headers: Object.fromEntries(response.headers.entries())
        });
        
        if (response.ok) {
            const result = await response.json();
            console.log(`âœ… [checkAuthStatus] è§£æJSONæˆåŠŸ:`, result);
            
            // ğŸ†• æ·»åŠ EVE SSOä¿¡æ¯è¾“å‡º
            console.log(`ğŸš€ [checkAuthStatus] EVE SSOçŠ¶æ€æ£€æŸ¥:`, {
                eve_character_id: '{{ session.get("eve_character_id") if session else "" }}',
                eve_character_name: '{{ session.get("eve_character_name") if session else "" }}',
                eve_access_token: '{{ session.get("eve_access_token") if session else "" }}' ? 'å­˜åœ¨' : 'ä¸å­˜åœ¨',
                eve_token_expires: '{{ session.get("eve_token_expires") if session else "" }}',
                eve_refresh_token: '{{ session.get("eve_refresh_token") if session else "" }}' ? 'å­˜åœ¨' : 'ä¸å­˜åœ¨'
            });
            
            if (result.authenticated) {
                console.log(`ğŸ‰ [checkAuthStatus] ç”¨æˆ·å·²è®¤è¯:`, result.user);
                
                // ğŸ†• æ£€æŸ¥EVE SSOä»¤ç‰ŒçŠ¶æ€
                const eveTokenExpires = '{{ session.get("eve_token_expires") if session else "" }}';
                if (eveTokenExpires) {
                    const expiresTime = new Date(eveTokenExpires);
                    const now = new Date();
                    const timeLeft = Math.floor((expiresTime - now) / 1000 / 60); // åˆ†é’Ÿ
                    
                    console.log(`â° [checkAuthStatus] EVE SSOä»¤ç‰ŒçŠ¶æ€:`, {
                        expires_at: eveTokenExpires,
                        time_left_minutes: timeLeft,
                        is_expired: timeLeft <= 0,
                        needs_refresh: timeLeft <= 5
                    });
                    
                    if (timeLeft <= 0) {
                        console.warn(`âš ï¸ [checkAuthStatus] EVE SSOä»¤ç‰Œå·²è¿‡æœŸï¼`);
                    } else if (timeLeft <= 5) {
                        console.warn(`âš ï¸ [checkAuthStatus] EVE SSOä»¤ç‰Œå³å°†è¿‡æœŸï¼Œå‰©ä½™${timeLeft}åˆ†é’Ÿ`);
                    } else {
                        console.log(`âœ… [checkAuthStatus] EVE SSOä»¤ç‰Œæœ‰æ•ˆï¼Œå‰©ä½™${timeLeft}åˆ†é’Ÿ`);
                    }
                } else {
                    console.warn(`âŒ [checkAuthStatus] æœªæ‰¾åˆ°EVE SSOä»¤ç‰Œè¿‡æœŸæ—¶é—´`);
                }
                
                updateUserInterface(result.user);
                    
                    // å°è¯•ä»æœ¬åœ°å­˜å‚¨æ¢å¤è¡€è¢­åˆä½œç¤¾å‡­æ®
                    try {
                        const savedCredentials = restoreCredentials();
                        console.log(`ğŸ’¾ [checkAuthStatus] æœ¬åœ°å­˜å‚¨çš„å‡­æ®:`, savedCredentials ? 'å­˜åœ¨' : 'ä¸å­˜åœ¨');
                        
                        if (savedCredentials) {
                            const parsed = JSON.parse(savedCredentials);
                            console.log(`ğŸ”‘ [checkAuthStatus] è§£æå‡­æ®æˆåŠŸ:`, {
                                hasUsername: !!parsed.username,
                                hasPassword: !!parsed.password
                            });
                            
                            bloodCredentials.username = parsed.username;
                            bloodCredentials.password = parsed.password;
                            
                            // å¯åŠ¨è‡ªåŠ¨æ›´æ–°å®šæ—¶å™¨
                            startAutoUpdate();
                        }
                    } catch (e) {
                        console.error('âŒ [checkAuthStatus] æ¢å¤å‡­æ®å¤±è´¥:', e);
                    }
                } else {
                console.log(`âŒ [checkAuthStatus] ç”¨æˆ·æœªè®¤è¯ï¼Œé‡è¯•æ¬¡æ•°: ${retryCount}`);
                
                // å¦‚æœè®¤è¯å¤±è´¥ä¸”é‡è¯•æ¬¡æ•°å°‘äº3æ¬¡ï¼Œåˆ™é‡è¯•
                if (retryCount < 3) {
                    console.log(`ğŸ”„ [checkAuthStatus] ${retryCount + 1}ç§’åé‡è¯•...`);
                    setTimeout(() => checkAuthStatus(retryCount + 1), 1000);
                    return;
                }
                console.log(`ğŸš« [checkAuthStatus] è¾¾åˆ°æœ€å¤§é‡è¯•æ¬¡æ•°ï¼Œåœæ­¢é‡è¯•`);
                updateUserInterface();
                stopAutoUpdate();
            }
        } else {
            console.error(`âŒ [checkAuthStatus] HTTPé”™è¯¯:`, {
                status: response.status,
                statusText: response.statusText
            });
            
            // ç½‘ç»œé”™è¯¯ä¹Ÿè¿›è¡Œé‡è¯•
            if (retryCount < 3) {
                console.log(`ğŸ”„ [checkAuthStatus] ç½‘ç»œé”™è¯¯ï¼Œ${retryCount + 1}ç§’åé‡è¯•...`);
                setTimeout(() => checkAuthStatus(retryCount + 1), 1000);
                return;
            }
            console.log(`ğŸš« [checkAuthStatus] ç½‘ç»œé”™è¯¯è¾¾åˆ°æœ€å¤§é‡è¯•æ¬¡æ•°`);
            updateUserInterface();
            stopAutoUpdate();
        }
    } catch (error) {
        console.error('ğŸ’¥ [checkAuthStatus] è¯·æ±‚å¼‚å¸¸:', {
            name: error.name,
            message: error.message,
            stack: error.stack
        });
        
        if (retryCount < 3) {
            console.log(`ğŸ”„ [checkAuthStatus] å¼‚å¸¸åé‡è¯•ï¼Œ${retryCount + 1}ç§’åé‡è¯•...`);
            setTimeout(() => checkAuthStatus(retryCount + 1), 1000);
            return;
        }
        console.log(`ğŸš« [checkAuthStatus] å¼‚å¸¸è¾¾åˆ°æœ€å¤§é‡è¯•æ¬¡æ•°`);
        updateUserInterface();
        stopAutoUpdate();
    }
}

        // ğŸ†• EVE SSOçŠ¶æ€è°ƒè¯•å‡½æ•°
        function debugEveSSO() {
            console.log(`ğŸ” [debugEveSSO] å®Œæ•´EVE SSOçŠ¶æ€:`, {
                session_data: {
                    character_id: '{{ session.get("eve_character_id") if session else "" }}',
                    character_name: '{{ session.get("eve_character_name") if session else "" }}',
                    access_token: '{{ session.get("eve_access_token") if session else "" }}' ? 'å­˜åœ¨(é•¿åº¦:' + '{{ session.get("eve_access_token")|length if session and session.get("eve_access_token") else 0 }}' + ')' : 'ä¸å­˜åœ¨',
                    refresh_token: '{{ session.get("eve_refresh_token") if session else "" }}' ? 'å­˜åœ¨' : 'ä¸å­˜åœ¨',
                    token_expires: '{{ session.get("eve_token_expires") if session else "" }}'
                },
                local_storage: {
                    blood_credentials: localStorage.getItem('bloodCredentials') ? 'å­˜åœ¨' : 'ä¸å­˜åœ¨',
                    last_update_time: localStorage.getItem('lastUpdateTime')
                },
                current_time: new Date().toISOString()
            });
            
            // æ£€æŸ¥ä»¤ç‰Œæœ‰æ•ˆæ€§
            const eveTokenExpires = '{{ session.get("eve_token_expires") if session else "" }}';
            if (eveTokenExpires) {
                const expiresTime = new Date(eveTokenExpires);
                const now = new Date();
                const timeLeft = Math.floor((expiresTime - now) / 1000 / 60);
                
                console.log(`â° [debugEveSSO] ä»¤ç‰Œæ—¶é—´åˆ†æ:`, {
                    expires_at: eveTokenExpires,
                    current_time: now.toISOString(),
                    time_left_minutes: timeLeft,
                    status: timeLeft > 5 ? 'æ­£å¸¸' : timeLeft > 0 ? 'å³å°†è¿‡æœŸ' : 'å·²è¿‡æœŸ'
                });
            }
        }

        // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥ç™»å½•çŠ¶æ€
        document.addEventListener('DOMContentLoaded', function() {
            debugEveSSO();
            checkAuthStatus();
            // ğŸ†• æ·»åŠ EVE SSOè¿‡æœŸæ£€æŸ¥
            checkEveTokenOnPageLoad();
            // åˆå§‹åŒ–è¡¨æ ¼
            initTables();
        });

        // ğŸ†• é¡µé¢åŠ è½½æ—¶æ£€æŸ¥EVE SSOä»¤ç‰ŒçŠ¶æ€
        function checkEveTokenOnPageLoad() {
            const eveCharacterId = '{{ session.get("eve_character_id") if session else "" }}';
            const eveTokenExpires = '{{ session.get("eve_token_expires") if session else "" }}';
            
            // å¦‚æœç”¨æˆ·å·²ç»ç»‘å®šäº†EVE SSOä½†ä»¤ç‰Œè¿‡æœŸ
            if (eveCharacterId && eveTokenExpires) {
                const expiresTime = new Date(eveTokenExpires);
                const now = new Date();
                const timeLeft = Math.floor((expiresTime - now) / 1000 / 60); // åˆ†é’Ÿ
                
                console.log(`ğŸ” [checkEveTokenOnPageLoad] EVE SSOä»¤ç‰Œæ£€æŸ¥:`, {
                    character_id: eveCharacterId,
                    expires_at: eveTokenExpires,
                    time_left_minutes: timeLeft,
                    is_expired: timeLeft <= 0
                });
                
                if (timeLeft <= 0) {
                    // ä»¤ç‰Œå·²è¿‡æœŸï¼Œæ˜¾ç¤ºæé†’
                    console.warn(`âš ï¸ [checkEveTokenOnPageLoad] EVE SSOä»¤ç‰Œå·²è¿‡æœŸï¼Œæé†’ç”¨æˆ·é‡æ–°ç™»å½•`);
                    showEveTokenExpiredNotification();
                } else if (timeLeft <= 10) {
                    // ä»¤ç‰Œå³å°†è¿‡æœŸï¼ˆ10åˆ†é’Ÿå†…ï¼‰ï¼Œæ˜¾ç¤ºè­¦å‘Š
                    console.warn(`âš ï¸ [checkEveTokenOnPageLoad] EVE SSOä»¤ç‰Œå³å°†è¿‡æœŸï¼Œå‰©ä½™${timeLeft}åˆ†é’Ÿ`);
                    showEveTokenExpiringNotification(timeLeft);
                }
            }
        }

        // ğŸ†• æ˜¾ç¤ºEVE SSOä»¤ç‰Œè¿‡æœŸé€šçŸ¥
        function showEveTokenExpiredNotification() {
            // åˆ›å»ºé€šçŸ¥å…ƒç´ 
            const notification = document.createElement('div');
            notification.className = 'eve-token-notification expired';
            notification.innerHTML = `
                <div class="notification-content">
                    <div class="notification-icon">âš ï¸</div>
                    <div class="notification-text">
                        <strong>EVE SSOä¼šè¯å·²è¿‡æœŸ</strong>
                        <p>æ‚¨çš„EVEåœ¨çº¿è®¤è¯å·²è¿‡æœŸï¼Œæ— æ³•è·å–æœ€æ–°çš„å¿ è¯šç‚¹æ•°æ®ã€‚è¯·é‡æ–°ç™»å½•EVE SSOä»¥ç»§ç»­ä½¿ç”¨å®Œæ•´åŠŸèƒ½ã€‚</p>
                    </div>
                    <div class="notification-actions">
                        <button onclick="window.location.href='/auth/login'" class="btn-primary">é‡æ–°ç™»å½•EVE SSO</button>
                        <button onclick="closeEveTokenNotification()" class="btn-secondary">ç¨åæé†’</button>
                    </div>
                </div>
            `;
            
            // æ·»åŠ æ ·å¼
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: #fff;
                border: 2px solid #ff6b6b;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                padding: 16px;
                max-width: 400px;
                z-index: 10000;
                animation: slideInRight 0.3s ease-out;
            `;
            
            document.body.appendChild(notification);
            
            // 5åˆ†é’Ÿåè‡ªåŠ¨éšè—
            setTimeout(() => {
                if (notification.parentNode) {
                    closeEveTokenNotification();
                }
            }, 5 * 60 * 1000);
        }

        // ğŸ†• æ˜¾ç¤ºEVE SSOä»¤ç‰Œå³å°†è¿‡æœŸé€šçŸ¥
        function showEveTokenExpiringNotification(minutesLeft) {
            const notification = document.createElement('div');
            notification.className = 'eve-token-notification expiring';
            notification.innerHTML = `
                <div class="notification-content">
                    <div class="notification-icon">â°</div>
                    <div class="notification-text">
                        <strong>EVE SSOä¼šè¯å³å°†è¿‡æœŸ</strong>
                        <p>æ‚¨çš„EVEåœ¨çº¿è®¤è¯å°†åœ¨${minutesLeft}åˆ†é’Ÿåè¿‡æœŸã€‚å»ºè®®æå‰é‡æ–°ç™»å½•ä»¥é¿å…æ•°æ®è·å–ä¸­æ–­ã€‚</p>
                    </div>
                    <div class="notification-actions">
                        <button onclick="window.location.href='/auth/login'" class="btn-primary">ç«‹å³é‡æ–°ç™»å½•</button>
                        <button onclick="closeEveTokenNotification()" class="btn-secondary">çŸ¥é“äº†</button>
                    </div>
                </div>
            `;
            
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: #fff;
                border: 2px solid #ffa726;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                padding: 16px;
                max-width: 400px;
                z-index: 10000;
                animation: slideInRight 0.3s ease-out;
            `;
            
            document.body.appendChild(notification);
            
            // 2åˆ†é’Ÿåè‡ªåŠ¨éšè—
            setTimeout(() => {
                if (notification.parentNode) {
                    closeEveTokenNotification();
                }
            }, 2 * 60 * 1000);
        }

        // ğŸ†• å…³é—­EVEä»¤ç‰Œé€šçŸ¥
        function closeEveTokenNotification() {
            const notifications = document.querySelectorAll('.eve-token-notification');
            notifications.forEach(notification => {
                notification.style.animation = 'slideOutRight 0.3s ease-in';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            });
        }

        // æ·»åŠ åˆ°å…¨å±€ï¼Œæ–¹ä¾¿æ‰‹åŠ¨è°ƒç”¨
        window.debugEveSSO = debugEveSSO;

        // ç”¨æˆ·å¤´åƒç‚¹å‡»äº‹ä»¶
        userAvatar.onclick = (e) => {
            e.stopPropagation();
            userProfile.classList.toggle('active');
        };



        // é˜»æ­¢ä¸‹æ‹‰èœå•ç‚¹å‡»äº‹ä»¶å†’æ³¡ï¼Œä½†å…è®¸æŒ‰é’®ç‚¹å‡»
        userDropdown.onclick = (e) => {
            e.stopPropagation();
            // ä¸é˜»æ­¢é»˜è®¤è¡Œä¸ºï¼Œå…è®¸æŒ‰é’®ç‚¹å‡»äº‹ä»¶è§¦å‘
        };

        // é€€å‡ºç™»å½•ï¼ˆæ·»åŠ è°ƒè¯•ä¿¡æ¯ï¼‰
        logoutBtn.onclick = async () => {
            console.log(`ğŸšª [logout] å¼€å§‹é€€å‡ºç™»å½•æµç¨‹`);
            
            try {
                console.log(`ğŸ“¡ [logout] å‘é€é€€å‡ºè¯·æ±‚åˆ°: /xuexi_ranshao/logout`);
                const response = await fetch('/xuexi_ranshao/logout', {
                    method: 'POST'
                });

                console.log(`ğŸ“¥ [logout] æ”¶åˆ°é€€å‡ºå“åº”:`, {
                    status: response.status,
                    statusText: response.statusText,
                    ok: response.ok,
                    headers: Object.fromEntries(response.headers.entries())
                });

                if (response.ok) {
                    const result = await response.json();
                    console.log(`âœ… [logout] é€€å‡ºå“åº”JSON:`, result);
                    
                    if (result.success) {
                        console.log(`ğŸ‰ [logout] é€€å‡ºæˆåŠŸ`);
                        showMessage('å·²æˆåŠŸé€€å‡ºç™»å½•', 'success');
                        updateUserInterface();
                        
                        // æ¸…é™¤ä¿å­˜çš„å‡­æ®
                        console.log(`ğŸ—‘ï¸ [logout] æ¸…é™¤æœ¬åœ°å‡­æ®`);
                        bloodCredentials.username = '';
                        bloodCredentials.password = '';
                        try {
                            localStorage.removeItem('bloodCredentials');
                            localStorage.removeItem('bloodCredentials_backup');
                            console.log(`âœ… [logout] æœ¬åœ°å‡­æ®æ¸…é™¤æˆåŠŸï¼ˆå«å¤‡ä»½ï¼‰`);
                        } catch (e) {
                            console.error('âŒ [logout] æ¸…é™¤å‡­æ®å¤±è´¥:', e);
                        }
                        
                        // åœæ­¢è‡ªåŠ¨æ›´æ–°
                        stopAutoUpdate();
                    } else {
                        console.error(`âŒ [logout] é€€å‡ºå¤±è´¥:`, result.message);
                        showMessage('é€€å‡ºç™»å½•å¤±è´¥: ' + result.message, 'error');
                    }
                } else {
                    console.error(`âŒ [logout] é€€å‡ºè¯·æ±‚HTTPé”™è¯¯:`, {
                        status: response.status,
                        statusText: response.statusText
                    });
                    showMessage('é€€å‡ºç™»å½•è¯·æ±‚å¤±è´¥', 'error');
                }
            } catch (error) {
                console.error('ğŸ’¥ [logout] é€€å‡ºè¯·æ±‚å¼‚å¸¸:', {
                    name: error.name,
                    message: error.message,
                    stack: error.stack
                });
                showMessage('é€€å‡ºç™»å½•å‡ºé”™', 'error');
            }
        };

        // æ˜¾ç¤ºç™»å½•å¼¹çª—
        loginBtn.onclick = () => {
            loginModal.classList.add('show');
            registerModal.classList.remove('show');
        };

        // æ˜¾ç¤ºæ³¨å†Œå¼¹çª—
        registerBtn.onclick = () => {
            registerModal.classList.add('show');
            loginModal.classList.remove('show');
        };

        // åˆ‡æ¢åˆ°æ³¨å†Œå¼¹çª—
        showRegister.onclick = (e) => {
            e.preventDefault();
            loginModal.classList.remove('show');
            registerModal.classList.add('show');
        };

        // åˆ‡æ¢åˆ°ç™»å½•å¼¹çª—
        showLogin.onclick = (e) => {
            e.preventDefault();
            registerModal.classList.remove('show');
            loginModal.classList.add('show');
        };

        // å…³é—­ç™»å½•å¼¹çª—
        closeModal.onclick = () => loginModal.classList.remove('show');

        // å…³é—­æ³¨å†Œå¼¹çª—
        closeRegisterModal.onclick = () => registerModal.classList.remove('show');

        // ç‚¹å‡»é¡µé¢å…¶ä»–åœ°æ–¹å…³é—­ä¸‹æ‹‰èœå•å’Œå¼¹çª—
        window.onclick = (event) => {
            // å…³é—­ç”¨æˆ·ä¸‹æ‹‰èœå•
            userProfile.classList.remove('active');
            
            // å…³é—­ç™»å½•å’Œæ³¨å†Œå¼¹çª—
            if (event.target === loginModal) {
                loginModal.classList.remove('show');
            }
            if (event.target === registerModal) {
                registerModal.classList.remove('show');
            }
            
            // å…³é—­è®¾ç½®æ¯”ç‡å¼¹çª—
            if (event.target === settingsModal) {
                closeSettingsModalFunc();
            }
            
            // å…³é—­æ›´æ–°æ•°æ®å¼¹çª—
            if (event.target === updateDataModal) {
                closeUpdateDataModalFunc();
            }
        };

        // ç™»å½•è¡¨å•AJAXæäº¤ï¼ˆæ·»åŠ è°ƒè¯•ä¿¡æ¯ï¼‰
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            console.log(`ğŸ” [login] å¼€å§‹ç™»å½•æµç¨‹`);

            const formData = new FormData(loginForm);
            const rememberMe = formData.get('rememberMe') === 'on';
            
            console.log(`ğŸ“ [login] è¡¨å•æ•°æ®:`, {
                username: formData.get('username'),
                hasPassword: !!formData.get('password'),
                rememberMe: rememberMe
            });
            
            try {
                console.log('ğŸ“¡ [login] å‘é€ç™»å½•è¯·æ±‚');
                const response = await fetch('/xuexi_ranshao/login', {
                    method: 'POST',
                    body: formData,
                    credentials: 'same-origin',  // ç¡®ä¿åŒ…å«cookies
                    // ä¸è¦è®¾ç½®Content-Typeï¼Œè®©æµè§ˆå™¨è‡ªåŠ¨å¤„ç†FormData
                });
                
                console.log('ğŸ“¥ [login] æ”¶åˆ°ç™»å½•å“åº”:', {
                    status: response.status,
                    statusText: response.statusText,
                    ok: response.ok,
                    headers: Object.fromEntries(response.headers.entries())
                });

                if (response.ok) {
                    const result = await response.json();
                    console.log('âœ… [login] ç™»å½•å“åº”JSON:', result);
                    
                    if (result.success) {
                        console.log('ğŸ‰ [login] ç™»å½•æˆåŠŸ:', result.user);
                        showMessage('ç™»å½•æˆåŠŸï¼', 'success');
                        loginModal.classList.remove('show');
                        loginForm.reset();
                        
                        // ä¿å­˜è¡€è¢­åˆä½œç¤¾å‡­æ®ï¼ˆä¸ç™»å½•å‡­æ®ç›¸åŒï¼‰
                        bloodCredentials.username = formData.get('username');
                        bloodCredentials.password = formData.get('password');
                        
                        console.log(`ğŸ’¾ [login] ä¿å­˜å‡­æ®åˆ°æœ¬åœ°å­˜å‚¨`);
                        // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨ï¼ˆå«å¤‡ä»½ï¼‰
                        saveCredentials(bloodCredentials.username, bloodCredentials.password);
                        
                        // æ›´æ–°ç”¨æˆ·ç•Œé¢
                        updateUserInterface({
                            username: result.user,
                            access_level: result.xuexi_specific_data?.access_level || 'standard'
                        });
                        
                        // ğŸ”‘ å…³é”®ï¼šç­‰å¾…ä¼šè¯å®Œå…¨å»ºç«‹åå†è¿›è¡Œåç»­æ“ä½œ
                        console.log('â³ [login] ç­‰å¾…ä¼šè¯å»ºç«‹...');
                        setTimeout(async () => {
                            console.log('ğŸ”„ [login] éªŒè¯ä¼šè¯æ˜¯å¦å»ºç«‹æˆåŠŸ');
                            try {
                                const authCheck = await fetch('/xuexi_ranshao/check_auth', {
                                    method: 'GET',
                                    credentials: 'same-origin',
                                    headers: {
                                        'Content-Type': 'application/json',
                                        'Cache-Control': 'no-cache'
                                    }
                                });
                                
                                if (authCheck.ok) {
                                    const authResult = await authCheck.json();
                                    if (authResult.authenticated) {
                                        console.log('âœ… [login] ä¼šè¯éªŒè¯æˆåŠŸï¼Œå¯åŠ¨è‡ªåŠ¨æ›´æ–°');
                                        startAutoUpdate();
                                    } else {
                                        console.error('âŒ [login] ä¼šè¯éªŒè¯å¤±è´¥');
                                        showMessage('ä¼šè¯å»ºç«‹å¤±è´¥ï¼Œè¯·é‡æ–°ç™»å½•', 'error');
                                    }
                                } else {
                                    console.error('âŒ [login] ä¼šè¯éªŒè¯è¯·æ±‚å¤±è´¥');
                                }
                            } catch (error) {
                                console.error('ğŸ’¥ [login] ä¼šè¯éªŒè¯å¼‚å¸¸:', error);
                            }
                        }, 2000); // ç­‰å¾…2ç§’ç¡®ä¿ä¼šè¯å®Œå…¨å»ºç«‹
                    } else {
                        console.error('âŒ [login] ç™»å½•å¤±è´¥:', result.message);
                        showMessage('ç™»å½•å¤±è´¥: ' + result.message, 'error');
                    }
                } else {
                    console.error('âŒ [login] ç™»å½•è¯·æ±‚HTTPé”™è¯¯:', {
                        status: response.status,
                        statusText: response.statusText
                    });
                    showMessage('ç™»å½•è¯·æ±‚å¤±è´¥ï¼Œè¯·ç¨åå†è¯•ã€‚', 'error');
                }
            } catch (error) {
                console.error('ğŸ’¥ [login] ç™»å½•è¯·æ±‚å¼‚å¸¸:', error);
                showMessage('ç™»å½•è¯·æ±‚å‡ºé”™ï¼Œè¯·ç¨åå†è¯•ã€‚', 'error');
            }
        });

        // æ³¨å†Œè¡¨å•AJAXæäº¤
        registerForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            // éªŒè¯å¯†ç ç¡®è®¤
            const password = document.getElementById('regPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;

            if (password !== confirmPassword) {
                showMessage('ä¸¤æ¬¡è¾“å…¥çš„å¯†ç ä¸ä¸€è‡´ï¼Œè¯·é‡æ–°è¾“å…¥ã€‚', 'error');
                return;
            }

            const formData = new FormData(registerForm);
            try {
                const response = await fetch('/xuexi_ranshao/register', {
                    method: 'POST',
                    body: formData
                });

                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        showMessage('æ³¨å†ŒæˆåŠŸï¼è¯·ç™»å½•ã€‚', 'success');
                        // åˆ‡æ¢åˆ°ç™»å½•å¼¹çª—å¹¶é¢„å¡«ç”¨æˆ·å
                        document.getElementById('username').value = document.getElementById('regUsername').value;
                        registerModal.classList.remove('show');
                        loginModal.classList.add('show');
                        // æ¸…ç©ºæ³¨å†Œè¡¨å•
                        registerForm.reset();
                    } else {
                        showMessage('æ³¨å†Œå¤±è´¥: ' + result.message, 'error');
                    }
                } else {
                    showMessage('æ³¨å†Œè¯·æ±‚å¤±è´¥ï¼Œè¯·ç¨åå†è¯•ã€‚', 'error');
                }
            } catch (error) {
                console.error('æ³¨å†Œè¯·æ±‚å‡ºé”™:', error);
                showMessage('æ³¨å†Œè¯·æ±‚å‡ºé”™ï¼Œè¯·ç¨åå†è¯•ã€‚', 'error');
            }
        });



        // æ›´æ–°æ•°æ®åŠŸèƒ½
        // æ‰“å¼€æ›´æ–°æ•°æ®å¼¹çª—
        function openUpdateDataModal() {
            // å¦‚æœæœ‰ä¿å­˜çš„å‡­æ®ï¼Œç›´æ¥å¼€å§‹æ›´æ–°æµç¨‹
            if (bloodCredentials.username && bloodCredentials.password) {
                startDataUpdate(bloodCredentials.username, bloodCredentials.password);
            } else {
                // å¦‚æœæ²¡æœ‰ä¿å­˜çš„å‡­æ®ï¼Œæ˜¾ç¤ºæç¤ºæ¶ˆæ¯
                showMessage('æ— æ³•è·å–è¡€è¢­åˆä½œç¤¾å‡­æ®ï¼Œè¯·é‡æ–°ç™»å½•', 'error');
            }
        }

        // å…³é—­æ›´æ–°æ•°æ®å¼¹çª—
        function closeUpdateDataModalFunc() {
            updateDataModal.classList.remove('show');
        }

        // ç»‘å®šäº‹ä»¶
        updateDataBtn.onclick = function(e) {
            e.stopPropagation(); // é˜»æ­¢å†’æ³¡ï¼Œé˜²æ­¢å…³é—­ä¸‹æ‹‰èœå•
            openUpdateDataModal();
        };
        closeUpdateDataModal.onclick = closeUpdateDataModalFunc;
        cancelUpdateData.onclick = closeUpdateDataModalFunc;



        // æ·»åŠ æ–°å‡½æ•°å¤„ç†æ•°æ®æ›´æ–°ï¼ˆä¿®å¤ä¼šè¯ä¼ é€’é—®é¢˜ï¼‰
        async function startDataUpdate(username, password, silent = false) {
            console.log(`ğŸš€ [startDataUpdate] å¼€å§‹æ•°æ®æ›´æ–°:`, {
                username: username,
                silent: silent,
                eve_character_id: '{{ session.get("eve_character_id") if session else "" }}',
                eve_character_name: '{{ session.get("eve_character_name") if session else "" }}'
            });
            
            // ğŸ†• æ£€æŸ¥EVE SSOçŠ¶æ€
            const eveCharacterId = '{{ session.get("eve_character_id") if session else "" }}';
            const eveAccessToken = '{{ session.get("eve_access_token") if session else "" }}';
            const eveTokenExpires = '{{ session.get("eve_token_expires") if session else "" }}';
            
            console.log(`ğŸ” [startDataUpdate] EVE SSOæ•°æ®æ›´æ–°å‰æ£€æŸ¥:`, {
                has_character_id: !!eveCharacterId,
                has_access_token: !!eveAccessToken,
                token_expires: eveTokenExpires,
                can_fetch_eve_data: !!(eveCharacterId && eveAccessToken)
            });
            
            if (eveTokenExpires) {
                const expiresTime = new Date(eveTokenExpires);
                const now = new Date();
                const isExpired = now >= expiresTime;
                
                console.log(`â° [startDataUpdate] EVEä»¤ç‰Œæ£€æŸ¥:`, {
                    expires_at: eveTokenExpires,
                    current_time: now.toISOString(),
                    is_expired: isExpired,
                    time_diff_minutes: Math.floor((expiresTime - now) / 1000 / 60)
                });
                
                if (isExpired) {
                    console.error(`âŒ [startDataUpdate] EVE SSOä»¤ç‰Œå·²è¿‡æœŸï¼Œæ— æ³•è·å–EVEæ•°æ®`);
                }
            }
            
            // æ£€æŸ¥ç™»å½•çŠ¶æ€
            if (!currentUser) {
                console.error(`âŒ [startDataUpdate] ç”¨æˆ·æœªç™»å½•`);
                showMessage('è¯·å…ˆç™»å½•åå†æ›´æ–°æ•°æ®', 'error');
                return;
            }

            // ğŸ”‘ å¼ºåˆ¶é‡æ–°éªŒè¯ä¼šè¯çŠ¶æ€
            console.log(`ğŸ” [startDataUpdate] éªŒè¯ä¼šè¯çŠ¶æ€`);
            try {
                const authResponse = await fetch('/xuexi_ranshao/check_auth', {
                    method: 'GET',
                    credentials: 'same-origin',
                    headers: {
                        'Content-Type': 'application/json',
                        'Cache-Control': 'no-cache'
                    }
                });
                
                if (!authResponse.ok) {
                    console.error(`âŒ [startDataUpdate] ä¼šè¯éªŒè¯è¯·æ±‚å¤±è´¥: ${authResponse.status}`);
                    showMessage('ä¼šè¯éªŒè¯å¤±è´¥ï¼Œè¯·é‡æ–°ç™»å½•', 'error');
                    updateUserInterface(); // åˆ‡æ¢åˆ°æœªç™»å½•çŠ¶æ€
                    return;
                }
                
                const authResult = await authResponse.json();
                if (!authResult.authenticated) {
                    console.error(`âŒ [startDataUpdate] ä¼šè¯éªŒè¯å¤±è´¥ï¼Œç”¨æˆ·æœªè®¤è¯`);
                    showMessage('ä¼šè¯å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•', 'error');
                    updateUserInterface(); // åˆ‡æ¢åˆ°æœªç™»å½•çŠ¶æ€
                    return;
                }
                
                console.log(`âœ… [startDataUpdate] ä¼šè¯éªŒè¯æˆåŠŸï¼Œç”¨æˆ·: ${authResult.user}`);
            } catch (error) {
                console.error(`ğŸ’¥ [startDataUpdate] ä¼šè¯éªŒè¯å¼‚å¸¸:`, error);
                showMessage('ä¼šè¯éªŒè¯å‡ºé”™ï¼Œè¯·é‡æ–°ç™»å½•', 'error');
                return;
            }

            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€å’Œæ›´æ–°çŠ¶æ€åŒºåŸŸ
            updateDataModal.classList.add('show');
            updateDataForm.style.display = 'none';
            updateLoadingIndicator.style.display = 'flex';
            const updateStatusDisplay = document.getElementById('updateStatusDisplay');
            updateStatusDisplay.style.display = 'block';
            
            // é‡ç½®æ‰€æœ‰æ­¥éª¤çŠ¶æ€
            resetStepStatus();
            
            // æ›´æ–°è¿›åº¦æ¡ä¸º0%
            updateProgress(0);
            
            try {
                // ç¬¬ä¸€æ­¥ï¼šéªŒè¯è´¦æˆ·
                console.log(`1ï¸âƒ£ [startDataUpdate] æ­¥éª¤1: éªŒè¯è´¦æˆ·`);
                updateStepStatus('step1', 'active');
                await simulateDelay(500);
                updateProgress(25);
                updateStepStatus('step1', 'completed');
                
                // ç¬¬äºŒæ­¥ï¼šè·å–æ•°æ®
                console.log(`2ï¸âƒ£ [startDataUpdate] æ­¥éª¤2: è·å–æ•°æ®`);
                updateStepStatus('step2', 'active');
                await simulateDelay(500);
                
                const apiUrl = `/api/blood_cooperatives_data?blood_username=${encodeURIComponent(username)}&blood_password=${encodeURIComponent(password)}`;
                console.log(`ğŸ“¡ [startDataUpdate] å‘é€æ•°æ®è¯·æ±‚åˆ°:`, apiUrl);
                
                // ğŸ”‘ å…³é”®ä¿®å¤ï¼šç¡®ä¿åŒ…å«ä¼šè¯å‡­æ®
                const response = await fetch(apiUrl, {
                    method: 'GET',
                    credentials: 'same-origin',  // ç¡®ä¿åŒ…å«cookies
                    headers: {
                        'Content-Type': 'application/json',
                        'Cache-Control': 'no-cache'
                    }
                });
                
                console.log(`ğŸ“¥ [startDataUpdate] æ”¶åˆ°æ•°æ®å“åº”:`, {
                    status: response.status,
                    statusText: response.statusText,
                    ok: response.ok,
                    headers: Object.fromEntries(response.headers.entries())
                });
                
                updateProgress(50);
                updateStepStatus('step2', 'completed');
                
                if (response.ok) {
                    const result = await response.json();
                    console.log(`âœ… [startDataUpdate] æ•°æ®å“åº”JSON:`, result);

                    if (result.success) {
                        // ç¬¬ä¸‰æ­¥ï¼šä¿å­˜åˆ°æ•°æ®åº“
                        console.log(`3ï¸âƒ£ [startDataUpdate] æ­¥éª¤3: ä¿å­˜åˆ°æ•°æ®åº“`);
                        updateStepStatus('step3', 'active');
                        await simulateDelay(500);
                        updateProgress(75);
                        updateStepStatus('step3', 'completed');
                        
                        // ç¬¬å››æ­¥ï¼šè®¡ç®—ç»Ÿè®¡ä¿¡æ¯
                        console.log(`4ï¸âƒ£ [startDataUpdate] æ­¥éª¤4: è®¡ç®—ç»Ÿè®¡ä¿¡æ¯`);
                        updateStepStatus('step4', 'active');
                        await simulateDelay(500);
                        updateProgress(100);
                        updateStepStatus('step4', 'completed');
                        
                        console.log(`ğŸ‰ [startDataUpdate] æ•°æ®æ›´æ–°æˆåŠŸ`);
                        showMessage('æ•°æ®æ›´æ–°æˆåŠŸï¼', 'success');
                        
                        // å…³é—­æ›´æ–°å¼¹çª—
                        setTimeout(() => {
                            closeUpdateDataModalFunc();
                        }, 2000);
                        
                        // å¯é€‰ï¼šåŠ¨æ€æ›´æ–°é¡µé¢ä¸Šçš„ç»Ÿè®¡æ•°æ®
                        if (result.data && result.data.summary) {
                            updatePageStatistics(result.data.summary);
                        }
                    } else {
                        console.error(`âŒ [startDataUpdate] æ•°æ®æ›´æ–°å¤±è´¥:`, result.message);
                        updateStepStatus('step2', 'error');
                        updateProgress(50);
                        showMessage(`æ›´æ–°æ•°æ®å¤±è´¥: ${result.message}`, 'error');
                    }
                } else {
                    console.error(`âŒ [startDataUpdate] æ•°æ®è¯·æ±‚HTTPé”™è¯¯:`, {
                        status: response.status,
                        statusText: response.statusText
                    });
                    updateStepStatus('step2', 'error');
                    updateProgress(50);
                    
                    // ğŸ” é’ˆå¯¹401é”™è¯¯çš„ç‰¹æ®Šå¤„ç†
                    if (response.status === 401) {
                        console.log(`ğŸ”„ [startDataUpdate] æ£€æµ‹åˆ°401é”™è¯¯ï¼Œå°è¯•é‡æ–°éªŒè¯ç™»å½•çŠ¶æ€`);
                        // é‡æ–°æ£€æŸ¥ç™»å½•çŠ¶æ€
                        await checkAuthStatus();
                        showMessage('ä¼šè¯å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•', 'error');
                    } else {
                        showMessage(`è¯·æ±‚å¤±è´¥: ${response.status}`, 'error');
                    }
                }
            } catch (error) {
                console.error('ğŸ’¥ [startDataUpdate] æ•°æ®æ›´æ–°å¼‚å¸¸:', {
                    name: error.name,
                    message: error.message,
                    stack: error.stack
                });
                updateStepStatus('step2', 'error');
                updateProgress(50);
                showMessage('ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åå†è¯•', 'error');
            } finally {
                updateLoadingIndicator.style.display = 'none';
                console.log(`ğŸ [startDataUpdate] æ•°æ®æ›´æ–°æµç¨‹ç»“æŸ`);
            }
        }

        // å¤„ç†æ›´æ–°æ•°æ®è¡¨å•æäº¤
        updateDataForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            // æ£€æŸ¥ç™»å½•çŠ¶æ€
            if (!currentUser) {
                showMessage('è¯·å…ˆç™»å½•åå†æ›´æ–°æ•°æ®', 'error');
                return;
            }

            // æ£€æŸ¥å‡­è¯
            const username = updateBloodUsername.value.trim();
            const password = updateBloodPassword.value.trim();

            if (!username || !password) {
                showMessage('è¯·è¾“å…¥è¡€è¢­åˆä½œç¤¾ç”¨æˆ·åå’Œå¯†ç ', 'error');
                return;
            }

            // ä¿å­˜å‡­æ®ä»¥ä¾¿ä¸‹æ¬¡ä½¿ç”¨
            bloodCredentials.username = username;
            bloodCredentials.password = password;
            
            // å¼€å§‹æ›´æ–°æµç¨‹
            updateDataForm.style.display = 'none';
            startDataUpdate(username, password);
        });

        // æ›´æ–°è¿›åº¦æ¡
        function updateProgress(percentage) {
            const progressFill = document.getElementById('progressFill');
            const progressText = document.getElementById('progressText');
            
            progressFill.style.width = `${percentage}%`;
            progressText.textContent = `${percentage}%`;
        }

        // æ›´æ–°æ­¥éª¤çŠ¶æ€
        function updateStepStatus(stepId, status) {
            const step = document.getElementById(stepId);
            // ç§»é™¤æ‰€æœ‰çŠ¶æ€ç±»
            step.classList.remove('active', 'completed', 'error');
            // æ·»åŠ æ–°çŠ¶æ€
            step.classList.add(status);
        }

        // é‡ç½®æ‰€æœ‰æ­¥éª¤çŠ¶æ€
        function resetStepStatus() {
            const steps = ['step1', 'step2', 'step3', 'step4'];
            steps.forEach(stepId => {
                const step = document.getElementById(stepId);
                step.classList.remove('active', 'completed', 'error');
            });
        }

        // æ¨¡æ‹Ÿå»¶è¿Ÿ
        function simulateDelay(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }
        
        // æ›´æ–°é¡µé¢ç»Ÿè®¡ä¿¡æ¯
        async function updatePageStatistics(summary) {
            console.log('ğŸ“Š [updatePageStatistics] æ›´æ–°é¡µé¢ç»Ÿè®¡ä¿¡æ¯:', summary);
            
            try {
                // è·å–æœ€æ–°çš„ä»»åŠ¡çŠ¶æ€ç»Ÿè®¡ä¿¡æ¯
                const response = await fetch('/api/mission_status_summary', {
                    method: 'GET',
                    credentials: 'same-origin',
                    headers: {
                        'Content-Type': 'application/json',
                        'Cache-Control': 'no-cache'
                    }
                });
                
                if (response.ok) {
                    const result = await response.json();
                    if (result.success && result.data) {
                        const missionStatus = result.data;
                        
                        // æ›´æ–°ä»»åŠ¡çŠ¶æ€ç»Ÿè®¡ä¿¡æ¯
                        const missionStatusCards = document.querySelectorAll('.mission-status-info .info-card');
                        
                        // æ›´æ–°å·²å®Œæˆä»»åŠ¡
                        if (missionStatus.completed && missionStatusCards[0]) {
                            const countElement = missionStatusCards[0].querySelector('.info-value');
                            const bountyElement = missionStatusCards[0].querySelector('.info-bounty');
                            if (countElement) countElement.textContent = missionStatus.completed.count;
                            if (bountyElement) {
                                bountyElement.textContent = new Intl.NumberFormat('zh-CN').format(missionStatus.completed.total_bounty) + ' ISK';
                            }
                        }
                        
                        // æ›´æ–°å·²æ”¯ä»˜ä»»åŠ¡
                        if (missionStatus.paid && missionStatusCards[1]) {
                            const countElement = missionStatusCards[1].querySelector('.info-value');
                            const bountyElement = missionStatusCards[1].querySelector('.info-bounty');
                            if (countElement) countElement.textContent = missionStatus.paid.count;
                            if (bountyElement) {
                                bountyElement.textContent = new Intl.NumberFormat('zh-CN').format(missionStatus.paid.total_bounty) + ' ISK';
                            }
                        }
                        
                        // æ›´æ–°å·²å®Œç»“ä»»åŠ¡
                        if (missionStatus.done && missionStatusCards[2]) {
                            const countElement = missionStatusCards[2].querySelector('.info-value');
                            const bountyElement = missionStatusCards[2].querySelector('.info-bounty');
                            if (countElement) countElement.textContent = missionStatus.done.count;
                            if (bountyElement) {
                                bountyElement.textContent = new Intl.NumberFormat('zh-CN').format(missionStatus.done.total_bounty) + ' ISK';
                            }
                        }
                        
                        console.log('âœ… [updatePageStatistics] ä»»åŠ¡çŠ¶æ€ç»Ÿè®¡ä¿¡æ¯æ›´æ–°å®Œæˆ');
                    } else {
                        console.log('âš ï¸ [updatePageStatistics] è·å–ä»»åŠ¡çŠ¶æ€ç»Ÿè®¡ä¿¡æ¯å¤±è´¥:', result.message);
                    }
                } else {
                    console.log('âš ï¸ [updatePageStatistics] ä»»åŠ¡çŠ¶æ€ç»Ÿè®¡ä¿¡æ¯è¯·æ±‚å¤±è´¥:', response.status);
                }
                
                // æ›´æ–°è¡€è¢­è€…LPç‚¹æ•°
                console.log('ğŸ”„ [updatePageStatistics] æ›´æ–°è¡€è¢­è€…LPç‚¹æ•°');
                try {
                    const lpResponse = await fetch('/api/blood_raider_lp');
                    if (lpResponse.ok) {
                        const lpResult = await lpResponse.json();
                        if (lpResult.success) {
                            // æ›´æ–°è¡€è¢­è€…LPç‚¹æ•°æ˜¾ç¤º
                            const infoCards = document.querySelectorAll('.info-card');
                            if (infoCards.length > 2) {
                                const lpCard = infoCards[2].querySelector('.info-value');
                                if (lpCard) {
                                    lpCard.textContent = new Intl.NumberFormat('zh-CN').format(lpResult.blood_raider_lp);
                                }
                            }
                            
                            // æ›´æ–°æ„æ—å¥¸å•†ä»·è®¡ç®—
                            updateBloodRaiderLPCalculation();
                            
                            console.log('âœ… [updatePageStatistics] è¡€è¢­è€…LPç‚¹æ•°æ›´æ–°å®Œæˆ:', lpResult.blood_raider_lp);
                        } else {
                            console.log('âš ï¸ [updatePageStatistics] è·å–è¡€è¢­è€…LPç‚¹æ•°å¤±è´¥:', lpResult.message);
                        }
                    } else {
                        console.log('âš ï¸ [updatePageStatistics] è¡€è¢­è€…LPç‚¹æ•°è¯·æ±‚å¤±è´¥:', lpResponse.status);
                    }
                } catch (error) {
                    console.error('âŒ [updatePageStatistics] æ›´æ–°è¡€è¢­è€…LPç‚¹æ•°æ—¶å‡ºé”™:', error);
                }
                
                // åˆ·æ–°å·²æ”¯ä»˜ä»»åŠ¡è¡¨æ ¼
                console.log('ğŸ”„ [updatePageStatistics] åˆ·æ–°å·²æ”¯ä»˜ä»»åŠ¡è¡¨æ ¼');
                loadPaidMissionsData();
                
                // åˆ·æ–°é’±åŒ…æèµ è¡¨æ ¼
                console.log('ğŸ”„ [updatePageStatistics] åˆ·æ–°é’±åŒ…æèµ è¡¨æ ¼');
                loadWalletDonationsData();
                
                // åˆ·æ–°è¡¨æ ¼æ•°æ®
                initTables();
                
            } catch (error) {
                console.error('âŒ [updatePageStatistics] æ›´æ–°ç»Ÿè®¡ä¿¡æ¯æ—¶å‡ºé”™:', error);
            }
        }
       
        
        // è‡ªåŠ¨æ›´æ–°åŠŸèƒ½
        function startAutoUpdate() {
            // æ¸…é™¤ç°æœ‰çš„å®šæ—¶å™¨ï¼ˆå¦‚æœæœ‰ï¼‰
            stopAutoUpdate();
            
            // è®¾ç½®æ–°çš„å®šæ—¶å™¨ï¼Œæ¯5åˆ†é’Ÿè‡ªåŠ¨æ›´æ–°ä¸€æ¬¡
            autoUpdateTimer = setInterval(() => {
                // æ£€æŸ¥æ˜¯å¦æœ‰ä¿å­˜çš„å‡­æ®
                if (bloodCredentials.username && bloodCredentials.password) {
                    // é™é»˜æ›´æ–°æ•°æ®
                    startDataUpdate(bloodCredentials.username, bloodCredentials.password, true);
                }
            }, 5 * 60 * 1000); // 5åˆ†é’Ÿ * 60ç§’ * 1000æ¯«ç§’
            
            console.log('è‡ªåŠ¨æ›´æ–°å·²å¯åŠ¨ï¼ˆæ¯5åˆ†é’Ÿï¼‰');
        }
        
        // åœæ­¢è‡ªåŠ¨æ›´æ–°
        function stopAutoUpdate() {
            if (autoUpdateTimer) {
                clearInterval(autoUpdateTimer);
                autoUpdateTimer = null;
                console.log('è‡ªåŠ¨æ›´æ–°å·²åœæ­¢');
            }
        }

        // æ‰“å¼€è®¾ç½®å¼¹çª—
        function openSettingsModal() {
            settingsModal.classList.add('show');
            cooperativeRateInput.value = '';
            cooperativeRateInput.focus();
        }

        // å…³é—­è®¾ç½®å¼¹çª—
        function closeSettingsModalFunc() {
            settingsModal.classList.remove('show');
        }

        // ç»‘å®šäº‹ä»¶
        settingsBtnLoggedIn.onclick = function(e) {
            e.stopPropagation(); // é˜»æ­¢å†’æ³¡ï¼Œé˜²æ­¢å…³é—­ä¸‹æ‹‰èœå•
            openSettingsModal();
        };
        closeSettingsModal.onclick = closeSettingsModalFunc;
        cancelSettings.onclick = closeSettingsModalFunc;



        // æ›´æ–°è¡€è¢­è€…LPç‚¹æ•°è®¡ç®—
        function updateBloodRaiderLPCalculation() {
            const infoCards = document.querySelectorAll('.info-card');
            let currentRate = 2200; // é»˜è®¤æ¯”ç‡
            
            // è·å–å½“å‰è®¾ç½®çš„æ¯”ç‡
            if (infoCards.length > 1) {
                const cooperativeCard = infoCards[1].querySelector('.info-value');
                if (cooperativeCard) {
                    currentRate = parseFloat(cooperativeCard.textContent) || 2200;
                }
            }
            
            // è·å–è¡€è¢­è€…LPç‚¹æ•°
            let bloodRaiderLP = 0;
            if (infoCards.length > 2) {
                const lpCard = infoCards[2].querySelector('.info-value');
                if (lpCard) {
                    // ç§»é™¤åƒåˆ†ä½åˆ†éš”ç¬¦å¹¶è½¬æ¢ä¸ºæ•°å­—
                    bloodRaiderLP = parseFloat(lpCard.textContent.replace(/,/g, '')) || 0;
                }
            }
            
            // æ›´æ–°è®¡ç®—ç»“æœ
            if (infoCards.length > 3) {
                const calculationCard = infoCards[3].querySelector('.info-value');
                if (calculationCard) {
                    const calculatedValue = currentRate * bloodRaiderLP;
                    calculationCard.textContent = new Intl.NumberFormat('zh-CN').format(Math.round(calculatedValue));
                }
            }
        }

        // å¤„ç†è¡¨å•æäº¤
        settingsForm.addEventListener('submit', (e) => {
            e.preventDefault();

            const newRate = parseFloat(cooperativeRateInput.value);

            if (isNaN(newRate) || newRate <= 0) {
                showMessage('è¯·è¾“å…¥æœ‰æ•ˆçš„æ¯”ç‡æ•°å€¼', 'error');
                return;
            }

            // æ›´æ–°æ˜¾ç¤ºçš„æ¯”ç‡
            const infoCards = document.querySelectorAll('.info-card');
            if (infoCards.length > 1) {
                const cooperativeCard = infoCards[1].querySelector('.info-value');
                if (cooperativeCard) {
                    cooperativeCard.textContent = newRate;
                }
            }

            // æ›´æ–°å½“å‰æ¯”ç‡æ˜¾ç¤º
            currentRateSpan.textContent = newRate;

            // æ›´æ–°è¡€è¢­è€…LPç‚¹æ•°è®¡ç®—
            updateBloodRaiderLPCalculation();

            // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
            localStorage.setItem('cooperativeRate', newRate);

            showMessage('åˆä½œç¤¾æ¯”ç‡è®¾ç½®æˆåŠŸ', 'success');
            closeSettingsModalFunc();
        });

        // å¼ºåˆ¶åˆ·æ–°åŠŸèƒ½
        document.getElementById('forceRefreshBtn').addEventListener('click', function() {
            // åªæ¸…é™¤æ›´æ–°æ—¶é—´ï¼Œä¿ç•™å‡­æ®
            localStorage.removeItem('lastUpdateTime');
            // localStorage.removeItem('bloodCredentials'); // âŒ æ³¨é‡Šæ‰è¿™è¡Œ
            
            // ç›´æ¥å¼ºåˆ¶æ›´æ–°æ•°æ®ï¼Œä¸éœ€è¦é‡æ–°ç™»å½•EVE
            if (bloodCredentials.username && bloodCredentials.password) {
                startDataUpdate(bloodCredentials.username, bloodCredentials.password, true);
                showMessage('æ­£åœ¨å¼ºåˆ¶åˆ·æ–°æ•°æ®...', 'info');
            } else {
                showMessage('è¯·å…ˆç™»å½•è¡€è¢­åˆä½œç¤¾è´¦å·', 'warning');
            }
        });

        // é¡µé¢åŠ è½½æ—¶æ¢å¤ä¿å­˜çš„æ¯”ç‡
        window.addEventListener('DOMContentLoaded', () => {
            const savedRate = localStorage.getItem('cooperativeRate');
            if (savedRate) {
                const infoCards = document.querySelectorAll('.info-card');
                if (infoCards.length > 1) {
                    const cooperativeCard = infoCards[1].querySelector('.info-value');
                    if (cooperativeCard) {
                        cooperativeCard.textContent = savedRate;
                    }
                }
                currentRateSpan.textContent = savedRate;
                
                // é¡µé¢åŠ è½½æ—¶ä¹Ÿæ›´æ–°è¡€è¢­è€…LPç‚¹æ•°è®¡ç®—
                setTimeout(() => {
                    updateBloodRaiderLPCalculation();
                }, 100);
            }
        });

        // å®šæœŸæ£€æŸ¥å‡­æ®çŠ¶æ€
        setInterval(() => {
            const credentials = localStorage.getItem('bloodCredentials');
            if (!credentials && bloodCredentials.username) {
                console.warn('âš ï¸ æ£€æµ‹åˆ°å‡­æ®ä¸¢å¤±ï¼Œå°è¯•æ¢å¤');
                // å°è¯•ä»å†…å­˜æ¢å¤åˆ°å­˜å‚¨
                if (bloodCredentials.username && bloodCredentials.password) {
                    saveCredentials(bloodCredentials.username, bloodCredentials.password);
                }
            }
        }, 30000); // æ¯30ç§’æ£€æŸ¥ä¸€æ¬¡

    </script>
</body>

</html>