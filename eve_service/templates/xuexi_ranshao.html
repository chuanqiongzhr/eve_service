<!DOCTYPE html>
<html lang="zh">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¡€è¢­ç‡ƒçƒ§</title>
    <link rel="icon" href="{{ url_for('static', filename='favicon.ico') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css', v='1.0') }}">
    <style>
        /* å¯¼èˆªæ ä¼˜å…ˆåŠ è½½æ ·å¼ */
        .navbar {
            opacity: 1 !important;
            visibility: visible !important;
        }
        
        /* ä¸‹æ‹‰èœå•æ ·å¼ */
        #dropdown-menu {
            display: none;
            position: absolute;
            background-color: white;
            min-width: 120px;
            box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
            z-index: 1000;
            border-radius: 4px;
            overflow: hidden;
        }
        
        #dropdown-menu a {
            color: black;
            padding: 12px 16px;
            text-decoration: none;
            display: block;
            font-size: 14px;
        }
        
        #dropdown-menu a:hover {
            background-color: #f1f1f1;
        }
        
        [data-theme="dark"] #dropdown-menu {
            background-color: #333;
        }
        
        [data-theme="dark"] #dropdown-menu a {
            color: white;
        }
        
        [data-theme="dark"] #dropdown-menu a:hover {
            background-color: #444;
        }
        
        /* å†…å®¹åŒºåŸŸåˆå§‹éšè—ï¼Œé¿å…é—ªçƒ */
        .content-loading {
            opacity: 0.3;
            pointer-events: none;
        }
        
        .content-loading .info-card,
        .content-loading .table-section {
            opacity: 0.5;
            transition: opacity 0.3s ease;
        }
        
        /* éª¨æ¶å±æ ·å¼ */
        .skeleton {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
            position: relative;
            overflow: hidden;
        }
        
        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
        
        .skeleton-card {
            height: 120px;
            border-radius: 12px;
            margin-bottom: 20px;
        }
        
        .skeleton-table {
            height: 200px;
            border-radius: 8px;
        }
        
        /* é¡¶éƒ¨åŠ è½½æŒ‡ç¤ºå™¨æ ·å¼ */
        .top-loading {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: linear-gradient(135deg, #1976d2, #42a5f5);
            color: white;
            padding: 8px 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            z-index: 9999;
            font-size: 14px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .top-loading .spinner {
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255,255,255,0.3);
            border-top: 2px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        /* å¤œé—´æ¨¡å¼ä¸‹çš„éª¨æ¶å±æ ·å¼ */
        [data-theme="dark"] .skeleton {
            background: linear-gradient(90deg, #2a2a2a 25%, #333 50%, #2a2a2a 75%);
        }
        
        [data-theme="dark"] .top-loading {
            background: linear-gradient(135deg, #1565c0, #1976d2);
        }
    </style>
    <script>
    // ä¸‹æ‹‰èœå•åŠŸèƒ½
    document.addEventListener('DOMContentLoaded', function() {
        const userBtn = document.getElementById('user-btn');
        const dropdownMenu = document.getElementById('dropdown-menu');
        
        if (userBtn && dropdownMenu) {
            // ç‚¹å‡»ç”¨æˆ·åæŒ‰é’®æ—¶æ˜¾ç¤º/éšè—ä¸‹æ‹‰èœå•
            userBtn.addEventListener('click', function(e) {
                e.stopPropagation();
                
                // è·å–æŒ‰é’®ä½ç½®
                const rect = userBtn.getBoundingClientRect();
                
                // è®¾ç½®ä¸‹æ‹‰èœå•ä½ç½®
                dropdownMenu.style.top = (rect.bottom + window.scrollY) + 'px';
                dropdownMenu.style.left = (rect.left + window.scrollX) + 'px';
                dropdownMenu.style.display = dropdownMenu.style.display === 'block' ? 'none' : 'block';
            });
            
            // ç‚¹å‡»é¡µé¢å…¶ä»–åœ°æ–¹å…³é—­ä¸‹æ‹‰èœå•
            document.addEventListener('click', function() {
                dropdownMenu.style.display = 'none';
            });
        }
    });
    </script>
</head>

<body>
   <nav class="navbar">
        <div class="navbar-container">
            <div class="navbar-menu">
                <a href="/" class="navbar-brand">EVE å·¥å…·é›†</a>
                <a href="/price_history" class="navbar-item">ä»·æ ¼æŸ¥è¯¢</a>
                <a href="/xuexi_ranshao" class="navbar-item">è¡€è¢­ç‡ƒçƒ§</a>
            </div>
            <div class="navbar-menu">
                <!-- EVE SSO è®¤è¯æŒ‰é’® -->
                {% if session.get('eve_character_name') %}
                    <span class="navbar-item user-btn" id="user-btn">{{ session.get('eve_character_name') }}</span>
                {% else %}
                    <a href="/auth/login" class="navbar-item">EVE SSO ç™»å½•</a>
                {% endif %}
                <!-- ä¸»é¢˜åˆ‡æ¢æŒ‰é’® -->
                <button class="navbar-item theme-btn" onclick="toggleTheme()" title="åˆ‡æ¢å¤œé—´æ¨¡å¼">
                    <span id="theme-icon">ğŸŒ™</span>
                </button>
            </div>
        </div>
    </nav>
    
    <!-- å°†ä¸‹æ‹‰èœå•ç§»åˆ°bodyçš„ç›´æ¥å­å…ƒç´ ï¼Œå®Œå…¨è„±ç¦»å¯¼èˆªæ  -->
    {% if session.get('eve_character_name') %}
    <div id="dropdown-menu">
        <a href="/auth/logout">é€€å‡º</a>
    </div>
    {% endif %}

    <!-- ç”¨æˆ·æ“ä½œåŒºåŸŸ -->
    <div id="userArea" class="user-area">
        <!-- æœªç™»å½•çŠ¶æ€ -->
        <div id="guestArea" class="guest-area">
            <button id="loginBtn" class="auth-btn login-btn">ç™»å½•</button>
            <button id="registerBtn" class="auth-btn register-btn">æ³¨å†Œ</button>
        </div>

        <!-- å·²ç™»å½•çŠ¶æ€ -->
        <div id="userProfile" class="user-profile" style="display: none;">

            <div class="user-avatar" id="userAvatar">
                <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23fff'%3E%3Cpath d='M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z'/%3E%3C/svg%3E"
                    alt="ç”¨æˆ·å¤´åƒ">
                <span class="username" id="displayUsername"></span>
                <span class="dropdown-arrow">â–¼</span>
            </div>
            <div class="user-dropdown" id="userDropdown">
                <div class="dropdown-item user-info">
                    <div class="user-details">
                        <div class="user-name" id="dropdownUsername"></div>
                        <div class="user-level" id="userLevel"></div>
                    </div>
                </div>
                <div class="dropdown-divider"></div>
                <!-- è®¾ç½®æ¯”ç‡æŒ‰é’® -->
                <button class="dropdown-item settings-item" id="settingsBtnLoggedIn">
                    <span class="settings-icon">âš™ï¸</span>
                    è®¾ç½®æ¯”ç‡
                </button>
                <!-- æ›´æ–°æ•°æ®æŒ‰é’® -->
                <button class="dropdown-item update-data-item" id="updateDataBtn">
                    <span class="update-icon">ğŸ”„</span>
                    æ›´æ–°æ•°æ®
                </button>
                <!-- åˆ é™¤å¼ºåˆ¶åˆ·æ–°æŒ‰é’® -->
                <!-- <button class="dropdown-item force-refresh-item" id="forceRefreshBtn">
                    <span class="refresh-icon">ğŸ”„</span>
                    å¼ºåˆ¶åˆ·æ–°
                </button> -->
                <div class="dropdown-divider"></div>
                <button class="dropdown-item logout-btn" id="logoutBtn">
                    <span class="logout-icon">ğŸšª</span>
                    é€€å‡ºç™»å½•
                </button>
            </div>
        </div>
    </div>

    <main>
        <!-- ç™»å½•å¼¹çª— -->
        <div id="loginModal" class="modal">
            <div class="modal-content">
                <span class="close" id="closeModal">&times;</span>
                <h2>ç”¨æˆ·ç™»å½•</h2>
                <div class="modal-body">
                    <form id="loginForm" action="/xuexi_ranshao/login" method="POST">
                        <div class="mb-3">
                            <label for="username" class="form-label">ç”¨æˆ·å</label>
                            <input type="text" class="form-control" id="username" name="username" required>
                        </div>
                        <div class="mb-3">
                            <label for="password" class="form-label">å¯†ç </label>
                            <input type="password" class="form-control" id="password" name="password" required>
                        </div>
                        <div class="mb-3 form-check">
                            <input type="checkbox" class="form-check-input" id="rememberMe" name="rememberMe">
                            <label class="form-check-label" for="rememberMe">è®°ä½æˆ‘ï¼ˆä¿æŒç™»å½•çŠ¶æ€30å¤©ï¼‰</label>
                        </div>
                        <button type="submit" class="btn btn-primary">ç™»å½•</button>
                    </form>
                    <div class="switch-form">
                        <p>è¿˜æ²¡æœ‰è´¦å·ï¼Ÿ<a href="#" id="showRegister">ç«‹å³æ³¨å†Œ</a></p>
                    </div>
                </div>
            </div>
        </div>

        <!-- æ³¨å†Œå¼¹çª— -->
        <div id="registerModal" class="modal">
            <div class="modal-content">
                <span class="close" id="closeRegisterModal">&times;</span>
                <h2>ç”¨æˆ·æ³¨å†Œ</h2>
                <div class="modal-body">
                    <form id="registerForm" action="/xuexi_ranshao/register" method="POST">
                        <div class="mb-3">
                            <label for="regUsername" class="form-label">ç”¨æˆ·å</label>
                            <input type="text" class="form-control" id="regUsername" name="username" required>
                        </div>
                        <div class="mb-3">
                            <label for="regPassword" class="form-label">å¯†ç </label>
                            <input type="password" class="form-control" id="regPassword" name="password" required>
                        </div>
                        <div class="mb-3">
                            <label for="confirmPassword" class="form-label">ç¡®è®¤å¯†ç </label>
                            <input type="password" class="form-control" id="confirmPassword" name="confirmPassword"
                                required>
                        </div>
                        <div class="mb-3">
                            <label for="regEmail" class="form-label">é‚®ç®±ï¼ˆå¯é€‰ï¼‰</label>
                            <input type="email" class="form-control" id="regEmail" name="email">
                        </div>
                        <button type="submit" class="btn btn-success">æ³¨å†Œ</button>
                    </form>
                    <div class="switch-form">
                        <p>å·²æœ‰è´¦å·ï¼Ÿ<a href="#" id="showLogin">ç«‹å³ç™»å½•</a></p>
                    </div>
                </div>
            </div>
        </div>

        <!-- è®¾ç½®æ¯”ç‡å¼¹çª— -->
        <div id="settingsModal" class="modal">
            <div class="modal-content">
                <span class="close" id="closeSettingsModal">&times;</span>
                <h2>è®¾ç½®åˆä½œç¤¾å›æ”¶æ¯”ç‡</h2>
                <p>å½“å‰æ¯”ç‡: <span id="currentRateSpan">2200</span></p>
                <div class="modal-body">
                    <form id="settingsForm">
                        <div class="mb-3">
                            <label for="cooperativeRate" class="form-label">æ–°æ¯”ç‡</label>
                            <input type="number" step="0.01" class="form-control" id="cooperativeRate" required>
                        </div>
                        <button type="submit" class="btn btn-primary">ä¿å­˜</button>
                        <button type="button" id="cancelSettings" class="btn btn-secondary cancel-btn">å–æ¶ˆ</button>
                    </form>
                </div>
            </div>
        </div>

        <!-- è‡ªå®šä¹‰æ¶ˆæ¯å¼¹çª— -->
        <div id="messageModal" class="message-modal">
            <div class="message-content">
                <div class="message-icon" id="messageIcon"></div>
                <div class="message-text" id="messageText"></div>
                <button class="message-btn" id="messageBtn">ç¡®å®š</button>
            </div>
        </div>

        <!-- æ›´æ–°æ•°æ®å¼¹çª— -->
        <div id="updateDataModal" class="modal">
            <div class="modal-content">
                <span class="close" id="closeUpdateDataModal">&times;</span>
                <h2>æ›´æ–°è¡€è¢­åˆä½œç¤¾æ•°æ®</h2>
                <div class="modal-body">
                    <!-- ç§»é™¤è¡¨å•éƒ¨åˆ†ï¼Œç›´æ¥æ˜¾ç¤ºè¿›åº¦ -->
                    <div id="updateLoadingIndicator" class="loading-indicator" style="display: none;">
                        <div class="spinner"></div>
                        <div>æ­£åœ¨è·å–æ•°æ®ï¼Œè¯·ç¨å€™...</div>
                    </div>
                    <!-- æ›´æ–°çŠ¶æ€æ˜¾ç¤ºåŒºåŸŸ -->
                    <div id="updateStatusDisplay" class="update-status-display" style="display: none;">
                        <div class="update-progress">
                            <div class="progress-bar">
                                <div class="progress-fill" id="progressFill"></div>
                            </div>
                            <div class="progress-text" id="progressText">0%</div>
                        </div>
                        <div class="update-steps">
                            <div class="update-step" id="step1">
                                <div class="step-icon">1</div>
                                <div class="step-text">éªŒè¯è´¦æˆ·</div>
                            </div>
                            <div class="update-step" id="step2">
                                <div class="step-icon">2</div>
                                <div class="step-text">è·å–æ•°æ®</div>
                            </div>
                            <div class="update-step" id="step3">
                                <div class="step-icon">3</div>
                                <div class="step-text">ä¿å­˜åˆ°æ•°æ®åº“</div>
                            </div>
                            <div class="update-step" id="step4">
                                <div class="step-icon">4</div>
                                <div class="step-text">è®¡ç®—ç»Ÿè®¡ä¿¡æ¯</div>
                            </div>
                        </div>
                        <!-- æ·»åŠ å…³é—­æŒ‰é’® -->
                        <div style="margin-top: 20px; text-align: center;">
                            <button type="button" id="cancelUpdateData" class="btn btn-secondary cancel-btn">å…³é—­</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- é¡µé¢å†…å®¹åŒºåŸŸ -->
        <div class="content-area">
            <div class="isk-lp-info">
                <a href="https://www.fuzzwork.co.uk/lpstore/buy/10000002/1000134" class="info-card-link" target="_blank" rel="noopener noreferrer">
                    <div class="info-card clickable">
                        <div class="info-label">å®æ—¶jita ISK/LP æ¯”ç‡</div>
                        <div class="info-value">{{ max_isk_lp if max_isk_lp is defined else '0' }}</div>
                    </div>
                </a>
                <div class="info-card clickable" onclick="openSettingsModal()">
                    <div class="info-label">å®æ—¶åˆä½œç¤¾å›æ”¶ ISK/LP æ¯”ç‡</div>
                    <div class="info-value">2200</div>
                </div>
                <!-- æ–°å¢è¡€è¢­è€…LPç‚¹æ•°æ˜¾ç¤ºå¡ç‰‡ -->
                <div class="info-card">
                    <div class="info-label">è¡€è¢­è€…LPç‚¹æ•°</div>
                    <div class="info-value">{{ '{:,}'.format(blood_raider_lp) if blood_raider_lp is defined and blood_raider_lp else '0' }}</div>
                </div>
                <div class="info-card">
                    <div class="info-label">æ„æ—å¥¸å•†ä»·</div>
                    <div class="info-value">{{ '{:,.0f}'.format(2200 * blood_raider_lp) if blood_raider_lp is defined and blood_raider_lp else '0' }}</div>
                </div>
            </div>
            
            <!-- ä»»åŠ¡çŠ¶æ€ä¿¡æ¯ -->
            <div class="mission-status-info">
                <h3>ä»»åŠ¡çŠ¶æ€ç»Ÿè®¡</h3>
                <div class="isk-lp-info">  <!-- å¤ç”¨ç°æœ‰çš„å¡ç‰‡å¸ƒå±€æ ·å¼ -->
                    {% if mission_status is defined and mission_status.completed %}
                    <div class="info-card">
                        <div class="info-label">å·²å®Œæˆä»»åŠ¡</div>
                        <div class="info-value">{{ mission_status.completed.count }}</div>
                        <div class="info-bounty">{{ '{:,.0f}'.format(mission_status.completed.total_bounty) }} ISK</div>
                    </div>
                    {% endif %}
                    
                    {% if mission_status is defined and mission_status.paid %}
                    <div class="info-card clickable" onclick="window.open('https://blood.cs-eve.com/running', '_blank')" style="cursor: pointer;">
                        <div class="info-label">å·²æ”¯ä»˜ä»»åŠ¡</div>
                        <div class="info-value">{{ mission_status.paid.count }}</div>
                        <div class="info-bounty">{{ '{:,.0f}'.format(mission_status.paid.total_bounty) }} ISK</div>
                    </div>
                    {% endif %}
                    
                    {% if mission_status is defined and mission_status.done %}
                    <div class="info-card">
                        <div class="info-label">å·²å®Œç»“ä»»åŠ¡</div>
                        <div class="info-value">{{ mission_status.done.count }}</div>
                        <div class="info-bounty">{{ '{:,.0f}'.format(mission_status.done.total_bounty) }} ISK</div>
                    </div>
                    {% endif %}
                </div>
            </div>
            
            <!-- åœ¨ä»»åŠ¡çŠ¶æ€ç»Ÿè®¡ä¸‹æ–¹æ·»åŠ  -->
            <div class="tables-container">
                <div class="table-section">
                    <h4>å·²æ”¯ä»˜ä»»åŠ¡æ±‡æ€»</h4>
                    <div class="table-wrapper">
                        <table id="paidMissionsTable" class="data-table">
                            <thead>
                                <tr>
                                    <th>è€æ¿è´¦å·</th>
                                    <th>ä»»åŠ¡æ•°é‡</th>
                                    <th>æ€»é‡‘é¢</th>
                                    <th>æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- æ•°æ®å°†é€šè¿‡JavaScriptåŠ¨æ€åŠ è½½ -->
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="table-section">
                    <h4>æœ€è¿‘é’±åŒ…æèµ </h4>
                    <div class="table-wrapper">
                        <table id="walletDonationsTable" class="data-table">
                            <thead>
                                <tr>
                                    <th>æèµ äºº</th>
                                    <th>ç±»å‹</th>
                                    <th>é‡‘é¢</th>
                                    <th>æ—¥æœŸ</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- æ•°æ®å°†é€šè¿‡JavaScriptåŠ¨æ€åŠ è½½ -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            

        </div>
    </main>

    <!-- è§’è½é€šçŸ¥å¼¹çª— -->
    <div id="cornerNotification" class="corner-notification">
        <div class="corner-notification-icon" id="cornerNotificationIcon"></div>
        <div class="corner-notification-text" id="cornerNotificationText"></div>
    </div>

    <style>
        .db-save-status {
            margin: 15px 0;
            padding: 12px;
            border-radius: 6px;
            font-weight: 500;
        }

        .db-save-status.success {
            background: #e8f5e9;
            color: #388e3c;
            border-left: 4px solid #4caf50;
        }

        .db-save-status.error {
            background: #ffebee;
            color: #d32f2f;
            border-left: 4px solid #f44336;
        }

        .btn-success:hover {
            background: linear-gradient(90deg, #2e7d32 0%, #81c784 100%) !important;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin: 0 4px;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background-color: #007bff;
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            background-color: #0056b3;
        }

        .btn-primary:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }

        .btn-secondary {
            background-color: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background-color: #545b62;
        }

        /* æ·»åŠ å–æ¶ˆæŒ‰é’®æ ·å¼ï¼Œä¸è®¾ç½®æ¯”ç‡æŒ‰é’®ä¿æŒä¸€è‡´ */
        .btn-secondary.cancel-btn {
            background: linear-gradient(135deg, #4caf50, #66bb6a);
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            padding: 12px;
            margin-top: 8px;
            box-sizing: border-box;
            width: 100%;
        }

        .btn-secondary.cancel-btn:hover {
            background: linear-gradient(135deg, #388e3c, #81c784);
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(76, 175, 80, 0.3);
        }
        
        /* æ›´æ–°çŠ¶æ€æ˜¾ç¤ºæ ·å¼ */
        .update-status-display {
            margin-top: 20px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
        }

        .update-progress {
            margin-bottom: 20px;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e0e0e0;
            border-radius: 4px;
            overflow: hidden;
            position: relative;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #1976d2, #42a5f5);
            border-radius: 4px;
            transition: width 0.3s ease;
            width: 0%;
        }

        .progress-text {
            text-align: center;
            margin-top: 8px;
            font-weight: 600;
            color: #1976d2;
        }

        .update-steps {
            display: flex;
            justify-content: space-between;
            gap: 10px;
        }

        .update-step {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
        }

        .step-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #e0e0e0;
            color: #666;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-bottom: 8px;
            transition: all 0.3s ease;
        }

        .step-text {
            font-size: 0.9em;
            color: #666;
            transition: color 0.3s ease;
        }

        .update-step.active .step-icon {
            background: #1976d2;
            color: white;
            animation: pulse 1.5s infinite;
        }

        .update-step.active .step-text {
            color: #1976d2;
            font-weight: 600;
        }

        .update-step.completed .step-icon {
            background: #4caf50;
            color: white;
        }

        .update-step.completed .step-text {
            color: #4caf50;
            font-weight: 600;
        }

        .update-step.error .step-icon {
            background: #f44336;
            color: white;
        }

        .update-step.error .step-text {
            color: #f44336;
            font-weight: 600;
        }

        @keyframes pulse {
            0% {
                transform: scale(1);
                box-shadow: 0 0 0 0 rgba(25, 118, 210, 0.7);
            }
            70% {
                transform: scale(1.05);
                box-shadow: 0 0 0 10px rgba(25, 118, 210, 0);
            }
            100% {
                transform: scale(1);
                box-shadow: 0 0 0 0 rgba(25, 118, 210, 0);
            }
        }

        /* å¤œé—´æ¨¡å¼é€‚é… */
        [data-theme="dark"] .update-status-display {
            background: #2a2a2a;
            border-color: #444;
        }

        [data-theme="dark"] .progress-bar {
            background: #444;
        }

        [data-theme="dark"] .progress-text {
            color: #64b5f6;
        }

        [data-theme="dark"] .step-icon {
            background: #444;
            color: #b0b0b0;
        }

        [data-theme="dark"] .step-text {
            color: #b0b0b0;
        }

        [data-theme="dark"] .update-step.active .step-text {
            color: #64b5f6;
        }

        [data-theme="dark"] .update-step.completed .step-text {
            color: #4caf50;
        }

        [data-theme="dark"] .update-step.error .step-text {
            color: #f44336;
        }

        .switch-form {
            margin-top: 20px;
            padding-top: 16px;
            border-top: 1px solid #eee;
        }

        .settings-item {
            color: #4caf50;
            font-weight: 500;
        }

        .settings-item:hover {
            background: #e8f5e9;
            color: #388e3c;
        }

        /* ç»Ÿä¸€æ‰€æœ‰å›¾æ ‡æ ·å¼ï¼Œè¦†ç›–ä¹‹å‰çš„å®šä¹‰ */
        .settings-icon,
        .update-icon,
        .logout-icon {
            font-size: 14px !important; /* ä½¿ç”¨!importantç¡®ä¿ä¼˜å…ˆçº§ */
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 16px;
            height: 16px;
            flex-shrink: 0;
            line-height: 1;
            vertical-align: baseline;
        }

        .update-data-item {
            color: #1976d2;
            font-weight: 500;
        }

        .update-data-item:hover {
            background: #e3f2fd;
            color: #1565c0;
        }



        /* ISK/LP ä¿¡æ¯å¡ç‰‡æ ·å¼ */
        .isk-lp-info {
            display: flex;
            gap: 20px;
            margin: 30px 0;
            flex-wrap: wrap;
        }

        .info-card-link {
            text-decoration: none;
            color: inherit;
            display: block;
            flex: 1;
        }

        .info-card {
            background: linear-gradient(135deg, #ffffff, #f8f9fa);
            border: 2px solid #e3f2fd;
            border-radius: 12px;
            padding: 20px;
            min-width: 200px;
            flex: 1;
            text-align: center;
            box-shadow: 0 4px 12px rgba(25, 118, 210, 0.1);
            transition: all 0.3s ease;
        }

        .info-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(25, 118, 210, 0.15);
            border-color: #1976d2;
        }

        .info-card.clickable {
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .info-card.clickable:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 25px rgba(25, 118, 210, 0.2);
            border-color: #1976d2;
            background: linear-gradient(135deg, #f8f9fa, #e3f2fd);
        }

        .info-card.clickable:active {
            transform: translateY(-2px);
        }

        .info-label {
            font-size: 0.9em;
            color: #666;
            margin-bottom: 8px;
            font-weight: 500;
        }

        .info-value {
            font-size: 1.8em;
            font-weight: bold;
            color: #1976d2;
            text-shadow: 0 1px 2px rgba(25, 118, 210, 0.1);
        }
        
        .info-bounty {
            font-size: 1em;
            color: #388e3c;
            margin-top: 5px;
            font-weight: 500;
        }
        
        /* ä»»åŠ¡çŠ¶æ€ä¿¡æ¯æ ·å¼ */
        .mission-status-info {
            margin: 30px 0;
        }
        
        .mission-status-info h3 {
            color: #1976d2;
            margin-bottom: 15px;
            font-size: 1.3em;
        }
        
        .info-bounty {
            font-size: 1em;
            color: #388e3c;
            margin-top: 5px;
            font-weight: 500;
        }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            .isk-lp-info {
                flex-direction: column;
            }

            .info-card {
                min-width: auto;
            }
        }

        .tables-container {
            display: flex;
            gap: 20px;
            margin-top: 30px;
            width: 100%;
        }

        .table-section {
            flex: 1;
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .table-section h4 {
            margin: 0 0 15px 0;
            color: #333;
            font-size: 1.2em;
            text-align: center;
        }

        .table-wrapper {
            overflow-x: auto;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 8px;
            overflow: hidden;
        }

        .data-table th {
            background: linear-gradient(135deg, #1976d2, #42a5f5);
            color: white;
            padding: 12px 15px;
            text-align: left;
            font-weight: 600;
            font-size: 0.9em;
        }

        .data-table td {
            padding: 10px 15px;
            border-bottom: 1px solid #e0e0e0;
            color: #333;
        }

        .data-table tbody tr:hover {
            background-color: #f5f5f5;
        }

        .data-table tbody tr:last-child td {
            border-bottom: none;
        }

        .data-table .amount {
            color: #388e3c;
            font-weight: 500;
        }

        .data-table .count {
            color: #1976d2;
            font-weight: 500;
        }

        /* æ“ä½œæŒ‰é’®æ ·å¼ */
        .action-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
        }
        
        .view-btn {
            background: linear-gradient(135deg, #2196f3, #64b5f6);
            color: white;
        }
        
        .view-btn:hover {
            background: linear-gradient(135deg, #1976d2, #42a5f5);
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(33, 150, 243, 0.3);
        }
        
        .action-btn .icon-view {
            font-size: 14px;
        }
        
        /* æ”¯ä»˜è€…åŒ¹é…å¼¹çª—æ ·å¼ */
        .payer-match-modal {
            max-width: 900px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e0e0e0;
        }
        
        .modal-header h3 {
            margin: 0;
            color: #1976d2;
            font-size: 1.4em;
        }
        
        .match-info {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #2196f3;
        }
        
        .match-info h4 {
            margin: 0 0 10px 0;
            color: #1976d2;
        }
        
        .match-info p {
            margin: 0;
            color: #666;
        }
        
        .match-records-list {
            margin-top: 15px;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .match-record-item {
            background: #f8f9fa;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            margin-bottom: 15px;
            padding: 15px;
            transition: all 0.3s ease;
        }
        
        .match-record-item:hover {
            background: #e3f2fd;
            border-color: #2196f3;
        }
        
        .record-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding-bottom: 8px;
            border-bottom: 1px solid #ddd;
        }
        
        .record-number {
            background: #2196f3;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8em;
            font-weight: bold;
        }
        
        .record-donor {
            font-weight: 600;
            color: #1976d2;
            flex: 1;
            margin-left: 15px;
        }
        
        .record-amount {
            color: #388e3c;
            font-weight: 600;
            font-size: 1.1em;
        }
        
        .record-details {
            display: grid;
            gap: 8px;
        }
        
        .detail-item {
            color: #666;
            font-size: 0.9em;
        }
        
        .detail-item strong {
            color: #333;
            margin-right: 8px;
        }
        
        .no-match {
            text-align: center;
            color: #666;
            font-style: italic;
            padding: 40px 20px;
        }
        
        .modal-footer {
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid #e0e0e0;
            text-align: right;
        }
        
        /* ä¼˜åŒ–çš„åŒ¹é…å¤±è´¥å¼¹çª—æ ·å¼ */
        .no-match-modal {
            max-width: 600px;
            width: 90%;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15);
            border: none;
            overflow: hidden;
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
        }
        
        .modal-header-enhanced {
            display: flex;
            align-items: center;
            padding: 24px 32px 20px;
            background: linear-gradient(135deg, #ff6b6b 0%, #ff8e8e 100%);
            color: white;
            border-bottom: none;
            position: relative;
        }
        
        .header-icon {
            font-size: 32px;
            margin-right: 16px;
            animation: pulse 2s infinite;
        }
        
        .header-content {
            flex: 1;
        }
        
        .header-content h3 {
            margin: 0 0 4px 0;
            font-size: 1.5em;
            font-weight: 600;
            color: white;
        }
        
        .header-subtitle {
            margin: 0;
            font-size: 0.9em;
            opacity: 0.9;
            color: white;
        }
        
        .close-btn {
            position: absolute;
            top: 16px;
            right: 20px;
            font-size: 28px;
            color: white;
            cursor: pointer;
            opacity: 0.8;
            transition: opacity 0.2s;
            line-height: 1;
        }
        
        .close-btn:hover {
            opacity: 1;
        }
        
        .modal-body-enhanced {
            padding: 32px;
        }
        
        .payer-info-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 24px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            border: 1px solid #e9ecef;
        }
        
        .info-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #f1f3f4;
        }
        
        .info-row:last-child {
            border-bottom: none;
        }
        
        .info-label {
            font-weight: 500;
            color: #495057;
            font-size: 0.95em;
        }
        
        .info-value {
            font-weight: 600;
            color: #212529;
            font-size: 1em;
        }
        
        .info-value.amount {
            color: #28a745;
            font-family: 'Courier New', monospace;
        }
        
        .reasons-section, .suggestions-section {
            margin-bottom: 24px;
        }
        
        .reasons-section h4, .suggestions-section h4 {
            display: flex;
            align-items: center;
            margin: 0 0 16px 0;
            font-size: 1.1em;
            color: #495057;
            font-weight: 600;
        }
        
        .reasons-section h4 i, .suggestions-section h4 i {
            margin-right: 8px;
            font-size: 1.2em;
        }
        
        .reasons-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .reason-item {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #ffc107;
            transition: transform 0.2s;
        }
        
        .reason-item:hover {
            transform: translateX(4px);
        }
        
        .reason-icon {
            margin-right: 12px;
            font-size: 1.1em;
        }
        
        .suggestion-text {
            color: #6c757d;
            line-height: 1.5;
            margin: 0;
            font-size: 0.95em;
        }
        
        .modal-footer-enhanced {
            padding: 20px 32px 32px;
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }
        
        .btn-enhanced {
            display: flex;
            align-items: center;
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            font-weight: 500;
            font-size: 0.95em;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            min-width: 140px;
            justify-content: center;
        }
        
        .btn-icon {
            margin-right: 8px;
            font-size: 1em;
        }
        
        .btn-primary-enhanced {
            background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(0, 123, 255, 0.3);
        }
        
        .btn-primary-enhanced:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(0, 123, 255, 0.4);
        }
        
        .btn-success-enhanced {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
        }
        
        .btn-success-enhanced:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(40, 167, 69, 0.4);
        }
        
        .btn-secondary-enhanced {
            background: linear-gradient(135deg, #6c757d 0%, #5a6268 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(108, 117, 125, 0.3);
        }
        
        .btn-secondary-enhanced:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(108, 117, 125, 0.4);
        }
        
        .btn-enhanced:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
            box-shadow: none !important;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        
        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            .tables-container {
                flex-direction: column;
            }
            
            .data-table {
                font-size: 0.8em;
            }
            
            .data-table th,
            .data-table td {
                padding: 8px 10px;
            }
            
            .action-btn {
                padding: 6px 12px;
                font-size: 0.8em;
            }
            
            .payer-match-modal {
                width: 95%;
                max-height: 90vh;
            }
            
            .record-details {
                grid-template-columns: 1fr;
            }
            
            .record-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
            }
            
            .record-donor {
                margin-left: 0;
            }
            
            .no-match-modal {
                width: 95%;
                margin: 20px auto;
            }
            
            .modal-header-enhanced {
                padding: 20px 24px 16px;
            }
            
            .modal-body-enhanced {
                padding: 24px 20px;
            }
            
            .modal-footer-enhanced {
                padding: 16px 20px 24px;
                flex-direction: column;
            }
            
            .btn-enhanced {
                width: 100%;
                margin-bottom: 8px;
            }
        }

        /* è¡€è¢­æ•°æ®åŒºåŸŸæ ·å¼ */
        .blood-data-section {
            margin-top: 40px;
            padding: 30px;
            background: #f8f9fa;
            border-radius: 12px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
        }

        .blood-data-section h2 {
            color: #1976d2;
            margin-bottom: 25px;
            font-size: 1.5em;
            display: inline-block;
            margin-right: 20px;
        }

        .data-controls {
            margin-bottom: 25px;
            display: inline-block;
            vertical-align: top;
        }

        .section-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 25px;
        }

        .credentials-input {
            display: grid;
            grid-template-columns: auto 1fr auto 1fr auto;
            gap: 15px;
            align-items: center;
            max-width: 700px;
        }

        .credentials-input label {
            font-weight: 600;
            color: #333;
        }

        .credentials-input input {
            padding: 10px 12px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 1em;
            transition: border-color 0.3s;
        }

        .credentials-input input:focus {
            border-color: #1976d2;
            outline: none;
        }

        .fetch-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            background: linear-gradient(135deg, #1976d2, #42a5f5);
            color: white;
        }

        .fetch-btn:hover {
            background: linear-gradient(135deg, #1565c0, #64b5f6);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(25, 118, 210, 0.3);
        }

        .summary-btn {
            background: linear-gradient(135deg, #388e3c, #66bb6a);
        }

        .summary-btn:hover {
            background: linear-gradient(135deg, #2e7d32, #81c784);
        }

        .loading-indicator {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 20px;
            background: #e3f2fd;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .spinner {
            width: 24px;
            height: 24px;
            border: 3px solid #e0e0e0;
            border-top: 3px solid #1976d2;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .data-display {
            background: white;
            border-radius: 8px;
            padding: 20px;
            min-height: 200px;
            border: 1px solid #e0e0e0;
        }

        .data-placeholder {
            text-align: center;
            color: #666;
            font-style: italic;
            padding: 40px 20px;
        }

        .data-content {
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            line-height: 1.6;
            white-space: pre-wrap;
            word-wrap: break-word;
            max-height: 600px;
            overflow-y: auto;
        }

        .error-message {
            color: #d32f2f;
            background: #ffebee;
            padding: 15px;
            border-radius: 6px;
            border-left: 4px solid #d32f2f;
        }

        /* ç”¨æˆ·æ“ä½œåŒºåŸŸæ ·å¼ */
        .user-area {
            position: absolute;
            top: 70px;
            right: 40px;
            z-index: 100;
        }

        /* æœªç™»å½•çŠ¶æ€æ ·å¼ */
        .guest-area {
            display: flex;
            gap: 12px;
        }

        .auth-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 20px;
            font-size: 0.95em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .login-btn {
            background: linear-gradient(135deg, #1976d2, #42a5f5);
            color: white;
        }

        .login-btn:hover {
            background: linear-gradient(135deg, #1565c0, #64b5f6);
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(25, 118, 210, 0.3);
        }

        .register-btn {
            background: white;
            color: #1976d2;
            border: 2px solid #1976d2;
        }

        .register-btn:hover {
            background: #1976d2;
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(25, 118, 210, 0.3);
        }

        /* å·²ç™»å½•çŠ¶æ€æ ·å¼ */
        .user-profile {
            position: relative;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        /* è®¾ç½®æŒ‰é’®æ ·å¼ */
        .settings-btn {
            background: linear-gradient(135deg, #4caf50, #66bb6a);
            color: white;
        }

        .settings-btn:hover {
            background: linear-gradient(135deg, #388e3c, #81c784);
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(76, 175, 80, 0.3);
        }

        .user-avatar {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: linear-gradient(135deg, #1976d2, #42a5f5);
            color: white;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 12px rgba(25, 118, 210, 0.2);
        }

        .user-avatar:hover {
            background: linear-gradient(135deg, #1565c0, #64b5f6);
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(25, 118, 210, 0.3);
        }

        .user-avatar img {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            padding: 4px;
        }

        .username {
            font-weight: 600;
            font-size: 0.95em;
            max-width: 120px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .dropdown-arrow {
            font-size: 0.8em;
            transition: transform 0.3s ease;
        }

        .user-profile.active .dropdown-arrow {
            transform: rotate(180deg);
        }

        /* ä¸‹æ‹‰èœå•æ ·å¼ */
        .user-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            margin-top: 8px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
            min-width: 220px;
            max-width: 220px; /* æ·»åŠ æœ€å¤§å®½åº¦é™åˆ¶ */
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: all 0.3s ease;
            z-index: 1000;
        }

        .user-profile.active .user-dropdown {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .dropdown-item {
            padding: 12px 16px;
            border: none;
            background: none;
            width: 100%;
            text-align: left;
            cursor: pointer;
            transition: background 0.2s ease;
            display: flex;
            align-items: center;
            gap: 10px;
            line-height: 1.4;
            font-size: 14px;
            box-sizing: border-box; /* ç¡®ä¿paddingè®¡ç®—æ­£ç¡® */
        }

        .dropdown-item:hover {
            background: #f5f5f5;
        }

        .dropdown-item:first-child {
            border-radius: 12px 12px 0 0;
        }

        .dropdown-item:last-child {
            border-radius: 0 0 12px 12px;
        }

        .user-info {
            cursor: default;
            background: #f8f9fa;
            padding: 12px 16px; /* ç¡®ä¿ä¸å…¶ä»–é¡¹ä¸€è‡´çš„å†…è¾¹è· */
        }

        .user-info:hover {
            background: #f8f9fa;
        }

        .user-details {
            flex: 1;
            min-width: 0; /* é˜²æ­¢flexé¡¹ç›®æº¢å‡º */
        }

        .user-name {
            font-weight: 600;
            color: #333;
            font-size: 1em;
        }

        .user-level {
            font-size: 0.85em;
            color: #666;
            margin-top: 2px;
        }

        .dropdown-divider {
            height: 1px;
            background: #e0e0e0;
            margin: 0;
        }

        .logout-btn {
            color: #d32f2f;
            font-weight: 500;
        }

        .logout-btn:hover {
            background: #ffebee;
            color: #c62828;
        }

        /* åˆ é™¤é‡å¤çš„logout-iconå®šä¹‰ï¼Œå·²åœ¨ä¸Šé¢ç»Ÿä¸€å®šä¹‰ */

        /* åŸæœ‰æ ·å¼ä¿æŒä¸å˜ */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.15);
            justify-content: center;
            align-items: center;
        }

        .modal.show {
            display: flex;
            animation: simpleModalFadeIn 0.15s ease-out forwards;
        }

        @keyframes simpleModalFadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        .modal-content {
            background: #fff;
            margin: auto;
            padding: 36px 32px 28px 32px;
            border-radius: 18px;
            width: 340px;
            box-shadow: 0 8px 24px rgba(25, 118, 210, 0.12);
            position: relative;
            text-align: center;
            /* ç§»é™¤å†…å®¹çš„å•ç‹¬åŠ¨ç”»ï¼Œé¿å…é‡å¤åŠ¨ç”» */
            /* animation: modalFadeIn 0.3s; */
        }

        .close {
            position: absolute;
            right: 18px;
            top: 12px;
            font-size: 28px;
            color: #aaa;
            cursor: pointer;
            transition: color 0.2s;
        }

        .close:hover {
            color: #1976d2;
        }

        .modal-content h2 {
            margin-bottom: 24px;
            color: #1976d2;
            font-weight: bold;
            font-size: 1.5em;
        }

        .modal-content label {
            display: block;
            text-align: left;
            margin-bottom: 6px;
            color: #333;
            font-size: 1em;
        }

        .modal-content input {
            width: 100%;
            margin-bottom: 18px;
            padding: 10px 12px;
            border: 1.5px solid #bdbdbd;
            border-radius: 6px;
            font-size: 1.1em;
            transition: border 0.2s;
            box-sizing: border-box;
        }

        .modal-content input:focus {
            border: 1.5px solid #1976d2;
            outline: none;
        }

        .modal-content button[type="submit"] {
            width: 100%;
            padding: 12px;
            background: linear-gradient(90deg, #1976d2 0%, #42a5f5 100%);
            color: #fff;
            border: none;
            border-radius: 6px;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            transition: background 0.3s;
            margin-top: 8px;
            box-sizing: border-box;
        }

        .modal-content button[type="submit"]:hover {
            background: linear-gradient(90deg, #1565c0 0%, #64b5f6 100%);
        }

        .btn-success {
            background: linear-gradient(90deg, #388e3c 0%, #66bb6a 100%) !important;
        }

        .btn-success:hover {
            background: linear-gradient(90deg, #2e7d32 0%, #81c784 100%) !important;
        }

        .switch-form {
            margin-top: 20px;
            padding-top: 16px;
            border-top: 1px solid #eee;
        }

        .switch-form p {
            margin: 0;
            color: #666;
            font-size: 0.9em;
        }

        .switch-form a {
            color: #1976d2;
            text-decoration: none;
            font-weight: bold;
            transition: color 0.2s;
        }

        .switch-form a:hover {
            color: #1565c0;
            text-decoration: underline;
        }

        /* è‡ªå®šä¹‰æ¶ˆæ¯å¼¹çª—æ ·å¼ */
        .message-modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.2);
            justify-content: center;
            align-items: center;
        }

        .message-modal.show {
            display: flex;
            animation: simpleModalFadeIn 0.15s ease-out forwards;
        }

        .message-content {
            background: #fff;
            padding: 32px 28px 24px 28px;
            border-radius: 16px;
            width: 320px;
            max-width: 90vw;
            box-shadow: 0 12px 30px rgba(0, 0, 0, 0.1);
            text-align: center;
            /* ç§»é™¤å†…å®¹çš„å•ç‹¬åŠ¨ç”»ï¼Œé¿å…é‡å¤åŠ¨ç”» */
            /* animation: messageModalFadeIn 0.25s; */
        }

        .message-icon {
            width: 48px;
            height: 48px;
            margin: 0 auto 16px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            font-weight: bold;
        }

        .message-icon.success {
            background: linear-gradient(135deg, #4caf50, #66bb6a);
            color: #fff;
        }

        .message-icon.success::before {
            content: 'âœ“';
        }

        .message-icon.error {
            background: linear-gradient(135deg, #f44336, #ef5350);
            color: #fff;
        }

        .message-icon.error::before {
            content: 'âœ•';
        }

        .message-icon.info {
            background: linear-gradient(135deg, #2196f3, #42a5f5);
            color: #fff;
        }

        .message-icon.info::before {
            content: 'i';
        }

        .message-icon.warning {
            background: linear-gradient(135deg, #ff9800, #ffb74d);
            color: #fff;
        }

        .message-icon.warning::before {
            content: 'âš ';
        }

        .message-text {
            font-size: 1.1em;
            color: #333;
            margin-bottom: 24px;
            line-height: 1.5;
        }

        .message-btn {
            background: linear-gradient(90deg, #1976d2 0%, #42a5f5 100%);
            color: #fff;
            border: none;
            padding: 10px 32px;
            border-radius: 8px;
            font-size: 1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
            min-width: 80px;
        }

        .message-btn:hover {
            background: linear-gradient(90deg, #1565c0 0%, #64b5f6 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(25, 118, 210, 0.3);
        }

        /* å†…å®¹åŒºåŸŸæ ·å¼ */
        .content-area {
            padding: 120px 40px 40px;
            max-width: 1200px;
            margin: 0 auto;
        }

        .content-area h1 {
            color: #1976d2;
            margin-bottom: 20px;
        }

        /* EVEä»¤ç‰Œé€šçŸ¥æ ·å¼ */
        .eve-token-notification {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        .eve-token-notification .notification-content {
            display: flex;
            align-items: flex-start;
            gap: 12px;
        }

        .eve-token-notification .notification-icon {
            font-size: 24px;
            flex-shrink: 0;
            margin-top: 2px;
        }

        .eve-token-notification .notification-text {
            flex: 1;
        }

        .eve-token-notification .notification-text strong {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-size: 16px;
        }

        .eve-token-notification .notification-text p {
            margin: 0;
            color: #666;
            font-size: 14px;
            line-height: 1.4;
        }

        .eve-token-notification .notification-actions {
            display: flex;
            gap: 8px;
            margin-top: 12px;
            flex-wrap: wrap;
        }

        .eve-token-notification .btn-primary {
            background: linear-gradient(135deg, #1976d2, #42a5f5);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .eve-token-notification .btn-primary:hover {
            background: linear-gradient(135deg, #1565c0, #64b5f6);
            transform: translateY(-1px);
        }

        .eve-token-notification .btn-secondary {
            background: #f5f5f5;
            color: #666;
            border: 1px solid #ddd;
            padding: 8px 16px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .eve-token-notification .btn-secondary:hover {
            background: #e0e0e0;
            color: #333;
        }

        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideOutRight {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }
    </style>

    <script>
        // åˆå§‹åŒ–è¡¨æ ¼ï¼ˆä¿ç•™åŸæœ‰å‡½æ•°ä»¥å…¼å®¹æ€§ï¼‰
        function initTables() {
            // åŠ è½½æ•°æ®
            loadPaidMissionsData();
            loadWalletDonationsData();
        }

        // åŠ è½½å·²æ”¯ä»˜ä»»åŠ¡æ•°æ®
        function loadPaidMissionsData() {
            // ğŸ†• æ·»åŠ tokenæ£€æŸ¥å’Œé‡è¯•æœºåˆ¶
            async function fetchPaidMissionsData(retryCount = 0) {
                try {
                    // æ£€æŸ¥tokenæ˜¯å¦æœ‰æ•ˆ
                    if (!isCurrentTokenValid()) {
                        console.log('ğŸ”„ Tokenå³å°†è¿‡æœŸï¼Œå…ˆåˆ·æ–°token');
                        const tokenRefreshSuccess = await attemptTokenRefreshSilent();
                        if (!tokenRefreshSuccess) {
                            console.error('âŒ Tokenåˆ·æ–°å¤±è´¥ï¼Œæ— æ³•è·å–å·²æ”¯ä»˜ä»»åŠ¡æ•°æ®');
                            return;
                        }
                    }
                    
                    const response = await fetch('/api/paid_missions_summary', {
                        credentials: 'same-origin',
                        headers: {
                            'Content-Type': 'application/json',
                            'Cache-Control': 'no-cache'
                        }
                    });
                    
                    if (response.status === 401 && retryCount < 2) {
                        console.log('ğŸ”„ æ”¶åˆ°401é”™è¯¯ï¼Œå°è¯•åˆ·æ–°tokenå¹¶é‡è¯•');
                        const tokenRefreshSuccess = await attemptTokenRefreshSilent();
                        if (tokenRefreshSuccess) {
                            return fetchPaidMissionsData(retryCount + 1);
                        }
                    }
                    
                    const result = await response.json();
                    if (result.success) {
                        const data = result.data;
                        const tbody = document.querySelector('#paidMissionsTable tbody');
                        
                        // æ¸…ç©ºç°æœ‰æ•°æ®
                        tbody.innerHTML = '';
                        
                        if (data.length === 0) {
                            tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; color: #666;">æš‚æ— æ•°æ®</td></tr>';
                            return;
                        }
                        
                        data.forEach(item => {
                            const row = document.createElement('tr');
                            row.innerHTML = `
                                <td>${item.payer}</td>
                                <td class="count">${item.mission_count}</td>
                                <td class="amount">${(item.total_amount || 0).toLocaleString()} ISK</td>
                                <td>
                                    <button class="action-btn view-btn" onclick="viewPayerDetails('${item.payer}')" title="æŸ¥çœ‹è¯¦æƒ…">
                                        <i class="icon-view">ğŸ‘</i> è¯¦æƒ…
                                    </button>
                                </td>
                            `;
                            tbody.appendChild(row);
                        });
                    }
                } catch (error) {
                    console.error('åŠ è½½å·²æ”¯ä»˜ä»»åŠ¡æ•°æ®å¤±è´¥:', error);
                }
            }
            
            fetchPaidMissionsData();
        }

        // æŸ¥çœ‹æ”¯ä»˜è€…è¯¦æƒ… - åœ¨é’±åŒ…æèµ ä¸­æŸ¥æ‰¾åŒ¹é…é¡¹
        async function viewPayerDetails(payer) {
            console.log('æŸ¥æ‰¾æ”¯ä»˜è€…åœ¨é’±åŒ…æèµ ä¸­çš„è®°å½•:', payer);
            
            try {
                // æ£€æŸ¥tokenæ˜¯å¦æœ‰æ•ˆ
                if (!isCurrentTokenValid()) {
                    console.log('ğŸ”„ Tokenå³å°†è¿‡æœŸï¼Œå…ˆåˆ·æ–°token');
                    const tokenRefreshSuccess = await attemptTokenRefreshSilent();
                    if (!tokenRefreshSuccess) {
                        showMessage('Tokenåˆ·æ–°å¤±è´¥ï¼Œè¯·é‡æ–°ç™»å½•EVE SSO', 'error');
                        return;
                    }
                }
                
                // é¦–å…ˆè·å–å·²æ”¯ä»˜ä»»åŠ¡æ•°æ®ï¼Œæ‰¾åˆ°å¯¹åº”æ”¯ä»˜è€…çš„é‡‘é¢
                const response = await fetch('/api/paid_missions_summary', {
                    credentials: 'same-origin',
                    headers: {
                        'Content-Type': 'application/json',
                        'Cache-Control': 'no-cache'
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`è·å–å·²æ”¯ä»˜ä»»åŠ¡æ•°æ®å¤±è´¥: ${response.status}`);
                }
                
                const result = await response.json();
                if (result.success) {
                    const paidMissionsData = result.data;
                    const payerData = paidMissionsData.find(item => item.payer === payer);
                    
                    if (!payerData) {
                        showMessage('æœªæ‰¾åˆ°æ”¯ä»˜è€…ä¿¡æ¯', 'error');
                        return;
                    }
                    
                    const payerAmount = payerData.total_amount;
                    const missionIds = payerData.mission_ids || []; // è·å–ä»»åŠ¡IDåˆ—è¡¨
                    console.log('æ”¯ä»˜è€…é‡‘é¢:', payerAmount);
                    console.log('ä»»åŠ¡IDs:', missionIds);
                    
                    // è·å–é’±åŒ…æèµ æ•°æ®
                    const walletResponse = await fetch('/api/recent_wallet_donations', {
                        credentials: 'same-origin',
                        headers: {
                            'Content-Type': 'application/json',
                            'Cache-Control': 'no-cache'
                        }
                    });
                    
                    if (!walletResponse.ok) {
                        throw new Error(`è·å–é’±åŒ…æèµ æ•°æ®å¤±è´¥: ${walletResponse.status}`);
                    }
                    
                    const walletResult = await walletResponse.json();
                    if (walletResult.success) {
                        const walletData = walletResult.data;
                        
                        // æŸ¥æ‰¾åŒ¹é…é¡¹ - é‡‡ç”¨æ¨¡ç³ŠåŒ¹é…æ–¹å¼
                        const matchedRecords = walletData.filter(item => {
                            // æ¨¡ç³Šåç§°åŒ¹é… - ä½¿ç”¨å¤šç§åŒ¹é…ç­–ç•¥
                            const nameMatch = fuzzyNameMatch(item.donor, payer);
                            
                            // å®½æ¾é‡‘é¢åŒ¹é…ï¼ˆå…è®¸Â±5%çš„è¯¯å·®èŒƒå›´ï¼‰
                            const amountMatch = item.amount && Math.abs(item.amount - payerAmount) <= (payerAmount * 0.05);
                            
                            return nameMatch && amountMatch;
                        });
                        
                        // æ˜¾ç¤ºåŒ¹é…ç»“æœï¼Œä¼ é€’mission_ids
                        showPayerMatchResults(payer, matchedRecords, payerAmount, missionIds);
                    } else {
                        showMessage('è·å–é’±åŒ…æèµ æ•°æ®å¤±è´¥', 'error');
                    }
                } else {
                    showMessage('è·å–å·²æ”¯ä»˜ä»»åŠ¡æ•°æ®å¤±è´¥', 'error');
                }
            } catch (error) {
                console.error('æŸ¥æ‰¾æ”¯ä»˜è€…è¯¦æƒ…å¤±è´¥:', error);
                showMessage('æŸ¥æ‰¾æ”¯ä»˜è€…è¯¦æƒ…å¤±è´¥: ' + error.message, 'error');
            }
        }
        
        // æ˜¾ç¤ºæ”¯ä»˜è€…åŒ¹é…ç»“æœå¼¹çª—ï¼ˆæ›´æ–°å‡½æ•°ç­¾åä»¥åŒ…å«é‡‘é¢å’Œä»»åŠ¡IDsï¼‰
        function showPayerMatchResults(payer, matchedRecords, payerAmount, missionIds) {
            // å¦‚æœæ²¡æœ‰åŒ¹é…è®°å½•ï¼Œæ˜¾ç¤ºå¸¦æœ‰é‡æ–°æ›´æ–°é€‰é¡¹çš„å¼¹çª—
            if (matchedRecords.length === 0) {
                const noMatchModalHtml = `
                    <div id="payerNoMatchModal" class="modal show">
                        <div class="modal-content no-match-modal">
                            <div class="modal-header-enhanced">
                                <div class="header-icon">
                                    <i class="icon-warning">âš ï¸</i>
                                </div>
                                <div class="header-content">
                                    <h3>æ”¯ä»˜è€…åŒ¹é…å¤±è´¥</h3>
                                    <p class="header-subtitle">æœªåœ¨é’±åŒ…è®°å½•ä¸­æ‰¾åˆ°åŒ¹é…é¡¹</p>
                                </div>
                                <span class="close-btn" onclick="closePayerNoMatchModal()">&times;</span>
                            </div>
                            
                            <div class="modal-body-enhanced">
                                <div class="payer-info-card">
                                    <div class="info-row">
                                        <span class="info-label">æ”¯ä»˜è€…</span>
                                        <span class="info-value">${payer}</span>
                                    </div>
                                    <div class="info-row">
                                        <span class="info-label">ä»»åŠ¡é‡‘é¢</span>
                                        <span class="info-value amount">${payerAmount.toLocaleString()} ISK</span>
                                    </div>
                                    <div class="info-row">
                                        <span class="info-label">ä»»åŠ¡æ•°é‡</span>
                                        <span class="info-value">${missionIds ? missionIds.length : 0} ä¸ª</span>
                                    </div>
                                </div>
                                

                            </div>
                            
                            <div class="modal-footer-enhanced">
                                <button class="btn-enhanced btn-primary-enhanced" onclick="refreshWalletDataAndRetry('${payer}', ${payerAmount}, ${JSON.stringify(missionIds).replace(/"/g, '&quot;')})">
                                    <i class="btn-icon">ğŸ”„</i>
                                    <span>é‡æ–°æ›´æ–°é’±åŒ…è®°å½•</span>
                                </button>
                                <button class="btn-enhanced btn-success-enhanced" onclick="markMissionsAsDone('${payer}', ${JSON.stringify(missionIds).replace(/"/g, '&quot;')})" ${!missionIds || missionIds.length === 0 ? 'disabled' : ''}>
                                    <i class="btn-icon">âœ…</i>
                                    <span>å¼ºåˆ¶æ ‡è®°å®Œæˆ</span>
                                </button>
                                <button class="btn-enhanced btn-secondary-enhanced" onclick="closePayerNoMatchModal()">
                                    <i class="btn-icon">âœ–ï¸</i>
                                    <span>å…³é—­</span>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                
                // æ·»åŠ åˆ°é¡µé¢
                document.body.insertAdjacentHTML('beforeend', noMatchModalHtml);
                return;
            }
            
            // åªæœ‰åŒ¹é…æˆåŠŸæ—¶æ‰åˆ›å»ºå¼¹çª—
            const modalHtml = `
                <div id="payerMatchModal" class="modal show">
                    <div class="modal-content payer-match-modal">
                        <div class="modal-header">
                            <h3>æ”¯ä»˜è€…åŒ¹é…ç»“æœ</h3>
                            <span class="close" onclick="closePayerMatchModal()">&times;</span>
                        </div>
                        <div class="modal-body">
                            <div class="match-info">
                                <h4>æ”¯ä»˜è€…: ${payer}</h4>
                                <p>ä»»åŠ¡é‡‘é¢: <strong>${payerAmount.toLocaleString()} ISK</strong></p>
                                <p>åœ¨é’±åŒ…æèµ è®°å½•ä¸­æ‰¾åˆ° <strong>${matchedRecords.length}</strong> æ¡åŒ¹é…è®°å½•ï¼ˆåç§°+é‡‘é¢åŒ¹é…ï¼‰</p>
                                <p>ä»»åŠ¡æ•°é‡: <strong>${missionIds ? missionIds.length : 0}</strong> ä¸ª</p>
                            </div>
                            <div class="match-results">
                                ${generateMatchResultsList(matchedRecords)}
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-primary" onclick="markMissionsAsDone('${payer}', ${JSON.stringify(missionIds).replace(/"/g, '&quot;')})" ${!missionIds || missionIds.length === 0 ? 'disabled' : ''}>æ ‡è®°ä»»åŠ¡å®Œæˆ</button>
                            <button class="btn btn-secondary" onclick="closePayerMatchModal()">å…³é—­</button>
                        </div>
                    </div>
                </div>
            `;
            
            // æ·»åŠ åˆ°é¡µé¢
            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }
        
        // ç”ŸæˆåŒ¹é…ç»“æœåˆ—è¡¨ï¼ˆæ›¿æ¢åŸæ¥çš„è¡¨æ ¼å‡½æ•°ï¼‰
        function generateMatchResultsList(records) {
            let listHtml = '<div class="match-records-list">';
            
            records.forEach((record, index) => {
                listHtml += `
                    <div class="match-record-item">
                        <div class="record-header">
                            <span class="record-number">#${index + 1}</span>
                            <span class="record-donor">${record.donor || 'æœªçŸ¥'}</span>
                            <span class="record-amount">${(record.amount || 0).toLocaleString()} ISK</span>
                        </div>
                        <div class="record-details">
                            <div class="detail-item">
                                <strong>ç±»å‹:</strong> ${record.type || 'æœªçŸ¥'}
                            </div>
                            <div class="detail-item">
                                <strong>æ—¥æœŸ:</strong> ${record.date ? record.date.split('T')[0] : 'æœªçŸ¥'}
                            </div>
                            <div class="detail-item">
                                <strong>æè¿°:</strong> ${record.description || 'æ— æè¿°'}
                            </div>
                        </div>
                    </div>
                `;
            });
            
            listHtml += '</div>';
            return listHtml;
        }
        
        // å…³é—­æ”¯ä»˜è€…åŒ¹é…å¼¹çª—
        function closePayerMatchModal() {
            const modal = document.getElementById('payerMatchModal');
            if (modal) {
                modal.remove();
            }
        }
        
        // å…³é—­æ”¯ä»˜è€…æ— åŒ¹é…å¼¹çª—
        function closePayerNoMatchModal() {
            const modal = document.getElementById('payerNoMatchModal');
            if (modal) {
                modal.remove();
            }
        }
        
        // é‡æ–°æ›´æ–°é’±åŒ…æ•°æ®å¹¶é‡è¯•åŒ¹é…
        async function refreshWalletDataAndRetry(payer, payerAmount, missionIds) {
            const refreshBtn = document.querySelector('#payerNoMatchModal .btn-primary-enhanced');
            
            if (refreshBtn) {
                const originalText = refreshBtn.innerHTML;
                refreshBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> æ›´æ–°ä¸­...';
                refreshBtn.disabled = true;
                
                try {
                    console.log('ğŸ”„ å¼€å§‹ç›´æ¥æ›´æ–°EVEé’±åŒ…æ•°æ®');
                    
                    // æ£€æŸ¥EVE tokençŠ¶æ€
                    if (!isCurrentTokenValid()) {
                        console.log('ğŸ”„ Tokenå³å°†è¿‡æœŸï¼Œå…ˆåˆ·æ–°token');
                        const tokenRefreshSuccess = await attemptTokenRefreshSilent();
                        if (!tokenRefreshSuccess) {
                            showMessage('Tokenåˆ·æ–°å¤±è´¥ï¼Œè¯·é‡æ–°ç™»å½•EVE SSO', 'error');
                            return;
                        }
                    }
                    
                    // ğŸ†• ç›´æ¥è°ƒç”¨å¢é‡æ›´æ–°APIè·å–æœ€æ–°EVEæ•°æ®
                    const updateResponse = await fetch('/api/wallet_incremental_update', {
                        method: 'POST',
                        credentials: 'same-origin',
                        headers: {
                            'Content-Type': 'application/json',
                            'Cache-Control': 'no-cache'
                        },
                        body: JSON.stringify({
                            force_refresh: true,  // å¼ºåˆ¶åˆ·æ–°è·å–æœ€æ–°æ•°æ®
                            last_update: null
                        })
                    });
                    
                    if (updateResponse.ok) {
                        const updateResult = await updateResponse.json();
                        if (updateResult.success) {
                            console.log(`âœ… å¢é‡æ›´æ–°æˆåŠŸï¼Œè·å–åˆ° ${updateResult.new_entries || 0} æ¡æ–°è®°å½•`);
                            
                            // ç­‰å¾…æ•°æ®åº“å†™å…¥å®Œæˆ
                            await new Promise(resolve => setTimeout(resolve, 2000));
                            
                            // å¼ºåˆ¶åˆ·æ–°é’±åŒ…æ•°æ®æ˜¾ç¤º
                            await loadWalletDonationsData();
                            
                            // å†æ¬¡ç­‰å¾…ç•Œé¢æ¸²æŸ“
                            await new Promise(resolve => setTimeout(resolve, 1000));
                            
                            // éªŒè¯æ˜¯å¦æœ‰æ•°æ®æ›´æ–°
                            const verifyResponse = await fetch('/api/recent_wallet_donations?' + Date.now(), {
                                method: 'GET',
                                credentials: 'same-origin',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'Cache-Control': 'no-cache, no-store, must-revalidate'
                                }
                            });
                            
                            if (verifyResponse.ok) {
                                const verifyResult = await verifyResponse.json();
                                if (verifyResult.success && verifyResult.data && verifyResult.data.length > 0) {
                                    const latestEntry = verifyResult.data[0];
                                    const entryTime = new Date(latestEntry.date || latestEntry.timestamp);
                                    const now = new Date();
                                    const timeDiff = (now - entryTime) / 1000 / 60;
                                    
                                    console.log(`ğŸ“Š éªŒè¯ç»“æœ: æœ€æ–°è®°å½•æ—¶é—´=${entryTime.toLocaleString()}, æ—¶é—´å·®=${timeDiff.toFixed(1)}åˆ†é’Ÿ`);
                                }
                            }
                            
                            // å…³é—­å½“å‰å¼¹çª—
                            closePayerNoMatchModal();
                            
                            // é‡æ–°å°è¯•åŒ¹é…æ”¯ä»˜è€…
                            setTimeout(() => {
                                viewPayerDetails(payer, payerAmount, missionIds);
                            }, 500);
                            
                            showMessage('é’±åŒ…æ•°æ®æ›´æ–°å®Œæˆï¼Œæ­£åœ¨é‡æ–°åŒ¹é…...', 'success');
                            
                        } else {
                            showMessage(`å¢é‡æ›´æ–°å¤±è´¥: ${updateResult.message}`, 'error');
                        }
                    } else {
                        const errorResult = await updateResponse.json();
                        showMessage(`å¢é‡æ›´æ–°å¤±è´¥: ${errorResult.message}`, 'error');
                    }
                    
                } catch (error) {
                    console.error('âŒ æ›´æ–°é’±åŒ…æ•°æ®æ—¶å‡ºé”™:', error);
                    showMessage('æ›´æ–°é’±åŒ…æ•°æ®å¤±è´¥: ' + error.message, 'error');
                } finally {
                    if (refreshBtn) {
                        refreshBtn.innerHTML = originalText;
                        refreshBtn.disabled = false;
                    }
                }
            }
        }

        // åŠ è½½é’±åŒ…æèµ æ•°æ®
        function loadWalletDonationsData() {
            // ğŸ†• æ·»åŠ tokenæ£€æŸ¥å’Œé‡è¯•æœºåˆ¶
            async function fetchWalletData(retryCount = 0) {
                try {
                    // æ£€æŸ¥tokenæ˜¯å¦æœ‰æ•ˆ
                    if (!isCurrentTokenValid()) {
                        console.log('ğŸ”„ Tokenå³å°†è¿‡æœŸï¼Œå…ˆåˆ·æ–°token');
                        const tokenRefreshSuccess = await attemptTokenRefreshSilent();
                        if (!tokenRefreshSuccess) {
                            console.error('âŒ Tokenåˆ·æ–°å¤±è´¥ï¼Œæ— æ³•è·å–é’±åŒ…æ•°æ®');
                            return;
                        }
                    }
                    
                    const response = await fetch('/api/recent_wallet_donations', {
                        credentials: 'same-origin',
                        headers: {
                            'Content-Type': 'application/json',
                            'Cache-Control': 'no-cache'
                        }
                    });
                    
                    if (response.status === 401 && retryCount < 2) {
                        console.log('ğŸ”„ æ”¶åˆ°401é”™è¯¯ï¼Œå°è¯•åˆ·æ–°tokenå¹¶é‡è¯•');
                        const tokenRefreshSuccess = await attemptTokenRefreshSilent();
                        if (tokenRefreshSuccess) {
                            return fetchWalletData(retryCount + 1);
                        }
                    }
                    
                    const result = await response.json();
                    if (result.success) {
                        const data = result.data;
                        const tbody = document.querySelector('#walletDonationsTable tbody');
                        
                        // æ¸…ç©ºç°æœ‰æ•°æ®
                        tbody.innerHTML = '';
                        
                        if (data.length === 0) {
                            tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; color: #666;">æš‚æ— æ•°æ®</td></tr>';
                            return;
                        }
                        
                        data.forEach(item => {
                            const row = document.createElement('tr');
                            row.innerHTML = `
                                <td>${item.donor}</td>
                                <td>${item.type}</td>
                                <td class="amount">${(item.amount || 0).toLocaleString()} ISK</td>
                                <td>${item.date ? item.date.split('T')[0] : ''}</td>
                            `;
                            tbody.appendChild(row);
                        });
                    }
                } catch (error) {
                    console.error('åŠ è½½é’±åŒ…æèµ æ•°æ®å¤±è´¥:', error);
                }
            }
            
            fetchWalletData();
        }

        // DOM å…ƒç´ 
        const userArea = document.getElementById('userArea');
        const guestArea = document.getElementById('guestArea');
        const userProfile = document.getElementById('userProfile');
        const userAvatar = document.getElementById('userAvatar');
        const userDropdown = document.getElementById('userDropdown');
        const displayUsername = document.getElementById('displayUsername');
        const dropdownUsername = document.getElementById('dropdownUsername');
        const userLevel = document.getElementById('userLevel');

        const loginBtn = document.getElementById('loginBtn');
        const registerBtn = document.getElementById('registerBtn');
        const logoutBtn = document.getElementById('logoutBtn');
        
        // è®¾ç½®æ¯”ç‡ç›¸å…³å…ƒç´ 
        const settingsBtnLoggedIn = document.getElementById('settingsBtnLoggedIn');
        const settingsModal = document.getElementById('settingsModal');
        const closeSettingsModal = document.getElementById('closeSettingsModal');
        const settingsForm = document.getElementById('settingsForm');
        const cancelSettings = document.getElementById('cancelSettings');
        const cooperativeRateInput = document.getElementById('cooperativeRate');
        const currentRateSpan = document.getElementById('currentRateSpan');

        const loginModal = document.getElementById('loginModal');
        const registerModal = document.getElementById('registerModal');
        const closeModal = document.getElementById('closeModal');
        const closeRegisterModal = document.getElementById('closeRegisterModal');
        const loginForm = document.getElementById('loginForm');
        const registerForm = document.getElementById('registerForm');
        const showRegister = document.getElementById('showRegister');
        const showLogin = document.getElementById('showLogin');

        // è‡ªå®šä¹‰æ¶ˆæ¯å¼¹çª—å…ƒç´ 
        const messageModal = document.getElementById('messageModal');
        const messageIcon = document.getElementById('messageIcon');
        const messageText = document.getElementById('messageText');
        const messageBtn = document.getElementById('messageBtn');
        
        // æ›´æ–°æ•°æ®å…ƒç´ 
        const updateDataBtn = document.getElementById('updateDataBtn');
        const updateDataModal = document.getElementById('updateDataModal');
        const closeUpdateDataModal = document.getElementById('closeUpdateDataModal');
        const cancelUpdateData = document.getElementById('cancelUpdateData');
        const updateLoadingIndicator = document.getElementById('updateLoadingIndicator');

        // å½“å‰ç”¨æˆ·ä¿¡æ¯
        let currentUser = null;
        // æ·»åŠ è¡€è¢­åˆä½œç¤¾å‡­æ®å­˜å‚¨
        let bloodCredentials = {
            username: '',
            password: ''
        };
        
        // å°†bloodCredentialsæš´éœ²åˆ°å…¨å±€ä½œç”¨åŸŸ
        window.bloodCredentials = bloodCredentials;
        // æ·»åŠ å®šæ—¶æ›´æ–°çš„è®¡æ—¶å™¨å˜é‡
        let autoUpdateTimer = null;

        // ä¿å­˜å‡­æ®å‡½æ•°ï¼ˆå«å¤‡ä»½ï¼‰
        function saveCredentials(username, password) {
            const credentials = { username, password, timestamp: Date.now() };
            
            try {
                // ä¸»å­˜å‚¨
                localStorage.setItem('bloodCredentials', JSON.stringify(credentials));
                // å¤‡ä»½å­˜å‚¨
                localStorage.setItem('bloodCredentials_backup', JSON.stringify(credentials));
                console.log('âœ… å‡­æ®ä¿å­˜æˆåŠŸï¼ˆå«å¤‡ä»½ï¼‰');
            } catch (e) {
                console.error('âŒ å‡­æ®ä¿å­˜å¤±è´¥:', e);
            }
        }

        // æ¢å¤å‡­æ®å‡½æ•°ï¼ˆå°è¯•å¤‡ä»½ï¼‰
        function restoreCredentials() {
            let savedCredentials = localStorage.getItem('bloodCredentials');
            
            if (!savedCredentials) {
                console.log('ğŸ”„ ä¸»å‡­æ®ä¸å­˜åœ¨ï¼Œå°è¯•ä»å¤‡ä»½æ¢å¤');
                savedCredentials = localStorage.getItem('bloodCredentials_backup');
                
                if (savedCredentials) {
                    // ä»å¤‡ä»½æ¢å¤åˆ°ä¸»å­˜å‚¨
                    localStorage.setItem('bloodCredentials', savedCredentials);
                    console.log('âœ… ä»å¤‡ä»½æˆåŠŸæ¢å¤å‡­æ®');
                }
            }
            
            return savedCredentials;
        }

        // è§’è½é€šçŸ¥å¼¹çª—å…ƒç´ 
        const cornerNotification = document.getElementById('cornerNotification');
        const cornerNotificationIcon = document.getElementById('cornerNotificationIcon');
        const cornerNotificationText = document.getElementById('cornerNotificationText');
        
        // è‡ªå®šä¹‰æ¶ˆæ¯å¼¹çª—å‡½æ•° - æ”¹ä¸ºè§’è½å¼¹çª—
        function showMessage(text, type = 'info') {
            // è®¾ç½®æ–‡æœ¬å’Œå›¾æ ‡
            cornerNotificationText.textContent = text;
            cornerNotificationIcon.className = `corner-notification-icon ${type}`;
            cornerNotification.className = `corner-notification ${type}`;
            
            // æ˜¾ç¤ºå¼¹çª—
            cornerNotification.classList.add('show');
            
            // 4ç§’åå¼€å§‹æ·¡å‡ºåŠ¨ç”»
            setTimeout(() => {
                cornerNotification.classList.add('fade-out');
                cornerNotification.classList.remove('show');
                
                // åŠ¨ç”»å®Œæˆåé‡ç½®çŠ¶æ€
                setTimeout(() => {
                    cornerNotification.classList.remove('fade-out', type);
                }, 400);
            }, 4000);
        }

        // å…³é—­æ¶ˆæ¯å¼¹çª—
        messageBtn.onclick = () => messageModal.classList.remove('show');

        // ç‚¹å‡»æ¶ˆæ¯å¼¹çª—å¤–éƒ¨å…³é—­
        messageModal.onclick = (event) => {
            if (event.target === messageModal) {
                messageModal.classList.remove('show');
            }
        };

        // è·å–å½“å‰æœ‰æ•ˆçš„tokenè¿‡æœŸæ—¶é—´
        function getCurrentTokenExpires() {
            // ä¼˜å…ˆä½¿ç”¨æ›´æ–°åçš„tokenä¿¡æ¯
            return window.eveTokenInfo?.token_expires || '{{ session.get("eve_token_expires") if session else "" }}';
        }

        // æ·»åŠ ä¼šè¯ä¿æ´»åŠŸèƒ½
        let sessionKeepAliveTimer = null;

        function startSessionKeepAlive() {
            // æ¸…é™¤ç°æœ‰å®šæ—¶å™¨
            if (sessionKeepAliveTimer) {
                clearInterval(sessionKeepAliveTimer);
            }
            
            // æ¯3åˆ†é’Ÿå‘é€ä¸€æ¬¡ä¿æ´»è¯·æ±‚
            sessionKeepAliveTimer = setInterval(async () => {
                try {
                    console.log('ğŸ”„ æ‰§è¡Œä¼šè¯ä¿æ´»æ£€æŸ¥');
                    
                    // åŒæ—¶æ£€æŸ¥EVE tokençŠ¶æ€
                    const eveTokenExpires = getCurrentTokenExpires();
                    if (eveTokenExpires) {
                        const expiresTime = new Date(eveTokenExpires);
                        const now = new Date();
                        const timeLeft = Math.floor((expiresTime - now) / 1000 / 60);
                        
                        if (timeLeft <= 0) {
                            console.warn('âš ï¸ EVE tokenå·²è¿‡æœŸï¼Œå°è¯•åˆ·æ–°');
                            await attemptTokenRefreshSilent();
                        } else if (timeLeft <= 10) {
                            console.warn(`âš ï¸ EVE tokenå³å°†è¿‡æœŸï¼Œå‰©ä½™${timeLeft}åˆ†é’Ÿ`);
                        }
                    }
                    
                    const response = await fetch('/xuexi_ranshao/check_auth', {
                        method: 'GET',
                        credentials: 'same-origin',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    });
                    
                    if (response.ok) {
                        const result = await response.json();
                        if (result.authenticated) {
                            console.log('âœ… ä¼šè¯ä¿æ´»æˆåŠŸ');
                        } else {
                            console.warn('âš ï¸ ä¼šè¯å·²å¤±æ•ˆï¼Œåœæ­¢ä¿æ´»');
                            stopSessionKeepAlive();
                            updateUserInterface(); // åˆ‡æ¢åˆ°æœªç™»å½•çŠ¶æ€
                        }
                    } else {
                        console.warn('âš ï¸ ä¼šè¯ä¿æ´»è¯·æ±‚å¤±è´¥');
                    }
                } catch (error) {
                    console.error('âŒ ä¼šè¯ä¿æ´»å¼‚å¸¸:', error);
                }
            }, 3 * 60 * 1000); // 3åˆ†é’Ÿ
            
            console.log('ğŸ”„ ä¼šè¯ä¿æ´»å·²å¯åŠ¨ï¼ˆåŒ…å«EVE tokenæ£€æŸ¥ï¼‰');
        }

        function stopSessionKeepAlive() {
            if (sessionKeepAliveTimer) {
                clearInterval(sessionKeepAliveTimer);
                sessionKeepAliveTimer = null;
                console.log('ğŸ›‘ ä¼šè¯ä¿æ´»å·²åœæ­¢');
            }
        }

        // æ›´æ–°ç”¨æˆ·ç•Œé¢
        function updateUserInterface(user = null) {
            console.log(`ğŸ”„ [updateUserInterface] æ›´æ–°ç”¨æˆ·ç•Œé¢:`, user);
            
            // ğŸ†• æ·»åŠ EVE SSOçŠ¶æ€è¾“å‡º
            console.log(`ğŸš€ [updateUserInterface] EVE SSOä¼šè¯ä¿¡æ¯:`, {
                character_id: '{{ session.get("eve_character_id") if session else "" }}',
                character_name: '{{ session.get("eve_character_name") if session else "" }}',
                has_access_token: '{{ session.get("eve_access_token") if session else "" }}' ? true : false,
                has_refresh_token: '{{ session.get("eve_refresh_token") if session else "" }}' ? true : false,
                token_expires: '{{ session.get("eve_token_expires") if session else "" }}'
            });
            
            if (user) {
                currentUser = user;
                console.log(`âœ… [updateUserInterface] ç”¨æˆ·ç™»å½•çŠ¶æ€:`, {
                    username: user.username,
                    access_level: user.access_level || 'standard',
                    eve_sso_linked: '{{ session.get("eve_character_name") if session else "" }}' ? true : false
                });
                
                guestArea.style.display = 'none';
                userProfile.style.display = 'block';
                displayUsername.textContent = user.username;
                dropdownUsername.textContent = user.username;
                userLevel.textContent = `æƒé™ç­‰çº§: ${user.access_level || 'standard'}`;
                
                // é‡æ–°ç»‘å®šæŒ‰é’®äº‹ä»¶
                updateDataBtn.onclick = function(e) {
                    e.stopPropagation();
                    openUpdateDataModal();
                };
                
                settingsBtnLoggedIn.onclick = function(e) {
                    e.stopPropagation();
                    openSettingsModal();
                };
                
                // å¯åŠ¨ä¼šè¯ä¿æ´»
                startSessionKeepAlive();
            } else {
                console.log(`âŒ [updateUserInterface] ç”¨æˆ·æœªç™»å½•ï¼Œæ¸…é™¤ç•Œé¢çŠ¶æ€`);
                currentUser = null;
                guestArea.style.display = 'flex';
                userProfile.style.display = 'none';
                userProfile.classList.remove('active');
                // åœæ­¢ä¼šè¯ä¿æ´»
                stopSessionKeepAlive();
            }
        }

        // æ£€æŸ¥ç™»å½•çŠ¶æ€ï¼ˆå¸¦é‡è¯•æœºåˆ¶å’Œè¯¦ç»†è°ƒè¯•ä¿¡æ¯ï¼‰
async function checkAuthStatus(retryCount = 0) {
    console.log(`ğŸ” [checkAuthStatus] å¼€å§‹æ£€æŸ¥ç™»å½•çŠ¶æ€ï¼Œé‡è¯•æ¬¡æ•°: ${retryCount}`);
    
    try {
        // ğŸ”‘ å¼ºåˆ¶åˆ·æ–°é¡µé¢cookies
        if (retryCount === 0) {
            console.log('ğŸ”„ [checkAuthStatus] é¦–æ¬¡æ£€æŸ¥ï¼Œç­‰å¾…cookiesåŠ è½½');
            await new Promise(resolve => setTimeout(resolve, 500));
        }
        
        console.log(`ğŸ“¡ [checkAuthStatus] å‘é€è¯·æ±‚åˆ°: /xuexi_ranshao/check_auth`);
        const response = await fetch('/xuexi_ranshao/check_auth', {
            method: 'GET',
            credentials: 'same-origin',  // ğŸ”‘ ç¡®ä¿åŒ…å«cookies
            headers: {
                'Content-Type': 'application/json',
                'Cache-Control': 'no-cache',
                'Pragma': 'no-cache'  // å¼ºåˆ¶ä¸ä½¿ç”¨ç¼“å­˜
            }
        });
        
        console.log(`ğŸ“¥ [checkAuthStatus] æ”¶åˆ°å“åº”:`, {
            status: response.status,
            statusText: response.statusText,
            ok: response.ok,
            headers: Object.fromEntries(response.headers.entries())
        });
        
        if (response.ok) {
            const result = await response.json();
            console.log(`âœ… [checkAuthStatus] è§£æJSONæˆåŠŸ:`, result);
            
            // ğŸ†• æ·»åŠ EVE SSOä¿¡æ¯è¾“å‡º
            console.log(`ğŸš€ [checkAuthStatus] EVE SSOçŠ¶æ€æ£€æŸ¥:`, {
                eve_character_id: '{{ session.get("eve_character_id") if session else "" }}',
                eve_character_name: '{{ session.get("eve_character_name") if session else "" }}',
                eve_access_token: '{{ session.get("eve_access_token") if session else "" }}' ? 'å­˜åœ¨' : 'ä¸å­˜åœ¨',
                eve_token_expires: '{{ session.get("eve_token_expires") if session else "" }}',
                eve_refresh_token: '{{ session.get("eve_refresh_token") if session else "" }}' ? 'å­˜åœ¨' : 'ä¸å­˜åœ¨'
            });
            
            if (result.authenticated) {
                console.log(`ğŸ‰ [checkAuthStatus] ç”¨æˆ·å·²è®¤è¯:`, result.user);
                
                // ğŸ†• æ£€æŸ¥EVE SSOä»¤ç‰ŒçŠ¶æ€
                const eveTokenExpires = '{{ session.get("eve_token_expires") if session else "" }}';
                if (eveTokenExpires) {
                    const expiresTime = new Date(eveTokenExpires);
                    const now = new Date();
                    const timeLeft = Math.floor((expiresTime - now) / 1000 / 60); // åˆ†é’Ÿ
                    
                    console.log(`â° [checkAuthStatus] EVE SSOä»¤ç‰ŒçŠ¶æ€:`, {
                        expires_at: eveTokenExpires,
                        time_left_minutes: timeLeft,
                        is_expired: timeLeft <= 0,
                        needs_refresh: timeLeft <= 5
                    });
                    
                    if (timeLeft <= 0) {
                        console.warn(`âš ï¸ [checkAuthStatus] EVE SSOä»¤ç‰Œå·²è¿‡æœŸï¼`);
                    } else if (timeLeft <= 5) {
                        console.warn(`âš ï¸ [checkAuthStatus] EVE SSOä»¤ç‰Œå³å°†è¿‡æœŸï¼Œå‰©ä½™${timeLeft}åˆ†é’Ÿ`);
                    } else {
                        console.log(`âœ… [checkAuthStatus] EVE SSOä»¤ç‰Œæœ‰æ•ˆï¼Œå‰©ä½™${timeLeft}åˆ†é’Ÿ`);
                    }
                } else {
                    console.warn(`âŒ [checkAuthStatus] æœªæ‰¾åˆ°EVE SSOä»¤ç‰Œè¿‡æœŸæ—¶é—´`);
                }
                
                updateUserInterface(result.user);
                    
                    // å°è¯•ä»æœ¬åœ°å­˜å‚¨æ¢å¤è¡€è¢­åˆä½œç¤¾å‡­æ®
                    try {
                        const savedCredentials = restoreCredentials();
                        console.log(`ğŸ’¾ [checkAuthStatus] æœ¬åœ°å­˜å‚¨çš„å‡­æ®:`, savedCredentials ? 'å­˜åœ¨' : 'ä¸å­˜åœ¨');
                        
                        if (savedCredentials) {
                            const parsed = JSON.parse(savedCredentials);
                            console.log(`ğŸ”‘ [checkAuthStatus] è§£æå‡­æ®æˆåŠŸ:`, {
                                hasUsername: !!parsed.username,
                                hasPassword: !!parsed.password
                            });
                            
                            bloodCredentials.username = parsed.username;
                            bloodCredentials.password = parsed.password;
                            
                            // å¯åŠ¨è‡ªåŠ¨æ›´æ–°å®šæ—¶å™¨
                            startAutoUpdate();
                        }
                    } catch (e) {
                        console.error('âŒ [checkAuthStatus] æ¢å¤å‡­æ®å¤±è´¥:', e);
                    }
                } else {
                console.log(`âŒ [checkAuthStatus] ç”¨æˆ·æœªè®¤è¯ï¼Œé‡è¯•æ¬¡æ•°: ${retryCount}`);
                
                // å¦‚æœè®¤è¯å¤±è´¥ä¸”é‡è¯•æ¬¡æ•°å°‘äº3æ¬¡ï¼Œåˆ™é‡è¯•
                if (retryCount < 3) {
                    console.log(`ğŸ”„ [checkAuthStatus] ${retryCount + 1}ç§’åé‡è¯•...`);
                    setTimeout(() => checkAuthStatus(retryCount + 1), 1000);
                    return;
                }
                console.log(`ğŸš« [checkAuthStatus] è¾¾åˆ°æœ€å¤§é‡è¯•æ¬¡æ•°ï¼Œåœæ­¢é‡è¯•`);
                updateUserInterface();
                stopAutoUpdate();
            }
        } else {
            console.error(`âŒ [checkAuthStatus] HTTPé”™è¯¯:`, {
                status: response.status,
                statusText: response.statusText
            });
            
            // ç½‘ç»œé”™è¯¯ä¹Ÿè¿›è¡Œé‡è¯•
            if (retryCount < 3) {
                console.log(`ğŸ”„ [checkAuthStatus] ç½‘ç»œé”™è¯¯ï¼Œ${retryCount + 1}ç§’åé‡è¯•...`);
                setTimeout(() => checkAuthStatus(retryCount + 1), 1000);
                return;
            }
            console.log(`ğŸš« [checkAuthStatus] ç½‘ç»œé”™è¯¯è¾¾åˆ°æœ€å¤§é‡è¯•æ¬¡æ•°`);
            updateUserInterface();
            stopAutoUpdate();
        }
    } catch (error) {
        console.error('ğŸ’¥ [checkAuthStatus] è¯·æ±‚å¼‚å¸¸:', {
            name: error.name,
            message: error.message,
            stack: error.stack
        });
        
        if (retryCount < 3) {
            console.log(`ğŸ”„ [checkAuthStatus] å¼‚å¸¸åé‡è¯•ï¼Œ${retryCount + 1}ç§’åé‡è¯•...`);
            setTimeout(() => checkAuthStatus(retryCount + 1), 1000);
            return;
        }
        console.log(`ğŸš« [checkAuthStatus] å¼‚å¸¸è¾¾åˆ°æœ€å¤§é‡è¯•æ¬¡æ•°`);
        updateUserInterface();
        stopAutoUpdate();
    }
}

        // ğŸ†• EVE SSOçŠ¶æ€è°ƒè¯•å‡½æ•°
        function debugEveSSO() {
            console.log(`ğŸ” [debugEveSSO] å®Œæ•´EVE SSOçŠ¶æ€:`, {
                session_data: {
                    character_id: '{{ session.get("eve_character_id") if session else "" }}',
                    character_name: '{{ session.get("eve_character_name") if session else "" }}',
                    access_token: '{{ session.get("eve_access_token") if session else "" }}' ? 'å­˜åœ¨(é•¿åº¦:' + '{{ session.get("eve_access_token")|length if session and session.get("eve_access_token") else 0 }}' + ')' : 'ä¸å­˜åœ¨',
                    refresh_token: '{{ session.get("eve_refresh_token") if session else "" }}' ? 'å­˜åœ¨' : 'ä¸å­˜åœ¨',
                    token_expires: '{{ session.get("eve_token_expires") if session else "" }}'
                },
                local_storage: {
                    blood_credentials: localStorage.getItem('bloodCredentials') ? 'å­˜åœ¨' : 'ä¸å­˜åœ¨',
                    last_update_time: localStorage.getItem('lastUpdateTime')
                },
                current_time: new Date().toISOString()
            });
            
            // æ£€æŸ¥ä»¤ç‰Œæœ‰æ•ˆæ€§
            const eveTokenExpires = '{{ session.get("eve_token_expires") if session else "" }}';
            if (eveTokenExpires) {
                const expiresTime = new Date(eveTokenExpires);
                const now = new Date();
                const timeLeft = Math.floor((expiresTime - now) / 1000 / 60);
                
                console.log(`â° [debugEveSSO] ä»¤ç‰Œæ—¶é—´åˆ†æ:`, {
                    expires_at: eveTokenExpires,
                    current_time: now.toISOString(),
                    time_left_minutes: timeLeft,
                    status: timeLeft > 5 ? 'æ­£å¸¸' : timeLeft > 0 ? 'å³å°†è¿‡æœŸ' : 'å·²è¿‡æœŸ'
                });
            }
        }

        // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥ç™»å½•çŠ¶æ€
        document.addEventListener('DOMContentLoaded', function() {
            // 1. ç«‹å³æ˜¾ç¤ºå¯¼èˆªæ å’ŒåŸºç¡€UI
            initializeBasicUI();
            
            // 2. å¼‚æ­¥åˆå§‹åŒ–tokenä¿¡æ¯ï¼ˆä¸é˜»å¡UIï¼‰
            setTimeout(() => {
                window.eveTokenInfo = {
                    character_id: '{{ session.get("eve_character_id") if session else "" }}',
                    character_name: '{{ session.get("eve_character_name") if session else "" }}',
                    token_expires: '{{ session.get("eve_token_expires") if session else "" }}',
                    has_access_token: "{{ 'true' if session.get('eve_access_token') else 'false' }}"
                };
                
                debugEveSSO();
                checkAuthStatus();
                checkEveTokenOnPageLoad();
            }, 0);
            
            // 3. å»¶è¿ŸåŠ è½½æ•°æ®å¯†é›†å‹æ“ä½œ
            setTimeout(() => {
                initTablesAsync();
            }, 100);
            
            // 4. æœ€åå¯åŠ¨è‡ªåŠ¨æ›´æ–°
            setTimeout(() => {
                startOptimizedAutoUpdate();
            }, 500);
        }); // ç»“æŸå‰ä¸€ä¸ªå‡½æ•°çš„é—­åŒ…

        // æ–°å¢ï¼šåŸºç¡€UIåˆå§‹åŒ–å‡½æ•°
        function initializeBasicUI() {
            // ç§»é™¤å†…å®¹åŠ è½½çŠ¶æ€
            document.body.classList.remove('content-loading');
            
            // æ˜¾ç¤ºéª¨æ¶å±
            showSkeletonScreens();
        }

        // æ–°å¢ï¼šæ˜¾ç¤ºéª¨æ¶å±
        function showSkeletonScreens() {
            const infoCards = document.querySelectorAll('.info-card');
            const tables = document.querySelectorAll('.table-section');
            
            infoCards.forEach(card => {
                const valueElement = card.querySelector('.info-value');
                if (valueElement && !valueElement.textContent.trim()) {
                    card.classList.add('skeleton', 'skeleton-card');
                }
            });
            
            tables.forEach(table => {
                const tbody = table.querySelector('tbody');
                if (!tbody || tbody.children.length === 0) {
                    table.classList.add('skeleton', 'skeleton-table');
                }
            });
        }

        // æ–°å¢ï¼šå¼‚æ­¥è¡¨æ ¼åˆå§‹åŒ–
        async function initTablesAsync() {
            try {
                // æ˜¾ç¤ºåŠ è½½æŒ‡ç¤ºå™¨
                showLoadingIndicator();
                
                // å¹¶è¡ŒåŠ è½½æ•°æ®ï¼Œä½†ä¸é˜»å¡UI
                const loadPromises = [
                    loadPaidMissionsDataAsync(),
                    loadWalletDonationsDataAsync()
                ];
                
                // ç­‰å¾…æ‰€æœ‰æ•°æ®åŠ è½½å®Œæˆ
                await Promise.allSettled(loadPromises);
                
                // ç§»é™¤éª¨æ¶å±
                removeSkeletonScreens();
                
            } catch (error) {
                console.error('æ•°æ®åŠ è½½å¤±è´¥:', error);
            } finally {
                hideLoadingIndicator();
            }
        }

        // æ–°å¢ï¼šå¼‚æ­¥åŠ è½½å·²æ”¯ä»˜ä»»åŠ¡æ•°æ®
        async function loadPaidMissionsDataAsync() {
            try {
                return new Promise((resolve, reject) => {
                    loadPaidMissionsData();
                    resolve();
                });
            } catch (error) {
                console.error('åŠ è½½å·²æ”¯ä»˜ä»»åŠ¡æ•°æ®å¤±è´¥:', error);
            }
        }

        // æ–°å¢ï¼šå¼‚æ­¥åŠ è½½é’±åŒ…æèµ æ•°æ®
        async function loadWalletDonationsDataAsync() {
            try {
                return new Promise((resolve, reject) => {
                    loadWalletDonationsData();
                    resolve();
                });
            } catch (error) {
                console.error('åŠ è½½é’±åŒ…æèµ æ•°æ®å¤±è´¥:', error);
            }
        }

        // æ–°å¢ï¼šç§»é™¤éª¨æ¶å±
        function removeSkeletonScreens() {
            document.querySelectorAll('.skeleton').forEach(element => {
                element.classList.remove('skeleton', 'skeleton-card', 'skeleton-table');
            });
        }

        // æ–°å¢ï¼šæ˜¾ç¤º/éšè—åŠ è½½æŒ‡ç¤ºå™¨
        function showLoadingIndicator() {
            const indicator = document.createElement('div');
            indicator.id = 'page-loading-indicator';
            indicator.className = 'top-loading';
            indicator.innerHTML = '<div class="spinner"></div><span>æ­£åœ¨åŠ è½½æ•°æ®...</span>';
            document.body.appendChild(indicator);
        }

        function hideLoadingIndicator() {
            const indicator = document.getElementById('page-loading-indicator');
            if (indicator) {
                indicator.remove();
            }
        }

        // ğŸ†• é¡µé¢åŠ è½½æ—¶æ£€æŸ¥EVE SSOä»¤ç‰ŒçŠ¶æ€
        function checkEveTokenOnPageLoad() {
            const eveCharacterId = '{{ session.get("eve_character_id") if session else "" }}';
            const eveTokenExpires = getCurrentTokenExpires();
            
            // å¦‚æœç”¨æˆ·å·²ç»ç»‘å®šäº†EVE SSOä½†ä»¤ç‰Œè¿‡æœŸ
            if (eveCharacterId && eveTokenExpires) {
                const expiresTime = new Date(eveTokenExpires);
                const now = new Date();
                const timeLeft = Math.floor((expiresTime - now) / 1000 / 60); // åˆ†é’Ÿ
                
                console.log(`ğŸ” [checkEveTokenOnPageLoad] EVE SSOä»¤ç‰Œæ£€æŸ¥:`, {
                    character_id: eveCharacterId,
                    expires_at: eveTokenExpires,
                    time_left_minutes: timeLeft,
                    is_expired: timeLeft <= 0
                });
                
                if (timeLeft <= 0) {
                    // ä»¤ç‰Œå·²è¿‡æœŸï¼Œå°è¯•è‡ªåŠ¨åˆ·æ–°
                    console.warn(`âš ï¸ [checkEveTokenOnPageLoad] EVE SSOä»¤ç‰Œå·²è¿‡æœŸï¼Œå°è¯•è‡ªåŠ¨åˆ·æ–°`);
                    attemptTokenRefresh();
                } else if (timeLeft <= 10) {
                    // ä»¤ç‰Œå³å°†è¿‡æœŸï¼ˆ10åˆ†é’Ÿå†…ï¼‰ï¼Œæå‰åˆ·æ–°
                    console.warn(`âš ï¸ [checkEveTokenOnPageLoad] EVE SSOä»¤ç‰Œå³å°†è¿‡æœŸï¼Œå‰©ä½™${timeLeft}åˆ†é’Ÿ`);
                    attemptTokenRefresh();
                }
            }
        }

        // ğŸ†• æ·»åŠ tokenåˆ·æ–°å‡½æ•°
        async function attemptTokenRefresh() {
            try {
                console.log('ğŸ”„ [attemptTokenRefresh] å°è¯•åˆ·æ–°EVE SSOä»¤ç‰Œ');
                const response = await fetch('/auth/refresh', {
                    method: 'POST',
                    credentials: 'same-origin',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        console.log('âœ… [attemptTokenRefresh] EVE SSOä»¤ç‰Œåˆ·æ–°æˆåŠŸ');
                        
                        // å¦‚æœè¿”å›äº†tokenä¿¡æ¯ï¼Œæ›´æ–°å…¨å±€tokenä¿¡æ¯å˜é‡
                        if (result.token_info) {
                            window.eveTokenInfo = {
                                character_id: result.token_info.character_id,
                                character_name: result.token_info.character_name,
                                token_expires: result.token_info.token_expires,
                                has_access_token: result.token_info.has_access_token
                            };
                            console.log('ğŸ”„ [attemptTokenRefresh] å·²æ›´æ–°é¡µé¢tokenä¿¡æ¯:', window.eveTokenInfo);
                        }
                        
                        // åˆ·æ–°é¡µé¢ä»¥è·å–æ–°çš„tokenä¿¡æ¯
                        location.reload();
                    } else {
                        console.error('âŒ [attemptTokenRefresh] EVE SSOä»¤ç‰Œåˆ·æ–°å¤±è´¥:', result.message);
                        showEveTokenExpiredNotification();
                    }
                } else {
                    console.error('âŒ [attemptTokenRefresh] ä»¤ç‰Œåˆ·æ–°è¯·æ±‚å¤±è´¥:', response.status);
                    showEveTokenExpiredNotification();
                }
            } catch (error) {
                console.error('âŒ [attemptTokenRefresh] ä»¤ç‰Œåˆ·æ–°è¯·æ±‚å¼‚å¸¸:', error);
                showEveTokenExpiredNotification();
            }
        }

        // æ·»åŠ é™é»˜tokenåˆ·æ–°å‡½æ•°
        async function attemptTokenRefreshSilent() {
            try {
                console.log('ğŸ”„ [attemptTokenRefreshSilent] é™é»˜åˆ·æ–°EVE SSOä»¤ç‰Œ');
                const response = await fetch('/auth/refresh', {
                    method: 'POST',
                    credentials: 'same-origin',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const result = await response.json();
                    if (result.success && result.token_info) {
                        console.log('âœ… [attemptTokenRefreshSilent] EVE SSOä»¤ç‰Œé™é»˜åˆ·æ–°æˆåŠŸ');
                        
                        // æ›´æ–°å…¨å±€tokenä¿¡æ¯å˜é‡
                        window.eveTokenInfo = {
                            character_id: result.token_info.character_id,
                            character_name: result.token_info.character_name,
                            token_expires: result.token_info.token_expires,
                            has_access_token: result.token_info.has_access_token
                        };
                        
                        console.log('ğŸ”„ [attemptTokenRefreshSilent] å·²æ›´æ–°é¡µé¢tokenä¿¡æ¯:', window.eveTokenInfo);
                        
                        // ğŸ†• åˆ·æ–°æˆåŠŸåé‡æ–°åŠ è½½æ•°æ®
                        console.log('ğŸ”„ Tokenåˆ·æ–°æˆåŠŸï¼Œé‡æ–°åŠ è½½é¡µé¢æ•°æ®');
                        setTimeout(() => {
                            loadWalletDonationsData();
                            loadPaidMissionsData();
                        }, 500);
                        
                        return true;
                    } else {
                        console.error('âŒ [attemptTokenRefreshSilent] EVE SSOä»¤ç‰Œåˆ·æ–°å¤±è´¥:', result.message);
                        return false;
                    }
                } else {
                    console.error('âŒ [attemptTokenRefreshSilent] ä»¤ç‰Œåˆ·æ–°è¯·æ±‚å¤±è´¥:', response.status);
                    return false;
                }
            } catch (error) {
                console.error('âŒ [attemptTokenRefreshSilent] ä»¤ç‰Œåˆ·æ–°è¯·æ±‚å¼‚å¸¸:', error);
                return false;
            }
        }

        // ğŸ†• æ˜¾ç¤ºEVE SSOä»¤ç‰Œè¿‡æœŸé€šçŸ¥
        function showEveTokenExpiredNotification() {
            // åˆ›å»ºé€šçŸ¥å…ƒç´ 
            const notification = document.createElement('div');
            notification.className = 'eve-token-notification expired';
            notification.innerHTML = `
                <div class="notification-content">
                    <div class="notification-icon">âš ï¸</div>
                    <div class="notification-text">
                        <strong>EVE SSOä¼šè¯å·²è¿‡æœŸ</strong>
                        <p>æ‚¨çš„EVEåœ¨çº¿è®¤è¯å·²è¿‡æœŸï¼Œæ— æ³•è·å–æœ€æ–°çš„å¿ è¯šç‚¹æ•°æ®ã€‚è¯·é‡æ–°ç™»å½•EVE SSOä»¥ç»§ç»­ä½¿ç”¨å®Œæ•´åŠŸèƒ½ã€‚</p>
                    </div>
                    <div class="notification-actions">
                        <button onclick="window.location.href='/auth/login'" class="btn-primary">é‡æ–°ç™»å½•EVE SSO</button>
                        <button onclick="closeEveTokenNotification()" class="btn-secondary">ç¨åæé†’</button>
                    </div>
                </div>
            `;
            
            // æ·»åŠ æ ·å¼
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: #fff;
                border: 2px solid #ff6b6b;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                padding: 16px;
                max-width: 400px;
                z-index: 10000;
                animation: slideInRight 0.3s ease-out;
            `;
            
            document.body.appendChild(notification);
            
            // 5åˆ†é’Ÿåè‡ªåŠ¨éšè—
            setTimeout(() => {
                if (notification.parentNode) {
                    closeEveTokenNotification();
                }
            }, 5 * 60 * 1000);
        }

        // ğŸ†• æ˜¾ç¤ºEVE SSOä»¤ç‰Œå³å°†è¿‡æœŸé€šçŸ¥
        function showEveTokenExpiringNotification(minutesLeft) {
            const notification = document.createElement('div');
            notification.className = 'eve-token-notification expiring';
            notification.innerHTML = `
                <div class="notification-content">
                    <div class="notification-icon">â°</div>
                    <div class="notification-text">
                        <strong>EVE SSOä¼šè¯å³å°†è¿‡æœŸ</strong>
                        <p>æ‚¨çš„EVEåœ¨çº¿è®¤è¯å°†åœ¨${minutesLeft}åˆ†é’Ÿåè¿‡æœŸã€‚å»ºè®®æå‰é‡æ–°ç™»å½•ä»¥é¿å…æ•°æ®è·å–ä¸­æ–­ã€‚</p>
                    </div>
                    <div class="notification-actions">
                        <button onclick="window.location.href='/auth/login'" class="btn-primary">ç«‹å³é‡æ–°ç™»å½•</button>
                        <button onclick="closeEveTokenNotification()" class="btn-secondary">çŸ¥é“äº†</button>
                    </div>
                </div>
            `;
            
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: #fff;
                border: 2px solid #ffa726;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                padding: 16px;
                max-width: 400px;
                z-index: 10000;
                animation: slideInRight 0.3s ease-out;
            `;
            
            document.body.appendChild(notification);
            
            // 2åˆ†é’Ÿåè‡ªåŠ¨éšè—
            setTimeout(() => {
                if (notification.parentNode) {
                    closeEveTokenNotification();
                }
            }, 2 * 60 * 1000);
        }

        // ğŸ†• å…³é—­EVEä»¤ç‰Œé€šçŸ¥
        function closeEveTokenNotification() {
            const notifications = document.querySelectorAll('.eve-token-notification');
            notifications.forEach(notification => {
                notification.style.animation = 'slideOutRight 0.3s ease-in';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            });
        }

        // æ·»åŠ åˆ°å…¨å±€ï¼Œæ–¹ä¾¿æ‰‹åŠ¨è°ƒç”¨
        window.debugEveSSO = debugEveSSO;
        
        // æ£€æŸ¥å½“å‰tokenæ˜¯å¦æœ‰æ•ˆ
        function isCurrentTokenValid() {
            const eveTokenExpires = getCurrentTokenExpires();
            if (!eveTokenExpires) return false;
            
            const expiresTime = new Date(eveTokenExpires);
            const now = new Date();
            const timeLeft = Math.floor((expiresTime - now) / 1000 / 60); // åˆ†é’Ÿ
            
            return timeLeft > 5; // å¦‚æœå‰©ä½™æ—¶é—´å¤§äº5åˆ†é’Ÿï¼Œè®¤ä¸ºæœ‰æ•ˆ
        }

        // ç”¨æˆ·å¤´åƒç‚¹å‡»äº‹ä»¶
        userAvatar.onclick = (e) => {
            e.stopPropagation();
            userProfile.classList.toggle('active');
        };



        // é˜»æ­¢ä¸‹æ‹‰èœå•ç‚¹å‡»äº‹ä»¶å†’æ³¡ï¼Œä½†å…è®¸æŒ‰é’®ç‚¹å‡»
        userDropdown.onclick = (e) => {
            e.stopPropagation();
            // ä¸é˜»æ­¢é»˜è®¤è¡Œä¸ºï¼Œå…è®¸æŒ‰é’®ç‚¹å‡»äº‹ä»¶è§¦å‘
        };

        // é€€å‡ºç™»å½•ï¼ˆæ·»åŠ è°ƒè¯•ä¿¡æ¯ï¼‰
        logoutBtn.onclick = async () => {
            console.log(`ğŸšª [logout] å¼€å§‹é€€å‡ºç™»å½•æµç¨‹`);
            
            try {
                console.log(`ğŸ“¡ [logout] å‘é€é€€å‡ºè¯·æ±‚åˆ°: /xuexi_ranshao/logout`);
                const response = await fetch('/xuexi_ranshao/logout', {
                    method: 'POST'
                });

                console.log(`ğŸ“¥ [logout] æ”¶åˆ°é€€å‡ºå“åº”:`, {
                    status: response.status,
                    statusText: response.statusText,
                    ok: response.ok,
                    headers: Object.fromEntries(response.headers.entries())
                });

                if (response.ok) {
                    const result = await response.json();
                    console.log(`âœ… [logout] é€€å‡ºå“åº”JSON:`, result);
                    
                    if (result.success) {
                        console.log(`ğŸ‰ [logout] é€€å‡ºæˆåŠŸ`);
                        showMessage('å·²æˆåŠŸé€€å‡ºç™»å½•', 'success');
                        updateUserInterface();
                        
                        // æ¸…é™¤ä¿å­˜çš„å‡­æ®
                        console.log(`ğŸ—‘ï¸ [logout] æ¸…é™¤æœ¬åœ°å‡­æ®`);
                        bloodCredentials.username = '';
                        bloodCredentials.password = '';
                        try {
                            localStorage.removeItem('bloodCredentials');
                            localStorage.removeItem('bloodCredentials_backup');
                            console.log(`âœ… [logout] æœ¬åœ°å‡­æ®æ¸…é™¤æˆåŠŸï¼ˆå«å¤‡ä»½ï¼‰`);
                        } catch (e) {
                            console.error('âŒ [logout] æ¸…é™¤å‡­æ®å¤±è´¥:', e);
                        }
                        
                        // åœæ­¢è‡ªåŠ¨æ›´æ–°
                        stopAutoUpdate();
                    } else {
                        console.error(`âŒ [logout] é€€å‡ºå¤±è´¥:`, result.message);
                        showMessage('é€€å‡ºç™»å½•å¤±è´¥: ' + result.message, 'error');
                    }
                } else {
                    console.error(`âŒ [logout] é€€å‡ºè¯·æ±‚HTTPé”™è¯¯:`, {
                        status: response.status,
                        statusText: response.statusText
                    });
                    showMessage('é€€å‡ºç™»å½•è¯·æ±‚å¤±è´¥', 'error');
                }
            } catch (error) {
                console.error('ğŸ’¥ [logout] é€€å‡ºè¯·æ±‚å¼‚å¸¸:', {
                    name: error.name,
                    message: error.message,
                    stack: error.stack
                });
                showMessage('é€€å‡ºç™»å½•å‡ºé”™', 'error');
            }
        };

        // æ˜¾ç¤ºç™»å½•å¼¹çª—
        loginBtn.onclick = () => {
            loginModal.classList.add('show');
            registerModal.classList.remove('show');
        };

        // æ˜¾ç¤ºæ³¨å†Œå¼¹çª—
        registerBtn.onclick = () => {
            registerModal.classList.add('show');
            loginModal.classList.remove('show');
        };

        // åˆ‡æ¢åˆ°æ³¨å†Œå¼¹çª—
        showRegister.onclick = (e) => {
            e.preventDefault();
            loginModal.classList.remove('show');
            registerModal.classList.add('show');
        };

        // åˆ‡æ¢åˆ°ç™»å½•å¼¹çª—
        showLogin.onclick = (e) => {
            e.preventDefault();
            registerModal.classList.remove('show');
            loginModal.classList.add('show');
        };

        // å…³é—­ç™»å½•å¼¹çª—
        closeModal.onclick = () => loginModal.classList.remove('show');

        // å…³é—­æ³¨å†Œå¼¹çª—
        closeRegisterModal.onclick = () => registerModal.classList.remove('show');

        // ç‚¹å‡»é¡µé¢å…¶ä»–åœ°æ–¹å…³é—­ä¸‹æ‹‰èœå•å’Œå¼¹çª—
        window.onclick = (event) => {
            // å…³é—­ç”¨æˆ·ä¸‹æ‹‰èœå•
            userProfile.classList.remove('active');
            
            // å…³é—­ç™»å½•å’Œæ³¨å†Œå¼¹çª—
            if (event.target === loginModal) {
                loginModal.classList.remove('show');
            }
            if (event.target === registerModal) {
                registerModal.classList.remove('show');
            }
            
            // å…³é—­è®¾ç½®æ¯”ç‡å¼¹çª—
            if (event.target === settingsModal) {
                closeSettingsModalFunc();
            }
            
            // å…³é—­æ›´æ–°æ•°æ®å¼¹çª—
            if (event.target === updateDataModal) {
                closeUpdateDataModalFunc();
            }
        };

        // ç™»å½•è¡¨å•AJAXæäº¤ï¼ˆæ·»åŠ è°ƒè¯•ä¿¡æ¯ï¼‰
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            console.log(`ğŸ” [login] å¼€å§‹ç™»å½•æµç¨‹`);

            const formData = new FormData(loginForm);
            const rememberMe = formData.get('rememberMe') === 'on';
            
            console.log(`ğŸ“ [login] è¡¨å•æ•°æ®:`, {
                username: formData.get('username'),
                hasPassword: !!formData.get('password'),
                rememberMe: rememberMe
            });
            
            try {
                console.log('ğŸ“¡ [login] å‘é€ç™»å½•è¯·æ±‚');
                const response = await fetch('/xuexi_ranshao/login', {
                    method: 'POST',
                    body: formData,
                    credentials: 'same-origin',  // ç¡®ä¿åŒ…å«cookies
                    // ä¸è¦è®¾ç½®Content-Typeï¼Œè®©æµè§ˆå™¨è‡ªåŠ¨å¤„ç†FormData
                });
                
                console.log('ğŸ“¥ [login] æ”¶åˆ°ç™»å½•å“åº”:', {
                    status: response.status,
                    statusText: response.statusText,
                    ok: response.ok,
                    headers: Object.fromEntries(response.headers.entries())
                });

                if (response.ok) {
                    const result = await response.json();
                    console.log('âœ… [login] ç™»å½•å“åº”JSON:', result);
                    
                    if (result.success) {
                        console.log('ğŸ‰ [login] ç™»å½•æˆåŠŸ:', result.user);
                        showMessage('ç™»å½•æˆåŠŸï¼', 'success');
                        loginModal.classList.remove('show');
                        loginForm.reset();
                        
                        // ä¿å­˜è¡€è¢­åˆä½œç¤¾å‡­æ®ï¼ˆä¸ç™»å½•å‡­æ®ç›¸åŒï¼‰
                        bloodCredentials.username = formData.get('username');
                        bloodCredentials.password = formData.get('password');
                        
                        console.log(`ğŸ’¾ [login] ä¿å­˜å‡­æ®åˆ°æœ¬åœ°å­˜å‚¨`);
                        // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨ï¼ˆå«å¤‡ä»½ï¼‰
                        saveCredentials(bloodCredentials.username, bloodCredentials.password);
                        
                        // æ›´æ–°ç”¨æˆ·ç•Œé¢
                        updateUserInterface({
                            username: result.user,
                            access_level: result.xuexi_specific_data?.access_level || 'standard'
                        });
                        
                        // ğŸ”‘ å…³é”®ï¼šç­‰å¾…ä¼šè¯å®Œå…¨å»ºç«‹åå†è¿›è¡Œåç»­æ“ä½œ
                        console.log('â³ [login] ç­‰å¾…ä¼šè¯å»ºç«‹...');
                        setTimeout(async () => {
                            console.log('ğŸ”„ [login] éªŒè¯ä¼šè¯æ˜¯å¦å»ºç«‹æˆåŠŸ');
                            try {
                                const authCheck = await fetch('/xuexi_ranshao/check_auth', {
                                    method: 'GET',
                                    credentials: 'same-origin',
                                    headers: {
                                        'Content-Type': 'application/json',
                                        'Cache-Control': 'no-cache'
                                    }
                                });
                                
                                if (authCheck.ok) {
                                    const authResult = await authCheck.json();
                                    if (authResult.authenticated) {
                                        console.log('âœ… [login] ä¼šè¯éªŒè¯æˆåŠŸï¼Œå¯åŠ¨è‡ªåŠ¨æ›´æ–°');
                                        startAutoUpdate();
                                    } else {
                                        console.error('âŒ [login] ä¼šè¯éªŒè¯å¤±è´¥');
                                        showMessage('ä¼šè¯å»ºç«‹å¤±è´¥ï¼Œè¯·é‡æ–°ç™»å½•', 'error');
                                    }
                                } else {
                                    console.error('âŒ [login] ä¼šè¯éªŒè¯è¯·æ±‚å¤±è´¥');
                                }
                            } catch (error) {
                                console.error('ğŸ’¥ [login] ä¼šè¯éªŒè¯å¼‚å¸¸:', error);
                            }
                        }, 2000); // ç­‰å¾…2ç§’ç¡®ä¿ä¼šè¯å®Œå…¨å»ºç«‹
                    } else {
                        console.error('âŒ [login] ç™»å½•å¤±è´¥:', result.message);
                        showMessage('ç™»å½•å¤±è´¥: ' + result.message, 'error');
                    }
                } else {
                    console.error('âŒ [login] ç™»å½•è¯·æ±‚HTTPé”™è¯¯:', {
                        status: response.status,
                        statusText: response.statusText
                    });
                    showMessage('ç™»å½•è¯·æ±‚å¤±è´¥ï¼Œè¯·ç¨åå†è¯•ã€‚', 'error');
                }
            } catch (error) {
                console.error('ğŸ’¥ [login] ç™»å½•è¯·æ±‚å¼‚å¸¸:', error);
                showMessage('ç™»å½•è¯·æ±‚å‡ºé”™ï¼Œè¯·ç¨åå†è¯•ã€‚', 'error');
            }
        });

        // æ³¨å†Œè¡¨å•AJAXæäº¤
        registerForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            // éªŒè¯å¯†ç ç¡®è®¤
            const password = document.getElementById('regPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;

            if (password !== confirmPassword) {
                showMessage('ä¸¤æ¬¡è¾“å…¥çš„å¯†ç ä¸ä¸€è‡´ï¼Œè¯·é‡æ–°è¾“å…¥ã€‚', 'error');
                return;
            }

            const formData = new FormData(registerForm);
            try {
                const response = await fetch('/xuexi_ranshao/register', {
                    method: 'POST',
                    body: formData
                });

                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        showMessage('æ³¨å†ŒæˆåŠŸï¼è¯·ç™»å½•ã€‚', 'success');
                        // åˆ‡æ¢åˆ°ç™»å½•å¼¹çª—å¹¶é¢„å¡«ç”¨æˆ·å
                        document.getElementById('username').value = document.getElementById('regUsername').value;
                        registerModal.classList.remove('show');
                        loginModal.classList.add('show');
                        // æ¸…ç©ºæ³¨å†Œè¡¨å•
                        registerForm.reset();
                    } else {
                        showMessage('æ³¨å†Œå¤±è´¥: ' + result.message, 'error');
                    }
                } else {
                    showMessage('æ³¨å†Œè¯·æ±‚å¤±è´¥ï¼Œè¯·ç¨åå†è¯•ã€‚', 'error');
                }
            } catch (error) {
                console.error('æ³¨å†Œè¯·æ±‚å‡ºé”™:', error);
                showMessage('æ³¨å†Œè¯·æ±‚å‡ºé”™ï¼Œè¯·ç¨åå†è¯•ã€‚', 'error');
            }
        });



        // æ›´æ–°æ•°æ®åŠŸèƒ½ï¼ˆåˆå¹¶å¼ºåˆ¶åˆ·æ–°åŠŸèƒ½ï¼‰
        // æ‰“å¼€æ›´æ–°æ•°æ®å¼¹çª—
        function openUpdateDataModal() {
            // æ¸…é™¤æ›´æ–°æ—¶é—´ç¼“å­˜ï¼Œç¡®ä¿è·å–æœ€æ–°æ•°æ®
            localStorage.removeItem('lastUpdateTime');
            
            // å¦‚æœæœ‰ä¿å­˜çš„å‡­æ®ï¼Œç›´æ¥å¼€å§‹æ›´æ–°æµç¨‹
            if (bloodCredentials.username && bloodCredentials.password) {
                startDataUpdate(bloodCredentials.username, bloodCredentials.password, true);
                showMessage('æ­£åœ¨æ›´æ–°æ•°æ®...', 'info');
            } else {
                // å¦‚æœæ²¡æœ‰ä¿å­˜çš„å‡­æ®ï¼Œæ˜¾ç¤ºæç¤ºæ¶ˆæ¯
                showMessage('æ— æ³•è·å–è¡€è¢­åˆä½œç¤¾å‡­æ®ï¼Œè¯·é‡æ–°ç™»å½•', 'error');
            }
        }

        // å…³é—­æ›´æ–°æ•°æ®å¼¹çª—
        function closeUpdateDataModalFunc() {
            updateDataModal.classList.remove('show');
            // é‡ç½®è¿›åº¦æ˜¾ç¤º
            resetStepStatus();
            updateProgress(0);
            updateLoadingIndicator.style.display = 'none';
        }

        // ç»‘å®šäº‹ä»¶
        updateDataBtn.addEventListener('click', function(e) {
            e.stopPropagation(); // é˜»æ­¢å†’æ³¡ï¼Œé˜²æ­¢å…³é—­ä¸‹æ‹‰èœå•
            
            // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²ç™»å½•
            if (!currentUser) {
                showMessage('è¯·å…ˆç™»å½•åå†æ›´æ–°æ•°æ®', 'error');
                return;
            }
            
            // ç›´æ¥æ˜¾ç¤ºå¼¹çª—å¹¶å¼€å§‹æ›´æ–°
            updateDataModal.classList.add('show');
            const updateStatusDisplay = document.getElementById('updateStatusDisplay');
            updateStatusDisplay.style.display = 'block';
            
            // ä½¿ç”¨ä¿å­˜çš„å‡­æ®ç›´æ¥å¼€å§‹æ›´æ–°
            const savedCreds = restoreCredentials();
            if (savedCreds) {
                try {
                    const creds = JSON.parse(savedCreds);
                    if (creds.username && creds.password) {
                        // ç›´æ¥å¼€å§‹æ•°æ®æ›´æ–°
                        startDataUpdate(creds.username, creds.password);
                    } else {
                        showMessage('æœªæ‰¾åˆ°ä¿å­˜çš„è¡€è¢­åˆä½œç¤¾å‡­æ®ï¼Œè¯·å…ˆç™»å½•', 'error');
                        updateDataModal.classList.remove('show');
                    }
                } catch (e) {
                    console.error('æ¢å¤å‡­æ®å¤±è´¥:', e);
                    showMessage('å‡­æ®æ ¼å¼é”™è¯¯ï¼Œè¯·é‡æ–°ç™»å½•', 'error');
                    updateDataModal.classList.remove('show');
                }
            } else {
                showMessage('æœªæ‰¾åˆ°ä¿å­˜çš„è¡€è¢­åˆä½œç¤¾å‡­æ®ï¼Œè¯·å…ˆç™»å½•', 'error');
                updateDataModal.classList.remove('show');
            }
        });
        
        // å…³é—­æŒ‰é’®äº‹ä»¶ç»‘å®š
        closeUpdateDataModal.addEventListener('click', function() {
            updateDataModal.classList.remove('show');
        });
        
        // å–æ¶ˆæŒ‰é’®äº‹ä»¶ç»‘å®š
        cancelUpdateData.addEventListener('click', function() {
            updateDataModal.classList.remove('show');
        });



        // æ·»åŠ æ–°å‡½æ•°å¤„ç†æ•°æ®æ›´æ–°ï¼ˆä¿®å¤é™é»˜æ¨¡å¼é—®é¢˜ï¼‰
        async function startDataUpdate(username, password, silent = false) {
            console.log(`ğŸš€ [startDataUpdate] å¼€å§‹æ•°æ®æ›´æ–°:`, {
                username: username,
                silent: silent,
                eve_character_id: '{{ session.get("eve_character_id") if session else "" }}',
                eve_character_name: '{{ session.get("eve_character_name") if session else "" }}'
            });
            
            // ğŸ†• æ£€æŸ¥EVE SSOçŠ¶æ€ - ä¼˜å…ˆä½¿ç”¨æ›´æ–°åçš„tokenä¿¡æ¯
            const eveCharacterId = window.eveTokenInfo?.character_id || '{{ session.get("eve_character_id") if session else "" }}';
            const eveAccessToken = window.eveTokenInfo?.has_access_token || ('{{ session.get("eve_access_token") if session else "" }}' ? true : false);
            const eveTokenExpires = getCurrentTokenExpires();
            
            console.log(`ğŸ” [startDataUpdate] EVE SSOæ•°æ®æ›´æ–°å‰æ£€æŸ¥:`, {
                has_character_id: !!eveCharacterId,
                has_access_token: !!eveAccessToken,
                token_expires: eveTokenExpires,
                can_fetch_eve_data: !!(eveCharacterId && eveAccessToken)
            });
            
            if (eveTokenExpires) {
                const expiresTime = new Date(eveTokenExpires);
                const now = new Date();
                const isExpired = now >= expiresTime;
                
                console.log(`â° [startDataUpdate] EVEä»¤ç‰Œæ£€æŸ¥:`, {
                    expires_at: eveTokenExpires,
                    current_time: now.toISOString(),
                    is_expired: isExpired,
                    time_diff_minutes: Math.floor((expiresTime - now) / 1000 / 60)
                });
                
                if (isExpired) {
                    console.error(`âŒ [startDataUpdate] EVE SSOä»¤ç‰Œå·²è¿‡æœŸï¼Œå°è¯•åˆ·æ–°`);
                    
                    // å°è¯•åˆ·æ–°ä»¤ç‰Œ
                    const refreshSuccess = await attemptTokenRefreshSilent();
                    if (!refreshSuccess) {
                        console.error(`âŒ [startDataUpdate] ä»¤ç‰Œåˆ·æ–°å¤±è´¥ï¼Œæ— æ³•è·å–EVEæ•°æ®`);
                        if (!silent) {
                            showMessage('EVE SSOä»¤ç‰Œå·²è¿‡æœŸä¸”åˆ·æ–°å¤±è´¥ï¼Œè¯·é‡æ–°ç™»å½•EVE SSO', 'error');
                            showEveTokenExpiredNotification();
                        }
                        return; // åœæ­¢æ‰§è¡Œ
                    } else {
                        console.log(`âœ… [startDataUpdate] ä»¤ç‰Œåˆ·æ–°æˆåŠŸï¼Œç»§ç»­æ•°æ®æ›´æ–°`);
                        // ä¸éœ€è¦åˆ·æ–°é¡µé¢ï¼Œç»§ç»­æ‰§è¡Œ
                    }
                }
            }
            
            // æ£€æŸ¥ç™»å½•çŠ¶æ€
            if (!currentUser) {
                console.error(`âŒ [startDataUpdate] ç”¨æˆ·æœªç™»å½•`);
                if (!silent) showMessage('è¯·å…ˆç™»å½•åå†æ›´æ–°æ•°æ®', 'error');
                return;
            }

            // ğŸ”‘ å¼ºåˆ¶é‡æ–°éªŒè¯ä¼šè¯çŠ¶æ€
            console.log(`ğŸ” [startDataUpdate] éªŒè¯ä¼šè¯çŠ¶æ€`);
            try {
                const authResponse = await fetch('/xuexi_ranshao/check_auth', {
                    method: 'GET',
                    credentials: 'same-origin',
                    headers: {
                        'Content-Type': 'application/json',
                        'Cache-Control': 'no-cache'
                    }
                });
                
                if (!authResponse.ok) {
                    console.error(`âŒ [startDataUpdate] ä¼šè¯éªŒè¯è¯·æ±‚å¤±è´¥: ${authResponse.status}`);
                    if (!silent) {
                        showMessage('ä¼šè¯éªŒè¯å¤±è´¥ï¼Œè¯·é‡æ–°ç™»å½•', 'error');
                        updateUserInterface(); // åˆ‡æ¢åˆ°æœªç™»å½•çŠ¶æ€
                    }
                    return;
                }
                
                const authResult = await authResponse.json();
                if (!authResult.authenticated) {
                    console.error(`âŒ [startDataUpdate] ä¼šè¯éªŒè¯å¤±è´¥ï¼Œç”¨æˆ·æœªè®¤è¯`);
                    if (!silent) {
                        showMessage('ä¼šè¯å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•', 'error');
                        updateUserInterface(); // åˆ‡æ¢åˆ°æœªç™»å½•çŠ¶æ€
                    }
                    return;
                }
                
                console.log(`âœ… [startDataUpdate] ä¼šè¯éªŒè¯æˆåŠŸï¼Œç”¨æˆ·: ${authResult.user}`);
            } catch (error) {
                console.error(`ğŸ’¥ [startDataUpdate] ä¼šè¯éªŒè¯å¼‚å¸¸:`, error);
                if (!silent) showMessage('ä¼šè¯éªŒè¯å‡ºé”™ï¼Œè¯·é‡æ–°ç™»å½•', 'error');
                return;
            }

            // ğŸ†• åªåœ¨éé™é»˜æ¨¡å¼ä¸‹æ˜¾ç¤ºUI
            if (!silent) {
                // æ˜¾ç¤ºåŠ è½½çŠ¶æ€å’Œæ›´æ–°çŠ¶æ€åŒºåŸŸ
                updateDataModal.classList.add('show');
                updateLoadingIndicator.style.display = 'flex';
                const updateStatusDisplay = document.getElementById('updateStatusDisplay');
                updateStatusDisplay.style.display = 'block';
                
                // é‡ç½®æ‰€æœ‰æ­¥éª¤çŠ¶æ€
                resetStepStatus();
                
                // æ›´æ–°è¿›åº¦æ¡ä¸º0%
                updateProgress(0);
            }
            
            try {
                // ç¬¬ä¸€æ­¥ï¼šéªŒè¯è´¦æˆ·
                console.log(`1ï¸âƒ£ [startDataUpdate] æ­¥éª¤1: éªŒè¯è´¦æˆ·`);
                if (!silent) {
                    updateStepStatus('step1', 'active');
                    await simulateDelay(500);
                    updateProgress(25);
                    updateStepStatus('step1', 'completed');
                }
                
                // ç¬¬äºŒæ­¥ï¼šè·å–æ•°æ®
                console.log(`2ï¸âƒ£ [startDataUpdate] æ­¥éª¤2: è·å–æ•°æ®`);
                if (!silent) {
                    updateStepStatus('step2', 'active');
                    await simulateDelay(500);
                }
                
                const params = new URLSearchParams({
                    blood_username: username,
                    blood_password: password
                });
                const apiUrl = `/api/blood_cooperatives_data?${params.toString()}`;
                console.log(`ğŸ“¡ [startDataUpdate] å‘é€æ•°æ®è¯·æ±‚åˆ°:`, apiUrl);
                
                // ğŸ”‘ å…³é”®ä¿®å¤ï¼šç¡®ä¿åŒ…å«ä¼šè¯å‡­æ®
                const response = await fetch(apiUrl, {
                    method: 'GET',
                    credentials: 'same-origin',  // ç¡®ä¿åŒ…å«cookies
                    headers: {
                        'Content-Type': 'application/json',
                        'Cache-Control': 'no-cache'
                    }
                });
                
                console.log(`ğŸ“¥ [startDataUpdate] æ”¶åˆ°æ•°æ®å“åº”:`, {
                    status: response.status,
                    statusText: response.statusText,
                    ok: response.ok,
                    headers: Object.fromEntries(response.headers.entries())
                });
                
                // ğŸ”§ ä¿®å¤ï¼šå¤„ç†401è®¤è¯é”™è¯¯
                if (response.status === 401) {
                    console.error('âŒ EVE SSOè®¤è¯å¤±è´¥');
                    if (!silent) {
                        updateStepStatus('step2', 'error');
                        updateProgress(50);
                        showMessage('EVE SSOè®¤è¯å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•EVE SSO', 'error');
                        showEveTokenExpiredNotification();
                    }
                    return false;
                }
                
                if (!silent) {
                    updateProgress(50);
                    updateStepStatus('step2', 'completed');
                }
                
                if (response.ok) {
                    const result = await response.json();
                    console.log(`âœ… [startDataUpdate] æ•°æ®å“åº”JSON:`, result);

                    if (result.success) {
                        // ç¬¬ä¸‰æ­¥ï¼šä¿å­˜åˆ°æ•°æ®åº“
                        console.log(`3ï¸âƒ£ [startDataUpdate] æ­¥éª¤3: ä¿å­˜åˆ°æ•°æ®åº“`);
                        if (!silent) {
                            updateStepStatus('step3', 'active');
                            await simulateDelay(500);
                            updateProgress(75);
                            updateStepStatus('step3', 'completed');
                        }
                        
                        // ç¬¬å››æ­¥ï¼šè®¡ç®—ç»Ÿè®¡ä¿¡æ¯
                        console.log(`4ï¸âƒ£ [startDataUpdate] æ­¥éª¤4: è®¡ç®—ç»Ÿè®¡ä¿¡æ¯`);
                        if (!silent) {
                            updateStepStatus('step4', 'active');
                            await simulateDelay(500);
                            updateProgress(100);
                            updateStepStatus('step4', 'completed');
                        }
                        
                        console.log(`ğŸ‰ [startDataUpdate] æ•°æ®æ›´æ–°æˆåŠŸ`);
                        
                        // ğŸ†• éªŒè¯å®é™…æ•°æ®æ›´æ–°ç»“æœ
                        const hasValidData = result.data && (
                            (result.data.summary && Object.keys(result.data.summary).length > 0) ||
                            (result.data.missions && result.data.missions.length > 0) ||
                            (result.data.wallet_donations && result.data.wallet_donations.length > 0)
                        );
                        
                        if (hasValidData) {
                            if (!silent) {
                                showMessage('æ•°æ®æ›´æ–°æˆåŠŸï¼', 'success');
                                // å…³é—­æ›´æ–°å¼¹çª—
                                setTimeout(() => {
                                    closeUpdateDataModalFunc();
                                }, 2000);
                            }
                            
                            // å¯é€‰ï¼šåŠ¨æ€æ›´æ–°é¡µé¢ä¸Šçš„ç»Ÿè®¡æ•°æ®
                            if (result.data && result.data.summary) {
                                updatePageStatistics(result.data.summary);
                            }
                            
                            return true; // è¿”å›æˆåŠŸçŠ¶æ€
                        } else {
                            console.warn(`âš ï¸ [startDataUpdate] æ•°æ®æ›´æ–°æˆåŠŸä½†æ— æœ‰æ•ˆæ•°æ®`);
                            if (!silent) {
                                showMessage('æ•°æ®æ›´æ–°å®Œæˆï¼Œä½†æœªè·å–åˆ°æ–°æ•°æ®', 'warning');
                            }
                            return true; // ğŸ†• å³ä½¿æ— æ–°æ•°æ®ä¹Ÿè¿”å›æˆåŠŸï¼Œå› ä¸ºæ›´æ–°æµç¨‹æœ¬èº«æ˜¯æˆåŠŸçš„
                        }
                    } else {
                        console.error(`âŒ [startDataUpdate] æ•°æ®æ›´æ–°å¤±è´¥:`, result.message);
                        if (!silent) {
                            updateStepStatus('step2', 'error');
                            updateProgress(50);
                            showMessage(`æ•°æ®æ›´æ–°å¤±è´¥: ${result.message}`, 'error');
                        }
                        return false;
                    }
                } else {
                    const errorMessage = `HTTP ${response.status}: ${response.statusText}`;
                    console.error(`âŒ [startDataUpdate] æ•°æ®è¯·æ±‚HTTPé”™è¯¯:`, {
                        status: response.status,
                        statusText: response.statusText
                    });
                    if (!silent) {
                        updateStepStatus('step2', 'error');
                        updateProgress(50);
                        showMessage(`æ•°æ®è¯·æ±‚å¤±è´¥: ${errorMessage}`, 'error');
                    }
                    return false;
                }
            } catch (error) {
                console.error('ğŸ’¥ [startDataUpdate] æ•°æ®æ›´æ–°å¼‚å¸¸:', {
                    name: error.name,
                    message: error.message,
                    stack: error.stack
                });
                if (!silent) {
                    updateStepStatus('step2', 'error');
                    updateProgress(50);
                    showMessage(`æ•°æ®æ›´æ–°å¼‚å¸¸: ${error.message}`, 'error');
                }
                return false;
            } finally {
                if (!silent) {
                    updateLoadingIndicator.style.display = 'none';
                }
                console.log(`ğŸ [startDataUpdate] æ•°æ®æ›´æ–°æµç¨‹ç»“æŸ`);
            }
        }

        // å¤„ç†æ›´æ–°æ•°æ®è¡¨å•æäº¤ï¼ˆå·²ç§»é™¤ï¼Œç°åœ¨ç›´æ¥ä½¿ç”¨ä¿å­˜çš„å‡­æ®ï¼‰

        // æ›´æ–°è¿›åº¦æ¡
        function updateProgress(percentage) {
            const progressFill = document.getElementById('progressFill');
            const progressText = document.getElementById('progressText');
            
            progressFill.style.width = `${percentage}%`;
            progressText.textContent = `${percentage}%`;
        }

        // æ›´æ–°æ­¥éª¤çŠ¶æ€
        function updateStepStatus(stepId, status) {
            const step = document.getElementById(stepId);
            // ç§»é™¤æ‰€æœ‰çŠ¶æ€ç±»
            step.classList.remove('active', 'completed', 'error');
            // æ·»åŠ æ–°çŠ¶æ€
            step.classList.add(status);
        }

        // é‡ç½®æ‰€æœ‰æ­¥éª¤çŠ¶æ€
        function resetStepStatus() {
            const steps = ['step1', 'step2', 'step3', 'step4'];
            steps.forEach(stepId => {
                const step = document.getElementById(stepId);
                step.classList.remove('active', 'completed', 'error');
            });
        }

        // æ¨¡æ‹Ÿå»¶è¿Ÿ
        function simulateDelay(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }
        
        // æ›´æ–°é¡µé¢ç»Ÿè®¡ä¿¡æ¯
        async function updatePageStatistics(summary) {
            console.log('ğŸ“Š [updatePageStatistics] æ›´æ–°é¡µé¢ç»Ÿè®¡ä¿¡æ¯:', summary);
            
            try {
                // æ£€æŸ¥tokenæ˜¯å¦æœ‰æ•ˆ
                if (!isCurrentTokenValid()) {
                    console.log('ğŸ”„ Tokenå³å°†è¿‡æœŸï¼Œå…ˆåˆ·æ–°token');
                    const tokenRefreshSuccess = await attemptTokenRefreshSilent();
                    if (!tokenRefreshSuccess) {
                        console.error('âŒ Tokenåˆ·æ–°å¤±è´¥ï¼Œæ— æ³•æ›´æ–°ç»Ÿè®¡ä¿¡æ¯');
                        return;
                    }
                }
                
                // è·å–æœ€æ–°çš„ä»»åŠ¡çŠ¶æ€ç»Ÿè®¡ä¿¡æ¯
                const response = await fetch('/api/mission_status_summary', {
                    method: 'GET',
                    credentials: 'same-origin',
                    headers: {
                        'Content-Type': 'application/json',
                        'Cache-Control': 'no-cache'
                    }
                });
                
                if (response.ok) {
                    const result = await response.json();
                    if (result.success && result.data) {
                        const missionStatus = result.data;
                        
                        // æ›´æ–°ä»»åŠ¡çŠ¶æ€ç»Ÿè®¡ä¿¡æ¯
                        const missionStatusCards = document.querySelectorAll('.mission-status-info .info-card');
                        
                        // æ›´æ–°å·²å®Œæˆä»»åŠ¡
                        if (missionStatus.completed && missionStatusCards[0]) {
                            const countElement = missionStatusCards[0].querySelector('.info-value');
                            const bountyElement = missionStatusCards[0].querySelector('.info-bounty');
                            if (countElement) countElement.textContent = missionStatus.completed.count;
                            if (bountyElement) {
                                bountyElement.textContent = new Intl.NumberFormat('zh-CN').format(missionStatus.completed.total_bounty) + ' ISK';
                            }
                        }
                        
                        // æ›´æ–°å·²æ”¯ä»˜ä»»åŠ¡
                        if (missionStatus.paid && missionStatusCards[1]) {
                            const countElement = missionStatusCards[1].querySelector('.info-value');
                            const bountyElement = missionStatusCards[1].querySelector('.info-bounty');
                            if (countElement) countElement.textContent = missionStatus.paid.count;
                            if (bountyElement) {
                                bountyElement.textContent = new Intl.NumberFormat('zh-CN').format(missionStatus.paid.total_bounty) + ' ISK';
                            }
                        }
                        
                        // æ›´æ–°å·²å®Œç»“ä»»åŠ¡
                        if (missionStatus.done && missionStatusCards[2]) {
                            const countElement = missionStatusCards[2].querySelector('.info-value');
                            const bountyElement = missionStatusCards[2].querySelector('.info-bounty');
                            if (countElement) countElement.textContent = missionStatus.done.count;
                            if (bountyElement) {
                                bountyElement.textContent = new Intl.NumberFormat('zh-CN').format(missionStatus.done.total_bounty) + ' ISK';
                            }
                        }
                        
                        console.log('âœ… [updatePageStatistics] ä»»åŠ¡çŠ¶æ€ç»Ÿè®¡ä¿¡æ¯æ›´æ–°å®Œæˆ');
                    } else {
                        console.log('âš ï¸ [updatePageStatistics] è·å–ä»»åŠ¡çŠ¶æ€ç»Ÿè®¡ä¿¡æ¯å¤±è´¥:', result.message);
                    }
                } else {
                    console.log('âš ï¸ [updatePageStatistics] ä»»åŠ¡çŠ¶æ€ç»Ÿè®¡ä¿¡æ¯è¯·æ±‚å¤±è´¥:', response.status);
                }
                
                // æ›´æ–°è¡€è¢­è€…LPç‚¹æ•°
                console.log('ğŸ”„ [updatePageStatistics] æ›´æ–°è¡€è¢­è€…LPç‚¹æ•°');
                try {
                    const lpResponse = await fetch('/api/blood_raider_lp', {
                        credentials: 'same-origin',
                        headers: {
                            'Content-Type': 'application/json',
                            'Cache-Control': 'no-cache'
                        }
                    });
                    if (lpResponse.ok) {
                        const lpResult = await lpResponse.json();
                        if (lpResult.success) {
                            // æ›´æ–°è¡€è¢­è€…LPç‚¹æ•°æ˜¾ç¤º
                            const infoCards = document.querySelectorAll('.info-card');
                            if (infoCards.length > 2) {
                                const lpCard = infoCards[2].querySelector('.info-value');
                                if (lpCard) {
                                    lpCard.textContent = new Intl.NumberFormat('zh-CN').format(lpResult.blood_raider_lp);
                                }
                            }
                            
                            // æ›´æ–°æ„æ—å¥¸å•†ä»·è®¡ç®—
                            updateBloodRaiderLPCalculation();
                            
                            console.log('âœ… [updatePageStatistics] è¡€è¢­è€…LPç‚¹æ•°æ›´æ–°å®Œæˆ:', lpResult.blood_raider_lp);
                        } else {
                            console.log('âš ï¸ [updatePageStatistics] è·å–è¡€è¢­è€…LPç‚¹æ•°å¤±è´¥:', lpResult.message);
                        }
                    } else {
                        console.log('âš ï¸ [updatePageStatistics] è¡€è¢­è€…LPç‚¹æ•°è¯·æ±‚å¤±è´¥:', lpResponse.status);
                    }
                } catch (error) {
                    console.error('âŒ [updatePageStatistics] æ›´æ–°è¡€è¢­è€…LPç‚¹æ•°æ—¶å‡ºé”™:', error);
                }
                
                // åˆ·æ–°å·²æ”¯ä»˜ä»»åŠ¡è¡¨æ ¼
                console.log('ğŸ”„ [updatePageStatistics] åˆ·æ–°å·²æ”¯ä»˜ä»»åŠ¡è¡¨æ ¼');
                loadPaidMissionsData();
                
                // åˆ·æ–°é’±åŒ…æèµ è¡¨æ ¼
                console.log('ğŸ”„ [updatePageStatistics] åˆ·æ–°é’±åŒ…æèµ è¡¨æ ¼');
                loadWalletDonationsData();
                
                // åˆ·æ–°è¡¨æ ¼æ•°æ®
                initTables();
                
            } catch (error) {
                console.error('âŒ [updatePageStatistics] æ›´æ–°ç»Ÿè®¡ä¿¡æ¯æ—¶å‡ºé”™:', error);
            }
        }
       
        
        // è‡ªåŠ¨æ›´æ–°åŠŸèƒ½
        function startAutoUpdate() {
            // æ¸…é™¤ç°æœ‰çš„å®šæ—¶å™¨ï¼ˆå¦‚æœæœ‰ï¼‰
            stopAutoUpdate();
            
            // è®¾ç½®æ–°çš„å®šæ—¶å™¨ï¼Œæ¯3åˆ†é’Ÿè‡ªåŠ¨æ›´æ–°ä¸€æ¬¡ï¼ˆä¸sessionä¿æ´»åŒæ­¥ï¼‰
            autoUpdateTimer = setInterval(async () => {
                // é¦–å…ˆæ£€æŸ¥EVE tokençŠ¶æ€
                const eveTokenExpires = getCurrentTokenExpires();
                if (eveTokenExpires) {
                    const expiresTime = new Date(eveTokenExpires);
                    const now = new Date();
                    const timeLeft = Math.floor((expiresTime - now) / 1000 / 60);
                    
                    // å¦‚æœtokenåœ¨5åˆ†é’Ÿå†…è¿‡æœŸï¼Œå…ˆå°è¯•åˆ·æ–°
                    if (timeLeft <= 5) {
                        console.log(`âš ï¸ [autoUpdate] EVE tokenå³å°†è¿‡æœŸï¼Œå‰©ä½™${timeLeft}åˆ†é’Ÿï¼Œå°è¯•åˆ·æ–°`);
                        const refreshSuccess = await attemptTokenRefreshSilent();
                        if (!refreshSuccess) {
                            console.error('âŒ [autoUpdate] Tokenåˆ·æ–°å¤±è´¥ï¼Œè·³è¿‡æœ¬æ¬¡æ›´æ–°');
                            return;
                        }
                    }
                }
                
                // æ£€æŸ¥æ˜¯å¦æœ‰ä¿å­˜çš„å‡­æ®
                if (bloodCredentials.username && bloodCredentials.password) {
                    // é™é»˜æ›´æ–°æ•°æ®
                    startDataUpdate(bloodCredentials.username, bloodCredentials.password, true);
                }
            }, 3 * 60 * 1000); // æ”¹ä¸º3åˆ†é’Ÿï¼Œä¸sessionä¿æ´»åŒæ­¥
            
            console.log('è‡ªåŠ¨æ›´æ–°å·²å¯åŠ¨ï¼ˆæ¯3åˆ†é’Ÿï¼Œä¸sessionä¿æ´»åŒæ­¥ï¼‰');
        }
        
        // åœæ­¢è‡ªåŠ¨æ›´æ–°
        function stopAutoUpdate() {
            if (autoUpdateTimer) {
                clearInterval(autoUpdateTimer);
                autoUpdateTimer = null;
                console.log('è‡ªåŠ¨æ›´æ–°å·²åœæ­¢');
            }
        }

        // æ‰“å¼€è®¾ç½®å¼¹çª—
        function openSettingsModal() {
            settingsModal.classList.add('show');
            cooperativeRateInput.value = '';
            cooperativeRateInput.focus();
        }

        // å…³é—­è®¾ç½®å¼¹çª—
        function closeSettingsModalFunc() {
            settingsModal.classList.remove('show');
        }

        // ç»‘å®šäº‹ä»¶
        settingsBtnLoggedIn.onclick = function(e) {
            e.stopPropagation(); // é˜»æ­¢å†’æ³¡ï¼Œé˜²æ­¢å…³é—­ä¸‹æ‹‰èœå•
            openSettingsModal();
        };
        closeSettingsModal.onclick = closeSettingsModalFunc;
        cancelSettings.onclick = closeSettingsModalFunc;



        // æ›´æ–°è¡€è¢­è€…LPç‚¹æ•°è®¡ç®—
        function updateBloodRaiderLPCalculation() {
            const infoCards = document.querySelectorAll('.info-card');
            let currentRate = 2200; // é»˜è®¤æ¯”ç‡
            
            // è·å–å½“å‰è®¾ç½®çš„æ¯”ç‡
            if (infoCards.length > 1) {
                const cooperativeCard = infoCards[1].querySelector('.info-value');
                if (cooperativeCard) {
                    currentRate = parseFloat(cooperativeCard.textContent) || 2200;
                }
            }
            
            // è·å–è¡€è¢­è€…LPç‚¹æ•°
            let bloodRaiderLP = 0;
            if (infoCards.length > 2) {
                const lpCard = infoCards[2].querySelector('.info-value');
                if (lpCard) {
                    // ç§»é™¤åƒåˆ†ä½åˆ†éš”ç¬¦å¹¶è½¬æ¢ä¸ºæ•°å­—
                    bloodRaiderLP = parseFloat(lpCard.textContent.replace(/,/g, '')) || 0;
                }
            }
            
            // æ›´æ–°è®¡ç®—ç»“æœ
            if (infoCards.length > 3) {
                const calculationCard = infoCards[3].querySelector('.info-value');
                if (calculationCard) {
                    const calculatedValue = currentRate * bloodRaiderLP;
                    calculationCard.textContent = new Intl.NumberFormat('zh-CN').format(Math.round(calculatedValue));
                }
            }
        }

        // å¤„ç†è¡¨å•æäº¤
        settingsForm.addEventListener('submit', (e) => {
            e.preventDefault();

            const newRate = parseFloat(cooperativeRateInput.value);

            if (isNaN(newRate) || newRate <= 0) {
                showMessage('è¯·è¾“å…¥æœ‰æ•ˆçš„æ¯”ç‡æ•°å€¼', 'error');
                return;
            }

            // æ›´æ–°æ˜¾ç¤ºçš„æ¯”ç‡
            const infoCards = document.querySelectorAll('.info-card');
            if (infoCards.length > 1) {
                const cooperativeCard = infoCards[1].querySelector('.info-value');
                if (cooperativeCard) {
                    cooperativeCard.textContent = newRate;
                }
            }

            // æ›´æ–°å½“å‰æ¯”ç‡æ˜¾ç¤º
            currentRateSpan.textContent = newRate;

            // æ›´æ–°è¡€è¢­è€…LPç‚¹æ•°è®¡ç®—
            updateBloodRaiderLPCalculation();

            // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
            localStorage.setItem('cooperativeRate', newRate);

            showMessage('åˆä½œç¤¾æ¯”ç‡è®¾ç½®æˆåŠŸ', 'success');
            closeSettingsModalFunc();
        });



        // é¡µé¢åŠ è½½æ—¶æ¢å¤ä¿å­˜çš„æ¯”ç‡
        window.addEventListener('DOMContentLoaded', () => {
            const savedRate = localStorage.getItem('cooperativeRate');
            if (savedRate) {
                const infoCards = document.querySelectorAll('.info-card');
                if (infoCards.length > 1) {
                    const cooperativeCard = infoCards[1].querySelector('.info-value');
                    if (cooperativeCard) {
                        cooperativeCard.textContent = savedRate;
                    }
                }
                currentRateSpan.textContent = savedRate;
                
                // é¡µé¢åŠ è½½æ—¶ä¹Ÿæ›´æ–°è¡€è¢­è€…LPç‚¹æ•°è®¡ç®—
                setTimeout(() => {
                    updateBloodRaiderLPCalculation();
                }, 100);
            }
        });

        // å®šæœŸæ£€æŸ¥å‡­æ®çŠ¶æ€
        setInterval(() => {
            const credentials = localStorage.getItem('bloodCredentials');
            if (!credentials && bloodCredentials.username) {
                console.warn('âš ï¸ æ£€æµ‹åˆ°å‡­æ®ä¸¢å¤±ï¼Œå°è¯•æ¢å¤');
                // å°è¯•ä»å†…å­˜æ¢å¤åˆ°å­˜å‚¨
                if (bloodCredentials.username && bloodCredentials.password) {
                    saveCredentials(bloodCredentials.username, bloodCredentials.password);
                }
            }
        }, 30000); // æ¯30ç§’æ£€æŸ¥ä¸€æ¬¡

        // ä»å·²æ”¯ä»˜ä»»åŠ¡è¡¨æ ¼ä¸­ç§»é™¤æŒ‡å®šæ”¯ä»˜è€…çš„è¡Œ
        function removePayerFromTable(payer) {
            const tbody = document.querySelector('#paidMissionsTable tbody');
            const rows = tbody.querySelectorAll('tr');
            
            rows.forEach(row => {
                const payerCell = row.querySelector('td:first-child');
                if (payerCell && payerCell.textContent.trim() === payer) {
                    row.remove();
                }
            });
            
            // å¦‚æœè¡¨æ ¼ä¸ºç©ºï¼Œæ˜¾ç¤ºæš‚æ— æ•°æ®
            if (tbody.children.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; color: #666;">æš‚æ— æ•°æ®</td></tr>';
            }
        }

        // æ ‡è®°ä»»åŠ¡ä¸ºå®ŒæˆçŠ¶æ€
async function markMissionsAsDone(payer, missionIds) {
    try {
        // é€šè¿‡åç«¯APIä»£ç†è¯·æ±‚ï¼Œé¿å…CORSé—®é¢˜
        const response = await fetch('/api/mark_missions_done', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            credentials: 'same-origin',
            body: JSON.stringify({
                mission_ids: missionIds
            })
        });
        
        if (!response.ok) {
            throw new Error(`è¯·æ±‚å¤±è´¥: ${response.status}`);
        }
        
        const result = await response.json();
        
        if (result.success) {
            // åç«¯å¤„ç†æˆåŠŸåå†ä»å‰ç«¯ç§»é™¤å¯¹åº”çš„æ”¯ä»˜è€…è¡Œ
            removePayerFromTable(payer);
            
            const successCount = result.results.filter(r => r.status === 'success').length;
            const failCount = result.results.length - successCount;
            showMessage(`ä»»åŠ¡æ ‡è®°å®Œæˆï¼æˆåŠŸ: ${successCount}ä¸ªï¼Œå¤±è´¥: ${failCount}ä¸ª`, 'success');
            
            // å…³é—­å¼¹çª—
            closePayerMatchModal();
            closePayerNoMatchModal();
            
            // åªæ›´æ–°ç»Ÿè®¡ä¿¡æ¯ï¼Œä¸é‡æ–°åŠ è½½æ•´ä¸ªè¡¨æ ¼
            updatePageStatistics();
        } else {
            // å¦‚æœåç«¯å¤„ç†å¤±è´¥ï¼Œæ˜¾ç¤ºé”™è¯¯æ¶ˆæ¯
            showMessage('æ ‡è®°ä»»åŠ¡å¤±è´¥: ' + result.message, 'error');
        }
        
    } catch (error) {
        console.error('æ ‡è®°ä»»åŠ¡å®Œæˆæ—¶å‡ºé”™:', error);
        showMessage('æ ‡è®°ä»»åŠ¡å®Œæˆå¤±è´¥: ' + error.message, 'error');
    }
}
        
        // æ·»åŠ æ¨¡ç³Šåç§°åŒ¹é…å‡½æ•°
        function fuzzyNameMatch(donor, payer) {
            if (!donor || !payer) return false;
            
            const donorLower = donor.toLowerCase().trim();
            const payerLower = payer.toLowerCase().trim();
            
            // 1. å®Œå…¨åŒ¹é…
            if (donorLower === payerLower) return true;
            
            // 2. åŒ…å«åŒ¹é…ï¼ˆåŒå‘ï¼‰
            if (donorLower.includes(payerLower) || payerLower.includes(donorLower)) return true;
            
            // 3. å»é™¤ç©ºæ ¼ååŒ¹é…
            const donorNoSpace = donorLower.replace(/\s+/g, '');
            const payerNoSpace = payerLower.replace(/\s+/g, '');
            if (donorNoSpace.includes(payerNoSpace) || payerNoSpace.includes(donorNoSpace)) return true;
            
            // 4. è®¡ç®—ç¼–è¾‘è·ç¦»ç›¸ä¼¼åº¦
            const similarity = calculateSimilarity(donorLower, payerLower);
            return similarity > 0.7; // ç›¸ä¼¼åº¦é˜ˆå€¼70%
        }

        // è®¡ç®—å­—ç¬¦ä¸²ç›¸ä¼¼åº¦ï¼ˆåŸºäºç¼–è¾‘è·ç¦»ï¼‰
        function calculateSimilarity(str1, str2) {
            const maxLength = Math.max(str1.length, str2.length);
            if (maxLength === 0) return 1;
            
            const distance = levenshteinDistance(str1, str2);
            return (maxLength - distance) / maxLength;
        }

        // è®¡ç®—ç¼–è¾‘è·ç¦»
        function levenshteinDistance(str1, str2) {
            const matrix = [];
            
            for (let i = 0; i <= str2.length; i++) {
                matrix[i] = [i];
            }
            
            for (let j = 0; j <= str1.length; j++) {
                matrix[0][j] = j;
            }
            
            for (let i = 1; i <= str2.length; i++) {
                for (let j = 1; j <= str1.length; j++) {
                    if (str2.charAt(i - 1) === str1.charAt(j - 1)) {
                        matrix[i][j] = matrix[i - 1][j - 1];
                    } else {
                        matrix[i][j] = Math.min(
                            matrix[i - 1][j - 1] + 1, // æ›¿æ¢
                            matrix[i][j - 1] + 1,     // æ’å…¥
                            matrix[i - 1][j] + 1      // åˆ é™¤
                        );
                    }
                }
            }
            
            return matrix[str2.length][str1.length];
        }

        // ğŸ†• æ™ºèƒ½æ•°æ®æ›´æ–°ç­–ç•¥
        async function smartDataUpdate() {
            try {
                // æ£€æŸ¥ESIç¼“å­˜å¤´åŠ¨æ€è°ƒæ•´æ›´æ–°é¢‘ç‡
                const lastExpires = localStorage.getItem('lastEsiExpires');
                if (lastExpires) {
                    const expiresTime = new Date(lastExpires);
                    const now = new Date();
                    if (now < expiresTime) {
                        console.log(`â° ESIç¼“å­˜æœªè¿‡æœŸï¼Œ${Math.ceil((expiresTime - now) / 60000)}åˆ†é’Ÿåé‡è¯•`);
                        return;
                    }
                }
                
                // æ£€æŸ¥æ•°æ®æ–°é²œåº¦ - ä¿®æ”¹ä¸ºåŸºäºUTC+8æ—¶åŒºçš„æ¯”è¾ƒ
                const lastUpdate = localStorage.getItem('lastWalletUpdate');
                const now = Date.now();
                const updateInterval = 30 * 60 * 1000; // ä¿®æ”¹ä¸º30åˆ†é’Ÿé—´éš”
                
                if (lastUpdate) {
                    // è·å–æœ€æ–°çš„é’±åŒ…æ•°æ®è¿›è¡Œæ—¶é—´æ¯”è¾ƒ
                    const walletResponse = await fetch('/api/recent_wallet_donations', {
                        method: 'GET',
                        credentials: 'same-origin',
                        headers: {
                            'Content-Type': 'application/json',
                            'Cache-Control': 'no-cache'
                        }
                    });
                    
                    if (walletResponse.ok) {
                        const walletData = await walletResponse.json();
                        if (walletData.success && walletData.data && walletData.data.length > 0) {
                            const latestEntry = walletData.data[0];
                            
                            // ğŸ”§ ä¿®å¤ï¼šç›´æ¥ä½¿ç”¨UTCæ—¶é—´ï¼Œä¸è¦æ‰‹åŠ¨æ·»åŠ 8å°æ—¶
                            const entryTime = new Date(latestEntry.date || latestEntry.timestamp);
                            const currentTime = new Date();
                            const timeDiff = (currentTime - entryTime) / 1000 / 60; // åˆ†é’Ÿå·®
                            
                            if (timeDiff < 30) {
                                console.log(`ğŸ“Š æ•°æ®ä»ç„¶æ–°é²œ(${timeDiff.toFixed(1)}åˆ†é’Ÿå‰)ï¼Œè·³è¿‡æ›´æ–°`);
                                return;
                            } else {
                                console.log(`â° æ•°æ®å·²è¿‡æœŸ(${timeDiff.toFixed(1)}åˆ†é’Ÿå‰)ï¼Œéœ€è¦æ›´æ–°`);
                            }
                        }
                    }
                }
                
                // æ£€æŸ¥ESIé”™è¯¯é™åˆ¶
                const errorCount = parseInt(localStorage.getItem('esiErrorCount') || '0');
                if (errorCount >= 5) {
                    const lastError = parseInt(localStorage.getItem('lastEsiError') || '0');
                    const errorCooldown = 30 * 60 * 1000; // 30åˆ†é’Ÿå†·å´
                    if ((now - lastError) < errorCooldown) {
                        console.log('âš ï¸ ESIé”™è¯¯è¿‡å¤šï¼Œç­‰å¾…å†·å´æœŸç»“æŸ');
                        return;
                    } else {
                        localStorage.removeItem('esiErrorCount');
                        localStorage.removeItem('lastEsiError');
                    }
                }
                
                // æ‰§è¡Œå¢é‡æ›´æ–°å¹¶ä¿å­˜æ–°çš„Expiresæ—¶é—´
                const response = await fetch('/api/wallet_incremental_update', {
                    method: 'POST',
                    credentials: 'same-origin',
                    headers: {
                        'Content-Type': 'application/json',
                        'Cache-Control': 'no-cache'
                    },
                    body: JSON.stringify({
                        force_refresh: false,
                        last_update: lastUpdate
                    })
                });
                
                // ä¿å­˜ESIç¼“å­˜è¿‡æœŸæ—¶é—´
                const expires = response.headers.get('Expires');
                if (expires) {
                    localStorage.setItem('lastEsiExpires', expires);
                    console.log(`ğŸ“… ESIç¼“å­˜è¿‡æœŸæ—¶é—´: ${expires}`);
                }
                
                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        localStorage.setItem('lastWalletUpdate', now.toString());
                        console.log('âœ… å¢é‡æ•°æ®æ›´æ–°æˆåŠŸ');
                        
                        // ğŸ”§ ä¿®å¤ï¼šæ— è®ºæ˜¯å¦æœ‰æ–°æ•°æ®éƒ½åˆ·æ–°ç•Œé¢ï¼Œç¡®ä¿æ˜¾ç¤ºæœ€æ–°çŠ¶æ€
                        console.log(`ğŸ“Š æœ¬æ¬¡æ›´æ–°è·å–åˆ° ${result.new_entries || 0} æ¡æ–°è®°å½•ï¼Œåˆ·æ–°ç•Œé¢`);
                        loadWalletDonationsData();
                        loadPaidMissionsData();
                        
                        // ğŸ”§ å¢åŠ å»¶è¿Ÿç¡®ä¿æ•°æ®åº“å†™å…¥å®Œæˆ
                        setTimeout(() => {
                            loadWalletDonationsData();
                            loadPaidMissionsData();
                            console.log('ğŸ”„ å»¶è¿Ÿåˆ·æ–°ç•Œé¢å®Œæˆ');
                        }, 2000);
                    }
                }
                
            } catch (error) {
                console.error('âŒ æ™ºèƒ½æ•°æ®æ›´æ–°å¤±è´¥:', error);
                // è®°å½•é”™è¯¯
                const errorCount = parseInt(localStorage.getItem('esiErrorCount') || '0') + 1;
                localStorage.setItem('esiErrorCount', errorCount.toString());
                localStorage.setItem('lastEsiError', Date.now().toString());
            }
        }

        // ğŸ†• ä¼˜åŒ–çš„è‡ªåŠ¨æ›´æ–°
        function startOptimizedAutoUpdate() {
            // ä½¿ç”¨æ›´æ™ºèƒ½çš„æ›´æ–°é—´éš”
            const updateInterval = 3 * 60 * 1000; // 3åˆ†é’ŸåŸºç¡€é—´éš”
            
            setInterval(async () => {
                if (currentUser && isCurrentTokenValid()) {
                    await smartDataUpdate();
                }
            }, updateInterval);
            
            // ğŸ†• é¡µé¢å¯è§æ€§å˜åŒ–æ—¶çš„å¤„ç†
            document.addEventListener('visibilitychange', () => {
                if (!document.hidden && currentUser) {
                    // é¡µé¢é‡æ–°å¯è§æ—¶æ£€æŸ¥æ˜¯å¦éœ€è¦æ›´æ–°
                    setTimeout(smartDataUpdate, 1000);
                }
            });
        }

        // å°†å‡½æ•°æš´éœ²åˆ°å…¨å±€ä½œç”¨åŸŸï¼Œä»¥ä¾¿HTMLä¸­çš„onclickå¯ä»¥è®¿é—®
        window.viewPayerDetails = viewPayerDetails;
        window.closePayerMatchModal = closePayerMatchModal;
        window.closePayerNoMatchModal = closePayerNoMatchModal;
        window.refreshWalletDataAndRetry = refreshWalletDataAndRetry;
        window.generateMatchResultsList = generateMatchResultsList;
        window.showPayerMatchResults = showPayerMatchResults;
        window.markMissionsAsDone = markMissionsAsDone;
        window.fuzzyNameMatch = fuzzyNameMatch;
        window.calculateSimilarity = calculateSimilarity;
        window.levenshteinDistance = levenshteinDistance;
        // å°†å‡½æ•°æš´éœ²åˆ°å…¨å±€ä½œç”¨åŸŸï¼Œä»¥ä¾¿HTMLä¸­çš„onclickå¯ä»¥è®¿é—®
        window.viewPayerDetails = viewPayerDetails;
        window.closePayerMatchModal = closePayerMatchModal;
        window.closePayerNoMatchModal = closePayerNoMatchModal;
        window.refreshWalletDataAndRetry = refreshWalletDataAndRetry;
        window.generateMatchResultsList = generateMatchResultsList;
        window.showPayerMatchResults = showPayerMatchResults;
        window.markMissionsAsDone = markMissionsAsDone;
        window.fuzzyNameMatch = fuzzyNameMatch;
        window.calculateSimilarity = calculateSimilarity;
        window.levenshteinDistance = levenshteinDistance;
        window.attemptTokenRefresh = attemptTokenRefresh;
        window.attemptTokenRefreshSilent = attemptTokenRefreshSilent;
        window.checkEveTokenOnPageLoad = checkEveTokenOnPageLoad;
        window.smartDataUpdate = smartDataUpdate;
        window.startOptimizedAutoUpdate = startOptimizedAutoUpdate;
        window.initializeBasicUI = initializeBasicUI;
        window.showSkeletonScreens = showSkeletonScreens;
        window.initTablesAsync = initTablesAsync;
        window.removeSkeletonScreens = removeSkeletonScreens;
        window.showLoadingIndicator = showLoadingIndicator;
        window.hideLoadingIndicator = hideLoadingIndicator;

        // å¤œé—´æ¨¡å¼åˆ‡æ¢åŠŸèƒ½
        function toggleTheme() {
            const body = document.body;
            const themeIcon = document.getElementById('theme-icon');
            const currentTheme = body.getAttribute('data-theme');
            
            if (currentTheme === 'dark') {
                body.removeAttribute('data-theme');
                themeIcon.textContent = 'ğŸŒ™';
                localStorage.setItem('theme', 'light');
            } else {
                body.setAttribute('data-theme', 'dark');
                themeIcon.textContent = 'â˜€ï¸';
                localStorage.setItem('theme', 'dark');
            }
        }

        // é¡µé¢åŠ è½½æ—¶åº”ç”¨ä¿å­˜çš„ä¸»é¢˜
        document.addEventListener('DOMContentLoaded', function() {
            const savedTheme = localStorage.getItem('theme');
            const themeIcon = document.getElementById('theme-icon');
            
            if (savedTheme === 'dark') {
                document.body.setAttribute('data-theme', 'dark');
                themeIcon.textContent = 'â˜€ï¸';
            } else {
                themeIcon.textContent = 'ğŸŒ™';
            }
        });

        // å°†å¤œé—´æ¨¡å¼åˆ‡æ¢å‡½æ•°æš´éœ²åˆ°å…¨å±€ä½œç”¨åŸŸ
        window.toggleTheme = toggleTheme;

    </script>

    <style>
        /* å¤œé—´æ¨¡å¼åˆ‡æ¢æŒ‰é’®æ ·å¼ - å·²æ³¨é‡Šæ‰ */
        /* .theme-toggle {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 50px;
            height: 50px;
            border: none;
            border-radius: 50%;
            background: linear-gradient(135deg, #1976d2, #42a5f5);
            color: white;
            font-size: 20px;
            cursor: pointer;
            box-shadow: 0 4px 16px rgba(25, 118, 210, 0.3);
            transition: all 0.3s ease;
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .theme-toggle:hover {
            background: linear-gradient(135deg, #1565c0, #64b5f6);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(25, 118, 210, 0.4);
        }

        .theme-toggle:active {
            transform: translateY(0);
        } */

        [data-theme="dark"] .navbar-brand,
        [data-theme="dark"] .navbar-item {
            color: #e0e0e0;
        }

        [data-theme="dark"] .navbar-item:hover {
            color: #64b5f6;
        }

        [data-theme="dark"] .content-area {
            background-color: #121212;
        }

        [data-theme="dark"] .info-card {
            background: linear-gradient(135deg, #1e1e1e, #2a2a2a);
            border-color: #333;
            color: #e0e0e0;
        }

        [data-theme="dark"] .info-card:hover {
            background: linear-gradient(135deg, #2a2a2a, #333);
            border-color: #64b5f6;
        }

        [data-theme="dark"] .info-label {
            color: #b0b0b0;
        }

        [data-theme="dark"] .info-value {
            color: #64b5f6;
        }

        [data-theme="dark"] .table-section {
            background: #1e1e1e;
        }

        [data-theme="dark"] .data-table {
            background: #1a1a1a;
        }

        [data-theme="dark"] .data-table th {
            background: linear-gradient(135deg, #1565c0, #1976d2);
        }

        [data-theme="dark"] .data-table td {
            border-bottom-color: #333;
            color: #e0e0e0;
        }

        [data-theme="dark"] .data-table tbody tr:hover {
            background-color: #2a2a2a;
        }

        [data-theme="dark"] .modal-content {
            background: #1e1e1e;
            color: #e0e0e0;
        }

        [data-theme="dark"] .modal-content h2 {
            color: #64b5f6;
        }

        [data-theme="dark"] .modal-content input {
            background: #2a2a2a;
            border-color: #444;
            color: #e0e0e0;
        }

        [data-theme="dark"] .modal-content input:focus {
            border-color: #64b5f6;
        }

        [data-theme="dark"] .user-dropdown {
            background: #1e1e1e;
            border: 1px solid #333;
        }

        [data-theme="dark"] .dropdown-item {
            color: #e0e0e0;
        }

        [data-theme="dark"] .dropdown-item:hover {
            background: #2a2a2a;
        }

        [data-theme="dark"] .user-info {
            background: #2a2a2a;
        }

        [data-theme="dark"] .user-info:hover {
            background: #2a2a2a;
        }

        /* å¼¹çª—å¤œé—´æ¨¡å¼æ ·å¼ */
        [data-theme="dark"] .message-modal {
            background: rgba(0, 0, 0, 0.6);
        }

        [data-theme="dark"] .message-content {
            background: #1e1e1e;
            color: #e0e0e0;
            box-shadow: 0 12px 30px rgba(0, 0, 0, 0.3);
        }

        [data-theme="dark"] .message-text {
            color: #e0e0e0;
        }

        /* æ”¯ä»˜è€…åŒ¹é…å¼¹çª—å¤œé—´æ¨¡å¼ */
        [data-theme="dark"] .payer-match-modal {
            background: #1e1e1e;
            color: #e0e0e0;
        }

        [data-theme="dark"] .modal-header {
            border-bottom-color: #333;
        }

        [data-theme="dark"] .modal-header h3 {
            color: #64b5f6;
        }

        [data-theme="dark"] .match-info {
            background: #2a2a2a;
            border-left-color: #64b5f6;
        }

        [data-theme="dark"] .match-info h4 {
            color: #64b5f6;
        }

        [data-theme="dark"] .match-info p {
            color: #b0b0b0;
        }

        [data-theme="dark"] .detail-item strong {
            color: #e0e0e0;
        }

        [data-theme="dark"] .modal-footer {
            border-top-color: #333;
        }

        /* åŒ¹é…å¤±è´¥å¼¹çª—å¤œé—´æ¨¡å¼ */
        [data-theme="dark"] .no-match-modal {
            background: linear-gradient(135deg, #1e1e1e 0%, #2a2a2a 100%);
        }

        [data-theme="dark"] .modal-body-enhanced {
            background: #1e1e1e;
        }

        [data-theme="dark"] .payer-info-card {
            background: #2a2a2a;
            border-color: #444;
        }

        [data-theme="dark"] .info-row {
            border-bottom-color: #333;
        }

        [data-theme="dark"] .info-label {
            color: #b0b0b0;
        }

        [data-theme="dark"] .info-value {
            color: #e0e0e0;
        }

        [data-theme="dark"] .info-value.amount {
            color: #4caf50;
        }

        [data-theme="dark"] .reasons-section h4,
        [data-theme="dark"] .suggestions-section h4 {
            color: #e0e0e0;
        }

        [data-theme="dark"] .reason-item {
            background: #333;
            border-left-color: #ffb74d;
        }

        [data-theme="dark"] .suggestion-text {
            color: #b0b0b0;
        }

        /* å¢å¼ºæŒ‰é’®å¤œé—´æ¨¡å¼ */
        [data-theme="dark"] .btn-enhanced {
            color: #e0e0e0;
        }

        [data-theme="dark"] .btn-secondary-enhanced {
            background: linear-gradient(135deg, #444 0%, #555 100%);
            color: #e0e0e0;
        }

        [data-theme="dark"] .btn-secondary-enhanced:hover {
            background: linear-gradient(135deg, #555 0%, #666 100%);
        }

        /* é€šç”¨å¼¹çª—èƒŒæ™¯å¤œé—´æ¨¡å¼ */
        [data-theme="dark"] .modal {
            background-color: rgba(0, 0, 0, 0.6);
        }

        /* è¡¨å•å…ƒç´ å¤œé—´æ¨¡å¼ */
        [data-theme="dark"] .form-control {
            background: #2a2a2a;
            border-color: #444;
            color: #e0e0e0;
        }

        [data-theme="dark"] .form-control:focus {
            border-color: #64b5f6;
            box-shadow: 0 0 0 0.2rem rgba(100, 181, 246, 0.25);
        }

        [data-theme="dark"] .form-label {
            color: #e0e0e0;
        }

        /* å…³é—­æŒ‰é’®å¤œé—´æ¨¡å¼ */
        [data-theme="dark"] .close {
            color: #e0e0e0;
            opacity: 0.8;
        }

        [data-theme="dark"] .close:hover {
            color: #64b5f6;
            opacity: 1;
        }

        [data-theme="dark"] .close-btn {
            color: rgba(255, 255, 255, 0.9);
        }

        [data-theme="dark"] .close-btn:hover {
            color: white;
        }

        [data-theme="dark"] .theme-toggle {
            background: linear-gradient(135deg, #ff9800, #ffb74d);
            box-shadow: 0 4px 16px rgba(255, 152, 0, 0.3);
        }

        [data-theme="dark"] .theme-toggle:hover {
            background: linear-gradient(135deg, #f57c00, #ffa726);
            box-shadow: 0 6px 20px rgba(255, 152, 0, 0.4);
        }

        /* å¤œé—´æ¨¡å¼ä¸‹çš„åŠ è½½æŒ‡ç¤ºå™¨æ ·å¼ */
        [data-theme="dark"] .loading-indicator {
            background: #2a2a2a;
            border: 1px solid #444;
            color: #e0e0e0;
        }

        [data-theme="dark"] .spinner {
            border: 3px solid #444;
            border-top: 3px solid #64b5f6;
        }

        /* å¦‚æœæ²¡æœ‰data-themeå±æ€§ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨åª’ä½“æŸ¥è¯¢ */
        @media (prefers-color-scheme: dark) {
            .loading-indicator {
                background: #2a2a2a !important;
                border: 1px solid #444 !important;
                color: #e0e0e0 !important;
            }
            
            .spinner {
                border: 3px solid #444 !important;
                border-top: 3px solid #64b5f6 !important;
            }
        }

        /* è¡¨æ ¼å¤œé—´æ¨¡å¼è¡¥å……æ ·å¼ */
        [data-theme="dark"] .table-section h4 {
            color: #64b5f6;
        }

        [data-theme="dark"] .data-table .amount {
            color: #4caf50;
            font-weight: 600;
        }

        [data-theme="dark"] .data-table .count {
            color: #64b5f6;
            font-weight: 600;
        }

        [data-theme="dark"] .table-wrapper {
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }

        [data-theme="dark"] .action-btn.view-btn {
            background: linear-gradient(135deg, #1976d2, #42a5f5);
        }

        [data-theme="dark"] .action-btn.view-btn:hover {
            background: linear-gradient(135deg, #1565c0, #64b5f6);
        }

        /* ç¡®ä¿è¡¨æ ¼åœ¨å¤œé—´æ¨¡å¼ä¸‹çš„è¾¹æ¡†å¯è§æ€§ */
        [data-theme="dark"] .data-table {
            border: 1px solid #333;
        }

        [data-theme="dark"] .table-wrapper {
            border: 1px solid #333;
            border-radius: 8px;
        }

        /* è§’è½å¼¹çª—æ ·å¼ */
        .corner-notification {
            position: fixed;
            bottom: 20px;
            left: 20px;
            z-index: 2000;
            background: #fff;
            padding: 16px 20px;
            border-radius: 12px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
            max-width: 350px;
            min-width: 280px;
            display: flex;
            align-items: center;
            gap: 12px;
            transform: translateX(-100%);
            opacity: 0;
            transition: all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            border-left: 4px solid #2196f3;
        }

        /* åŒ¹é…è®°å½•åˆ—è¡¨å¤œé—´æ¨¡å¼æ ·å¼ */
        [data-theme="dark"] .match-records-list {
            background: #1e1e1e;
        }

        [data-theme="dark"] .match-record-item {
            background: #2a2a2a;
            border-color: #444;
            color: #e0e0e0;
        }

        [data-theme="dark"] .match-record-item:hover {
            background: #333;
            border-color: #64b5f6;
        }

        [data-theme="dark"] .record-header {
            border-bottom-color: #444;
        }

        [data-theme="dark"] .record-number {
            background: #64b5f6;
            color: #1e1e1e;
        }

        [data-theme="dark"] .record-donor {
            color: #64b5f6;
        }

        [data-theme="dark"] .record-amount {
            color: #4caf50;
        }

        [data-theme="dark"] .record-details {
            color: #b0b0b0;
        }

        [data-theme="dark"] .detail-item {
            color: #b0b0b0;
        }

        [data-theme="dark"] .no-match {
            color: #b0b0b0;
        }

        .corner-notification.show {
            transform: translateX(0);
            opacity: 1;
        }

        .corner-notification.fade-out {
            transform: translateX(-100%);
            opacity: 0;
        }

        .corner-notification-icon {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: bold;
            flex-shrink: 0;
        }

        .corner-notification-icon.success {
            background: #4caf50;
            color: #fff;
        }

        .corner-notification-icon.success::before {
            content: 'âœ“';
        }

        .corner-notification-icon.error {
            background: #f44336;
            color: #fff;
        }

        .corner-notification-icon.error::before {
            content: 'âœ•';
        }

        .corner-notification-icon.info {
            background: #2196f3;
            color: #fff;
        }

        .corner-notification-icon.info::before {
            content: 'i';
        }

        .corner-notification-icon.warning {
            background: #ff9800;
            color: #fff;
        }

        .corner-notification-icon.warning::before {
            content: 'âš ';
        }

        .corner-notification-text {
            font-size: 14px;
            color: #333;
            line-height: 1.4;
            flex: 1;
        }

        .corner-notification.success {
            border-left-color: #4caf50;
        }

        .corner-notification.error {
            border-left-color: #f44336;
        }

        .corner-notification.warning {
            border-left-color: #ff9800;
        }

        /* å¤œé—´æ¨¡å¼æ ·å¼ */
        [data-theme="dark"] .corner-notification {
            background: #2a2a2a;
            color: #e0e0e0;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.4);
        }

        [data-theme="dark"] .corner-notification-text {
            color: #e0e0e0;
        }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            .theme-toggle {
                bottom: 20px;
                right: 20px;
                width: 45px;
                height: 45px;
                font-size: 18px;
            }
        }
    </style>
</body>

</html>